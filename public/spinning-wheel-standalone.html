<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://code.jquery.com https://stackpath.bootstrapcdn.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://fonts.googleapis.com https://stackpath.bootstrapcdn.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com data:; img-src 'self' data: https: blob:; connect-src 'self' https://api.telegram.org https://*.supabase.co https://*.vercel.app; object-src 'none'; media-src 'self'; frame-src 'self'; base-uri 'self'; form-action 'self';">
    <title>Premium Spinning Wheel</title>
    <script src="js/config.js"></script>
    <script src="js/i18n-init.js"></script>
    <script>
        if (!window.API_BASE_URL) {
            window.API_BASE_URL = '';
        }

        function getTranslation(key) {
            try {
                if (typeof i18next !== 'undefined' && i18next && i18next.isInitialized) {
                    return i18next.t(key);
                }
            } catch (e) {
                console.warn('i18next translation error:', e);
            }
            return null;
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .spinning-wheel-container {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 15px 10px;
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Floating particles background - ОПТИМИЗИРОВАНО */
        .spinning-wheel-container::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            background-position: 0 0;
            animation: particlesFloat 20s linear infinite;
            pointer-events: none;
            will-change: transform;
        }

        @keyframes particlesFloat {
            0% { transform: translateY(0); }
            100% { transform: translateY(-100px); }
        }

        .wheel-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 1200px;
            width: 100%;
            position: relative;
            z-index: 1;
        }

        @media (min-width: 1024px) {
            .wheel-content {
                flex-direction: row;
                justify-content: center;
                align-items: center;
                gap: 40px;
            }
        }

        .wheel-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
            position: relative;
        }

        /* ОПТИМИЗИРОВАННЫЙ Wheel Container */
        .wheel-container {
            position: relative;
            width: 280px;
            height: 280px;
            will-change: transform;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            perspective: 1000px;
            -webkit-perspective: 1000px;
        }

        @media (min-width: 768px) {
            .wheel-container {
                width: 380px;
                height: 380px;
            }
        }

        @media (min-width: 1024px) {
            .wheel-container {
                width: 420px;
                height: 420px;
            }
        }

        /* Упрощенный glow для производительности */
        .wheel-glow {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            padding: 8px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            animation: glowPulse 3s ease infinite;
        }

        @keyframes glowPulse {
            0%, 100% { 
                box-shadow: 0 0 30px rgba(245, 158, 11, 0.4);
            }
            50% { 
                box-shadow: 0 0 45px rgba(245, 158, 11, 0.6);
            }
        }

        .wheel-border {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 0;
            box-shadow: 
                0 0 30px rgba(245, 158, 11, 0.3),
                inset 0 0 20px rgba(255, 255, 255, 0.9);
        }

        /* КРИТИЧНО ОПТИМИЗИРОВАННОЕ колесо */
        .wheel {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            will-change: transform;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .wheel-segment {
            position: absolute;
            top: -2px;
            left: -2px;
            width: calc(100% + 4px);
            height: calc(100% + 4px);
            transform-origin: center;
            will-change: auto;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .segment-border {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .segment-content {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120px;
            height: 120px;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .segment-icon {
            font-size: 32px;
            margin-bottom: 8px;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3));
            display: block;
        }

        @media (max-width: 480px) {
            .segment-icon {
                font-size: 24px;
                margin-bottom: 4px;
            }
        }

        .segment-text {
            font-size: 18px;
            line-height: 1.2;
            font-weight: 800;
            text-align: center;
            padding: 5px 8px;
            white-space: nowrap;
            min-width: 40px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
            z-index: 10;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 6px;
        }

        @media (max-width: 480px) {
            .segment-text {
                font-size: 15px;
                padding: 4px 6px;
            }
        }

        /* Оптимизированная центральная кнопка */
        .center-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 75px;
            height: 75px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: 4px solid white;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
            transition: all 0.2s ease;
            z-index: 20;
            will-change: transform;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        @media (min-width: 768px) {
            .center-button {
                width: 85px;
                height: 85px;
            }
        }

        .center-button:hover {
            transform: translate(-50%, -50%) scale(1.05);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.6);
        }

        .center-button:active {
            transform: translate(-50%, -50%) scale(0.95);
        }

        .center-button:disabled {
            cursor: not-allowed;
            opacity: 0.7;
            animation: spinningButton 1s linear infinite;
        }

        @keyframes spinningButton {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .center-icon {
            font-size: 1.1rem;
            color: white;
            display: block;
            font-weight: 800;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
        }

        /* Упрощенная стрелка */
        .arrow-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 30;
            animation: arrowBounce 1.5s ease-in-out infinite;
        }

        @keyframes arrowBounce {
            0%, 100% { 
                transform: translateX(-50%) translateY(0);
            }
            50% { 
                transform: translateX(-50%) translateY(-6px);
            }
        }

        .arrow {
            width: 0;
            height: 0;
            border-left: 18px solid transparent;
            border-right: 18px solid transparent;
            border-top: 28px solid white;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
            position: relative;
        }

        @media (max-width: 480px) {
            .arrow-pointer {
                top: -16px;
            }
            .arrow {
                border-left: 15px solid transparent;
                border-right: 15px solid transparent;
                border-top: 24px solid white;
            }
        }

        .info-section {
            flex: 1;
            max-width: 520px;
            width: 100%;
            position: relative;
        }

        /* Компактная карточка инструкций */
        .instructions-card {
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            .instructions-card {
                padding: 30px;
            }
        }

        .instructions-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(245, 158, 11, 0.08), transparent);
            animation: cardShimmer 3s infinite;
        }

        @keyframes cardShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .instructions-title {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 18px;
            position: relative;
        }

        @media (max-width: 480px) {
            .instructions-title {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }
        }

        .instructions-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .instruction-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 12px;
            transition: all 0.2s ease;
            background: rgba(245, 158, 11, 0.06);
        }

        @media (max-width: 480px) {
            .instruction-step {
                padding: 8px;
                margin-bottom: 10px;
                gap: 10px;
            }
        }

        .instruction-step:hover {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.12), rgba(217, 119, 6, 0.12));
            transform: translateX(5px);
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.95rem;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        @media (max-width: 480px) {
            .step-number {
                width: 28px;
                height: 28px;
                font-size: 0.85rem;
            }
        }

        .step-text {
            color: #2d3748;
            font-size: 0.95rem;
            line-height: 1.5;
            padding-top: 0.25rem;
            font-weight: 500;
        }

        @media (max-width: 480px) {
            .step-text {
                font-size: 0.9rem;
            }
        }

        /* Карточка результата */
        .result-card {
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.5);
            display: none;
            position: relative;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            .result-card {
                padding: 35px;
            }
        }

        .result-card::before {
            content: '🎉';
            position: absolute;
            font-size: 80px;
            opacity: 0.08;
            top: -15px;
            right: -15px;
            animation: rotate 10s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-card.show {
            display: block;
            animation: resultPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes resultPop {
            0% {
                transform: scale(0.7);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .congratulations {
            font-size: 2rem;
            font-weight: 900;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            position: relative;
        }

        @media (max-width: 480px) {
            .congratulations {
                font-size: 1.6rem;
            }
        }

        .you-won {
            font-size: 1.1rem;
            color: #4a5568;
            margin-bottom: 1.2rem;
            font-weight: 600;
        }

        @media (max-width: 480px) {
            .you-won {
                font-size: 1rem;
            }
        }

        .prize-display {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            font-size: 1.6rem;
            font-weight: 900;
            padding: 12px 30px;
            border-radius: 50px;
            margin-bottom: 1.2rem;
            display: inline-block;
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }

        @media (max-width: 480px) {
            .prize-display {
                font-size: 1.4rem;
                padding: 10px 25px;
            }
        }

        .code-text {
            font-size: 1rem;
            margin-bottom: 1.5rem;
            color: #4a5568;
            font-weight: 500;
        }

        .discount-code {
            font-family: 'Courier New', monospace;
            font-weight: 900;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1));
            color: #f59e0b;
            padding: 8px 16px;
            border-radius: 10px;
            border: 2px solid rgba(245, 158, 11, 0.4);
            font-size: 1.2rem;
            letter-spacing: 2px;
        }

        @media (max-width: 480px) {
            .discount-code {
                font-size: 1.1rem;
                padding: 7px 14px;
            }
        }

        .book-now-button {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 50px;
            font-size: 1.05rem;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            overflow: hidden;
        }

        @media (max-width: 480px) {
            .book-now-button {
                padding: 12px 25px;
                font-size: 1rem;
            }
        }

        .book-now-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .book-now-button:hover::before {
            left: 100%;
        }

        .book-now-button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 12px 30px rgba(245, 158, 11, 0.5);
        }

        .book-now-button:active {
            transform: translateY(0) scale(1);
        }

        /* SVG Icon sizing */
        .wheel-container svg {
            width: 30px;
            height: 30px;
        }

        @media (max-width: 480px) {
            .wheel-container svg {
                width: 24px;
                height: 24px;
            }
        }

        /* Scrollbar styling */
        .spinning-wheel-container::-webkit-scrollbar {
            width: 6px;
        }

        .spinning-wheel-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .spinning-wheel-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        .spinning-wheel-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <div class="spinning-wheel-container">
        <div class="wheel-content">
            <div class="wheel-section">
                <div class="wheel-container">
                    <div class="wheel-glow">
                        <div class="wheel-border">
                            <div class="wheel" id="wheel"></div>
                            <button class="center-button" id="centerButton">
                                <span class="center-icon">START</span>
                            </button>
                        </div>
                    </div>
                    <div class="arrow-pointer">
                        <div class="arrow"></div>
                    </div>
                </div>
            </div>

            <div class="info-section">
                <div class="instructions-card" id="instructionsCard">
                    <h3 class="instructions-title" id="howToPlayTitle">How to Play</h3>
                    <ul class="instructions-list">
                        <li class="instruction-step">
                            <span class="step-number">1</span>
                            <span class="step-text" id="step1Text">Press the button in the center of the wheel</span>
                        </li>
                        <li class="instruction-step">
                            <span class="step-number">2</span>
                            <span class="step-text" id="step2Text">Watch the wheel spin and stop on your prize</span>
                        </li>
                        <li class="instruction-step">
                            <span class="step-number">3</span>
                            <span class="step-text" id="step3Text">Copy your discount code</span>
                        </li>
                        <li class="instruction-step">
                            <span class="step-number">4</span>
                            <span class="step-text" id="step4Text">Use it when you make your next reservation</span>
                        </li>
                    </ul>
                </div>

                <div class="result-card" id="resultCard">
                    <h3 class="congratulations" id="congratulationsText">CONGRATULATIONS!</h3>
                    <p class="you-won" id="youWonText">You won</p>
                    <div class="prize-display" id="prizeDisplay">0% OFF</div>
                    <p class="code-text"><span id="useCodeText" style="line-height: 2.5;">Use code:</span> <span class="discount-code" id="discountCode"></span></p>
                    <button class="book-now-button" id="bookNowButton">Book Now & Apply Bonus</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentLanguage = 'en';
        let translations = {};

        async function loadLanguage() {
            if (window.parent && window.parent.PREVENT_DUPLICATE_I18NEXT && window.parent.i18next && window.parent.i18next.isInitialized) {
                currentLanguage = window.parent.i18next.language || 'en';
                translations = window.parent.i18next.getResourceBundle(currentLanguage, 'translation') || {};
                updateTexts();
                return;
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const langParam = urlParams.get('lang');
            const storedLang = localStorage.getItem('lang');
            
            let parentLang = null;
            try {
                if (window.parent && window.parent !== window) {
                    if (window.parent.i18next && window.parent.i18next.language && typeof window.parent.i18next.language === 'string') {
                        parentLang = window.parent.i18next.language;
                    }
                    if (!parentLang) {
                        parentLang = window.parent.localStorage.getItem('lang');
                    }
                }
            } catch (e) {}

            let lang = langParam || parentLang || storedLang || 'en';
            
            if (!lang || typeof lang !== 'string') {
                lang = 'en';
            }
            
            const supportedLangs = ['en', 'ro', 'ru'];
            if (!supportedLangs.includes(lang)) {
                lang = 'en';
            }
            
            currentLanguage = lang;

            try {
                const response = await fetch(`js/locales/${lang}.json`);
                if (response.ok) {
                    translations = await response.json();
                    updateTexts();
                } else {
                    const enResponse = await fetch('js/locales/en.json');
                    if (enResponse.ok) {
                        translations = await enResponse.json();
                        updateTexts();
                    } else {
                        translations = {
                            wheel: {
                                how_to_play: "How to Play",
                                step1: "Press the button in the center of the wheel",
                                step2: "Watch the wheel spin and stop on your prize",
                                step3: "Copy your discount code",
                                step4: "Use it when you make your next reservation",
                                congratulations: "CONGRATULATIONS!",
                                you_won: "You won",
                                free_days: "FREE DAYS",
                                use_code: "Use code:",
                                book_now: "Book Now & Apply Bonus"
                            }
                        };
                        updateTexts();
                    }
                }
            } catch (error) {
                translations = {
                    wheel: {
                        how_to_play: "How to Play",
                        step1: "Press the button in the center of the wheel",
                        step2: "Watch the wheel spin and stop on your prize",
                        step3: "Copy your discount code",
                        step4: "Use it when you make your next reservation",
                        congratulations: "CONGRATULATIONS!",
                        you_won: "You won",
                        free_days: "FREE DAYS",
                        use_code: "Use code:",
                        book_now: "Book Now & Apply Bonus"
                    }
                };
                updateTexts();
            }
        }

        function updateTexts() {
            const wheel = translations.wheel || {};
            
            document.getElementById('howToPlayTitle').textContent = wheel.how_to_play || "How to Play";
            document.getElementById('step1Text').textContent = wheel.step1 || "Press the button in the center of the wheel";
            document.getElementById('step2Text').textContent = wheel.step2 || "Watch the wheel spin and stop on your prize";
            document.getElementById('step3Text').textContent = wheel.step3 || "Copy your discount code";
            document.getElementById('step4Text').textContent = wheel.step4 || "Use it when you make your next reservation";
            
            document.getElementById('congratulationsText').textContent = wheel.congratulations || "CONGRATULATIONS! 🎉";
            document.getElementById('youWonText').textContent = wheel.you_won || "You won";
            document.getElementById('useCodeText').textContent = wheel.use_code || "Use code:";
            document.getElementById('bookNowButton').textContent = wheel.book_now || "Book Now & Apply Bonus";

            const centerIcon = document.querySelector('.center-icon');
            if (centerIcon) {
                centerIcon.textContent = wheel.start || "START";
            }
            
            if (availableCoupons.length > 0) {
                createWheelSegments();
            }
        }

        let availableCoupons = [];
        let currentWinningCoupon = null;
        let cachedWheelSegments = null;
        let randomWinningIndex = null;
        let userPhoneNumber = null;

        function getPhoneNumberFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('phone');
        }

        function getWheelIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('wheel');
        }

        function showLoadingState() {
            const wheel = document.getElementById('wheel');
            const centerButton = document.getElementById('centerButton');
            
            if (wheel) {
                wheel.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #f59e0b; font-size: 16px;">
                        <div style="margin-bottom: 10px;">
                            <svg width="40" height="40" viewBox="0 0 40 40" style="animation: spin 1s linear infinite;">
                                <circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="4" fill="none" stroke-dasharray="30 100" stroke-dashoffset="0"/>
                            </svg>
                        </div>
                        <div style="font-weight: 600;">Loading wheel...</div>
                    </div>
                `;
            }
            
            if (centerButton) {
                centerButton.disabled = true;
                centerButton.querySelector('.center-icon').textContent = '⏳';
            }
        }

        function hideLoadingState() {
            const centerButton = document.getElementById('centerButton');
            if (centerButton) {
                centerButton.disabled = false;
                const centerIcon = centerButton.querySelector('.center-icon');
                if (centerIcon) {
                    const wheelTranslations = translations.wheel || {};
                    centerIcon.textContent = wheelTranslations.start || 'START';
                }
            }
        }

        async function fetchCoupons() {
            try {
                showLoadingState();
                
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Request timeout')), 10000)
                );
                
                if (!window.API_BASE_URL) {
                    window.API_BASE_URL = '';
                }
                
                const apiUrl = window.API_BASE_URL;
                const wheelId = getWheelIdFromURL();
                
                const endpoint = wheelId && wheelId !== 'active' 
                    ? `${apiUrl}/api/spinning-wheels/${wheelId}/secure-data`
                    : `${apiUrl}/api/spinning-wheels/secure/active-data`;
                
                const response = await Promise.race([
                    fetch(endpoint),
                    timeoutPromise
                ]);
                
                if (!response.ok) {
                    availableCoupons = [];
                    cachedWheelSegments = null;
                    hideLoadingState();
                    return;
                }
                
                const wheelData = await response.json();
                
                if (!wheelData.segments || wheelData.segments.length === 0) {
                    availableCoupons = [];
                    cachedWheelSegments = null;
                    hideLoadingState();
                    return;
                }
                
                availableCoupons = wheelData.segments.map(segment => ({
                    id: segment.coupon_id,
                    type: segment.type,
                    discount_percentage: segment.type === 'percentage' ? segment.value : null,
                    free_days: segment.type === 'free_days' ? segment.value : null,
                    code: segment.code
                }));

                cachedWheelSegments = null;
                hideLoadingState();
                
            } catch (error) {
                availableCoupons = [];
                cachedWheelSegments = null;
                hideLoadingState();
            }
        }

        // Градиент цветов от серого к красному (по ИНДЕКСУ, а не по значению)
        function getSegmentColorByIndex(index, totalSegments) {
            const colorPalette = [
                'linear-gradient(135deg, #9ca3af 0%, #6b7280 100%)',      // Серый
                'linear-gradient(135deg, #a8a29e 0%, #78716c 100%)',      // Тепло-серый
                'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)',      // Желтый
                'linear-gradient(135deg, #fb923c 0%, #f97316 100%)',      // Оранжевый
                'linear-gradient(135deg, #fb7185 0%, #f43f5e 100%)',      // Розово-красный
                'linear-gradient(135deg, #f87171 0%, #ef4444 100%)',      // Красный
                'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)'       // Темно-красный
            ];
            
            // Если сегментов меньше или равно количеству цветов, берем по порядку
            if (totalSegments <= colorPalette.length) {
                return colorPalette[index];
            }
            
            // Если сегментов больше, распределяем цвета равномерно
            const colorIndex = Math.floor((index / totalSegments) * colorPalette.length);
            return colorPalette[Math.min(colorIndex, colorPalette.length - 1)];
        }

        function getWheelSegments() {
            if (availableCoupons.length === 0) {
                cachedWheelSegments = [
                    { id: 1, text: '5%', gradient: 'linear-gradient(135deg, #9ca3af 0%, #6b7280 100%)', coupon: null },
                    { id: 2, text: '10%', gradient: 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)', coupon: null },
                    { id: 3, text: '15%', gradient: 'linear-gradient(135deg, #fb923c 0%, #f97316 100%)', coupon: null },
                    { id: 4, text: '20%', gradient: 'linear-gradient(135deg, #f87171 0%, #ef4444 100%)', coupon: null }
                ];
                return cachedWheelSegments;
            }

            const segments = [];
            const totalSegments = availableCoupons.length;
            
            availableCoupons.forEach((coupon, arrayIndex) => {
                const visualPosition = arrayIndex;
                
                // Получаем цвет по индексу (порядковому номеру)
                const gradient = getSegmentColorByIndex(arrayIndex, totalSegments);
                
                let segmentText;
                if (coupon.type === 'percentage') {
                    segmentText = `${coupon.discount_percentage}%`;
                } else if (coupon.type === 'free_days') {
                    const wheelTranslations = translations.wheel?.wheel_segments || {};
                    if (coupon.free_days === 1 && wheelTranslations['1_day']) {
                        segmentText = wheelTranslations['1_day'];
                    } else if (coupon.free_days === 2 && wheelTranslations['2_days']) {
                        segmentText = wheelTranslations['2_days'];
                    } else if (coupon.free_days === 3 && wheelTranslations['3_days']) {
                        segmentText = wheelTranslations['3_days'];
                    } else if (coupon.free_days === 4 && wheelTranslations['4_days']) {
                        segmentText = wheelTranslations['4_days'];
                    } else if (coupon.free_days === 6 && wheelTranslations['6_days']) {
                        segmentText = wheelTranslations['6_days'];
                    } else {
                        segmentText = `${coupon.free_days} ${coupon.free_days === 1 ? 'DAY' : 'DAYS'}`;
                    }
                } else {
                    segmentText = `${coupon.discount_percentage}%`;
                }
                
                segments.push({
                    id: arrayIndex + 1,
                    visualPosition: visualPosition,
                    text: segmentText,
                    gradient: gradient,
                    coupon: coupon
                });
            });

            cachedWheelSegments = segments;
            return cachedWheelSegments;
        }

        let isSpinning = false;
        let hasSpun = false;
        let currentRotation = 0;

        const wheel = document.getElementById('wheel');
        const centerButton = document.getElementById('centerButton');
        const instructionsCard = document.getElementById('instructionsCard');
        const resultCard = document.getElementById('resultCard');
        const prizeDisplay = document.getElementById('prizeDisplay');
        const discountCode = document.getElementById('discountCode');

        function createWheelSegments() {
            const fragment = document.createDocumentFragment();
            const wheelSegments = getWheelSegments();
            const segmentAngle = 360 / wheelSegments.length;

            wheelSegments.forEach((segment, index) => {
                const segmentElement = document.createElement('div');
                segmentElement.className = 'wheel-segment';
                segmentElement.id = `segment-${segment.id}`;
                segmentElement.style.background = segment.gradient;
                
                const startAngle = segment.visualPosition * segmentAngle;
                const endAngle = (segment.visualPosition + 1) * segmentAngle;
                const clipPath = generateClipPath(startAngle, endAngle);
                segmentElement.style.clipPath = clipPath;

                const visualStartAngle = segment.visualPosition * segmentAngle;
                const visualEndAngle = (segment.visualPosition + 1) * segmentAngle;
                const middleAngle = (visualStartAngle + visualEndAngle) / 2;
                const middleRad = (middleAngle - 90) * Math.PI / 180;
                const textRadius = 35;
                const textX = 50 + textRadius * Math.cos(middleRad);
                const textY = 50 + textRadius * Math.sin(middleRad);
                const textRotation = middleAngle;
                
                segmentElement.innerHTML = `
                    <div class="segment-content" style="position: absolute; left: ${textX}%; top: ${textY}%; transform: translate(-50%, -50%) rotate(${textRotation}deg);">
                        <div class="segment-icon" style="margin-bottom: 8px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 500 500" fill="none">
                                <path d="M437.5 208.334L437.5 223.959C446.129 223.959 453.125 216.963 453.125 208.334H437.5ZM395.833 250L380.208 249.999V250H395.833ZM437.5 291.667H453.125C453.125 283.037 446.129 276.042 437.5 276.042L437.5 291.667ZM62.5 291.667V276.042C53.8706 276.042 46.875 283.037 46.875 291.667H62.5ZM104.167 250L119.792 250L119.792 249.999L104.167 250ZM63.5752 208.347L63.9708 192.727C63.9052 192.726 63.8395 192.724 63.7739 192.724L63.5752 208.347ZM62.5 208.334H46.875C46.875 216.886 53.7501 223.849 62.3013 223.957L62.5 208.334ZM395.833 104.167V119.792C410.215 119.792 421.875 131.451 421.875 145.834H437.5H453.125C453.125 114.192 427.474 88.5416 395.833 88.5416V104.167ZM437.5 145.834H421.875V208.334H437.5H453.125V145.834H437.5ZM437.5 208.334L437.5 192.709C405.859 192.709 380.208 218.358 380.208 249.999L395.833 250L411.458 250C411.458 235.618 423.117 223.959 437.5 223.959L437.5 208.334ZM395.833 250H380.208C380.208 281.641 405.859 307.292 437.5 307.292L437.5 291.667L437.5 276.042C423.118 276.042 411.458 264.382 411.458 250H395.833ZM437.5 291.667H421.875V354.167H437.5H453.125V291.667H437.5ZM437.5 354.167H421.875C421.875 368.549 410.215 380.209 395.833 380.209V395.834V411.459C427.474 411.459 453.125 385.808 453.125 354.167H437.5ZM395.833 395.834V380.209H104.167V395.834V411.459H395.833V395.834ZM104.167 395.834V380.209C89.7846 380.209 78.125 368.549 78.125 354.167H62.5H46.875C46.875 385.808 72.5257 411.459 104.167 411.459V395.834ZM62.5 354.167H78.125V291.667H62.5H46.875V354.167H62.5ZM62.5 291.667V307.292C94.1413 307.292 119.792 281.641 119.792 250H104.167H88.542C88.542 264.382 76.8824 276.042 62.5 276.042V291.667ZM104.167 250L119.792 249.999C119.792 218.85 94.9363 193.512 63.9708 192.727L63.5752 208.347L63.1795 223.967C77.2438 224.324 88.5419 235.845 88.542 250L104.167 250ZM63.5752 208.347L63.7739 192.724L62.6987 192.71L62.5 208.334L62.3013 223.957L63.3765 223.971L63.5752 208.347ZM62.5 208.334H78.125V145.834H62.5H46.875V208.334H62.5ZM62.5 145.834H78.125C78.125 131.451 89.7846 119.792 104.167 119.792V104.167V88.5416C72.5257 88.5416 46.875 114.192 46.875 145.834H62.5ZM104.167 104.167V119.792H395.833V104.167V88.5416H104.167V104.167Z" fill="white"/>
                                <path d="M312.5 104.167V145.833" stroke="white" stroke-width="41.6667" stroke-linecap="round"/>
                                <path d="M312.5 229.167V270.833" stroke="white" stroke-width="31.25" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M312.5 354.167V395.833" stroke="white" stroke-width="31.25" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="segment-text">${segment.text}</div>
                    </div>
                `;

                fragment.appendChild(segmentElement);
            });
            
            wheel.innerHTML = '';
            wheel.appendChild(fragment);
            addSegmentBorders(wheelSegments.length);
        }

        function generateClipPath(startAngle, endAngle) {
            const centerX = 50;
            const centerY = 50;
            const radius = 50;
            
            const startRad = (startAngle - 90) * Math.PI / 180;
            const endRad = (endAngle - 90) * Math.PI / 180;
            
            const startX = centerX + radius * Math.cos(startRad);
            const startY = centerY + radius * Math.sin(startRad);
            const endX = centerX + radius * Math.cos(endRad);
            const endY = centerY + radius * Math.sin(endRad);
            
            const points = [];
            points.push(`${centerX}% ${centerY}%`);
            points.push(`${startX}% ${startY}%`);
            
            const numPoints = 10;
            for (let i = 1; i <= numPoints; i++) {
                const angle = startAngle + (endAngle - startAngle) * (i / numPoints);
                const rad = (angle - 90) * Math.PI / 180;
                const x = centerX + radius * Math.cos(rad);
                const y = centerY + radius * Math.sin(rad);
                points.push(`${x}% ${y}%`);
            }
            
            points.push(`${endX}% ${endY}%`);
            return `polygon(${points.join(', ')})`;
        }

        function addSegmentBorders(numSegments) {
            const segmentAngle = 360 / numSegments;
            
            for (let i = 0; i < numSegments; i++) {
                const borderElement = document.createElement('div');
                borderElement.className = 'segment-border';
                borderElement.style.position = 'absolute';
                borderElement.style.top = '50%';
                borderElement.style.left = '50%';
                borderElement.style.width = '2px';
                borderElement.style.height = '50%';
                borderElement.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                borderElement.style.transformOrigin = 'bottom center';
                borderElement.style.transform = `translate(-50%, -100%) rotate(${i * segmentAngle}deg)`;
                borderElement.style.zIndex = '15';
                borderElement.style.pointerEvents = 'none';
                
                wheel.appendChild(borderElement);
            }
        }

        async function getRandomWinningIndex() {
            try {
                const wheelId = getWheelIdFromURL();
                const endpoint = wheelId && wheelId !== 'active' 
                    ? `${window.API_BASE_URL}/api/spinning-wheels/${wheelId}/secure/random-winning-index`
                    : `${window.API_BASE_URL}/api/spinning-wheels/secure/random-winning-index`;
                
                const response = await fetch(endpoint);
                if (response.ok) {
                    const data = await response.json();
                    return data.winningIndex;
                } else {
                    return Math.floor(Math.random() * availableCoupons.length);
                }
            } catch (error) {
                return Math.floor(Math.random() * availableCoupons.length);
            }
        }

        async function redeemCouponSecurely(couponId, phoneNumber) {
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/spinning-wheels/secure/redeem-coupon`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        couponId: couponId,
                        phoneNumber: phoneNumber
                    })
                });
                
                if (!response.ok) {
                    discountCode.textContent = 'ERROR';
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    discountCode.textContent = result.code;
                    localStorage.setItem('spinningWheelWinningCoupon', result.code);
                    localStorage.setItem('spinningWheelRewardReceived', 'true');
                } else {
                    discountCode.textContent = 'ERROR';
                }
            } catch (error) {
                discountCode.textContent = 'ERROR';
            }
        }

        async function spinWheel() {
            if (isSpinning || hasSpun) return;

            if (!userPhoneNumber) {
                const phoneEntered = localStorage.getItem('spinningWheelPhoneEntered');
                const storedPhone = localStorage.getItem('spinningWheelPhone');
                
                if (phoneEntered === 'true' && storedPhone) {
                    userPhoneNumber = storedPhone;
                } else {
                    alert('Please provide a phone number to spin the wheel');
                    return;
                }
            }

            isSpinning = true;
            centerButton.disabled = true;
            centerButton.querySelector('.center-icon').textContent = '🔄';

            randomWinningIndex = await getRandomWinningIndex();
            
            wheel.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)';

            const wheelSegments = getWheelSegments();
            const segmentAngle = 360 / wheelSegments.length;
            const targetSegmentIndex = randomWinningIndex % wheelSegments.length;
            const winningSegment = wheelSegments[targetSegmentIndex];
            const targetVisualPosition = winningSegment.visualPosition;
            
            const numSegments = wheelSegments.length;
            const adjustedVisualPosition = (numSegments - 1 - targetVisualPosition) % numSegments;
            const targetAngle = (adjustedVisualPosition * segmentAngle + segmentAngle / 2) % 360;
            const extraRotations = 5 * 360;
            const totalRotation = extraRotations + targetAngle;

            wheel.style.transform = `rotate(${totalRotation}deg)`;

            setTimeout(() => {
                const winningSegment = wheelSegments[targetSegmentIndex];
                currentRotation = totalRotation;
                isSpinning = false;
                hasSpun = true;
                centerButton.disabled = false;
                const centerIcon = centerButton.querySelector('.center-icon');
                if (centerIcon) {
                    const wheelTranslations = translations.wheel || {};
                    centerIcon.textContent = wheelTranslations.start || 'START';
                }

                currentWinningCoupon = winningSegment.coupon;
                
                if (winningSegment.coupon) {
                    if (winningSegment.coupon.type === 'percentage') {
                        prizeDisplay.textContent = `${winningSegment.coupon.discount_percentage}% OFF`;
                    } else if (winningSegment.coupon.type === 'free_days') {
                        const wheelTranslations = translations.wheel?.wheel_segments || {};
                        const freeDaysText = translations.wheel?.free_days || 'FREE DAYS';
                        
                        if (winningSegment.coupon.free_days === 1 && wheelTranslations['1_day']) {
                            prizeDisplay.textContent = `${wheelTranslations['1_day']}`;
                        } else if (winningSegment.coupon.free_days === 2 && wheelTranslations['2_days']) {
                            prizeDisplay.textContent = `${wheelTranslations['2_days']}`;
                        } else if (winningSegment.coupon.free_days === 3 && wheelTranslations['3_days']) {
                            prizeDisplay.textContent = `${wheelTranslations['3_days']}`;
                        } else if (winningSegment.coupon.free_days === 4 && wheelTranslations['4_days']) {
                            prizeDisplay.textContent = `${wheelTranslations['4_days']}`;
                        } else if (winningSegment.coupon.free_days === 6 && wheelTranslations['6_days']) {
                            prizeDisplay.textContent = `${wheelTranslations['6_days']}`;
                        } else {
                            prizeDisplay.textContent = `${winningSegment.coupon.free_days} ${winningSegment.coupon.free_days === 1 ? 'FREE DAY' : 'FREE DAYS'}`;
                        }
                    } else {
                        prizeDisplay.textContent = `${winningSegment.text} OFF`;
                    }
                    
                    redeemCouponSecurely(winningSegment.coupon.id, userPhoneNumber);
                } else {
                    prizeDisplay.textContent = `${winningSegment.text} OFF`;
                    discountCode.textContent = 'ERROR';
                }

                instructionsCard.style.display = 'none';
                resultCard.classList.add('show');
            }, 4000);
        }

        centerButton.addEventListener('click', spinWheel);
        
        const bookNowButton = document.getElementById('bookNowButton');
        if (bookNowButton) {
            bookNowButton.addEventListener('click', function() {
                const actualCouponCode = document.getElementById('discountCode').textContent;
                if (actualCouponCode && actualCouponCode !== 'ERROR') {
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'autoApplyCoupon',
                            couponCode: actualCouponCode
                        }, '*');
                    }
                }
                
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'closeSpinningWheel'
                    }, '*');
                } else {
                    window.close();
                }
            });
        }

        loadLanguage().then(async () => {
            userPhoneNumber = getPhoneNumberFromURL();
            
            if (!userPhoneNumber) {
                const phoneEntered = localStorage.getItem('spinningWheelPhoneEntered');
                const storedPhone = localStorage.getItem('spinningWheelPhone');
                
                if (phoneEntered === 'true' && storedPhone) {
                    userPhoneNumber = storedPhone;
                }
            }

            await fetchCoupons();
            createWheelSegments();
            wheel.style.transition = 'transform 4s cubic-bezier(0.23, 1, 0.32, 1)';
            wheel.style.transform = 'rotate(0deg)';
            wheel.offsetHeight;
            setTimeout(() => {
                wheel.style.transition = 'none';
                wheel.style.transform = 'rotate(0deg)';
                setTimeout(() => {
                    wheel.style.transition = 'transform 4s cubic-bezier(0.23, 1, 0.32, 1)';
                }, 10);
            }, 100);
        });

        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'languageChange') {
                currentLanguage = event.data.language;
                loadLanguage();
            }
            
            if (event.data && event.data.type === 'phoneNumberEntered') {
                userPhoneNumber = event.data.phoneNumber;
                localStorage.setItem('spinningWheelPhone', userPhoneNumber);
                localStorage.setItem('spinningWheelPhoneEntered', 'true');
            }
        });

        window.addEventListener('storage', function(event) {
            if (event.key === 'lang') {
                currentLanguage = event.newValue;
                loadLanguage();
            }
        });

        window.addEventListener('load', function() {
            setTimeout(() => {
                try {
                    if (window.parent && window.parent !== window) {
                        if (window.parent.i18next && window.parent.i18next.language && typeof window.parent.i18next.language === 'string') {
                            currentLanguage = window.parent.i18next.language;
                            loadLanguage();
                        }
                        else if (window.parent.localStorage.getItem('lang')) {
                            currentLanguage = window.parent.localStorage.getItem('lang');
                            loadLanguage();
                        }
                    }
                } catch (e) {}
            }, 500);
        });
    </script>
</body>
</html>
