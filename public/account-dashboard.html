<!DOCTYPE html>
<html lang="zxx">

<head>
    <title>Admin Panel - Car Management</title>
    <link rel="icon" href="images/icon.png" type="image/gif" sizes="16x16">
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="PlusRent - Multipurpose Vehicle Car Rental Website Template" name="description">
    <meta content="" name="keywords">
    <meta content="" name="author">
    <!-- CSS Files
    ================================================== -->
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css" id="bootstrap">
    <link href="css/mdb.min.css" rel="stylesheet" type="text/css" id="mdb">
    <link href="css/plugins.css" rel="stylesheet" type="text/css">
    <link href="css/style.css" rel="stylesheet" type="text/css">
    <link href="css/coloring.css" rel="stylesheet" type="text/css">
    <!-- color scheme -->
    <link id="colors" href="css/colors/scheme-01.css" rel="stylesheet" type="text/css">
    <style>
      /* Autocomplete styles */
      .autocomplete-container {
        position: relative;
        display: inline-block;
        width: 100%;
      }
      
      .autocomplete-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      
      .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
      }
      
      .autocomplete-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
      }
      
      .autocomplete-item:hover {
        background-color: #f5f5f5;
      }
      
      .autocomplete-item.selected {
        background-color: #007bff;
        color: white;
      }
      
      .autocomplete-highlight {
        background-color: #ffeb3b;
        font-weight: bold;
        padding: 1px 2px;
      }
      
      .autocomplete-input.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
      }
      
      .autocomplete-input.is-valid {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
      }
      
      /* Override MDB button styles to use gray instead of purple */
      .btn-secondary {
        color: #fff !important;
        background-color: #6c757d !important;
        border-color: #6c757d !important;
      }
      
      .btn-secondary:hover {
        color: #fff !important;
        background-color: #5a6268 !important;
        border-color: #545b62 !important;
      }
      
      .btn-secondary:focus {
        box-shadow: 0 0 0 0.25rem rgba(108, 117, 125, 0.5) !important;
      }
      
      .btn-outline-secondary {
        color: #6c757d !important;
        border-color: #6c757d !important;
      }
      
      .btn-outline-secondary:hover {
        color: #fff !important;
        background-color: #6c757d !important;
        border-color: #6c757d !important;
      }
      
      .btn-outline-secondary:focus {
        box-shadow: 0 0 0 0.25rem rgba(108, 117, 125, 0.5) !important;
      }
      
      .btn-outline-secondary:active,
      .btn-outline-secondary.active {
        color: #fff !important;
        background-color: #6c757d !important;
        border-color: #6c757d !important;
      }
      
      /* Ensure wheel configuration buttons are clickable */
      .wheel-coupon-button {
        cursor: pointer !important;
        pointer-events: auto !important;
        user-select: none;
      }
      
      .wheel-coupon-button:disabled {
        cursor: not-allowed !important;
        opacity: 0.6;
      }
      
  .admin-main-container {
    max-width: 1400px;
    margin: 0 auto;
    padding-left: 32px;
    padding-right: 32px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .admin-header {
    text-align: center;
    margin-top: 2rem;
    margin-bottom: 1.2rem;
  }
  .admin-flex-row {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 20px;
    justify-content: flex-start;
    width: 100%;
  }
  .admin-btn-col {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    margin-top: 0.5rem;
    margin-right: 0;
  }
  .admin-form-col {
    width: 100%;
    position: relative;
  }
  .admin-form-panel {
    display: none;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%) scale(0.98);
    width: 90%;
    max-width: 1200px;
    min-width: 320px;
    max-height: 90vh;
    overflow-y: auto;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.18);
    padding: 1.4rem 1.8rem 1.4rem 1.8rem;
    transition: transform 0.4s cubic-bezier(.4,0,.2,1), opacity 0.4s cubic-bezier(.4,0,.2,1);
    opacity: 0;
    z-index: 10000;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch;
  }
  .admin-form-panel.active {
    display: block;
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
  /* Prevent body scroll when popup is open */
  html.admin-popup-open, body.admin-popup-open {
    overflow: hidden !important;
    height: 100%;
    touch-action: none;
    overscroll-behavior: contain;
  }
  .admin-form-panel .btn-fullwidth {
    width: auto;
    /* min-width: 160px; */
    display: block;
    margin: 0 auto;
  }
  /* .admin-form-panel .btn {
    display: block;
    margin: 0 auto;
    min-width: 160px;
    width: auto;
  } */
  .admin-form-panel .btn-fullwidth {
    width: auto;
    min-width: 160px;
    display: block;
    margin: 0 auto;
  }
  .admin-form-panel .btn-main {
    font-size: 1.1rem;
    padding: 0.7rem 2.2rem;
    height: 44px;
    border-radius: 6px;
  }
  .admin-form-panel .close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #888;
    cursor: pointer;
  }
  .admin-form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
  }
  
  /* Enhanced styling for wheel items */
  .wheel-item:hover {
    background-color: #f8f9fa;
    transform: translateX(2px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .wheel-item.active {
    background-color: #e3f2fd;
    border-left-color: #2196f3 !important;
  }
  
  /* Card enhancements */
  .card.shadow-sm {
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
  }
  
  .card-header {
    border-bottom: 1px solid rgba(0,0,0,0.125);
  }
  
  /* Button enhancements */
  .btn {
    border-radius: 6px;
    font-weight: 500;
  }
  
  .btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
  }
  
  /* List group enhancements */
  .list-group-item {
    border: 1px solid rgba(0,0,0,0.125);
    border-left: 4px solid transparent;
    transition: all 0.2s ease;
  }
  
  .list-group-item:first-child {
    border-top-left-radius: 0.375rem;
    border-top-right-radius: 0.375rem;
  }
  
  .list-group-item:last-child {
    border-bottom-left-radius: 0.375rem;
    border-bottom-right-radius: 0.375rem;
  }
  
  /* Form enhancements */
  .form-control {
    border-radius: 6px;
    border: 1px solid #ced4da;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  }
  
  .form-control:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }
  
  /* Badge enhancements */
  .badge {
    font-size: 0.75em;
    font-weight: 500;
  }
  
  /* Icon spacing */
  .fa {
    margin-right: 0.25rem;
  }
  .admin-form-grid .five-column-grid {
    grid-column: 1 / -1;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
  }
  .admin-form-grid > div {
    min-width: 0;
  }
  .admin-form-panel input,
  .admin-form-panel select {
    background: #fff !important;
    height: 36px !important;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    font-size: 0.75rem;
    width: 100%;
    padding: 0 8px;
    box-sizing: border-box;
  }
  .admin-form-panel input[type="number"] {
    height: 36px !important;
  }
  .admin-form-panel .form-label {
    font-size: 0.75rem;
    font-weight: 500;
    margin-bottom: 0 !important;
    color: #333;
  }
  .admin-form-panel .form-text,
  .admin-form-panel small.form-text {
    font-size: 0.75rem !important;
    color: #666 !important;
    line-height: 1.2 !important;
    margin-top: 2px !important;
    margin-bottom: 0 !important;
    display: block !important;
  }
  .admin-form-panel .form-control {
    height: 36px !important;
    font-size: 0.75rem;
    padding: 0 8px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
  }
  .admin-form-panel input[type="date"] {
    height: 36px !important;
    font-size: 0.75rem;
    padding: 0 8px;
  }
  .admin-form-panel input:focus,
  .admin-form-panel select:focus {
    outline: 2px solid #b3c6ff;
    border-color: #b3c6ff;
  }
  .admin-form-panel fieldset {
    grid-column: 1 / -1;
  }
  .admin-form-panel .row.g-2 > div {
    min-width: 0;
  }
  .admin-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(30, 30, 30, 0.65);
    z-index: 9999;
    transition: opacity 0.3s;
  }
  .admin-overlay.active {
    display: block;
  }
  .admin-confirm-modal {
    display: none;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.18);
    padding: 1.2rem 1.5rem;
    z-index: 10001;
    min-width: 320px;
    max-width: 400px;
    text-align: center;
  }
  .admin-confirm-modal.active {
    display: block;
  }
  .admin-confirm-modal button {
    margin: 0 10px;
    min-width: 110px;
    height: 44px;
    font-size: 1rem;
    border-radius: 6px;
    font-family: inherit;
    font-weight: 500;
  }
  .admin-confirm-modal .btn-main, .admin-confirm-modal .btn-danger {
    background: #031B4E;
    color: #fff;
    border: none;
    transition: background 0.2s;
  }
  .admin-confirm-modal .btn-danger {
    background: #e74c3c;
  }
  .admin-btn-col {
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    min-width: 180px;
    margin-top: 0.5rem;
    margin-right: 0;
  }
  .admin-flex-row {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 20px;
    justify-content: flex-start;
    width: 100%;
  }
  .admin-flex-row + #carCards, .admin-flex-row + .row#carCards, .admin-flex-row + .row.g-4 {
    margin-top: 1.2rem !important;
  }
  #carCards {
    margin-top: 1.2rem !important;
  }
  /* Fix for car cards being too small after form grid change */
  #carCards.row.g-4 {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-start !important;
    align-items: stretch;
    width: 100%;
  }
  #carCards.row.g-4 > .col-md-6.col-lg-4 {
    flex: 1 1 320px;
    display: flex;
  }
  #carCards .card {
    min-width: 300px;
    width: 100%;
    margin: 0;
  }
  @media (max-width: 900px) {
    .admin-form-panel {
      width: 95vw;
      padding: 1.2rem 1rem;
      max-height: 95vh;
    }
    .admin-form-grid {
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }
    .admin-form-grid .five-column-grid {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }
  }
  @media (max-width: 600px) {
    .admin-form-panel {
      width: 98vw;
      padding: 1rem 0.8rem;
      max-height: 98vh;
    }
    .admin-form-grid {
      grid-template-columns: 1fr;
    }
    .admin-form-grid .five-column-grid {
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    }
  }
  @media (max-width: 480px) {
    .admin-form-panel {
      width: 100vw;
      padding: 0.8rem 0.6rem;
      max-height: 100vh;
      border-radius: 0;
    }
    .admin-form-grid {
      grid-template-columns: 1fr;
    }
    .admin-form-grid .five-column-grid {
      grid-template-columns: 1fr;
    }
    /* Stack image upload sections vertically on mobile */
    .admin-form-grid > div[style*="display: flex"] {
      flex-direction: column !important;
    }
    .admin-form-grid > div[style*="display: flex"] > div {
      width: 100% !important;
      margin-bottom: 16px;
    }
  }
  
  /* Override MDB button text-transform to use normal case */
  .btn {
    text-transform: none !important;
  }
  
  /* Prevent body scroll when modal is open */
  body.modal-open {
    overflow: hidden !important;
    position: fixed !important;
    width: 100% !important;
    left: 0 !important;
    right: 0 !important;
  }
  
  html.modal-open {
    overflow: hidden !important;
  }
  
  /* Prevent scrolling on modal overlay */
  .admin-overlay {
    overflow: hidden !important;
  }
  
  /* Gallery Carousel Styles */
  .admin-gallery-carousel {
    position: relative;
    max-width: 100%;
    margin-top: 8px;
  }

  .wheel-config-row {
    justify-content: space-between;
  }
  
  .admin-carousel-container {
    position: relative;
    overflow: visible; /* Allow buttons to overflow outside */
    border-radius: 8px;
    background: #f8f9fa;
  }
  
  .admin-carousel-track-wrapper {
    overflow: hidden;
    border-radius: 8px;
  }
  
  .admin-carousel-track {
    display: flex;
    transition: transform 0.3s ease;
    gap: 10px;
    padding: 10px 3px 10px 10px; /* Balanced right padding - middle ground */
  }
  
  .admin-carousel-image-item {
    position: relative;
    flex: 0 0 auto;
    padding: 0;
  }
  
  .admin-carousel-image-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: block;
  }
  
  .admin-carousel-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
    z-index: 10;
  }
  
  .admin-carousel-nav:hover {
    background: rgba(0,0,0,1);
  }
  
  .admin-carousel-nav:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }
  
  .admin-carousel-prev {
    left: -16px; /* Half of button width (32px / 2 = 16px) outside */
  }
  
  .admin-carousel-next {
    right: -16px; /* Half of button width (32px / 2 = 16px) outside */
  }
  
  .admin-carousel-counter {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
  }
  
  .admin-carousel-remove {
    position: absolute;
    top: -6px;
    right: -6px;
    background: rgb(248 67 61 / 90%);
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    font-size: 15px;
    padding-bottom: 3px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    transition: all 0.2s;
    backdrop-filter: blur(2px);
  }
  
  .admin-carousel-remove:hover {
    transform: scale(1.1);
  }
  
  /* Upload Button Styles */
  .admin-upload-area {
  position: relative;
    margin-bottom: 8px;
  }
  
  .admin-upload-button {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 60px;
    border: 2px dashed #ccc;
  border-radius: 6px;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 8px;
  }
  
  .admin-upload-button:hover {
    border-color: #007bff;
    background: #f0f8ff;
  }
  
  .admin-upload-icon {
    width: 20px;
    height: 20px;
    margin-bottom: 4px;
    margin-top: 4px;
    color: #666;
  }
  
  .admin-upload-text {
    font-size: 0.7rem;
    font-weight: 500;
    color: #333;
    text-align: center;
    margin: 0;
  }
  
  .admin-upload-subtext {
    font-size: 0.65rem;
    color: #666;
    text-align: center;
    margin: 2px 0 0 0;
  }
  
  .admin-upload-input {
    display: none;
  }
  
  .admin-image-preview {
    margin-top: 8px;
  }
  
  /* Tab Styles */
  .admin-tabs {
  display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .admin-tab-btn {
    padding: 12px 24px;
    border: 2px solid #e0e0e0;
    background: white;
    color: #666;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  
  .admin-tab-btn.active {
    border-color: #007bff;
    background: #007bff;
    color: white;
  }
  
  .admin-tab-btn:hover:not(.active) {
    border-color: #007bff;
    color: #007bff;
  }
  
  .admin-tab-content {
    display: none;
    width: 85%;
  }

  @media (max-width: 1100px) {
    .admin-tab-content {
      width: 95%;
    }
  }
  
  /* Mobile Responsive Styles */
  @media (max-width: 768px) {
    .admin-tabs {
      flex-direction: column;
      gap: 8px;
    }
    
    .admin-tab-btn {
      width: 100%;
      text-align: center;
      padding: 15px 20px;
      font-size: 16px;
      white-space: nowrap;
      min-width: fit-content;
    }
    
    .admin-tab-content {
      width: 100%;
      padding: 0 10px;
    }
    
    .admin-flex-row {
      flex-direction: column;
      gap: 20px;
    }
    
    .admin-btn-col {
      width: 100%;
      text-align: center;
    }
    
    .admin-form-col {
      width: 100%;
    }
    
    /* Fix booking cards overflow */
    .booking-card {
      margin: 0 0 15px 0;
      width: 100%;
      overflow-x: hidden;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .booking-card .card-body {
      padding: 12px;
    }
    
    /* Make booking cards more compact */
    .booking-card .card-title {
      font-size: 16px;
      margin-bottom: 8px;
    }
    
    .booking-card .card-text {
      font-size: 13px;
      margin-bottom: 6px;
    }
    
    .booking-card .badge {
      font-size: 11px;
      padding: 4px 8px;
    }
    
    .booking-card .btn {
      font-size: 12px;
      padding: 6px 12px;
      margin: 2px;
    }
    
    /* Make booking details stack vertically */
    .booking-details {
      flex-direction: column;
      gap: 10px;
    }
    
    .booking-details .col-md-6 {
      width: 100%;
    }
    
    /* Adjust button layout */
    .booking-actions {
      flex-direction: column;
      gap: 10px;
    }
    
    .booking-actions .btn {
      width: 100%;
      margin: 0;
    }
    
    /* Fix spinning wheel layout */
    .wheel-config-row {
      flex-direction: column;
      gap: 20px;
    }
    
    .wheel-config-row > div {
      width: 100% !important;
    }
    
    /* Fix coupon cards */
    .coupon-card {
      margin: 0 0 20px 0;
      width: 100%;
    }
    
    /* Fix car management layout */
    .car-management-row {
      flex-direction: column;
      gap: 20px;
    }
    
    .car-management-row > div {
      width: 100% !important;
    }
  }
  
  /* Extra small devices */
  @media (max-width: 576px) {
    .admin-tab-btn {
      padding: 12px 16px;
      font-size: 14px;
    }
    
    .booking-card .card-body {
      padding: 12px;
    }
    
    .booking-details {
      font-size: 14px;
    }
    
    .booking-details .col-md-6 {
      padding: 0;
    }
  }
  
  .admin-tab-content.active {
    display: block;
  }
  
  /* Compact layout for booking management */
  #bookings-tab .admin-flex-row {
    gap: 15px;
  }
  
  #bookings-tab .admin-btn-col {
    margin-bottom: 5px;
  }
  
  #bookings-tab .admin-btn-col h6 {
    margin-bottom: 5px;
    font-size: 14px;
  }
  
  #bookings-tab .btn-group-sm .btn {
    font-size: 11px;
    padding: 3px 6px;
  }
  
  #bookingsList {
    margin-top: 5px;
  }
  
  #bookingsList .row {
    margin: 0;
  }
  
  #bookingsList .col-md-6 {
    padding: 0 5px;
  }
  
  /* Responsive grid adjustments */
  @media (min-width: 1200px) {
    #bookingsList .row {
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }
  }
  
  @media (min-width: 1400px) {
    #bookingsList .row {
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
  }
  
  @media (max-width: 768px) {
    #bookingsList .row {
      grid-template-columns: 1fr;
    }
    
    .admin-flex-row {
      flex-direction: column;
    }
    
    .admin-btn-col {
      flex: none;
      width: 100%;
    }
  }
  
  /* Make booking cards display in a more horizontal grid */
  #bookingsList .row {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 15px;
    margin: 0;
  }
  
  #bookingsList .col-md-6 {
    width: 100%;
    padding: 0;
  }
  
  /* Make booking cards more compact */
  .booking-card {
    height: fit-content;
    margin: 0;
  }
  
  .booking-card .card-body {
    padding: 10px;
  }
  
  .booking-card .card-title {
    font-size: 14px;
    margin-bottom: 6px;
  }
  
  .booking-card .card-text {
    font-size: 12px;
    margin-bottom: 4px;
  }
  
  .booking-card .badge {
    font-size: 10px;
    padding: 3px 6px;
  }
  
  .booking-card .btn {
    font-size: 11px;
    padding: 4px 8px;
    margin: 1px;
  }

  .spinning-wheel-tab {
    width: 90%;
  }
  
  /* Coupon Card Styles */
  .coupon-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: 1px solid #e0e0e0;
  }
  
  /* Booking Card Animation Styles */
  .booking-card {
    transition: all 0.3s ease;
    transform: translateX(0);
    opacity: 1;
  }
  
  .booking-card.approving {
    background: #d4edda;
    border-color: #c3e6cb;
    transform: scale(1.02);
  }
  
  .booking-card.rejecting {
    background: #f8d7da;
    border-color: #f5c6cb;
    transform: scale(1.02);
  }
  
  .booking-card.cancelling {
    background: #fff3cd;
    border-color: #ffeaa7;
    transform: scale(1.02);
  }
  
  .booking-card.slide-out {
    transform: translateX(100%);
    opacity: 0;
  }
  
  .booking-card.fade-out {
    opacity: 0;
    transform: scale(0.95);
  }
  
  /* Button Animation Styles */
  .btn-approve, .btn-reject, .btn-cancel {
    transition: all 0.2s ease;
  }
  
  .btn-approve:active {
    transform: scale(0.95);
    background: #28a745 !important;
  }
  
  .btn-reject:active {
    transform: scale(0.95);
    background: #dc3545 !important;
  }
  
  .btn-cancel:active {
    transform: scale(0.95);
    background: #ffc107 !important;
  }
  
  /* Enhanced Rental Completed Badge */
  .rental-completed-badge {
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .rental-completed-badge::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }
  
  .rental-completed-badge:hover::before {
    left: 100%;
  }
  
  .rental-completed-badge:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(23, 162, 184, 0.4);
  }
  
  .rental-completed-badge i {
    animation: pulse-glow 2s infinite;
  }
  
  @keyframes pulse-glow {
    0%, 100% {
      opacity: 1;
      transform: scale(1);
    }
    50% {
      opacity: 0.8;
      transform: scale(1.05);
    }
  }
  
  /* Loading Animation */
  .btn-loading {
    position: relative;
    pointer-events: none;
  }
  
  .btn-loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 16px;
    height: 16px;
    margin: -8px 0 0 -8px;
    border: 2px solid transparent;
    border-top: 2px solid #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .coupon-status {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
  font-weight: 500;
  }
  
  .coupon-status.active {
    background: #d4edda;
    color: #155724;
  }
  
  .coupon-status.inactive {
    background: #f8d7da;
    color: #721c24;
  }
  
  .coupon-status.expired {
    background: #fff3cd;
    color: #856404;
}
  
  /* Percentage Field Styles */
  .percentage-field {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
    margin-top: 12px;
  }
  
  .percentage-field .form-control-sm {
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
  }
  
  .percentage-field label {
    font-weight: 500;
    color: #495057;
  }
  
  .coupon-item.enabled {
    border-left: 4px solid #28a745;
    background: #f8fff9;
  }
  
  .coupon-item.disabled {
    border-left: 4px solid #6c757d;
    opacity: 0.8;
  }
  
  /* Language switcher styles */
  .btn[data-lang].active {
    background-color: #007bff !important;
    color: white !important;
    border-color: #007bff !important;
    font-weight: 600;
  }
  
  .btn[data-lang]:not(.active) {
    background-color: white !important;
    color: #007bff !important;
    border-color: #007bff !important;
  }
  
  .btn[data-lang]:not(.active):hover {
    background-color: #f8f9fa !important;
  }
  
  /* Car card styles to match public cars page exactly */
  .de-item {
    box-shadow: 3px 3px 9px rgba(164,164,186,0.2);
    border: solid 1px #dddddd;
    padding: 10px;
    border-radius: 6px;
    -moz-border-radius: 6px;
    -webkit-border-radius: 6px;
  }

  /* Ensure delete button text turns white on hover */
  .btn-outline-danger:hover {
    color: #ffffff;
    background-color: #dc3545;
    border-color: #dc3545;
  }

  .btn-outline-danger:hover i {
    color: #ffffff;
  }

  /* Fix secondary button hover to use purple color */
  .btn-outline-secondary:hover {
    color: #b23cfd;
    background-color: rgba(0, 0, 0, .02);
    border-color: #b23cfd;
  }

  /* Remove right margin from preview button icon */
  .btn-outline-info .fa-eye {
    margin-right: 0;
  }

  /* Remove right margin from delete button icon */
  .btn-outline-danger .fa-trash {
    margin-right: 0;
  }
  
  .de-item.mb30 {
    transition: box-shadow 0.25s, transform 0.25s;
    margin-bottom: 0 !important;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    padding: 0.7rem 0.7rem 1.1rem 0.7rem;
  }
  
  .de-item h4 {
    font-size: 18px;
    margin-bottom: 5px;
  }
  
  .de-item .d-info {
    padding: 20px;
    position: relative;
  }
  
  .de-item .d-atr-group {
    border-bottom: solid 1px #dddddd;
    padding-bottom: 15px;
  }
  
  .de-item .d-atr {
    font-size: 14px;
    display: inline-block;
    font-weight: bold;
    color: #031B4E;
    margin-right: 10px;
  }
  
  .de-item .d-atr img {
    float: left;
    width: 16px; 
    padding-top: 5px;
    margin-right: 3px; 
  }
  
  .d-img {
    overflow: hidden;
    border-radius: 6px;
    -moz-border-radius: 6px;
    -webkit-border-radius: 6px;
    position: relative;
  }
  
  .d-img img {
    width: 100%;
    height: auto;
    object-fit: cover;
    box-shadow: 3px 3px 9px rgba(164,164,186,.5);
  }
  
  .d-item_like {
    position: absolute;
    top: 20px;
    right: 20px;
    font-weight: 500;
    font-size: 14px;
  }
  
  .d-item_like i {
    color: #cccccc;
    margin-right: 6px;
  }
  
  .d-price {
    position: relative;
    margin-top: 10px;
    font-size: 14px;
  }
  
  .d-price span {
    font-size: 14px;
    font-weight: bold;
    display: block;
    color: #031B4E;
  }
  
  /* Car card button alignment */
  .d-text {
    display: flex;
    flex-direction: column;
    height: 100%;
    min-height: 200px;
  }
  
  .d-text .btn-main {
    margin-top: auto;
    align-self: flex-start;
  }
  
  .d-text .btn-unavailable {
    margin-top: auto;
    align-self: flex-start;
  }
  
  /* Admin-specific button styling */
  .d-text .btn {
    margin-top: 8px;
    font-size: 12px;
    padding: 6px 12px;
  }
  
  .d-text .btn-primary {
    background-color: #007bff;
    border-color: #007bff;
  }
  
  .d-text .btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
  }
  
  /* Ensure consistent card heights and button alignment */
  .de-item.mb30 {
    display: flex;
    flex-direction: column;
    height: 100%;
    min-height: 420px;
  }
  
  .de-item .d-info {
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  
  .de-item .d-text {
    display: flex;
    flex-direction: column;
    height: 100%;
    justify-content: space-between;
  }
  
  .de-item .d-text .btn {
    margin-top: auto;
    align-self: flex-start;
  }
  
  /* Container styling to match cars page */
  .cars-main-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 15px;
  }
  
  /* Bootstrap Grid Media Queries for 3 cars in a row */
  @media (min-width: 1200px) {
    .col-xl-4 {
      width: 33.333333%;
      flex: 0 0 33.333333%;
      max-width: 33.333333%;
    }
  }
  
  @media (min-width: 992px) and (max-width: 1199px) {
    .col-lg-4 {
      width: 33.333333%;
      flex: 0 0 33.333333%;
      max-width: 33.333333%;
    }
  }
  
  @media (min-width: 768px) and (max-width: 991px) {
    .col-md-6 {
      width: 50%;
      flex: 0 0 50%;
      max-width: 50%;
    }
  }
  
  @media (max-width: 767px) {
    .col-md-6 {
      width: 100%;
      flex: 0 0 100%;
      max-width: 100%;
    }
  }
  
  /* Container styling to match cars page */
  .cars-main-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 15px;
  }
  
  /* Drag and drop styles for car reordering */
  .car-card { 
    cursor: grab; 
    transition: transform 0.2s, box-shadow 0.2s; 
    user-select: none; 
    position: relative;
    border: 2px solid transparent;
  }
  .car-card:hover {
    border-color: rgba(0, 123, 255, 0.3);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.1);
  }
  .car-card:active {
    cursor: grabbing;
  }
  .car-card.dragging { 
    opacity: 0.8; 
    transform: rotate(2deg) scale(1.02); 
    z-index: 1000; 
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  }
  .car-card.drag-over { 
    border: 2px dashed #007bff; 
    background-color: #f8f9fa; 
    transform: scale(1.02);
  }
  .drag-handle { 
    cursor: grab;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .drag-handle:hover {
    transform: scale(1.1);
  }
  .drag-handle:active {
    cursor: grabbing;
  }
  
  /* Add a subtle drag indicator to the card */
  .car-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent 30%, rgba(0, 123, 255, 0.05) 50%, transparent 70%);
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    z-index: 1;
  }
  
  .car-card:hover::before {
    opacity: 1;
  }
  
  .admin-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    margin-bottom: 10px;
  }
  
  .order-indicator { 
    background: rgba(0, 123, 255, 0.8); 
    color: white; 
    border-radius: 50%; 
    width: 20px; 
    height: 20px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-size: 10px; 
    font-weight: bold; 
  }
  
  /* Unavailable badge styling - positioned to avoid conflict with admin controls */
  .unavailable-badge {
    position: absolute;
    top: 0px; /* Back to original position since admin controls are no longer absolute */
    right: 0px;
    background: #ff6b5b;
    color: #fff;
    font-size: 0.52rem;
    font-weight: 700;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    padding: 5px 14px 4px 14px;
    border-radius: 7px;
    z-index: 2;
    box-shadow: 0 2px 8px rgba(0,0,0,0.10);
    pointer-events: none;
    border: none;
    max-width: 150px; /* Limit width to prevent overflow */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Premium car highlighting */
  .car-card.premium {
    border: 3px solid #ffd700;
    box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
    transform: scale(1.02);
    transition: all 0.3s ease;
  }

  .car-card.premium:hover {
    transform: scale(1.05);
    box-shadow: 0 12px 35px rgba(255, 215, 0, 0.4);
  }

  .premium-badge {
    position: absolute;
    top: 0px;
    left: 0px;
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #333;
    font-size: 0.6rem;
    font-weight: 700;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    padding: 6px 12px 5px 12px;
    border-radius: 0 0 7px 0;
    z-index: 3;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    border: none;
    max-width: 120px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .premium-toggle {
    background: #ffd700;
    color: #333;
    border: none;
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 10px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
    margin-left: 5px;
  }

  .premium-toggle:hover {
    background: #ffed4e;
    transform: scale(1.05);
  }

  .premium-toggle.active {
    background: #ff6b5b;
    color: white;
  }
</style>

<!-- Custom green for success alert and Booked checkbox styles -->
<style>
:root {
  --admin-success-green: #28a745;
}
#adminCustomAlert.success {
  background: var(--admin-success-green) !important;
  color: #fff !important;
}
#adminCustomAlert.error {
  background: #e74c3c !important;
  color: #fff !important;
}
/* Remove all custom Booked checkbox and label styles */
.admin-booked-checkbox, .admin-booked-label { }
</style>
</head>

<body>
    <div id="wrapper">
        
        <!-- page preloader begin -->
        <div id="de-preloader"></div>
        <!-- page preloader close -->

        <!-- header begin -->
        <header class="transparent scroll-light has-topbar">
            <div id="topbar" class="topbar-dark text-light">
                <div class="container">
                    <div class="topbar-left xs-hide">
                        <div class="topbar-widget">
                            <div class="topbar-widget"><a href="#"><i class="fa fa-phone"></i>+208 333 9296</a></div>
                            <div class="topbar-widget"><a href="#"><i class="fa fa-envelope"></i>contact@plusrent.com</a></div>
                            <div class="topbar-widget"><a href="#"><i class="fa fa-clock-o"></i>Mon - Fri 08.00 - 18.00</a></div>
                        </div>
                    </div>
                
                    <div class="topbar-right">
                        <div class="social-icons">
                            <a href="#"><i class="fa fa-facebook fa-lg"></i></a>
                            <a href="#"><i class="fa fa-twitter fa-lg"></i></a>
                            <a href="#"><i class="fa fa-youtube fa-lg"></i></a>
                            <a href="#"><i class="fa fa-pinterest fa-lg"></i></a>
                            <a href="#"><i class="fa fa-instagram fa-lg"></i></a>
                        </div>
                    </div>  
                    <div class="clearfix"></div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-md-12">
                        <div class="de-flex sm-pt10">
                            <div class="de-flex-col">
                                <div class="de-flex-col">
                                    <!-- logo begin -->
                                    <div id="logo">
                                        <a href="index.html">
                                                            <img class="logo-1" src="images/LOGO-4-demo.png" alt="">
                <img class="logo-2" src="images/LOGO-5-demo.png" alt="">
                                        </a>
                                    </div>
                                    <!-- logo close -->
                                </div>
                            </div>
                            <div class="de-flex-col header-col-mid">
                                <ul id="mainmenu">
                                    <li><a class="menu-item" href="index.html">Home</a></li>
                                    <li><a class="menu-item" href="cars.html">Cars</a></li>
                                    <li><a class="menu-item" href="quick-booking.html">Booking</a></li>
                                    <li><a class="menu-item" href="account-dashboard.html">Admin Panel</a></li>
                                </ul>
                            </div>
                            <div class="de-flex-col">
                                <div class="menu_side_area">
                                        <div id="menu-btn">
                                        <span></span>
                                        <span></span>
                                        <span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
            <!-- header close -->
        <!-- content begin -->
        <div class="no-bottom no-top zebra" id="content">
            <div id="top"></div>
            
            <!-- section begin -->
            <section id="subheader" class="jarallax text-light">
                <img src="images/background/14.jpg" class="jarallax-img" alt="">
                    <div class="center-y relative text-center">
                        <div class="container">
                            <div class="row">
                                <div class="col-md-12 text-center">
									<h1>Admin Panel</h1>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                        </div>
                    </div>
            </section>
            <!-- section close -->

            <section id="admin-add-car" class="bg-gray-100">
              <div class="admin-main-container">
                <h3 class="admin-header mb-4" style="font-family: var(--title-font); font-weight: 600; color: #031B4E;">Admin Panel</h3>
                
                <!-- Tab Navigation -->
                <div class="admin-tabs mb-4">
                  <button class="admin-tab-btn active" data-tab="cars">Manage Cars</button>
                  <button class="admin-tab-btn" data-tab="coupons">Manage Coupon Codes</button>
                  <button class="admin-tab-btn" data-tab="bookings">Manage Bookings</button>
                  <button class="admin-tab-btn" data-tab="spinning-wheel">Manage Spinning Wheel</button>
                </div>
                
                <!-- Language Switcher for Cars -->

                
                <!-- Cars Tab Content -->
                <div id="cars-tab" class="admin-tab-content active">
                <div class="admin-flex-row">
                  <div class="admin-btn-col">
                    <button id="showAddCarBtn" type="button" class="btn btn-main btn-lg">Add a Car</button>
                  </div>
                  <div class="admin-form-col">
                    <!-- Overlay -->
                    <div id="adminOverlay" class="admin-overlay"></div>
                    <!-- Add Car Form Panel (popup) -->
                    <div id="addCarPanel" class="admin-form-panel">
                      <button class="close-btn" id="closeAddCarPanel">&times;</button>
                      <form id="carForm" class="form-border" autocomplete="off">
                                                <h3 id="formTitle" class="mb-3" style="font-family: var(--title-font); font-weight: 600; color: #031B4E; font-size: 1.4rem;">Add Car</h3>
                          <div class="admin-form-grid">
                            <div style="grid-column: 1 / -1; display: flex; align-items: flex-start; margin-bottom: 6px; gap: 16px;">
                            <div style="flex: 1;">
                              <label class="form-label">Head Image</label>
                              <div class="admin-upload-area">
                                <div class="admin-upload-button" id="addHeadImageButton">
                                  <i class="fa fa-upload admin-upload-icon"></i>
                                  <div class="admin-upload-text">Upload Head Image</div>
                                </div>
                                <input type="file" id="addHeadImageInput" name="head_image" accept="image/*" class="admin-upload-input">
                              </div>
                              <div id="addHeadImagePreview" class="admin-image-preview"></div>
                            </div>
                            <div style="flex: 1;">
                              <label class="form-label">Gallery Images</label>
                              <div class="admin-upload-area">
                                <div class="admin-upload-button" id="addGalleryImagesButton">
                                  <i class="fa fa-upload admin-upload-icon"></i>
                                  <div class="admin-upload-text">Upload Gallery Images</div>
                                </div>
                                <input type="file" id="addGalleryImagesInput" name="gallery_images" accept="image/*" multiple class="admin-upload-input">
                              </div>
                              <div id="addGalleryImagesPreview"></div>
                            </div>
                          </div>
                          <div>
                            <label class="form-label">Make Name</label>
                                <select name="make_name" class="form-control" required>
                                <option value="">Select Make</option>
                                <option value="Abarth">Abarth</option>
                                <option value="Acura">Acura</option>
                                <option value="Alfa-Romeo">Alfa Romeo</option>
                                <option value="ARO">ARO</option>
                                <option value="Aito">Aito</option>
                                <option value="Aiways">Aiways</option>
                                <option value="ArcFox">ArcFox</option>
                                <option value="Aston Martin">Aston Martin</option>
                                <option value="Audi">Audi</option>
                                <option value="Avatr">Avatr</option>
                                <option value="BAIC">BAIC</option>
                                <option value="BAW">BAW</option>
                                <option value="Bentley">Bentley</option>
                                <option value="BMW">BMW</option>
                                <option value="Brilliance">Brilliance</option>
                                <option value="Buick">Buick</option>
                                <option value="Byd">Byd</option>
                                <option value="Cadillac">Cadillac</option>
                                <option value="Changan">Changan</option>
                                <option value="Chery">Chery</option>
                                <option value="Chevrolet">Chevrolet</option>
                                <option value="Chrysler">Chrysler</option>
                                <option value="Citroen">Citroen</option>
                                <option value="Cupra">Cupra</option>
                                <option value="Dacia">Dacia</option>
                                <option value="Daewoo">Daewoo</option>
                                <option value="Daihatsu">Daihatsu</option>
                                <option value="Datsun">Datsun</option>
                                <option value="Denza">Denza</option>
                                <option value="Dodge">Dodge</option>
                                <option value="Dongfeng">Dongfeng</option>
                                <option value="DS Automobiles">DS Automobiles</option>
                                <option value="Exeed">Exeed</option>
                                <option value="FAW">FAW</option>
                                <option value="Ferrari">Ferrari</option>
                                <option value="Fiat">Fiat</option>
                                <option value="Ford">Ford</option>
                                <option value="GAC">GAC</option>
                                <option value="Genesis">Genesis</option>
                                <option value="Geely">Geely</option>
                                <option value="GMC">GMC</option>
                                <option value="Great Wall">Great Wall</option>
                                <option value="Hafei">Hafei</option>
                                <option value="Haima">Haima</option>
                                <option value="Haval">Haval</option>
                                <option value="HiPhi">HiPhi</option>
                                <option value="Honda">Honda</option>
                                <option value="Hongqi">Hongqi</option>
                                <option value="Hozon">Hozon</option>
                                <option value="Hummer">Hummer</option>
                                <option value="Hyundai">Hyundai</option>
                                <option value="IM Motors">IM Motors</option>
                                <option value="Infiniti">Infiniti</option>
                                <option value="Iran Khodro">Iran Khodro</option>
                                <option value="Isuzu">Isuzu</option>
                                <option value="Iveco">Iveco</option>
                                <option value="Jac">Jac</option>
                                <option value="Jaguar">Jaguar</option>
                                <option value="Jeep">Jeep</option>
                                <option value="Jetour">Jetour</option>
                                <option value="Jetta">Jetta</option>
                                <option value="JMC">JMC</option>
                                <option value="KIA">KIA</option>
                                <option value="Lada">Lada</option>
                                <option value="Lada / ВАЗ">Lada / ВАЗ</option>
                                <option value="Lamborghini">Lamborghini</option>
                                <option value="Lancia">Lancia</option>
                                <option value="Land Rover">Land Rover</option>
                                <option value="Leapmotor">Leapmotor</option>
                                <option value="Lexus">Lexus</option>
                                <option value="LEVC">LEVC</option>
                                <option value="LiXiang">LiXiang</option>
                                <option value="Lifan">Lifan</option>
                                <option value="Lincoln">Lincoln</option>
                                <option value="Linktour">Linktour</option>
                                <option value="Lotus">Lotus</option>
                                <option value="Lucid">Lucid</option>
                                <option value="Luxeed">Luxeed</option>
                                <option value="Lynk & Co">Lynk & Co</option>
                                <option value="Maserati">Maserati</option>
                                <option value="Mazda">Mazda</option>
                                <option value="McLaren">McLaren</option>
                                <option value="Mercedes">Mercedes</option>
                                <option value="Mercedes-Maybach">Mercedes-Maybach</option>
                                <option value="Mercury">Mercury</option>
                                <option value="MG">MG</option>
                                <option value="Mini">Mini</option>
                                <option value="Mitsubishi">Mitsubishi</option>
                                <option value="NIO">NIO</option>
                                <option value="Nissan">Nissan</option>
                                <option value="Opel">Opel</option>
                                <option value="Oshan">Oshan</option>
                                <option value="Peugeot">Peugeot</option>
                                <option value="Piaggio">Piaggio</option>
                                <option value="Polestar">Polestar</option>
                                <option value="Pontiac">Pontiac</option>
                                <option value="Porsche">Porsche</option>
                                <option value="Ravon">Ravon</option>
                                <option value="Renault">Renault</option>
                                <option value="Renault Samsung">Renault Samsung</option>
                                <option value="Riddara">Riddara</option>
                                <option value="Rivian">Rivian</option>
                                <option value="Roewe">Roewe</option>
                                <option value="Rolls-Royce">Rolls-Royce</option>
                                <option value="Rover">Rover</option>
                                <option value="Saab">Saab</option>
                                <option value="Saturn">Saturn</option>
                                <option value="Scion">Scion</option>
                                <option value="Seat">Seat</option>
                                <option value="Skoda">Skoda</option>
                                <option value="Skywell">Skywell</option>
                                <option value="Smart">Smart</option>
                                <option value="Ssangyong">Ssangyong</option>
                                <option value="Subaru">Subaru</option>
                                <option value="Suzuki">Suzuki</option>
                                <option value="Tank">Tank</option>
                                <option value="Tata">Tata</option>
                                <option value="Tesla">Tesla</option>
                                <option value="Toyota">Toyota</option>
                                <option value="Venucia">Venucia</option>
                                <option value="Volkswagen">Volkswagen</option>
                                <option value="Volvo">Volvo</option>
                                <option value="Voyah">Voyah</option>
                                <option value="Weltmeister">Weltmeister</option>
                                <option value="Wuling">Wuling</option>
                                <option value="Xiaomi">Xiaomi</option>
                                <option value="Xpeng">Xpeng</option>
                                <option value="Zeekr">Zeekr</option>
                                <option value="Zotye">Zotye</option>
                              </select>
                          </div>
                          <div>
                            <label class="form-label">Model Name</label>
                            <input type="text" name="model_name" class="form-control" placeholder="Enter model name" required>
                          </div>
                          <div>
                            <label class="form-label">Production Year</label>
                            <select name="production_year" class="form-control" required></select>
                          </div>
                          <div>
                            <label class="form-label">Gear Type</label>
                            <select name="gear_type" class="form-control" required>
                              <option value="Automatic">Automatic</option>
                              <option value="Manual">Manual</option>
                            </select>
                          </div>
                          <div class="five-column-grid">
                            <div>
                              <label class="form-label">Fuel Type</label>
                              <select name="fuel_type" class="form-control" required>
                                <option value="Gasoline">Gasoline</option>
                                <option value="Diesel">Diesel</option>
                                <option value="Hybrid">Hybrid</option>
                                <option value="Electric">Electric</option>
                              </select>
                            </div>
                            <div>
                              <label class="form-label">Engine Capacity</label>
                              <input type="number" name="engine_capacity" class="form-control" step="0.1" min="0">
                            </div>
                            <div>
                              <label class="form-label">Car Type</label>
                              <select name="car_type" class="form-control" required>
                                <option value="Crossover">Crossover</option>
                                <option value="Sedan">Sedan</option>
                                <option value="Coupe">Coupe</option>
                                  <option value="Minivan">Minivan</option>
                                  <option value="Hatchback">Hatchback</option>
                              </select>
                            </div>
                            <div>
                              <label class="form-label">Number of Doors</label>
                              <select name="num_doors" class="form-control" required></select>
                            </div>
                            <div>
                              <label class="form-label">Number of Passengers</label>
                              <select name="num_passengers" class="form-control" required></select>
                            </div>
                          </div>
                        </div>
                        <fieldset class="mb-3 p-2 rounded-3" style="border: 1px solid #eee;">
                          <legend class="form-label mb-2" style="font-size: 1rem; color: #031B4E;">Price Policy</legend>
                          <div class="row g-2">
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">1-2 days</label>
                              <input type="text" name="price_1_2" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">3-7 days</label>
                              <input type="text" name="price_3_7" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">8-20 days</label>
                              <input type="text" name="price_8_20" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">21-45 days</label>
                              <input type="text" name="price_21_45" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">46+ days</label>
                              <input type="text" name="price_46" class="form-control" required>
                            </div>
                          </div>
                        </fieldset>
                        <div class="mb-3" style="max-width: 300px;">
                          <label class="form-label">Booked Until (optional)</label>
                          <input type="date" name="booked_until" class="form-control" placeholder="Select date until when car is booked">
                          <small class="form-text text-muted">Leave empty if car is available. Car will be automatically available after this date.</small>
                        </div>
                          <fieldset class="mb-3 p-2 rounded-3" style="border: 1px solid #eee;">
                            <legend class="form-label mb-2" style="font-size: 1rem; color: #031B4E;">Additional Specifications (Optional)</legend>
                            <div class="admin-form-grid">
                              <div>
                                <label class="form-label">Luggage Capacity</label>
                                <select name="luggage" class="form-control">
                                  <option value="">Select luggage capacity</option>
                                </select>
                              </div>
                              <div>
                                <label class="form-label">Mileage (km)</label>
                                <input type="number" name="mileage" class="form-control" placeholder="e.g., 50000" min="0">
                              </div>
                              <div>
                                <label class="form-label">Drive Type</label>
                                <select name="drive" class="form-control">
                                  <option value="">Select drive type</option>
                                  <option value="Front Wheel Drive">Front Wheel Drive</option>
                                  <option value="Rear Wheel Drive">Rear Wheel Drive</option>
                                  <option value="All Wheel Drive">All Wheel Drive</option>
                                  <option value="4 Wheel Drive">4 Wheel Drive</option>
                                </select>
                              </div>
                              <div>
                                <label class="form-label" id="fuel-economy-label">Fuel Economy (L/100km)</label>
                                <input type="number" name="fuel_economy" class="form-control" placeholder="e.g., 7.5" step="0.1" min="0">
                              </div>
                              <div>
                                <label class="form-label">Exterior Color</label>
                                <input type="text" name="exterior_color" class="form-control" placeholder="e.g., Pearl White">
                              </div>
                              <div>
                                <label class="form-label">Interior Color</label>
                                <input type="text" name="interior_color" class="form-control" placeholder="e.g., Black Leather">
                              </div>
                            </div>
                          </fieldset>
                          <fieldset class="mb-3 p-2 rounded-3" style="border: 1px solid #eee;">
                            <legend class="form-label mb-2" style="font-size: 1rem; color: #031B4E;">Insurance Pricing (Optional)</legend>
                            <div class="admin-form-grid">
                              <div>
                                <label class="form-label">RCA Insurance Price (€/day)</label>
                                <input type="number" name="rca_insurance_price" class="form-control" placeholder="e.g., 15" step="0.01" min="0">
                              </div>
                              <div>
                                <label class="form-label">Casco Insurance Price (€/day)</label>
                                <input type="number" name="casco_insurance_price" class="form-control" placeholder="e.g., 25" step="0.01" min="0">
                              </div>
                            </div>
                          </fieldset>
                          <fieldset class="mb-3 p-2 rounded-3" style="border: 1px solid #eee;">
                            <legend class="form-label mb-2" style="font-size: 1rem; color: #031B4E;">Social Features</legend>
                            <div class="admin-form-grid">
                              <div>
                                <label class="form-label">Number of Likes</label>
                                <input type="number" name="likes" class="form-control" placeholder="e.g., 42" min="0" value="0">
                                <small class="form-text text-muted">This will be displayed as the number of likes on the car cards.</small>
                              </div>
                            </div>
                          </fieldset>
                          <fieldset class="mb-3 p-2 rounded-3" style="border: 1px solid #eee;">
                            <legend class="form-label mb-2" style="font-size: 1rem; color: #031B4E;">Multilingual Description (Optional)</legend>
                            <div class="admin-form-grid">
                              <div>
                                <label class="form-label">English Description</label>
                                <textarea name="description_en" class="form-control" rows="3" placeholder="Enter description in English..."></textarea>
                              </div>
                              <div>
                                <label class="form-label">Romanian Description</label>
                                <textarea name="description_ro" class="form-control" rows="3" placeholder="Enter description in Romanian..."></textarea>
                              </div>
                              <div>
                                <label class="form-label">Russian Description</label>
                                <textarea name="description_ru" class="form-control" rows="3" placeholder="Enter description in Russian..."></textarea>
                              </div>
                              <div style="grid-column: 1 / -1;">
                                <small class="form-text text-muted">These descriptions will be displayed on the car details page based on the user's selected language.</small>
                              </div>
                            </div>
                          </fieldset>
                        <button type="submit" id="formSubmitBtn" class="btn btn-main">Add Car</button>
                      </form>
                    </div>
                    <!-- Edit Car Form Panel (popup) -->
                    <div id="editCarPanel" class="admin-form-panel">
                      <button class="close-btn" id="closeEditCarPanel">&times;</button>
                      <button id="deleteCarBtn" type="button" style="position:absolute;top:16px;right:48px;background:none;border:1.5px solid #e74c3c;color:#e74c3c;padding:6px 14px;border-radius:6px;font-size:1rem;display:flex;align-items:center;gap:6px;cursor:pointer;z-index:2;">
                        <i class="fa fa-trash"></i> Delete Car
                      </button>
                      <form id="editCarForm" class="form-border" autocomplete="off">
                                                <h3 id="editFormTitle" class="mb-3" style="font-family: var(--title-font); font-weight: 600; color: #031B4E; font-size: 1.4rem;">Edit Car</h3>
                          <div class="admin-form-grid">
                            <div style="grid-column: 1 / -1; display: flex; align-items: flex-start; margin-bottom: 6px; gap: 16px;">
                            <div style="flex: 1;">
                              <label class="form-label">Head Image</label>
                              <div class="admin-upload-area">
                                <div class="admin-upload-button" id="editHeadImageButton">
                                  <i class="fa fa-upload admin-upload-icon"></i>
                                  <div class="admin-upload-text">Upload Head Image</div>
                                </div>
                                <input type="file" id="editHeadImageInput" name="head_image" accept="image/*" class="admin-upload-input">
                              </div>
                              <div id="editHeadImagePreview" class="admin-image-preview"></div>
                            </div>
                            <div style="flex: 1;">
                              <label class="form-label">Gallery Images</label>
                              <div class="admin-upload-area">
                                <div class="admin-upload-button" id="editGalleryImagesButton">
                                  <i class="fa fa-upload admin-upload-icon"></i>
                                  <div class="admin-upload-text">Upload Gallery Images</div>
                                </div>
                                <input type="file" id="editGalleryImagesInput" name="gallery_images" accept="image/*" multiple class="admin-upload-input">
                              </div>
                              <div id="editGalleryImagesPreview"></div>
                            </div>
                          </div>
                          <div>
                            <label class="form-label">Make Name</label>
                                <select name="make_name" class="form-control" required>
                                <option value="">Select Make</option>
                                <option value="Abarth">Abarth</option>
                                <option value="Acura">Acura</option>
                                <option value="Alfa-Romeo">Alfa Romeo</option>
                                <option value="ARO">ARO</option>
                                <option value="Aito">Aito</option>
                                <option value="Aiways">Aiways</option>
                                <option value="ArcFox">ArcFox</option>
                                <option value="Aston Martin">Aston Martin</option>
                                <option value="Audi">Audi</option>
                                <option value="Avatr">Avatr</option>
                                <option value="BAIC">BAIC</option>
                                <option value="BAW">BAW</option>
                                <option value="Bentley">Bentley</option>
                                <option value="BMW">BMW</option>
                                <option value="Brilliance">Brilliance</option>
                                <option value="Buick">Buick</option>
                                <option value="Byd">Byd</option>
                                <option value="Cadillac">Cadillac</option>
                                <option value="Changan">Changan</option>
                                <option value="Chery">Chery</option>
                                <option value="Chevrolet">Chevrolet</option>
                                <option value="Chrysler">Chrysler</option>
                                <option value="Citroen">Citroen</option>
                                <option value="Cupra">Cupra</option>
                                <option value="Dacia">Dacia</option>
                                <option value="Daewoo">Daewoo</option>
                                <option value="Daihatsu">Daihatsu</option>
                                <option value="Datsun">Datsun</option>
                                <option value="Denza">Denza</option>
                                <option value="Dodge">Dodge</option>
                                <option value="Dongfeng">Dongfeng</option>
                                <option value="DS Automobiles">DS Automobiles</option>
                                <option value="Exeed">Exeed</option>
                                <option value="FAW">FAW</option>
                                <option value="Ferrari">Ferrari</option>
                                <option value="Fiat">Fiat</option>
                                <option value="Ford">Ford</option>
                                <option value="GAC">GAC</option>
                                <option value="Genesis">Genesis</option>
                                <option value="Geely">Geely</option>
                                <option value="GMC">GMC</option>
                                <option value="Great Wall">Great Wall</option>
                                <option value="Hafei">Hafei</option>
                                <option value="Haima">Haima</option>
                                <option value="Haval">Haval</option>
                                <option value="HiPhi">HiPhi</option>
                                <option value="Honda">Honda</option>
                                <option value="Hongqi">Hongqi</option>
                                <option value="Hozon">Hozon</option>
                                <option value="Hummer">Hummer</option>
                                <option value="Hyundai">Hyundai</option>
                                <option value="IM Motors">IM Motors</option>
                                <option value="Infiniti">Infiniti</option>
                                <option value="Iran Khodro">Iran Khodro</option>
                                <option value="Isuzu">Isuzu</option>
                                <option value="Iveco">Iveco</option>
                                <option value="Jac">Jac</option>
                                <option value="Jaguar">Jaguar</option>
                                <option value="Jeep">Jeep</option>
                                <option value="Jetour">Jetour</option>
                                <option value="Jetta">Jetta</option>
                                <option value="JMC">JMC</option>
                                <option value="KIA">KIA</option>
                                <option value="Lada">Lada</option>
                                <option value="Lada / ВАЗ">Lada / ВАЗ</option>
                                <option value="Lamborghini">Lamborghini</option>
                                <option value="Lancia">Lancia</option>
                                <option value="Land Rover">Land Rover</option>
                                <option value="Leapmotor">Leapmotor</option>
                                <option value="Lexus">Lexus</option>
                                <option value="LEVC">LEVC</option>
                                <option value="LiXiang">LiXiang</option>
                                <option value="Lifan">Lifan</option>
                                <option value="Lincoln">Lincoln</option>
                                <option value="Linktour">Linktour</option>
                                <option value="Lotus">Lotus</option>
                                <option value="Lucid">Lucid</option>
                                <option value="Luxeed">Luxeed</option>
                                <option value="Lynk & Co">Lynk & Co</option>
                                <option value="Maserati">Maserati</option>
                                <option value="Mazda">Mazda</option>
                                <option value="McLaren">McLaren</option>
                                <option value="Mercedes">Mercedes</option>
                                <option value="Mercedes-Maybach">Mercedes-Maybach</option>
                                <option value="Mercury">Mercury</option>
                                <option value="MG">MG</option>
                                <option value="Mini">Mini</option>
                                <option value="Mitsubishi">Mitsubishi</option>
                                <option value="NIO">NIO</option>
                                <option value="Nissan">Nissan</option>
                                <option value="Opel">Opel</option>
                                <option value="Oshan">Oshan</option>
                                <option value="Peugeot">Peugeot</option>
                                <option value="Piaggio">Piaggio</option>
                                <option value="Polestar">Polestar</option>
                                <option value="Pontiac">Pontiac</option>
                                <option value="Porsche">Porsche</option>
                                <option value="Ravon">Ravon</option>
                                <option value="Renault">Renault</option>
                                <option value="Renault Samsung">Renault Samsung</option>
                                <option value="Riddara">Riddara</option>
                                <option value="Rivian">Rivian</option>
                                <option value="Roewe">Roewe</option>
                                <option value="Rolls-Royce">Rolls-Royce</option>
                                <option value="Rover">Rover</option>
                                <option value="Saab">Saab</option>
                                <option value="Saturn">Saturn</option>
                                <option value="Scion">Scion</option>
                                <option value="Seat">Seat</option>
                                <option value="Skoda">Skoda</option>
                                <option value="Skywell">Skywell</option>
                                <option value="Smart">Smart</option>
                                <option value="Ssangyong">Ssangyong</option>
                                <option value="Subaru">Subaru</option>
                                <option value="Suzuki">Suzuki</option>
                                <option value="Tank">Tank</option>
                                <option value="Tata">Tata</option>
                                <option value="Tesla">Tesla</option>
                                <option value="Toyota">Toyota</option>
                                <option value="Venucia">Venucia</option>
                                <option value="Volkswagen">Volkswagen</option>
                                <option value="Volvo">Volvo</option>
                                <option value="Voyah">Voyah</option>
                                <option value="Weltmeister">Weltmeister</option>
                                <option value="Wuling">Wuling</option>
                                <option value="Xiaomi">Xiaomi</option>
                                <option value="Xpeng">Xpeng</option>
                                <option value="Zeekr">Zeekr</option>
                                <option value="Zotye">Zotye</option>
                              </select>
                          </div>
                          <div>
                            <label class="form-label">Model Name</label>
                            <input type="text" name="model_name" class="form-control" placeholder="Enter model name" required>
                          </div>
                          <div>
                            <label class="form-label">Production Year</label>
                            <select name="production_year" class="form-control" required></select>
                          </div>
                          <div>
                            <label class="form-label">Gear Type</label>
                            <select name="gear_type" class="form-control" required>
                              <option value="Automatic">Automatic</option>
                              <option value="Manual">Manual</option>
                            </select>
                          </div>
                          <div class="five-column-grid">
                            <div>
                              <label class="form-label">Fuel Type</label>
                              <select name="fuel_type" class="form-control" required>
                                <option value="Gasoline">Gasoline</option>
                                <option value="Diesel">Diesel</option>
                                <option value="Hybrid">Hybrid</option>
                                <option value="Electric">Electric</option>
                              </select>
                            </div>
                            <div>
                              <label class="form-label">Engine Capacity</label>
                              <input type="number" name="engine_capacity" class="form-control" step="0.1" min="0">
                            </div>
                            <div>
                              <label class="form-label">Car Type</label>
                              <select name="car_type" class="form-control" required>
                                <option value="Crossover">Crossover</option>
                                <option value="Sedan">Sedan</option>
                                <option value="Coupe">Coupe</option>
                                  <option value="Minivan">Minivan</option>
                                  <option value="Hatchback">Hatchback</option>
                              </select>
                            </div>
                            <div>
                              <label class="form-label">Number of Doors</label>
                              <select name="num_doors" class="form-control" required></select>
                            </div>
                            <div>
                              <label class="form-label">Number of Passengers</label>
                              <select name="num_passengers" class="form-control" required></select>
                            </div>
                          </div>
                        </div>
                        <fieldset class="mb-3 p-2 rounded-3" style="border: 1px solid #eee;">
                          <legend class="form-label mb-2" style="font-size: 1rem; color: #031B4E;">Price Policy</legend>
                          <div class="row g-2">
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">1-2 days</label>
                              <input type="text" name="price_1_2" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">3-7 days</label>
                              <input type="text" name="price_3_7" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">8-20 days</label>
                              <input type="text" name="price_8_20" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">21-45 days</label>
                              <input type="text" name="price_21_45" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">46+ days</label>
                              <input type="text" name="price_46" class="form-control" required>
                            </div>
                          </div>
                        </fieldset>
                        <div class="mb-3" style="max-width: 300px;">
                          <label class="form-label">Booked Until (optional)</label>
                          <input type="date" name="booked_until" class="form-control" placeholder="Select date until when car is booked">
                          <small class="form-text text-muted">Leave empty if car is available. Car will be automatically available after this date.</small>
                        </div>
                          <fieldset class="mb-3 p-2 rounded-3" style="border: 1px solid #eee;">
                            <legend class="form-label mb-2" style="font-size: 1rem; color: #031B4E;">Additional Specifications (Optional)</legend>
                            <div class="admin-form-grid">
                              <div>
                                <label class="form-label">Luggage Capacity</label>
                                <select name="luggage" class="form-control">
                                  <option value="">Select luggage capacity</option>
                                </select>
                              </div>
                              <div>
                                <label class="form-label">Mileage (km)</label>
                                <input type="number" name="mileage" class="form-control" placeholder="e.g., 50000" min="0">
                              </div>
                              <div>
                                <label class="form-label">Drive Type</label>
                                <select name="drive" class="form-control">
                                  <option value="">Select drive type</option>
                                  <option value="Front Wheel Drive">Front Wheel Drive</option>
                                  <option value="Rear Wheel Drive">Rear Wheel Drive</option>
                                  <option value="All Wheel Drive">All Wheel Drive</option>
                                  <option value="4 Wheel Drive">4 Wheel Drive</option>
                                </select>
                              </div>
                              <div>
                                <label class="form-label" id="edit-fuel-economy-label">Fuel Economy (L/100km)</label>
                                <input type="number" name="fuel_economy" class="form-control" placeholder="e.g., 7.5" step="0.1" min="0">
                              </div>
                              <div>
                                <label class="form-label">Exterior Color</label>
                                <input type="text" name="exterior_color" class="form-control" placeholder="e.g., Pearl White">
                              </div>
                              <div>
                                <label class="form-label">Interior Color</label>
                                <input type="text" name="interior_color" class="form-control" placeholder="e.g., Black Leather">
                              </div>
                            </div>
                          </fieldset>
                          <fieldset class="mb-3 p-2 rounded-3" style="border: 1px solid #eee;">
                            <legend class="form-label mb-2" style="font-size: 1rem; color: #031B4E;">Insurance Pricing (Optional)</legend>
                            <div class="admin-form-grid">
                              <div>
                                <label class="form-label">RCA Insurance Price (€/day)</label>
                                <input type="number" name="rca_insurance_price" class="form-control" placeholder="e.g., 15" step="0.01" min="0">
                              </div>
                              <div>
                                <label class="form-label">Casco Insurance Price (€/day)</label>
                                <input type="number" name="casco_insurance_price" class="form-control" placeholder="e.g., 25" step="0.01" min="0">
                              </div>
                            </div>
                          </fieldset>
                          <fieldset class="mb-3 p-2 rounded-3" style="border: 1px solid #eee;">
                            <legend class="form-label mb-2" style="font-size: 1rem; color: #031B4E;">Social Features</legend>
                            <div class="admin-form-grid">
                              <div>
                                <label class="form-label">Number of Likes</label>
                                <input type="number" name="likes" class="form-control" placeholder="e.g., 42" min="0" value="0">
                                <small class="form-text text-muted">This will be displayed as the number of likes on the car cards.</small>
                              </div>
                            </div>
                          </fieldset>
                          <fieldset class="mb-3 p-2 rounded-3" style="border: 1px solid #eee;">
                            <legend class="form-label mb-2" style="font-size: 1rem; color: #031B4E;">Multilingual Description (Optional)</legend>
                            <div class="admin-form-grid">
                              <div>
                                <label class="form-label">English Description</label>
                                <textarea name="description_en" class="form-control" rows="3" placeholder="Enter description in English..."></textarea>
                              </div>
                              <div>
                                <label class="form-label">Romanian Description</label>
                                <textarea name="description_ro" class="form-control" rows="3" placeholder="Enter description in Romanian..."></textarea>
                              </div>
                              <div>
                                <label class="form-label">Russian Description</label>
                                <textarea name="description_ru" class="form-control" rows="3" placeholder="Enter description in Russian..."></textarea>
                              </div>
                              <div style="grid-column: 1 / -1;">
                                <small class="form-text text-muted">These descriptions will be displayed on the car details page based on the user's selected language.</small>
                              </div>
                            </div>
                          </fieldset>
                        <button type="submit" id="editFormSubmitBtn" class="btn btn-main">Update Car</button>
                      </form>
                    </div>
                    <!-- Confirm Modal -->
                    <div id="adminConfirmModal" class="admin-confirm-modal">
                      <h4>Are you sure you want to close this form? All unsaved data will be lost.</h4>
                      <div class="mt-4 d-flex justify-content-center gap-3">
                        <button id="confirmCloseBtn" class="btn btn-danger">Close</button>
                        <button id="cancelCloseBtn" class="btn btn-main">Cancel</button>
                      </div>
                    </div>
                    <!-- Add a confirmation modal for delete -->
                    <div id="deleteConfirmModal" class="admin-confirm-modal">
                      <h4>Are you sure you want to delete this car?</h4>
                      <div class="mt-4 d-flex justify-content-center gap-3">
                        <button id="confirmDeleteBtn" class="btn btn-danger">Yes Delete</button>
                        <button id="cancelDeleteBtn" class="btn btn-main">Cancel</button>
                      </div>
                    </div>
                      

                  </div>
                </div>
                <div class="container cars-main-container">
                  <div class="row">
                    <div class="col-12">
                      <div id="carCards" class="row g-4 mt-4"></div>
                    </div>
                  </div>
                </div>
                </div>
                
                <!-- Coupon Codes Tab Content -->
                <div id="coupons-tab" class="admin-tab-content">
                  <div class="admin-flex-row">
                    <div class="admin-btn-col">
                      <button id="showAddCouponBtn" type="button" class="btn btn-main btn-lg">Add Coupon Code</button>
                    </div>
                    <div class="admin-form-col">
                      <!-- Overlay -->
                      <div id="couponOverlay" class="admin-overlay"></div>
                      <!-- Add Coupon Form Panel (popup) -->
                      <div id="addCouponPanel" class="admin-form-panel">
                        <button class="close-btn" id="closeAddCouponPanel">&times;</button>
                        <form id="couponForm" class="form-border" autocomplete="off">
                          <h3 id="couponFormTitle" class="mb-3" style="font-family: var(--title-font); font-weight: 600; color: #031B4E; font-size: 1.4rem;">Add Coupon Code</h3>
                          <div class="admin-form-grid">
                            <div>
                              <label class="form-label">Coupon Code</label>
                              <input type="text" name="code" class="form-control" placeholder="e.g., WELCOME10" required>
                            </div>
                            <div>
                              <label class="form-label">Coupon Type</label>
                              <select name="type" id="couponType" class="form-control" required>
                                <option value="percentage">Percentage Discount</option>
                                <option value="free_days">Free Days</option>
                              </select>
                            </div>
                            <div id="percentageField" class="coupon-field">
                              <label class="form-label">Discount Percentage</label>
                              <input type="number" name="discount_percentage" class="form-control" placeholder="e.g., 15" min="1" max="100" step="0.01">
                            </div>
                            <div id="freeDaysField" class="coupon-field" style="display: none;">
                              <label class="form-label">Free Days</label>
                              <input type="number" name="free_days" class="form-control" placeholder="e.g., 3" min="1" step="1">
                            </div>
                            <div>
                              <label class="form-label">Description</label>
                              <textarea name="description" class="form-control" placeholder="e.g., Welcome discount for new customers" rows="3"></textarea>
                            </div>
                            <div>
                              <label class="form-label">Expiry Date (Optional)</label>
                              <input type="datetime-local" name="expires_at" class="form-control">
                            </div>
                            <div>
                              <label class="form-label">Status</label>
                              <select name="is_active" class="form-control" required>
                                <option value="1">Active</option>
                                <option value="0">Inactive</option>
                              </select>
                            </div>
                          </div>
                          <button type="submit" id="couponFormSubmitBtn" class="btn btn-main">Add Coupon</button>
                        </form>
                      </div>
                      <!-- Edit Coupon Form Panel (popup) -->
                      <div id="editCouponPanel" class="admin-form-panel">
                        <button class="close-btn" id="closeEditCouponPanel">&times;</button>
                        <form id="editCouponForm" class="form-border" autocomplete="off">
                          <h3 class="mb-3" style="font-family: var(--title-font); font-weight: 600; color: #031B4E; font-size: 1.4rem;">Edit Coupon Code</h3>
                          <div class="admin-form-grid">
                            <div>
                              <label class="form-label">Coupon Code</label>
                              <input type="text" name="code" class="form-control" placeholder="e.g., WELCOME10" required>
                            </div>
                            <div>
                              <label class="form-label">Coupon Type</label>
                              <select name="type" id="editCouponType" class="form-control" required>
                                <option value="percentage">Percentage Discount</option>
                                <option value="free_days">Free Days</option>
                              </select>
                            </div>
                            <div id="editPercentageField" class="coupon-field">
                              <label class="form-label">Discount Percentage</label>
                              <input type="number" name="discount_percentage" class="form-control" placeholder="e.g., 15" min="1" max="100" step="0.01">
                            </div>
                            <div id="editFreeDaysField" class="coupon-field" style="display: none;">
                              <label class="form-label">Free Days</label>
                              <input type="number" name="free_days" class="form-control" placeholder="e.g., 3" min="1" step="1">
                            </div>
                            <div>
                              <label class="form-label">Description</label>
                              <textarea name="description" class="form-control" placeholder="e.g., Welcome discount for new customers" rows="3"></textarea>
                            </div>
                            <div>
                              <label class="form-label">Expiry Date (Optional)</label>
                              <input type="datetime-local" name="expires_at" class="form-control">
                            </div>
                            <div>
                              <label class="form-label">Status</label>
                              <select name="is_active" class="form-control" required>
                                <option value="1">Active</option>
                                <option value="0">Inactive</option>
                              </select>
                            </div>
                          </div>
                          
                          <!-- Update Button -->
                          <div class="mt-4">
                            <button type="submit" id="editCouponFormSubmitBtn" class="btn btn-main btn-lg">Update Coupon</button>
                          </div>
                        </form>
                        
                        <!-- Dynamic Codes Tables -->
                        <div class="mt-4">
                          <div class="row">
                            <!-- Active Codes Table -->
                            <div class="col-md-6">
                              <div class="card">
                                <div class="card-header bg-success text-white">
                                  <h6 class="mb-0"><i class="fa fa-check-circle"></i> Active Codes</h6>
                                </div>
                                <div class="card-body p-0">
                                  <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0" id="activeCodesTable">
                                      <thead class="table-light">
                                        <tr>
                                          <th>Code</th>
                                          <th>Created Date</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        <tr>
                                          <td colspan="2" class="text-center text-muted py-3">No active codes available</td>
                                        </tr>
                                      </tbody>
                                    </table>
                                  </div>
                                </div>
                              </div>
                            </div>
                            
                            <!-- Redeemed Codes Table -->
                            <div class="col-md-6">
                              <div class="card">
                                <div class="card-header text-dark" style="background-color: #d7d7d7;">
                                  <h6 class="mb-0">Redeemed Codes</h6>
                                </div>
                                <div class="card-body p-0">
                                  <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0" id="redeemedCodesTable">
                                      <thead class="table-light">
                                        <tr>
                                          <th>Code</th>
                                          <th>Created Date</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        <tr>
                                          <td colspan="2" class="text-center text-muted py-3">No redeemed codes</td>
                                        </tr>
                                      </tbody>
                                    </table>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <!-- See All Codes Button -->
                        <div class="mt-3">
                          <a href="#" id="seeAllCodesBtn" target="_blank" class="btn btn-outline-primary">See all codes</a>
                        </div>

                      </div>
                    </div>
                  </div>
                  <div id="couponCards" class="row g-4 mt-4"></div>
                </div>

                <!-- Bookings Tab Content -->
                <div id="bookings-tab" class="admin-tab-content">
                  <div class="admin-flex-row">
                    <div class="admin-btn-col">
                      <h6 class="mb-1">Booking Management</h6>
                      <p class="text-muted small mb-2">Manage all booking requests and their status</p>
                      
                      <!-- Status Filter Buttons -->
                      <div class="mb-3">
                        <div class="btn-group btn-group-sm" role="group" aria-label="Booking status filter" style="flex-wrap: wrap; gap: 2px;">
                          <button type="button" class="btn btn-outline-primary" onclick="loadAllBookings('all')" style="font-size: 11px; padding: 3px 6px;">
                            <i class="fa fa-list"></i> All
                          </button>
                          <button type="button" class="btn btn-outline-warning" onclick="loadAllBookings('pending')" style="font-size: 11px; padding: 3px 6px;">
                            <i class="fa fa-clock-o"></i> Pending
                          </button>
                          <button type="button" class="btn btn-outline-success" onclick="loadAllBookings('confirmed')" style="font-size: 11px; padding: 3px 6px;">
                            <i class="fa fa-check"></i> Confirmed
                          </button>
                          <button type="button" class="btn btn-outline-danger" onclick="loadAllBookings('cancelled')" style="font-size: 11px; padding: 3px 6px;">
                            <i class="fa fa-ban"></i> Cancelled
                          </button>
                                              <button type="button" class="btn btn-outline-secondary" onclick="loadAllBookings('rejected')" style="font-size: 11px; padding: 3px 6px;">
                      <i class="fa fa-times"></i> Rejected
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="loadAllBookings('finished')" style="font-size: 11px; padding: 3px 6px;">
                      <i class="fa fa-flag-checkered"></i> Finished
                    </button>
                        </div>
                      </div>
                    </div>
                    <div class="admin-form-col">
                      <div id="bookingsList" class="row g-3">
                        <!-- Bookings will be loaded here -->
                      </div>
                      <div id="paginationControls">
                        <!-- Pagination controls will be loaded here -->
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Spinning Wheel Tab Content -->
                <div id="spinning-wheel-tab" class="admin-tab-content">
                  <div class="admin-flex-row wheel-config-row">
                    <!-- Left Side - Wheels List -->
                    <div style="width: 50%;">
                      <div class="card shadow-sm">
                        <div class="card-body">
                          <p class="text-muted mb-3">Select a wheel to configure (multiple wheels can be active)</p>
                          <div class="mb-4">
                            <button id="addWheelBtn" type="button" class="btn btn-outline-primary btn-lg w-100">
                              <i class="fa fa-plus"></i> Add New Wheel
                            </button>
                          </div>
                          

                          
                          <!-- Wheels List -->
                          <div class="card">
                            <div class="card-header bg-light">
                              <h6 class="mb-0"><i class="fa fa-list"></i> All Wheels</h6>
                            </div>
                            <div class="card-body p-0">
                              <div id="wheelsList" class="list-group list-group-flush">
                                <!-- Wheels will be loaded here -->
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                                         <!-- Right Side - Wheel Configuration -->
                     <div style="width: 50%;">
                       <div id="wheelConfigurationPanel">
                         <!-- Default state when no wheel is selected -->
                         <div class="card shadow-sm">
                           <div class="card-header bg-light">
                             <h5 class="mb-0"><i class="fa fa-cog"></i> Wheel Configuration</h5>
                           </div>
                           <div class="card-body text-center py-5">
                             <div class="mb-4">
                               <i class="fa fa-arrow-left fa-3x text-muted"></i>
                             </div>
                             <h5 class="card-title">Select a Wheel</h5>
                             <p class="text-muted">Choose a wheel from the list on the left to configure it</p>
                           </div>
                         </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
			
			
        </div>
        <!-- content close -->

        <!-- Phone Number Modal -->
        <div class="modal fade" id="phoneNumberModal" tabindex="-1" aria-labelledby="phoneNumberModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="phoneNumberModalLabel">
                  <i class="fa fa-gift"></i> Spin the Wheel for a Bonus!
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <p class="text-muted mb-3">You can spin a wheel to get a random bonus.</p>
                </div>
                <form id="phoneNumberForm">
                  <div class="mb-3">
                    <input type="tel" class="form-control" id="phoneNumberInput" placeholder="Enter your phone number" required>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitPhoneNumberBtn">
                  <i class="fa fa-check"></i> Submit
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Spinning Wheel Preview Modal -->
        <div class="modal fade" id="spinningWheelModal" tabindex="-1" aria-labelledby="spinningWheelModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-xl">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="spinningWheelModalLabel">
                  <i class="fa fa-eye"></i> Spinning Wheel Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body p-0">
                <iframe id="spinningWheelIframe" src="spinning-wheel-standalone.html" 
                        style="width: 100%; height: 600px; border: none;"></iframe>
              </div>
              <div class="modal-footer">
                <a href="spinning-wheel-standalone.html" target="_blank" class="btn btn-primary">
                  <i class="fa fa-external-link"></i> Open in New Tab
                </a>
              </div>
            </div>
          </div>
        </div>

        <a href="#" id="back-to-top"></a>
        
        <!-- footer begin -->
        <footer class="text-light">
            <div class="container">
                <div class="row g-custom-x">
                    <div class="col-lg-3">
                        <div class="widget">
                            <h5>About PlusRent</h5>
                            <p>Where quality meets affordability. We understand the importance of a smooth and enjoyable journey without the burden of excessive costs. That's why we have meticulously crafted our offerings to provide you with top-notch vehicles at minimum expense.</p>
                        </div>
                    </div>
                    
                    <div class="col-lg-3">
                        <div class="widget">
                            <h5>Contact Info</h5>
                            <address class="s1">
                                <span><i class="id-color fa fa-map-marker fa-lg"></i>08 W 36th St, New York, NY 10001</span>
                                <span><i class="id-color fa fa-phone fa-lg"></i>+1 333 9296</span>
                                <span><i class="id-color fa fa-envelope-o fa-lg"></i><a href="mailto:contact@example.com">contact@example.com</a></span>
                                <span><i class="id-color fa fa-file-pdf-o fa-lg"></i><a href="#">Download Brochure</a></span>
                            </address>
                        </div>
                    </div>

                    <div class="col-lg-3">
                        <h5>Quick Links</h5>
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="widget">
                                    <ul>
                                        <li><a href="#">About</a></li>
                                        <li><a href="#">Blog</a></li>
                                        <li><a href="#">Careers</a></li>
                                        <li><a href="#">News</a></li>
                                        <li><a href="#">Partners</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3">
                        <div class="widget">
                            <h5>Social Network</h5>
                            <div class="social-icons">
                                <a href="#"><i class="fa fa-facebook fa-lg"></i></a>
                                <a href="#"><i class="fa fa-twitter fa-lg"></i></a>
                                <a href="#"><i class="fa fa-linkedin fa-lg"></i></a>
                                <a href="#"><i class="fa fa-pinterest fa-lg"></i></a>
                                <a href="#"><i class="fa fa-rss fa-lg"></i></a>
                            </div>
                        </div>    
                    </div>
                </div>
            </div>
            <div class="subfooter">
                <div class="container">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="de-flex">
                                <div class="de-flex-col">
                                    <a href="index.html">
                                        Copyright 2025 - PlusRent by Designesia
                                    </a>
                                </div>
                                <ul class="menu-simple">
                                                    <li><a href="#" data-i18n="footer.terms"></a></li>
                <li><a href="#" data-i18n="footer.privacy"></a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
        <!-- footer close -->
        
    </div>

    <!-- Custom Alert -->
    <div id="adminCustomAlert" style="display:none;position:fixed;top:32px;left:50%;transform:translateX(-50%);z-index:10002;min-width:320px;max-width:90vw;padding:16px 32px;border-radius:8px;font-size:1.1rem;font-weight:500;box-shadow:0 4px 24px rgba(0,0,0,0.12);background:#031B4E;color:#fff;text-align:center;transition:opacity 0.3s;opacity:0;"></div>

    <!-- Custom Delete Confirmation Overlay -->
    <div id="deleteConfirmationOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;backdrop-filter:blur(2px);">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:12px;padding:32px;min-width:400px;max-width:90vw;box-shadow:0 8px 32px rgba(0,0,0,0.2);">
            <h4 style="margin:0 0 16px 0;color:#333;font-weight:600;text-align:center;">Delete Coupon</h4>
            <p style="margin:0 0 24px 0;color:#666;text-align:center;line-height:1.5;">Are you sure you want to delete this coupon? This action cannot be undone.</p>
            <div style="display:flex;gap:12px;justify-content:center;">
                <button id="cancelDeleteBtn" onclick="handleCancelDelete()" style="padding:10px 20px;border:1px solid #ddd;background:white;color:#666;border-radius:6px;cursor:pointer;font-size:14px;transition:all 0.2s;">Cancel</button>
                <button id="confirmDeleteBtn" onclick="handleConfirmDelete()" style="padding:10px 20px;border:none;background:#dc3545;color:white;border-radius:6px;cursor:pointer;font-size:14px;transition:all 0.2s;">Delete Coupon</button>
            </div>
        </div>
    </div>


    <!-- Javascript Files
    ================================================== -->
    <script src="js/plugins.js"></script>
    <script src="js/designesia.js"></script>
    <script src="js/config.js"></script>
<script>
// Fallback API_BASE_URL configuration in case config.js doesn't load properly
if (!window.API_BASE_URL) {
  const hostname = window.location.hostname;
  const protocol = window.location.protocol;
  const port = window.location.port;
  
  if (hostname === 'localhost' || hostname === '127.0.0.1') {
    window.API_BASE_URL = `${protocol}//${hostname}:${port || '3000'}`;
  } else {
    window.API_BASE_URL = `${protocol}//${hostname}${port ? ':' + port : ''}`;
  }
  console.log('🔧 Fallback API Base URL configured as:', window.API_BASE_URL);
}
</script>
    <script>
        // Authentication check
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('adminToken');
            const user = localStorage.getItem('adminUser');
            
            if (!token || !user) {
                // Redirect to login if not authenticated
                window.location.href = '/login';
                return;
            }
            
            // Verify token is still valid
            fetch(`${window.API_BASE_URL}/api/auth/verify`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    // Token is invalid, redirect to login
                    localStorage.removeItem('adminToken');
                    localStorage.removeItem('adminUser');
                    window.location.href = '/login';
                }
            })
            .catch(error => {
                console.error('Token verification error:', error);
                // Network error, but we'll allow access for now
            });
            
            // Add logout functionality
            const logoutBtn = document.createElement('button');
            logoutBtn.textContent = 'Logout';
            logoutBtn.className = 'btn-main';
            logoutBtn.style.marginLeft = '10px';
            
            logoutBtn.addEventListener('click', function() {
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminUser');
                window.location.href = '/login';
            });
            
            // Add logout button to the menu_side_area
            const menuSideArea = document.querySelector('.menu_side_area');
            if (menuSideArea) {
                menuSideArea.appendChild(logoutBtn);
            }
        });
    </script>

    <!-- Global Booking Management Functions -->
    <script>
    // Global booking management functions
    async function approveBooking(bookingId, button) {
      if (!window.API_BASE_URL) {
        console.error('API_BASE_URL not defined');
        return;
      }
      
      // Find the booking card
      const bookingCard = button.closest('.booking-card');
      if (!bookingCard) return;
      
      // Add loading state to button
      button.classList.add('btn-loading');
      button.disabled = true;
      
      // Add approving animation to card
      bookingCard.classList.add('approving');
      
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${window.API_BASE_URL}/api/bookings/${bookingId}/confirm`, {
          method: 'PUT',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          // Success animation - slide out
          bookingCard.classList.remove('approving');
          bookingCard.classList.add('slide-out');
          
          // Remove card after animation
          setTimeout(() => {
            bookingCard.remove();
            // Refresh list if no more bookings
            const remainingCards = document.querySelectorAll('.booking-card');
            if (remainingCards.length === 0) {
              loadPendingBookings();
            }
          }, 300);
        } else {
          const error = await response.json();
          console.error('Error approving booking:', error.error);
          
          // Remove loading state
          bookingCard.classList.remove('approving');
          button.classList.remove('btn-loading');
          button.disabled = false;
        }
      } catch (error) {
        console.error('Error approving booking:', error);
        
        // Remove loading state
        bookingCard.classList.remove('approving');
        button.classList.remove('btn-loading');
        button.disabled = false;
      }
    }

    async function rejectBooking(bookingId, button) {
      if (!window.API_BASE_URL) {
        console.error('API_BASE_URL not defined');
        return;
      }
      
      // Find the booking card
      const bookingCard = button.closest('.booking-card');
      if (!bookingCard) return;
      
      // Add loading state to button
      button.classList.add('btn-loading');
      button.disabled = true;
      
      // Add rejecting animation to card
      bookingCard.classList.add('rejecting');
      
      const reason = ''; // No prompt needed
      
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${window.API_BASE_URL}/api/bookings/${bookingId}/reject`, {
          method: 'PUT',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ reason: reason || 'No reason provided' })
        });
        
        if (response.ok) {
          // Success animation - slide out
          bookingCard.classList.remove('rejecting');
          bookingCard.classList.add('slide-out');
          
          // Remove card after animation
          setTimeout(() => {
            bookingCard.remove();
            // Refresh list if no more bookings
            const remainingCards = document.querySelectorAll('.booking-card');
            if (remainingCards.length === 0) {
              loadAllBookings();
            }
          }, 300);
        } else {
          const error = await response.json();
          console.error('Error rejecting booking:', error.error);
          
          // Remove loading state
          bookingCard.classList.remove('rejecting');
          button.classList.remove('btn-loading');
          button.disabled = false;
        }
      } catch (error) {
        console.error('Error rejecting booking:', error);
        
        // Remove loading state
        bookingCard.classList.remove('rejecting');
        button.classList.remove('btn-loading');
        button.disabled = false;
      }
    }

    async function cancelBooking(bookingId, button) {
      if (!window.API_BASE_URL) {
        console.error('API_BASE_URL not defined');
        return;
      }
      
      // Confirm cancellation
      if (!confirm('Are you sure you want to cancel this booking? This action cannot be undone.')) {
        return;
      }
      
      // Find the booking card
      const bookingCard = button.closest('.booking-card');
      if (!bookingCard) return;
      
      // Add loading state to button
      button.classList.add('btn-loading');
      button.disabled = true;
      
      // Add cancelling animation to card
      bookingCard.classList.add('cancelling');
      
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${window.API_BASE_URL}/api/bookings/${bookingId}/cancel`, {
          method: 'PUT',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          // Success animation - slide out
          bookingCard.classList.remove('cancelling');
          bookingCard.classList.add('slide-out');
          
          // Remove card after animation
          setTimeout(() => {
            bookingCard.remove();
            // Refresh list if no more bookings
            const remainingCards = document.querySelectorAll('.booking-card');
            if (remainingCards.length === 0) {
              loadAllBookings();
            }
          }, 300);
          
          showCustomAlert('Booking cancelled successfully', 'success');
        } else {
          const error = await response.json();
          console.error('Error cancelling booking:', error.error);
          showCustomAlert('Error cancelling booking: ' + error.error, 'error');
          
          // Remove loading state
          bookingCard.classList.remove('cancelling');
          button.classList.remove('btn-loading');
          button.disabled = false;
        }
      } catch (error) {
        console.error('Error cancelling booking:', error);
        showCustomAlert('Error cancelling booking', 'error');
        
        // Remove loading state
        bookingCard.classList.remove('cancelling');
        button.classList.remove('btn-loading');
        button.disabled = false;
      }
    }

    // Global alert function
    function showCustomAlert(message, type = 'info') {
      const alert = document.getElementById('adminCustomAlert');
      if (!alert) return;
      
      alert.textContent = message;
      alert.style.background = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#031B4E';
      alert.style.display = 'block';
      alert.style.opacity = '1';
      
      setTimeout(() => {
        alert.style.opacity = '0';
        setTimeout(() => {
          alert.style.display = 'none';
        }, 300);
      }, 3000);
    }

    // Global variables for pagination
    let allBookings = [];
    let currentFilter = 'all';
    let currentPage = 1;
    const bookingsPerPage = 10;
    let isLoading = false;
    
    // Global function to load all bookings with status filtering and pagination
    async function loadAllBookings(statusFilter = 'all', page = 1) {
      if (!window.API_BASE_URL) {
        console.error('API_BASE_URL not defined');
        return;
      }
      
      if (isLoading) return;
      
      try {
        isLoading = true;
        
        const bookingsList = document.getElementById('bookingsList');
        if (!bookingsList) return;
        
        // Show loading indicator
        bookingsList.innerHTML = `
          <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading bookings...</p>
          </div>
        `;
        
        const response = await fetch(`${window.API_BASE_URL}/api/bookings`);
        const bookings = await response.json();
        
        // Store all bookings globally
        allBookings = bookings;
        currentFilter = statusFilter;
        currentPage = page;
        
        // Filter bookings based on status
        let filteredBookings = bookings;
        if (statusFilter !== 'all') {
          filteredBookings = bookings.filter(booking => booking.status === statusFilter);
        }
        
        if (filteredBookings.length === 0) {
          const statusText = statusFilter === 'all' ? 'bookings' : `${statusFilter} bookings`;
          bookingsList.innerHTML = `<div class="col-12"><div class="alert alert-info">No ${statusText} found.</div></div>`;
          document.getElementById('paginationControls').innerHTML = '';
          return;
        }
        
        // Render paginated bookings
        renderPaginatedBookings(filteredBookings);
        
      } catch (error) {
        console.error('Error loading bookings:', error);
        document.getElementById('bookingsList').innerHTML = '<div class="col-12"><div class="alert alert-danger">Error loading bookings.</div></div>';
      } finally {
        isLoading = false;
      }
    }
    
    // Function to render paginated bookings
    function renderPaginatedBookings(bookings) {
      const startIndex = (currentPage - 1) * bookingsPerPage;
      const endIndex = startIndex + bookingsPerPage;
      const paginatedBookings = bookings.slice(startIndex, endIndex);
      
      // Render bookings
      renderBookings(paginatedBookings);
      
      // Render pagination controls
      renderPaginationControls(bookings.length);
    }
    
    // Function to render pagination controls
    function renderPaginationControls(totalBookings) {
      const totalPages = Math.ceil(totalBookings / bookingsPerPage);
      
      if (totalPages <= 1) {
        document.getElementById('paginationControls').innerHTML = '';
        return;
      }
      
      const paginationHTML = `
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="pagination-info">
            <small class="text-muted">
              Showing ${(currentPage - 1) * bookingsPerPage + 1} to ${Math.min(currentPage * bookingsPerPage, totalBookings)} of ${totalBookings} bookings
            </small>
          </div>
          <div class="pagination-controls">
            <button class="btn btn-outline-primary btn-sm" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
              <i class="fa fa-chevron-left"></i> Previous
            </button>
            <span class="mx-2">
              Page ${currentPage} of ${totalPages}
            </span>
            <button class="btn btn-outline-primary btn-sm" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
              Next <i class="fa fa-chevron-right"></i>
            </button>
          </div>
        </div>
      `;
      
      document.getElementById('paginationControls').innerHTML = paginationHTML;
    }
    
    // Function to change page
    function changePage(page) {
      if (page < 1) return;
      
      // Filter bookings based on current filter
      let filteredBookings = allBookings;
      if (currentFilter !== 'all') {
        filteredBookings = allBookings.filter(booking => booking.status === currentFilter);
      }
      
      const totalPages = Math.ceil(filteredBookings.length / bookingsPerPage);
      if (page > totalPages) return;
      
      currentPage = page;
      renderPaginatedBookings(filteredBookings);
      
      // Scroll to top of bookings list
      document.getElementById('bookingsList').scrollIntoView({ behavior: 'smooth' });
    }
        

    
    // Function to render bookings (extracted from the map function)
    function renderBookings(bookings) {
      const bookingsList = document.getElementById('bookingsList');
      if (!bookingsList) return;
      
      const bookingCardsHTML = bookings.map(booking => {
        // Get status badge color
        const statusColors = {
          'pending': 'warning',
          'confirmed': 'success',
          'cancelled': 'danger',
          'rejected': 'secondary',
          'finished': 'info'
        };
        const statusColor = statusColors[booking.status] || 'info';
        
        // Generate action buttons based on status
        let actionButtons = '';
        if (booking.status === 'pending') {
          actionButtons = `
            <button class="btn btn-success mb-2 btn-approve" onclick="approveBooking(${booking.id}, this)">
              <i class="fa fa-check"></i> Approve
            </button>
            <button class="btn btn-danger btn-reject" onclick="rejectBooking(${booking.id}, this)">
              <i class="fa fa-times"></i> Reject
            </button>
          `;
        } else if (booking.status === 'confirmed') {
          actionButtons = `
            <button class="btn btn-warning btn-cancel" onclick="cancelBooking(${booking.id}, this)">
              <i class="fa fa-ban"></i> Cancel
            </button>
          `;
        } else if (booking.status === 'finished') {
          actionButtons = `
            <div class="rental-completed-badge" style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 8px 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3); border: 1px solid rgba(255,255,255,0.2);">
              <div style="display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 11px; font-weight: 600;">
                <i class="fa fa-flag-checkered" style="font-size: 12px;"></i>
                <span>Rental Completed</span>
              </div>
              <div style="font-size: 9px; opacity: 0.9; margin-top: 2px; font-weight: 400;">
                ✓ Successfully finished
              </div>
            </div>
          `;
        }
        
        return `
          <div class="col-12">
            <div class="card booking-card" data-booking-id="${booking.id}">
              <div class="card-body">
                <div class="row align-items-start">
                  <div class="col-md-3">
                    ${booking.cars && booking.cars.head_image ? 
                      `<div class="mb-2">
                        <img src="${booking.cars.head_image}" alt="Car Image" class="img-fluid rounded" style="max-width: 180px; max-height: 120px; object-fit: cover;">
                      </div>` : 
                      ''
                    }
                  </div>
                  <div class="col-md-6">
                    <h5 class="card-title">
                      ${booking.cars ? `${booking.cars.make_name} ${booking.cars.model_name} (${booking.cars.production_year})` : `Car ID: ${booking.car_id}`}
                      <span class="badge bg-${statusColor} ms-2">${booking.status.toUpperCase()}</span>
                    </h5>
                    <p class="card-text">
                      <strong>Dates:</strong> ${booking.pickup_date} ${booking.pickup_time} - ${booking.return_date} ${booking.return_time}<br>
                      
                      <strong>Pickup:</strong> ${booking.pickup_location} | <strong>Dropoff:</strong> ${booking.dropoff_location}<br>
                      <strong>Total Price:</strong> €${booking.total_price}<br>
                      ${booking.discount_code ? `<strong>Coupon Code:</strong> <code>${booking.discount_code}</code><br>` : ''}
                      <strong>Contact:</strong> ${booking.customer_name || 'Not provided'} | ${booking.customer_phone || 'Not provided'} | Age: ${booking.customer_age || 'Not provided'}<br>
                      <strong>Special Instructions:</strong> ${booking.special_instructions || 'None'}<br>
                      <strong>Created:</strong> ${new Date(booking.created_at).toLocaleString()}
                    </p>
                  </div>
                  <div class="col-md-3 text-end">
                    <div class="btn-group-vertical w-100">
                      ${actionButtons}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      bookingsList.innerHTML = bookingCardsHTML;
    }

    // Function to load pending bookings (for backward compatibility)
    async function loadPendingBookings() {
      await loadAllBookings('pending');
    }



    // Tab Navigation
    function initializeTabs() {
      const tabButtons = document.querySelectorAll('.admin-tab-btn');
      const tabContents = document.querySelectorAll('.admin-tab-content');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', function() {
          const targetTab = this.getAttribute('data-tab');
          
          // Remove active class from all buttons and contents
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          
          // Add active class to clicked button and corresponding content
          this.classList.add('active');
          document.getElementById(targetTab + '-tab').classList.add('active');
        });
      });
    }

    // Initialize Form Dropdowns
    function initializeFormDropdowns() {
      // Production Year dropdown (current year to 1990)
      const productionYearSelects = document.querySelectorAll('select[name="production_year"]');
      const currentYear = new Date().getFullYear();
      productionYearSelects.forEach(select => {
        // Clear existing options first
        select.innerHTML = '<option value="">Select Year</option>';
        for (let year = currentYear; year >= 1990; year--) {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          select.appendChild(option);
        }
      });
      
      // Number of Doors dropdown
      const numDoorsSelects = document.querySelectorAll('select[name="num_doors"]');
      numDoorsSelects.forEach(select => {
        // Clear existing options first
        select.innerHTML = '<option value="">Select Doors</option>';
        const doorOptions = ['2', '3', '4', '5'];
        doorOptions.forEach(doors => {
          const option = document.createElement('option');
          option.value = doors;
          option.textContent = doors;
          select.appendChild(option);
        });
      });
      
      // Number of Passengers dropdown
      const numPassengersSelects = document.querySelectorAll('select[name="num_passengers"]');
      numPassengersSelects.forEach(select => {
        // Clear existing options first
        select.innerHTML = '<option value="">Select Passengers</option>';
        const passengerOptions = ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15'];
        passengerOptions.forEach(passengers => {
          const option = document.createElement('option');
          option.value = passengers;
          option.textContent = passengers;
          select.appendChild(option);
        });
      });

      // Luggage dropdown
      const luggageSelects = document.querySelectorAll('select[name="luggage"]');
      luggageSelects.forEach(select => {
        const luggageOptions = [
          { value: '1_small', text: '1 Small Suitcase' },
          { value: '2_small', text: '2 Small Suitcases' },
          { value: '1_large', text: '1 Large Suitcase' },
          { value: '2_large', text: '2 Large Suitcases' },
          { value: '3_large', text: '3 Large Suitcases' },
          { value: '1_small_1_large', text: '1 Small + 1 Large Suitcase' },
          { value: '2_small_1_large', text: '2 Small + 1 Large Suitcase' },
          { value: '1_small_2_large', text: '1 Small + 2 Large Suitcases' },
          { value: '2_small_2_large', text: '2 Small + 2 Large Suitcases' },
          { value: '3_small_1_large', text: '3 Small + 1 Large Suitcase' },
          { value: '4_small', text: '4 Small Suitcases' },
          { value: '5_small', text: '5 Small Suitcases' },
          { value: '4_large', text: '4 Large Suitcases' },
          { value: '5_large', text: '5 Large Suitcases' }
        ];
        luggageOptions.forEach(option => {
          const optionElement = document.createElement('option');
          optionElement.value = option.value;
          optionElement.textContent = option.text;
          select.appendChild(optionElement);
        });
      });

      // Drive type dropdown
      const driveSelects = document.querySelectorAll('select[name="drive"]');
      driveSelects.forEach(select => {
        const driveOptions = [
          { value: 'front_wheel', text: 'Front Wheel Drive' },
          { value: 'rear_wheel', text: 'Rear Wheel Drive' },
          { value: 'all_wheel', text: 'All Wheel Drive' },
          { value: 'four_wheel', text: '4-Wheel Drive' }
        ];
        driveOptions.forEach(option => {
          const optionElement = document.createElement('option');
          optionElement.value = option.value;
          optionElement.textContent = option.text;
          select.appendChild(optionElement);
        });
      });
    }

    // Car Management Functions
    async function loadCars() {
      if (!window.API_BASE_URL) {
        console.error('API_BASE_URL not defined');
        return;
      }
      
      try {
        const response = await fetch(`${window.API_BASE_URL}/api/cars`);
        const cars = await response.json();
        
        const carCards = document.getElementById('carCards');
        if (!carCards) return;
        
        if (cars.length === 0) {
          carCards.innerHTML = '<div class="col-12"><div class="alert alert-info">No cars found. Add your first car!</div></div>';
          return;
        }
        
                    carCards.innerHTML = cars.map((car, index) => {
                      const isUnavailable = car.booked_until && new Date(car.booked_until) > new Date();
                      let badge = '';
                      if (isUnavailable && car.booked_until) {
                        const d = new Date(car.booked_until);
                        const options = { day: '2-digit', month: 'short', year: 'numeric' };
                        const formatted = d.toLocaleDateString(undefined, options).toUpperCase();
                        badge = `<div class="unavailable-badge">UNAVAILABLE UNTIL ${formatted}</div>`;
                      }
                      const isPremium = car.is_premium === 1 || car.is_premium === true;
                      return `
                                <div class="col-xl-4 col-lg-4 col-md-6">
                                    <div class="de-item mb30 car-card${isPremium ? ' premium' : ''}" draggable="true" data-car-id="${car.id}" data-car-index="${index}">
              <div class="admin-controls">
                <div class="order-indicator">${index + 1}</div>
                <div class="drag-handle" title="Drag to reorder">
                  <svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#7499e2">
                    <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                    <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC" stroke-width="0.048"></g>
                    <g id="SVGRepo_iconCarrier">
                      <path d="M16.1924 5.65683C16.5829 5.2663 16.5829 4.63314 16.1924 4.24261L13.364 1.41419C12.5829 0.633139 11.3166 0.633137 10.5355 1.41419L7.70711 4.24261C7.31658 4.63314 7.31658 5.2663 7.70711 5.65683C8.09763 6.04735 8.73079 6.04735 9.12132 5.65683L11 3.77812V11.0503H3.72784L5.60655 9.17157C5.99707 8.78104 5.99707 8.14788 5.60655 7.75735C5.21602 7.36683 4.58286 7.36683 4.19234 7.75735L1.36391 10.5858C0.582863 11.3668 0.582859 12.6332 1.36391 13.4142L4.19234 16.2426C4.58286 16.6332 5.21603 16.6332 5.60655 16.2426C5.99707 15.8521 5.99707 15.219 5.60655 14.8284L3.8284 13.0503H11V20.2219L9.12132 18.3432C8.73079 17.9526 8.09763 17.9526 7.7071 18.3432C7.31658 18.7337 7.31658 19.3669 7.7071 19.7574L10.5355 22.5858C11.3166 23.3669 12.5829 23.3669 13.364 22.5858L16.1924 19.7574C16.5829 19.3669 16.5829 18.7337 16.1924 18.3432C15.8019 17.9526 15.1687 17.9526 14.7782 18.3432L13 20.1213V13.0503H20.071L18.2929 14.8284C17.9024 15.219 17.9024 15.8521 18.2929 16.2426C18.6834 16.6332 19.3166 16.6332 19.7071 16.2426L22.5355 13.4142C23.3166 12.6332 23.3166 11.3668 22.5355 10.5858L19.7071 7.75735C19.3166 7.36683 18.6834 7.36683 18.2929 7.75735C17.9024 8.14788 17.9024 8.78104 18.2929 9.17157L20.1716 11.0503H13V3.87867L14.7782 5.65683C15.1687 6.04735 15.8019 6.04735 16.1924 5.65683Z" fill="#7499e2"></path>
                    </g>
                  </svg>
                </div>
                <button class="premium-toggle${isPremium ? ' active' : ''}" onclick="togglePremium(${car.id}, ${!isPremium})" title="${isPremium ? 'Remove Premium' : 'Make Premium'}">
                  ${isPremium ? '★' : '☆'}
                </button>
              </div>
          <div class="d-img${isUnavailable ? ' img-unavailable' : ''}">
            <img src="${car.head_image && car.head_image.startsWith('http') ? car.head_image : (car.head_image ? window.API_BASE_URL + car.head_image : window.API_BASE_URL + '/uploads/placeholder.png')}" class="img-fluid" alt="">
            ${badge}
            ${isPremium ? '<div class="premium-badge">PREMIUM</div>' : ''}
                                        </div>
                                        <div class="d-info">
                                            <div class="d-text">
              <h4>${formatDisplayText(car.make_name)}</h4>
              <p>${formatDisplayText(car.model_name)}</p>
                                                <div class="d-item_like">
                <i class="fa fa-heart"></i><span>${car.likes || 0}</span>
                                        </div>
                                        <div class="d-atr-group">
                <span class="d-atr"><img src="images/icons/1-green.svg" alt=""><span>Passengers</span> ${car.num_passengers || '-'}</span>
                <span class="d-atr"><img src="images/icons/2-green.svg" alt=""><span>Doors</span> ${car.num_doors || '-'}</span>
                <span class="d-atr"><img src="images/icons/3-green.svg" alt="">${getMappedDisplayText('luggage', car.luggage)}</span>
                <span class="d-atr"><img src="images/icons/4-green.svg" alt="">${car.car_type || '-'}</span>
                                                </div>
              <div class="d-price">Daily rate from <span>${car.price_policy ? car.price_policy['1-2'] + '€' : ''}</span></div>
              <div class="admin-actions">
                <button class="btn btn-main btn-sm edit-car-btn" onclick="editCar(${car.id})">Edit</button>
                <button class="btn btn-danger btn-sm delete-car-btn" onclick="deleteCar(${car.id})">Delete</button>
              </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
    `;
                    }).join('');
        
        // Initialize drag and drop functionality
        initializeDragAndDrop();
        
      } catch (error) {
        console.error('Error loading cars:', error);
        document.getElementById('carCards').innerHTML = '<div class="col-12"><div class="alert alert-danger">Error loading cars.</div></div>';
      }
    }

    // Drag and Drop Functionality
    function initializeDragAndDrop() {
      const carCards = document.querySelectorAll('.car-card');
      
      carCards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
        card.addEventListener('dragover', handleDragOver);
        card.addEventListener('dragenter', handleDragEnter);
        card.addEventListener('dragleave', handleDragLeave);
        card.addEventListener('drop', handleDrop);
      });
    }

    function handleDragStart(e) {
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.outerHTML);
    }

    function handleDragEnd(e) {
      this.classList.remove('dragging');
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }

    function handleDragEnter(e) {
      e.preventDefault();
      this.classList.add('drag-over');
    }

    function handleDragLeave(e) {
      this.classList.remove('drag-over');
    }

    function handleDrop(e) {
      e.preventDefault();
      this.classList.remove('drag-over');
      
      const draggedCard = document.querySelector('.dragging');
      if (!draggedCard) return;
      
      const carCards = Array.from(document.querySelectorAll('.car-card'));
      const draggedIndex = carCards.indexOf(draggedCard);
      const droppedIndex = carCards.indexOf(this);
      
      if (draggedIndex === droppedIndex) return;
      
      // Get new order
      const newOrder = getNewCarOrder(draggedIndex, droppedIndex);
      
      // Update car order in database
      updateCarOrder(newOrder);
    }

    function getNewCarOrder(draggedIndex, droppedIndex) {
      const carCards = Array.from(document.querySelectorAll('.car-card'));
      const carIds = carCards.map(card => parseInt(card.dataset.carId));
      
      const draggedId = carIds[draggedIndex];
      carIds.splice(draggedIndex, 1);
      carIds.splice(droppedIndex, 0, draggedId);
      
      return carIds;
    }

    async function updateCarOrder(newOrder) {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${window.API_BASE_URL}/api/cars/reorder`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ carOrder: newOrder })
        });
        
        if (response.ok) {
          // Reload cars to reflect new order
          loadCars();
        } else {
          console.error('Failed to update car order');
        }
      } catch (error) {
        console.error('Error updating car order:', error);
      }
    }

    // Coupon Management Functions
    async function loadCoupons() {
      
      if (!window.API_BASE_URL) {
        console.error('API_BASE_URL not defined');
        return;
      }
      
      try {
        const response = await fetch(`${window.API_BASE_URL}/api/coupons`);
        const coupons = await response.json();
        
        
        const couponCards = document.getElementById('couponCards');
        if (!couponCards) return;
        
        if (coupons.length === 0) {
          couponCards.innerHTML = '<div class="col-12"><div class="alert alert-info">No coupon codes found. Add your first coupon!</div></div>';
          return;
        }
        
        couponCards.innerHTML = coupons.map(coupon => {
          // Check if coupon has active codes
          const availableCodes = JSON.parse(coupon.available_codes || '[]');
          const hasActiveCodes = availableCodes.length > 0;
          
          return `
          <div class="col-md-6 col-lg-4">
            <div class="coupon-card">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <h5 class="card-title mb-0">${coupon.code}</h5>
                <span class="coupon-status ${coupon.is_active ? 'active' : 'inactive'}">
                  ${coupon.is_active ? 'Active' : 'Inactive'}
                </span>
              </div>
              <p class="card-text">
                <strong>${coupon.type === 'free_days' ? 'Free Days:' : 'Discount:'}</strong> 
                ${coupon.type === 'free_days' ? `${coupon.free_days} ${coupon.free_days === 1 ? 'Day Free' : 'Days Free'}` : `${coupon.discount_percentage}%`}<br>
                <strong>Description:</strong> ${coupon.description || 'No description'}<br>
                ${coupon.expires_at ? `<strong>Expires:</strong> ${new Date(coupon.expires_at).toLocaleDateString()}` : ''}
              </p>
              ${!hasActiveCodes ? `
              <div class="mb-3">
                <span class="badge bg-warning text-dark">
                  <i class="fa fa-exclamation-triangle"></i> No active codes
                </span>
              </div>
              ` : ''}
              <div class="d-flex gap-2">
                <button class="btn btn-primary btn-sm" onclick="editCoupon(${coupon.id})">
                  <i class="fa fa-edit"></i> Edit
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteCoupon(${coupon.id})">
                  <i class="fa fa-trash"></i> Delete
                </button>
              </div>
            </div>
          </div>
        `;
        }).join('');
        
      } catch (error) {
        console.error('Error loading coupons:', error);
        document.getElementById('couponCards').innerHTML = '<div class="col-12"><div class="alert alert-danger">Error loading coupons.</div></div>';
      }
    }

    // Form Handlers
    function initializeCarForms() {
      // Populate dropdown options
      function populateDropdowns() {
        // Production year dropdown (current year to 1990)
        const productionYearSelects = document.querySelectorAll('select[name="production_year"]');
        productionYearSelects.forEach(select => {
          if (select.children.length === 0) {
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= 1990; year--) {
              const option = document.createElement('option');
              option.value = year;
              option.textContent = year;
              select.appendChild(option);
            }
          }
        });

        // Number of doors dropdown
        const numDoorsSelects = document.querySelectorAll('select[name="num_doors"]');
        numDoorsSelects.forEach(select => {
          if (select.children.length === 0) {
            for (let doors = 2; doors <= 5; doors++) {
              const option = document.createElement('option');
              option.value = doors;
              option.textContent = doors;
              select.appendChild(option);
            }
          }
        });

        // Number of passengers dropdown
        const numPassengersSelects = document.querySelectorAll('select[name="num_passengers"]');
        numPassengersSelects.forEach(select => {
          if (select.children.length === 0) {
            for (let passengers = 2; passengers <= 8; passengers++) {
              const option = document.createElement('option');
              option.value = passengers;
              option.textContent = passengers;
              select.appendChild(option);
            }
          }
        });

        // Populate car makes dropdown
        const makeSelects = document.querySelectorAll('select[name="make_name"]');
        makeSelects.forEach(select => {
          if (select.children.length <= 1) { // Only has "Select Make" option
            const makes = [
              'bmw', 'mercedes', 'audi', 'volkswagen', 'toyota', 'honda', 'ford', 'chevrolet', 
              'nissan', 'hyundai', 'kia', 'mazda', 'subaru', 'volvo', 'lexus', 'infiniti', 
              'acura', 'buick', 'cadillac', 'chrysler', 'dodge', 'jeep', 'ram', 'gmc', 
              'pontiac', 'saturn', 'oldsmobile', 'plymouth', 'eagle', 'tesla', 'ferrari', 
              'lamborghini', 'porsche', 'maserati', 'aston_martin', 'bentley', 'rolls_royce', 
              'mclaren', 'bugatti', 'koenigsegg', 'pagani', 'rimac', 'lotus', 'alpine', 
              'caterham', 'ariel', 'noble', 'radical', 'ultima', 'zenvo', 'gumpert', 
              'saleen', 'hennessey', 'callaway', 'ruf', 'techart', 'mansory', 'brabus', 
              'alpina', 'hamann', 'hartge', 'ac_schnitzer', 'dinan', 'vorsteiner', 'hre', 
              'adv_1', 'forgiato', 'vossen', 'rohana', 'titan7', 'volk', 'work', 'rays', 
              'enkei', 'bbs', 'oz', 'ssr', 'weds', 'gram_lights', 'volk_racing', 
              'work_emotion', 'volk_te37', 'volk_ce28', 'volk_re30', 'volk_gt_c', 
              'volk_gt_n', 'volk_gt_v', 'volk_gt_u', 'volk_gt_f', 'volk_gt_m', 'volk_gt_s', 
              'volk_gt_t', 'volk_gt_w', 'volk_gt_x', 'volk_gt_y', 'volk_gt_z'
            ];
            makes.forEach(makeKey => {
              const option = document.createElement('option');
              option.value = makeKey;
              option.textContent = makeKey.toUpperCase().replace('_', ' ');
              select.appendChild(option);
            });
          }
        });

        // Populate car models dropdown
        const modelSelects = document.querySelectorAll('select[name="model_name"]');
        modelSelects.forEach(select => {
          if (select.children.length <= 1) { // Only has "Select Model" option
            const models = [
              'bmw_3_series', 'bmw_5_series', 'bmw_7_series', 'bmw_x3', 'bmw_x5', 'bmw_x7', 
              'bmw_z4', 'bmw_m3', 'bmw_m5', 'bmw_m8', 'mercedes_c_class', 'mercedes_e_class', 
              'mercedes_s_class', 'mercedes_gla', 'mercedes_glc', 'mercedes_gle', 'mercedes_gls', 
              'mercedes_amg_gt', 'audi_a3', 'audi_a4', 'audi_a6', 'audi_a8', 'audi_q3', 
              'audi_q5', 'audi_q7', 'audi_q8', 'audi_rs6', 'audi_rs7', 'volkswagen_golf', 
              'volkswagen_passat', 'volkswagen_tiguan', 'volkswagen_atlas', 'volkswagen_id4', 
              'toyota_camry', 'toyota_corolla', 'toyota_rav4', 'toyota_highlander', 'toyota_prius', 
              'honda_civic', 'honda_accord', 'honda_crv', 'honda_pilot', 'ford_focus', 'ford_fusion', 
              'ford_escape', 'ford_explorer', 'chevrolet_cruze', 'chevrolet_malibu', 'chevrolet_equinox', 
              'chevrolet_tahoe', 'nissan_sentra', 'nissan_altima', 'nissan_rogue', 'nissan_murano', 
              'hyundai_elantra', 'hyundai_sonata', 'hyundai_tucson', 'hyundai_santa_fe', 'kia_forte', 
              'kia_optima', 'kia_sportage', 'kia_sorento', 'mazda_3', 'mazda_6', 'mazda_cx5', 
              'mazda_cx9', 'subaru_impreza', 'subaru_legacy', 'subaru_forester', 'subaru_outback', 
              'volvo_s60', 'volvo_s90', 'volvo_xc40', 'volvo_xc60', 'volvo_xc90', 'lexus_es', 
              'lexus_ls', 'lexus_rx', 'lexus_nx', 'lexus_gx', 'lexus_lx', 'infiniti_q50', 
              'infiniti_q70', 'infiniti_qx50', 'infiniti_qx60', 'acura_tlx', 'acura_rlx', 
              'acura_rdx', 'acura_mdx', 'buick_regal', 'buick_lacrosse', 'buick_encore', 
              'buick_enclave', 'cadillac_cts', 'cadillac_ct6', 'cadillac_xt4', 'cadillac_xt5', 
              'cadillac_escalade', 'chrysler_300', 'chrysler_pacifica', 'dodge_charger', 
              'dodge_challenger', 'dodge_durango', 'jeep_cherokee', 'jeep_grand_cherokee', 
              'jeep_wrangler', 'ram_1500', 'ram_2500', 'ram_3500', 'gmc_terrain', 'gmc_acadia', 
              'gmc_yukon', 'tesla_model_3', 'tesla_model_s', 'tesla_model_x', 'tesla_model_y', 
              'ferrari_f8', 'ferrari_sf90', 'ferrari_roma', 'lamborghini_huracan', 'lamborghini_aventador', 
              'lamborghini_urus', 'porsche_911', 'porsche_cayenne', 'porsche_macan', 'maserati_ghibli', 
              'maserati_quattroporte', 'maserati_levante', 'aston_martin_db11', 'aston_martin_vantage', 
              'aston_martin_dbs', 'bentley_continental', 'bentley_flying_spur', 'bentley_bentayga', 
              'rolls_royce_phantom', 'rolls_royce_ghost', 'rolls_royce_cullinan', 'mclaren_720s', 
              'mclaren_765lt', 'mclaren_artura', 'bugatti_chiron', 'bugatti_veyron', 'koenigsegg_jesko', 
              'koenigsegg_regera', 'pagani_huayra', 'pagani_zonda', 'rimac_nevera', 'lotus_emira', 
              'lotus_evija', 'alpine_a110', 'caterham_7', 'ariel_atom', 'noble_m600', 'radical_sr3', 
              'ultima_evo', 'zenvo_ts1', 'gumpert_apollo', 'saleen_s7', 'hennessey_venom', 
              'callaway_corvette', 'ruf_ctr', 'techart_gt_street', 'mansory_mercedes', 'brabus_mercedes', 
              'alpina_bmw', 'hamann_bmw', 'hartge_bmw', 'ac_schnitzer_bmw', 'dinan_bmw', 'vorsteiner_bmw', 
              'hre_wheels', 'adv_1_wheels', 'forgiato_wheels', 'vossen_wheels', 'rohana_wheels', 
              'titan7_wheels', 'volk_wheels', 'work_wheels', 'rays_wheels', 'enkei_wheels', 
              'bbs_wheels', 'oz_wheels', 'ssr_wheels', 'weds_wheels', 'gram_lights_wheels', 
              'volk_racing_wheels', 'work_emotion_wheels', 'volk_te37_wheels', 'volk_ce28_wheels', 
              'volk_re30_wheels', 'volk_gt_c_wheels', 'volk_gt_n_wheels', 'volk_gt_v_wheels', 
              'volk_gt_u_wheels', 'volk_gt_f_wheels', 'volk_gt_m_wheels', 'volk_gt_s_wheels', 
              'volk_gt_t_wheels', 'volk_gt_w_wheels', 'volk_gt_x_wheels', 'volk_gt_y_wheels', 
              'volk_gt_z_wheels'
            ];
            models.forEach(modelKey => {
              const option = document.createElement('option');
              option.value = modelKey;
              option.textContent = modelKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
              select.appendChild(option);
            });
          }
        });

        // Populate exterior colors dropdown
        const exteriorColorSelects = document.querySelectorAll('select[name="exterior_color"]');
        exteriorColorSelects.forEach(select => {
          if (select.children.length <= 1) { // Only has "Select Exterior Color" option
            const colors = [
              'white', 'black', 'silver', 'gray', 'red', 'blue', 'green', 'yellow', 'orange', 
              'purple', 'brown', 'beige', 'gold', 'bronze', 'copper', 'chrome', 'matte_black', 
              'matte_white', 'matte_gray', 'matte_red', 'matte_blue', 'matte_green', 'matte_yellow', 
              'matte_orange', 'matte_purple', 'matte_brown', 'matte_beige', 'matte_gold', 
              'matte_bronze', 'matte_copper', 'matte_chrome', 'pearl_white', 'pearl_black', 
              'pearl_silver', 'pearl_gray', 'pearl_red', 'pearl_blue', 'pearl_green', 'pearl_yellow', 
              'pearl_orange', 'pearl_purple', 'pearl_brown', 'pearl_beige', 'pearl_gold', 
              'pearl_bronze', 'pearl_copper', 'pearl_chrome', 'metallic_white', 'metallic_black', 
              'metallic_silver', 'metallic_gray', 'metallic_red', 'metallic_blue', 'metallic_green', 
              'metallic_yellow', 'metallic_orange', 'metallic_purple', 'metallic_brown', 'metallic_beige', 
              'metallic_gold', 'metallic_bronze', 'metallic_copper', 'metallic_chrome', 'candy_white', 
              'candy_black', 'candy_silver', 'candy_gray', 'candy_red', 'candy_blue', 'candy_green', 
              'candy_yellow', 'candy_orange', 'candy_purple', 'candy_brown', 'candy_beige', 'candy_gold', 
              'candy_bronze', 'candy_copper', 'candy_chrome', 'chameleon_white', 'chameleon_black', 
              'chameleon_silver', 'chameleon_gray', 'chameleon_red', 'chameleon_blue', 'chameleon_green', 
              'chameleon_yellow', 'chameleon_orange', 'chameleon_purple', 'chameleon_brown', 'chameleon_beige', 
              'chameleon_gold', 'chameleon_bronze', 'chameleon_copper', 'chameleon_chrome'
            ];
            colors.forEach(colorKey => {
              const option = document.createElement('option');
              option.value = colorKey;
              option.textContent = colorKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
              select.appendChild(option);
            });
          }
        });

        // Populate interior colors dropdown
        const interiorColorSelects = document.querySelectorAll('select[name="interior_color"]');
        interiorColorSelects.forEach(select => {
          if (select.children.length <= 1) { // Only has "Select Interior Color" option
            const colors = [
              'white', 'black', 'silver', 'gray', 'red', 'blue', 'green', 'yellow', 'orange', 
              'purple', 'brown', 'beige', 'gold', 'bronze', 'copper', 'chrome', 'matte_black', 
              'matte_white', 'matte_gray', 'matte_red', 'matte_blue', 'matte_green', 'matte_yellow', 
              'matte_orange', 'matte_purple', 'matte_brown', 'matte_beige', 'matte_gold', 
              'matte_bronze', 'matte_copper', 'matte_chrome', 'pearl_white', 'pearl_black', 
              'pearl_silver', 'pearl_gray', 'pearl_red', 'pearl_blue', 'pearl_green', 'pearl_yellow', 
              'pearl_orange', 'pearl_purple', 'pearl_brown', 'pearl_beige', 'pearl_gold', 
              'pearl_bronze', 'pearl_copper', 'pearl_chrome', 'metallic_white', 'metallic_black', 
              'metallic_silver', 'metallic_gray', 'metallic_red', 'metallic_blue', 'metallic_green', 
              'metallic_yellow', 'metallic_orange', 'metallic_purple', 'metallic_brown', 'metallic_beige', 
              'metallic_gold', 'metallic_bronze', 'metallic_copper', 'metallic_chrome', 'candy_white', 
              'candy_black', 'candy_silver', 'candy_gray', 'candy_red', 'candy_blue', 'candy_green', 
              'candy_yellow', 'candy_orange', 'candy_purple', 'candy_brown', 'candy_beige', 'candy_gold', 
              'candy_bronze', 'candy_copper', 'candy_chrome', 'chameleon_white', 'chameleon_black', 
              'chameleon_silver', 'chameleon_gray', 'chameleon_red', 'chameleon_blue', 'chameleon_green', 
              'chameleon_yellow', 'chameleon_orange', 'chameleon_purple', 'chameleon_brown', 'chameleon_beige', 
              'chameleon_gold', 'chameleon_bronze', 'chameleon_copper', 'chameleon_chrome'
            ];
            colors.forEach(colorKey => {
              const option = document.createElement('option');
              option.value = colorKey;
              option.textContent = colorKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
              select.appendChild(option);
            });
          }
        });

        // Populate luggage dropdown
        const luggageSelects = document.querySelectorAll('select[name="luggage"]');
        luggageSelects.forEach(select => {
          if (select.children.length <= 1) { // Only has "Select Luggage Capacity" option
            const capacities = [
              'small', 'medium', 'large', 'extra_large'
            ];
            capacities.forEach(capacityKey => {
              const option = document.createElement('option');
              option.value = capacityKey;
              option.textContent = capacityKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
              select.appendChild(option);
            });
          }
        });
      }

      // Call populateDropdowns on page load
      populateDropdowns();

          // Unsaved changes confirmation modal
    function showUnsavedChangesConfirmation(panelType) {
      // Check if modal already exists and remove it
      const existingModal = document.querySelector('.unsaved-changes-modal');
      if (existingModal) {
        existingModal.remove();
      }
      
      const modal = document.createElement('div');
      modal.className = 'unsaved-changes-modal';
      modal.innerHTML = `
        <div class="unsaved-changes-content">
          <h3>Unsaved Changes</h3>
          <p>You have unsaved changes. Are you sure you want to close without saving?</p>
          <div class="unsaved-changes-buttons">
            <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
            <button class="btn btn-danger" id="confirmBtn">Close Without Saving</button>
          </div>
        </div>
      `;
      
      // Add styles
      const style = document.createElement('style');
      style.textContent = `
        .unsaved-changes-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        }
        .unsaved-changes-content {
          background: white;
          padding: 30px;
          border-radius: 8px;
          max-width: 400px;
          text-align: center;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .unsaved-changes-content h3 {
          margin-bottom: 15px;
          color: #333;
        }
        .unsaved-changes-content p {
          margin-bottom: 25px;
          color: #666;
        }
        .unsaved-changes-buttons {
          display: flex;
          gap: 10px;
          justify-content: center;
        }
        .unsaved-changes-buttons .btn {
          padding: 10px 20px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-weight: 500;
        }
        .unsaved-changes-buttons .btn-secondary {
          background: #6c757d;
          color: white;
        }
        .unsaved-changes-buttons .btn-danger {
          background: #dc3545;
          color: white;
        }
        .unsaved-changes-buttons .btn:hover {
          opacity: 0.9;
        }
      `;
      document.head.appendChild(style);
      document.body.appendChild(modal);
      
      // Add event listeners after modal is created
      const cancelBtn = modal.querySelector('#cancelBtn');
      const confirmBtn = modal.querySelector('#confirmBtn');
      
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          modal.remove();
          // Don't close the edit car form - just close the modal and keep the form open
        });
      }
      
      if (confirmBtn) {
        confirmBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          modal.remove();
          
          if (panelType === 'addCarPanel') {
            closeAddCarPanelFunction();
          } else if (panelType === 'editCarPanel') {
            closeEditCarPanelFunction();
          }
        });
      }
    }



    // Check if form has unsaved changes
    function hasUnsavedChanges(formId) {
      const form = document.getElementById(formId);
      if (!form) {
        return false;
      }
      
      // Check if any input has been modified
      const inputs = form.querySelectorAll('input, select, textarea');
      
      for (let input of inputs) {
        if (input.type === 'file') continue; // Skip file inputs
        
        // For add car form, any non-empty value indicates unsaved changes
        if (formId === 'carForm') {
          // Check for both text inputs and select dropdowns
          // Only consider it a change if it's not empty AND not a default/placeholder value
          if (input.value && input.value !== '' && 
              input.value !== 'Select Make' && input.value !== 'Select Model' && 
              input.value !== 'Select Production Year' && input.value !== 'Select Gear Type' && 
              input.value !== 'Select Fuel Type' && input.value !== 'Select Car Type' && 
              input.value !== 'Select Number of Doors' && input.value !== 'Select Number of Passengers' &&
              input.value !== 'Automatic' && input.value !== 'Gasoline' && input.value !== 'Crossover' &&
              input.value !== '0') {
            return true;
          }
        } else {
          // For edit car form, check if the value has changed from the original
          if (input.dataset.originalValue !== undefined) {
            if (input.value !== input.dataset.originalValue) {
              return true;
            }
          }
          // If no original value is set, assume no changes (don't show modal)
          // This prevents false positives when original values haven't been stored yet
        }
      }
      
      // Check for image previews
      if (formId === 'addCarForm') {
        const headImagePreview = document.getElementById('addHeadImagePreview');
        const galleryImagesPreview = document.getElementById('addGalleryImagesPreview');
        
        // Check if new images were uploaded
        const headImageInput = document.getElementById('addHeadImageInput');
        const galleryImagesInput = document.getElementById('addGalleryImagesInput');
        
        if (headImageInput && headImageInput.files.length > 0) return true;
        if (galleryImagesInput && galleryImagesInput.files.length > 0) return true;
        
        // Check if images were added to preview
        if (headImagePreview && headImagePreview.innerHTML !== '') return true;
        if (galleryImagesPreview && galleryImagesPreview.innerHTML !== '') return true;
        

      } else if (formId === 'editCarForm') {
        // For edit car form, only check if new images were added (not existing ones)
        const headImageInput = document.getElementById('editHeadImageInput');
        const galleryImagesInput = document.getElementById('editGalleryImagesInput');
        
        // Check if new files were selected
        if (headImageInput && headImageInput.files.length > 0) {
          return true;
        }
        if (galleryImagesInput && galleryImagesInput.files.length > 0) {
          return true;
        }
        
        // Check if images were removed from preview (indicating deletion)
        const headImagePreview = document.getElementById('editHeadImagePreview');
        const galleryImagesPreview = document.getElementById('editGalleryImagesPreview');
        
        // If there were originally images but now there are none, that's a change
        const originalHeadImage = form.dataset.originalHeadImage;
        const originalGalleryImages = form.dataset.originalGalleryImages;
        
        if (originalHeadImage && (!headImagePreview || headImagePreview.innerHTML.trim() === '' || !headImagePreview.querySelector('img'))) {
          return true;
        }
        if (originalGalleryImages && (!galleryImagesPreview || galleryImagesPreview.innerHTML.trim() === '' || !galleryImagesPreview.querySelector('img'))) {
          return true;
        }
      }
      
      return false;
    }

    // Store original form values when form is loaded
    function storeOriginalValues(formId) {
      const form = document.getElementById(formId);
      if (!form) return;
      
      const inputs = form.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        if (input.type !== 'file') {
          input.dataset.originalValue = input.value;
        }
      });
      
      // Store original image state for edit car form
      if (formId === 'editCarForm') {
        const headImagePreview = document.getElementById('editHeadImagePreview');
        const galleryImagesPreview = document.getElementById('editGalleryImagesPreview');
        
        if (headImagePreview && headImagePreview.innerHTML !== '') {
          form.dataset.originalHeadImage = 'true';
        }
        if (galleryImagesPreview && galleryImagesPreview.innerHTML !== '') {
          form.dataset.originalGalleryImages = 'true';
        }
      }
      
      // Store original image state for add car form
      if (formId === 'carForm') {
        const headImagePreview = document.getElementById('addHeadImagePreview');
        const galleryImagesPreview = document.getElementById('addGalleryImagesPreview');
        
        if (headImagePreview && headImagePreview.innerHTML !== '') {
          form.dataset.originalHeadImage = 'true';
        }
        if (galleryImagesPreview && galleryImagesPreview.innerHTML !== '') {
          form.dataset.originalGalleryImages = 'true';
        }
      }
    }
    
    // Make function globally accessible
    window.storeOriginalValues = storeOriginalValues;

    // Close functions
    function closeAddCarPanelFunction() {
      const addCarPanel = document.getElementById('addCarPanel');
      const addCarForm = document.getElementById('carForm');
      const adminOverlay = document.getElementById('adminOverlay');
      
      // Reset form and clear image previews
      if (addCarForm) {
        addCarForm.reset();
      }
      
      const headImagePreview = document.getElementById('addHeadImagePreview');
      const galleryImagesPreview = document.getElementById('addGalleryImagesPreview');
      const headImageInput = document.getElementById('addHeadImageInput');
      const galleryImagesInput = document.getElementById('addGalleryImagesInput');
      
      if (headImagePreview) headImagePreview.innerHTML = '';
      if (galleryImagesPreview) galleryImagesPreview.innerHTML = '';
      if (headImageInput) headImageInput.value = '';
      if (galleryImagesInput) galleryImagesInput.value = '';
      
      if (addCarPanel) addCarPanel.classList.remove('active');
      if (adminOverlay) adminOverlay.classList.remove('active');
      document.body.classList.remove('admin-popup-open');
    }

    function closeEditCarPanelFunction() {
      const editCarPanel = document.getElementById('editCarPanel');
      const editCarForm = document.getElementById('editCarForm');
      const adminOverlay = document.getElementById('adminOverlay');
      
      // Clear pending deletion flags since we're closing without saving
      delete editCarForm.dataset.pendingHeadImageDeletion;
      delete editCarForm.dataset.pendingGalleryImageDeletions;
      
      // Reset form and clear image previews
      editCarForm.reset();
      document.getElementById('editHeadImagePreview').innerHTML = '';
      document.getElementById('editGalleryImagesPreview').innerHTML = '';
      document.getElementById('editHeadImageInput').value = '';
      document.getElementById('editGalleryImagesInput').value = '';
      
      // Clear original image data
      delete editCarForm.dataset.originalHeadImageData;
      delete editCarForm.dataset.originalGalleryImagesData;
      
      editCarPanel.classList.remove('active');
      adminOverlay.classList.remove('active');
      document.body.classList.remove('admin-popup-open');
    }

    function closeAllPanels() {
      const addCarPanel = document.getElementById('addCarPanel');
      const editCarPanel = document.getElementById('editCarPanel');
      const addCarForm = document.getElementById('carForm');
      const adminOverlay = document.getElementById('adminOverlay');
      
      // Reset add car form if it's active
      if (addCarPanel && addCarPanel.classList.contains('active') && addCarForm) {
        addCarForm.reset();
        
        const headImagePreview = document.getElementById('addHeadImagePreview');
        const galleryImagesPreview = document.getElementById('addGalleryImagesPreview');
        const headImageInput = document.getElementById('addHeadImageInput');
        const galleryImagesInput = document.getElementById('addGalleryImagesInput');
        
        if (headImagePreview) headImagePreview.innerHTML = '';
        if (galleryImagesPreview) galleryImagesPreview.innerHTML = '';
        if (headImageInput) headImageInput.value = '';
        if (galleryImagesInput) galleryImagesInput.value = '';
      }
      
      if (addCarPanel) addCarPanel.classList.remove('active');
      if (editCarPanel) editCarPanel.classList.remove('active');
      if (adminOverlay) adminOverlay.classList.remove('active');
      document.body.classList.remove('admin-popup-open');
    }

    // Add Car Button
    
    const showAddCarBtn = document.getElementById('showAddCarBtn');
    const addCarPanel = document.getElementById('addCarPanel');
    const closeAddCarPanel = document.getElementById('closeAddCarPanel');
    const adminOverlay = document.getElementById('adminOverlay');
    

      
      if (showAddCarBtn) {
        showAddCarBtn.addEventListener('click', () => {
          // Reset the form first to ensure it starts empty
          const addCarForm = document.getElementById('carForm');
          if (addCarForm) {
            addCarForm.reset();
            // Clear any image previews
            document.getElementById('addHeadImagePreview').innerHTML = '';
            document.getElementById('addGalleryImagesPreview').innerHTML = '';
            document.getElementById('addHeadImageInput').value = '';
            document.getElementById('addGalleryImagesInput').value = '';
          }
          
          addCarPanel.classList.add('active');
          adminOverlay.classList.add('active');
          document.body.classList.add('admin-popup-open');
          
          // Store original values after a short delay to ensure form is rendered and reset
          setTimeout(() => {
            storeOriginalValues('carForm');
          }, 100);
        });
      }
      
      if (closeAddCarPanel) {
        closeAddCarPanel.addEventListener('click', () => {
          const hasChanges = hasUnsavedChanges('carForm');
          
          if (window.bypassUnsavedChangesCheck || !hasChanges) {
            closeAddCarPanelFunction();
          } else {
            showUnsavedChangesConfirmation('addCarPanel');
          }
        });
      }
      
      // Close modal when clicking overlay
                      if (adminOverlay && !adminOverlay.dataset.listenerAttached) {
          adminOverlay.dataset.listenerAttached = 'true';
          adminOverlay.addEventListener('click', (e) => {
            if (addCarPanel.classList.contains('active') && !window.bypassUnsavedChangesCheck && hasUnsavedChanges('carForm')) {
              showUnsavedChangesConfirmation('addCarPanel');
            } else if (editCarPanel.classList.contains('active') && !window.bypassUnsavedChangesCheck && hasUnsavedChanges('editCarForm')) {
              showUnsavedChangesConfirmation('editCarPanel');
            } else {
              closeAllPanels();
            }
          });
        }
      
      // Edit Car Panel functionality
      const editCarPanel = document.getElementById('editCarPanel');
      const closeEditCarPanel = document.getElementById('closeEditCarPanel');
      

      
      if (closeEditCarPanel && !closeEditCarPanel.dataset.listenerAttached) {
        closeEditCarPanel.dataset.listenerAttached = 'true';
        closeEditCarPanel.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
                  const hasChanges = hasUnsavedChanges('editCarForm');
          
          if (window.bypassUnsavedChangesCheck || !hasChanges) {
            closeEditCarPanelFunction();
          } else {
            showUnsavedChangesConfirmation('editCarPanel');
          }
        });
      }
      
      // Edit Car Form Submit
      const editCarForm = document.getElementById('editCarForm');
      if (editCarForm && !editCarForm.dataset.initialized) {
        editCarForm.dataset.initialized = 'true';
        
        let isEditSubmitting = false; // Prevent double submission
        
        // Prevent any automatic form submission
        editCarForm.setAttribute('novalidate', 'true');
        editCarForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          if (isEditSubmitting) {
            return;
          }
          
          isEditSubmitting = true;
          
          const carId = editCarForm.dataset.carId;
          if (!carId) {
            showCustomAlert('Error: Car ID not found', 'error');
            return;
          }
          
          const formData = new FormData(editCarForm);
          const carData = Object.fromEntries(formData.entries());
          
          // Convert price fields to price_policy object
          const pricePolicy = {
            '1-2': carData.price_1_2 || '',
            '3-7': carData.price_3_7 || '',
            '8-20': carData.price_8_20 || '',
            '21-45': carData.price_21_45 || '',
            '46+': carData.price_46 || ''
          };
          
          // Remove individual price fields and add price_policy
          delete carData.price_1_2;
          delete carData.price_3_7;
          delete carData.price_8_20;
          delete carData.price_21_45;
          delete carData.price_46;
          carData.price_policy = pricePolicy;
          
          // Ensure all required fields are present
          carData.make_name = carData.make_name || '';
          carData.model_name = carData.model_name || '';
          carData.production_year = carData.production_year || '';
          carData.gear_type = carData.gear_type || '';
          carData.fuel_type = carData.fuel_type || '';
          carData.car_type = carData.car_type || '';
          carData.num_doors = carData.num_doors || '';
          carData.num_passengers = carData.num_passengers || '';
          carData.rca_insurance_price = carData.rca_insurance_price || '';
          carData.casco_insurance_price = carData.casco_insurance_price || '';
          
          // Handle engine_capacity for electric cars
          if (carData.fuel_type === 'Electric') {
            carData.engine_capacity = null;
          } else {
            carData.engine_capacity = carData.engine_capacity || '';
          }
          
          // Handle image uploads if files are selected
          const headImageFile = document.getElementById('editHeadImageInput').files[0];
          const galleryImageFiles = Array.from(document.getElementById('editGalleryImagesInput').files);
          
          // If there are images to upload, upload them first
          if (headImageFile || galleryImageFiles.length > 0) {
            const imageData = {};
            
            // Convert head image to base64
            if (headImageFile) {
              const headImageBase64 = await fileToBase64(headImageFile);
              imageData.head_image = {
                data: headImageBase64,
                extension: headImageFile.name.split('.').pop()
              };
            }
            
            // Convert gallery images to base64
            if (galleryImageFiles.length > 0) {
              imageData.gallery_images = [];
              for (const file of galleryImageFiles) {
                if (file && file.size > 0 && file.name) {
                  const galleryImageBase64 = await fileToBase64(file);
                  imageData.gallery_images.push({
                    data: galleryImageBase64,
                    extension: file.name.split('.').pop()
                  });
                }
              }
            }
            
            try {
              const token = localStorage.getItem('adminToken');
              const imageResponse = await fetch(`${window.API_BASE_URL}/api/cars/${carId}/images`, {
                method: 'POST',
                headers: { 
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(imageData)
              });
              
              if (imageResponse.ok) {
                // Get the updated image data from the response
                const imageResult = await imageResponse.json();
                if (imageResult.gallery_images) {
                  // Update carData with the new gallery images
                  carData.gallery_images = JSON.stringify(imageResult.gallery_images);
                }
              } else {
                console.error('❌ Image upload failed');
                const imageError = await imageResponse.json();
                showCustomAlert('Image upload failed: ' + imageError.error, 'error');
                return; // Don't proceed with car update if image upload failed
              }
            } catch (imageError) {
              console.error('Error uploading images:', imageError);
              showCustomAlert('Image upload failed', 'error');
              return; // Don't proceed with car update if image upload failed
            }
          }
          
          // Handle pending image deletions
          if (editCarForm.dataset.pendingHeadImageDeletion || editCarForm.dataset.pendingGalleryImageDeletions) {
                    // Delete head image if pending
        if (editCarForm.dataset.pendingHeadImageDeletion) {
          const headImagePath = editCarForm.dataset.pendingHeadImageDeletion;
              
              try {
                const token = localStorage.getItem('adminToken');
                const deleteResponse = await fetch(`${window.API_BASE_URL}/api/cars/${carId}/images?path=${encodeURIComponent(headImagePath)}&type=head`, {
                  method: 'DELETE',
                  headers: {
                    'Authorization': `Bearer ${token}`
                  }
                });
                
                if (deleteResponse.ok) {
                } else {
                  const error = await deleteResponse.json();
                  console.error('❌ Error deleting head image:', error);
                  showCustomAlert('Error deleting head image: ' + error.error, 'error');
                }
              } catch (error) {
                console.error('❌ Error deleting head image:', error);
                showCustomAlert('Error deleting head image', 'error');
              }
            }
            
                    // Delete gallery images if pending
        if (editCarForm.dataset.pendingGalleryImageDeletions) {
          const galleryImagePaths = editCarForm.dataset.pendingGalleryImageDeletions.split(',').filter(p => p);
              
              for (const imagePath of galleryImagePaths) {
                try {
                  const token = localStorage.getItem('adminToken');
                  const deleteResponse = await fetch(`${window.API_BASE_URL}/api/cars/${carId}/images?path=${encodeURIComponent(imagePath)}&type=gallery`, {
                    method: 'DELETE',
                    headers: {
                      'Authorization': `Bearer ${token}`
                    }
                  });
                  
                  if (deleteResponse.ok) {
                  } else {
                    const error = await deleteResponse.json();
                    console.error('❌ Error deleting gallery image:', error);
                    showCustomAlert('Error deleting gallery image: ' + error.error, 'error');
                  }
                } catch (error) {
                  console.error('❌ Error deleting gallery image:', error);
                  showCustomAlert('Error deleting gallery image', 'error');
                }
              }
            }
            
            // Clear pending deletion flags
            delete editCarForm.dataset.pendingHeadImageDeletion;
            delete editCarForm.dataset.pendingGalleryImageDeletions;
          }
          
          // Now update car data with JSON (including any new images)
          try {
            const token = localStorage.getItem('adminToken');
            const response = await fetch(`${window.API_BASE_URL}/api/cars/${carId}`, {
              method: 'PUT',
              headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(carData)
            });
            
            if (response.ok) {
              showCustomAlert('Car updated successfully!', 'success');
              
              // Clear only the file inputs, but keep image previews
              document.getElementById('editHeadImageInput').value = '';
              document.getElementById('editGalleryImagesInput').value = '';
              
              // Reset original values since form is now clean
              storeOriginalValues('editCarForm');
              
              // Close the panel after successful save
              editCarPanel.classList.remove('active');
              adminOverlay.classList.remove('active');
              document.body.classList.remove('admin-popup-open');
              loadCars();
            } else {
              const error = await response.json();
              let errorMessage = 'Error updating car: ' + error.error;
              if (error.missingFields && error.missingFields.length > 0) {
                errorMessage += '\n\nMissing fields:\n• ' + error.missingFields.join('\n• ');
              }
              showCustomAlert(errorMessage, 'error');
            }
          } catch (error) {
            console.error('Error updating car:', error);
            showCustomAlert('Error updating car', 'error');
          } finally {
            isEditSubmitting = false; // Reset submission flag
          }
        });
      }
      
      // Delete Car Button functionality
      const deleteCarBtn = document.getElementById('deleteCarBtn');
      if (deleteCarBtn) {
        deleteCarBtn.addEventListener('click', async () => {
          const carId = editCarForm.dataset.carId;
          if (!carId) {
            showCustomAlert('Error: Car ID not found', 'error');
            return;
          }
          
          if (confirm('Are you sure you want to delete this car? This action cannot be undone.')) {
            try {
              const token = localStorage.getItem('adminToken');
              const response = await fetch(`${window.API_BASE_URL}/api/cars/${carId}`, {
                method: 'DELETE',
                headers: {
                  'Authorization': `Bearer ${token}`
                }
              });
              
              if (response.ok) {
                showCustomAlert('Car deleted successfully!', 'success');
                
                // Reset form and clear image previews
                editCarForm.reset();
                document.getElementById('editHeadImagePreview').innerHTML = '';
                document.getElementById('editGalleryImagesPreview').innerHTML = '';
                document.getElementById('editHeadImageInput').value = '';
                document.getElementById('editGalleryImagesInput').value = '';
                
                editCarPanel.classList.remove('active');
                adminOverlay.classList.remove('active');
                document.body.classList.remove('admin-popup-open');
                loadCars();
              } else {
                const error = await response.json();
                showCustomAlert('Error deleting car: ' + error.error, 'error');
              }
            } catch (error) {
              console.error('Error deleting car:', error);
              showCustomAlert('Error deleting car', 'error');
            }
          }
        });
      }
      
      // Image Upload Functionality
      initializeImageUploads();
      
      // Fuel Type Change Listener
      initializeFuelTypeListener();
    }
    
    // Helper function to convert file to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
          // Remove the data:image/...;base64, prefix
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = error => reject(error);
      });
    }
    
    function initializeFuelTypeListener() {
      // Handle both add car and edit car forms
      const addFuelTypeInput = document.querySelector('#addCarPanel select[name="fuel_type"]');
      const addEngineCapacityInput = document.querySelector('#addCarPanel input[name="engine_capacity"]');
      const editFuelTypeInput = document.querySelector('#editCarPanel select[name="fuel_type"]');
      const editEngineCapacityInput = document.querySelector('#editCarPanel input[name="engine_capacity"]');
      
      // Initialize add car form fuel type listener
      if (addFuelTypeInput && addEngineCapacityInput) {
        // Set initial state
        updateEngineCapacityField(addFuelTypeInput, addEngineCapacityInput);
        
        // Add change listener
        addFuelTypeInput.addEventListener('change', () => updateEngineCapacityField(addFuelTypeInput, addEngineCapacityInput));
      }
      
      // Initialize edit car form fuel type listener
      if (editFuelTypeInput && editEngineCapacityInput) {
        // Set initial state
        updateEngineCapacityField(editFuelTypeInput, editEngineCapacityInput);
        
        // Add change listener
        editFuelTypeInput.addEventListener('change', () => updateEngineCapacityField(editFuelTypeInput, editEngineCapacityInput));
      }
      
      function updateEngineCapacityField(fuelTypeInput, engineCapacityInput) {
        const fuelType = fuelTypeInput.value;
        
        if (fuelType === 'Electric') {
          engineCapacityInput.disabled = true;
          engineCapacityInput.value = '';
          engineCapacityInput.placeholder = 'Not applicable';
          engineCapacityInput.style.backgroundColor = '#e0e0e0';
          engineCapacityInput.style.color = '#666';
          engineCapacityInput.style.cursor = 'not-allowed';
        } else {
          engineCapacityInput.disabled = false;
          engineCapacityInput.placeholder = 'Enter engine capacity (e.g., 2.0)';
          engineCapacityInput.style.backgroundColor = '';
          engineCapacityInput.style.color = '';
          engineCapacityInput.style.cursor = '';
        }
      }
    }
    
    function initializeImageUploads() {
      // Add Car Image Uploads
      const addHeadImageButton = document.getElementById('addHeadImageButton');
      const addHeadImageInput = document.getElementById('addHeadImageInput');
      const addHeadImagePreview = document.getElementById('addHeadImagePreview');
      
      if (addHeadImageButton && addHeadImageInput && !addHeadImageButton.dataset.initialized) {

        addHeadImageButton.dataset.initialized = 'true';
        addHeadImageInput.dataset.initialized = 'true';
        
        addHeadImageButton.addEventListener('click', () => {

          addHeadImageInput.click();
        });
        addHeadImageInput.addEventListener('change', (e) => {
          
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              addHeadImagePreview.innerHTML = `
                <div style="position: relative; display: inline-block;">
                  <img src="${e.target.result}" alt="Head image preview" style="max-width: 200px; max-height: 150px; border-radius: 4px;">
                  <button type="button" class="btn btn-danger btn-sm" style="position: absolute; top: -8px; right: -8px; border-radius: 50%; width: 24px; height: 24px; padding: 0; font-size: 12px;" onclick="this.parentElement.remove()">×</button>
                </div>
              `;
            };
            reader.readAsDataURL(file);
          }
        });
      }
      
      const addGalleryImagesButton = document.getElementById('addGalleryImagesButton');
      const addGalleryImagesInput = document.getElementById('addGalleryImagesInput');
      const addGalleryImagesPreview = document.getElementById('addGalleryImagesPreview');
      
      if (addGalleryImagesButton && addGalleryImagesInput && !addGalleryImagesButton.dataset.initialized) {

        addGalleryImagesButton.dataset.initialized = 'true';
        addGalleryImagesInput.dataset.initialized = 'true';
        
        addGalleryImagesButton.addEventListener('click', () => {

          addGalleryImagesInput.click();
        });
        addGalleryImagesInput.addEventListener('change', (e) => {
          
          const files = Array.from(e.target.files);
          
          files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
              addGalleryImagesPreview.innerHTML += `
                <div style="position: relative; display: inline-block; margin: 5px;">
                  <img src="${e.target.result}" alt="Gallery image preview" style="max-width: 100px; max-height: 75px; border-radius: 4px;">
                  <button type="button" class="btn btn-danger btn-sm" style="position: absolute; top: -8px; right: -8px; border-radius: 50%; width: 24px; height: 24px; padding: 0; font-size: 12px;" onclick="this.parentElement.remove()">×</button>
                </div>
              `;
            };
            reader.readAsDataURL(file);
          });
        });
      }
      
      // Edit Car Image Uploads
      const editHeadImageButton = document.getElementById('editHeadImageButton');
      const editHeadImageInput = document.getElementById('editHeadImageInput');
      const editHeadImagePreview = document.getElementById('editHeadImagePreview');
      
      if (editHeadImageButton && editHeadImageInput && !editHeadImageButton.dataset.initialized) {
        editHeadImageButton.dataset.initialized = 'true';
        editHeadImageInput.dataset.initialized = 'true';
        
        editHeadImageButton.addEventListener('click', () => editHeadImageInput.click());
        editHeadImageInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              editHeadImagePreview.innerHTML = `
                <div style="position: relative; display: inline-block;">
                  <img src="${e.target.result}" alt="Head image preview" style="max-width: 200px; max-height: 150px; border-radius: 4px;">
                  <button type="button" class="btn btn-danger btn-sm" style="position: absolute; top: -8px; right: -8px; border-radius: 50%; width: 24px; height: 24px; padding: 0; font-size: 12px;" onclick="this.parentElement.remove()">×</button>
                </div>
              `;
            };
            reader.readAsDataURL(file);
          }
        });
      }
      
      const editGalleryImagesButton = document.getElementById('editGalleryImagesButton');
      const editGalleryImagesInput = document.getElementById('editGalleryImagesInput');
      const editGalleryImagesPreview = document.getElementById('editGalleryImagesPreview');
      
      if (editGalleryImagesButton && editGalleryImagesInput && !editGalleryImagesButton.dataset.initialized) {
        editGalleryImagesButton.dataset.initialized = 'true';
        editGalleryImagesInput.dataset.initialized = 'true';
        
        editGalleryImagesButton.addEventListener('click', () => editGalleryImagesInput.click());
        editGalleryImagesInput.addEventListener('change', (e) => {
          const files = Array.from(e.target.files);
          
          files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
              editGalleryImagesPreview.innerHTML += `
                <div style="position: relative; display: inline-block; margin: 5px;">
                  <img src="${e.target.result}" alt="Gallery image preview" style="max-width: 100px; max-height: 75px; border-radius: 4px;">
                  <button type="button" class="btn btn-danger btn-sm" style="position: absolute; top: -8px; right: -8px; border-radius: 50%; width: 24px; height: 24px; padding: 0; font-size: 12px;" onclick="this.parentElement.remove()">×</button>
                </div>
              `;
            };
            reader.readAsDataURL(file);
          });
        });
      }
      
      // Image removal functions
      window.removeHeadImage = async function() {
        const editHeadImagePreview = document.getElementById('editHeadImagePreview');
        const editForm = document.getElementById('editCarForm');
        const carId = editForm.dataset.carId;
        
        if (!carId) {
          console.error('No car ID found for head image deletion');
          return;
        }
        
        // Get the current head image path from the preview
        const headImage = editHeadImagePreview.querySelector('img');
        if (!headImage) {
          return;
        }
        
        const imagePath = headImage.src.replace(window.API_BASE_URL, '');
        
        // Store the image path for pending deletion instead of deleting immediately
        if (!editForm.dataset.pendingHeadImageDeletion) {
          editForm.dataset.pendingHeadImageDeletion = imagePath;
        }
        
        // Remove from preview (but don't delete from database yet)
        editHeadImagePreview.innerHTML = '';
        showCustomAlert('Head image will be deleted when you save the form', 'info');
      };
      
      window.removeGalleryImage = async function(index) {
        const editGalleryImagesPreview = document.getElementById('editGalleryImagesPreview');
        const editForm = document.getElementById('editCarForm');
        const carId = editForm.dataset.carId;
        
        if (!carId) {
          console.error('No car ID found for gallery image deletion');
          return;
        }
        
        const images = editGalleryImagesPreview.querySelectorAll('div');
        if (!images[index]) {
          console.error('Gallery image not found at index:', index);
          return;
        }
        
        // Get the image path from the img element
        const imgElement = images[index].querySelector('img');
        if (!imgElement) {
          console.error('Image element not found at index:', index);
          return;
        }
        
        const imagePath = imgElement.src.replace(window.API_BASE_URL, '');
        
        // Store the image path for pending deletion
        if (!editForm.dataset.pendingGalleryImageDeletions) {
          editForm.dataset.pendingGalleryImageDeletions = '';
        }
        const pendingDeletions = editForm.dataset.pendingGalleryImageDeletions.split(',').filter(p => p);
        pendingDeletions.push(imagePath);
        editForm.dataset.pendingGalleryImageDeletions = pendingDeletions.join(',');
        
        // Remove from preview (but don't delete from database yet)
        images[index].remove();
        showCustomAlert('Gallery image will be deleted when you save the form', 'info');
      };
      
      window.removeGalleryImageByUrl = async function(imageUrl) {
        const editForm = document.getElementById('editCarForm');
        const carId = editForm.dataset.carId;
        
        if (!carId) {
          console.error('No car ID found for gallery image deletion');
          return;
        }
        

        
        // Store the image path for pending deletion
        if (!editForm.dataset.pendingGalleryImageDeletions) {
          editForm.dataset.pendingGalleryImageDeletions = '';
        }
        const pendingDeletions = editForm.dataset.pendingGalleryImageDeletions.split(',').filter(p => p);
        pendingDeletions.push(imageUrl);
        editForm.dataset.pendingGalleryImageDeletions = pendingDeletions.join(',');
        
        // Find and remove the specific image element by URL
        const editGalleryImagesPreview = document.getElementById('editGalleryImagesPreview');
        const imageElements = editGalleryImagesPreview.querySelectorAll('img');
        
        for (let imgElement of imageElements) {
          if (imgElement.src === imageUrl || imgElement.src === window.API_BASE_URL + imageUrl) {
            // Remove the parent div containing this image
            imgElement.closest('div').remove();

            break;
          }
        }
        
        showCustomAlert('Gallery image will be deleted when you save the form', 'info');
      };
      
      // Car Form Submit
      const carForm = document.getElementById('carForm');
      if (carForm && !carForm.dataset.initialized) {

        carForm.dataset.initialized = 'true';
        
        let isSubmitting = false; // Prevent double submission
        
        // Prevent any automatic form submission
        carForm.setAttribute('novalidate', 'true');
        
        // Log all form events for debugging
        carForm.addEventListener('click', (e) => {

        });
        
        carForm.addEventListener('input', (e) => {

        });
        

        
        carForm.addEventListener('submit', async (e) => {
          
          
          e.preventDefault();
          e.stopPropagation();
          
          if (isSubmitting) {
            return;
          }
          

          isSubmitting = true;
          
          const formData = new FormData(carForm);
          const carData = Object.fromEntries(formData.entries());
          

          
          // Convert price fields to price_policy object
          const pricePolicy = {
            '1-2': carData.price_1_2 || '',
            '3-7': carData.price_3_7 || '',
            '8-20': carData.price_8_20 || '',
            '21-45': carData.price_21_45 || '',
            '46+': carData.price_46 || ''
          };
          
          // Remove individual price fields and add price_policy
          delete carData.price_1_2;
          delete carData.price_3_7;
          delete carData.price_8_20;
          delete carData.price_21_45;
          delete carData.price_46;
          carData.price_policy = pricePolicy;
          
          // Ensure all required fields are present
          carData.make_name = carData.make_name || '';
          carData.model_name = carData.model_name || '';
          carData.production_year = carData.production_year || '';
          carData.gear_type = carData.gear_type || '';
          carData.fuel_type = carData.fuel_type || '';
          carData.car_type = carData.car_type || '';
          carData.num_doors = carData.num_doors || '';
          carData.num_passengers = carData.num_passengers || '';
          carData.rca_insurance_price = carData.rca_insurance_price || '';
          carData.casco_insurance_price = carData.casco_insurance_price || '';
          
          // Handle engine_capacity for electric cars
          if (carData.fuel_type === 'Electric') {
            carData.engine_capacity = null;
          } else {
            carData.engine_capacity = carData.engine_capacity || '';
          }
          
                  // Convert display text back to raw keys for backend processing
        if (carData.make_name && carData.make_name !== '') {
          // Make name is now a simple select - no conversion needed
          // The value from the select will be used directly
        }
        if (carData.model_name && carData.model_name !== '') {
          // Model name is now a simple select - no conversion needed
          // The value from the select will be used directly
        }
        if (carData.exterior_color && carData.exterior_color !== '') {
          // Check if we have a stored raw value first
          const exteriorColorInput = document.getElementById('add_exterior_color');
          if (exteriorColorInput && exteriorColorInput.dataset.rawValue) {
            carData.exterior_color = exteriorColorInput.dataset.rawValue;
          } else {
          const colorKeys = {
            'White': 'white',
            'Black': 'black',
            'Silver': 'silver',
            'Gray': 'gray',
            'Red': 'red',
            'Blue': 'blue',
            'Green': 'green',
            'Yellow': 'yellow',
            'Orange': 'orange',
            'Purple': 'purple',
            'Pink': 'pink',
            'Brown': 'brown',
            'Beige': 'beige',
            'Gold': 'gold',
            'Bronze': 'bronze',
            'Pearl White': 'pearl_white',
            'Metallic Black': 'metallic_black',
            'Metallic Silver': 'metallic_silver',
            'Metallic Gray': 'metallic_gray',
            'Metallic Red': 'metallic_red',
            'Metallic Blue': 'metallic_blue',
            'Metallic Green': 'metallic_green',
            'Metallic Yellow': 'metallic_yellow',
            'Metallic Orange': 'metallic_orange',
            'Metallic Purple': 'metallic_purple',
            'Metallic Pink': 'metallic_pink',
            'Metallic Brown': 'metallic_brown',
            'Metallic Beige': 'metallic_beige',
            'Metallic Gold': 'metallic_gold',
            'Metallic Bronze': 'metallic_bronze'
          };
          carData.exterior_color = colorKeys[carData.exterior_color] || carData.exterior_color;
          }
        }
        if (carData.interior_color && carData.interior_color !== '') {
          // Check if we have a stored raw value first
          const interiorColorInput = document.getElementById('add_interior_color');
          if (interiorColorInput && interiorColorInput.dataset.rawValue) {
            carData.interior_color = interiorColorInput.dataset.rawValue;
          }
        }
          
          // Handle image uploads if files are selected
          const headImageFile = document.getElementById('addHeadImageInput').files[0];
          const galleryImageFiles = Array.from(document.getElementById('addGalleryImagesInput').files);
          

          
          // Only proceed with one submission path
          if (headImageFile || galleryImageFiles.length > 0) {
            // Convert images to base64 and add to carData
            const carDataWithImages = { ...carData };
            
            // Convert head image to base64
            if (headImageFile) {
              const headImageBase64 = await fileToBase64(headImageFile);
              carDataWithImages.head_image = {
                data: headImageBase64,
                extension: headImageFile.name.split('.').pop()
              };
            }
            
            // Convert gallery images to base64
            if (galleryImageFiles.length > 0) {
              carDataWithImages.gallery_images = [];
              for (const file of galleryImageFiles) {
                if (file && file.size > 0 && file.name) {
                  const galleryImageBase64 = await fileToBase64(file);
                  carDataWithImages.gallery_images.push({
                    data: galleryImageBase64,
                    extension: file.name.split('.').pop()
                  });
                }
              }
            }
            
            try {
              const token = localStorage.getItem('adminToken');
              const response = await fetch(`${window.API_BASE_URL}/api/cars`, {
                method: 'POST',
                headers: { 
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(carDataWithImages)
              });
              
              if (response.ok) {
                showCustomAlert('Car added successfully!', 'success');
                
                // Reset form and clear image previews
                carForm.reset();
                document.getElementById('addHeadImagePreview').innerHTML = '';
                document.getElementById('addGalleryImagesPreview').innerHTML = '';
                document.getElementById('addHeadImageInput').value = '';
                document.getElementById('addGalleryImagesInput').value = '';
                
                // Reset original values since form is now clean
                storeOriginalValues('addCarForm');
                
                addCarPanel.classList.remove('active');
                adminOverlay.classList.remove('active');
                document.body.classList.remove('admin-popup-open');
                loadCars();
              } else {
                const error = await response.json();
                let errorMessage = 'Error adding car: ' + error.error;
                if (error.missingFields && error.missingFields.length > 0) {
                  errorMessage += '\n\nMissing fields:\n• ' + error.missingFields.join('\n• ');
                }
                showCustomAlert(errorMessage, 'error');
              }
            } catch (error) {
              console.error('💥 Network error adding car:', error);
              showCustomAlert('Error adding car', 'error');
            } finally {
              isSubmitting = false; // Reset submission flag
            }
          } else {
            // No images to upload, use JSON
            try {
              const token = localStorage.getItem('adminToken');
              const response = await fetch(`${window.API_BASE_URL}/api/cars`, {
                method: 'POST',
                headers: { 
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(carData)
              });
              
              if (response.ok) {
                showCustomAlert('Car added successfully!', 'success');
                
                // Reset form and clear image previews
                carForm.reset();
                document.getElementById('addHeadImagePreview').innerHTML = '';
                document.getElementById('addGalleryImagesPreview').innerHTML = '';
                document.getElementById('addHeadImageInput').value = '';
                document.getElementById('addGalleryImagesInput').value = '';
                
                addCarPanel.classList.remove('admin-popup-open');
                loadCars();
              } else {
                const error = await response.json();
                let errorMessage = 'Error adding car: ' + error.error;
                if (error.missingFields && error.missingFields.length > 0) {
                  errorMessage += '\n\nMissing fields:\n• ' + error.missingFields.join('\n• ');
                }
                showCustomAlert(errorMessage, 'error');
              }
            } catch (error) {
              console.error('Error adding car:', error);
              showCustomAlert('Error adding car', 'error');
            } finally {
              isSubmitting = false; // Reset submission flag
            }
          }
        });
      }
    }

    // Function to check if form has unsaved changes
    function hasUnsavedChanges(formId) {
      const form = document.getElementById(formId);
      if (!form) {
        return false;
      }
      
      // Check if any input has been modified
      const inputs = form.querySelectorAll('input, select, textarea');
      
      for (let input of inputs) {
        if (input.type === 'file') continue; // Skip file inputs
        
        // For add coupon form, any non-empty value indicates unsaved changes
        if (formId === 'couponForm') {
          if (input.value && input.value !== '' && input.value !== 'percentage' && input.value !== 'free_days' && input.value !== '1' && input.value !== '0') {
            return true;
          }
        } else {
          // For edit coupon form, check if the value has changed from the original
          if (input.dataset.originalValue !== undefined) {
            if (input.value !== input.dataset.originalValue) {
              return true;
            }
          } else if (input.value !== '' && input.value !== 'percentage' && input.value !== 'free_days' && input.value !== '1' && input.value !== '0') {
            // If no original value is set, check if current value is not empty or default
            return true;
          }
        }
      }
      
      return false;
    }
    
    // Function to store original values for edit form
    function storeOriginalValues(formId) {
      const form = document.getElementById(formId);
      if (!form) return;
      
      const inputs = form.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        input.dataset.originalValue = input.value;
      });
    }
    
    // Function to show unsaved changes confirmation
    function showUnsavedChangesConfirmation(panelType) {
      // Check if modal already exists and remove it
      const existingModal = document.querySelector('.unsaved-changes-modal');
      if (existingModal) {
        existingModal.remove();
      }
      
      const modal = document.createElement('div');
      modal.className = 'unsaved-changes-modal';
      modal.innerHTML = `
        <div class="unsaved-changes-content">
          <h3>Unsaved Changes</h3>
          <p>You have unsaved changes. Are you sure you want to close without saving?</p>
          <div class="unsaved-changes-buttons">
            <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
            <button class="btn btn-danger" id="confirmBtn">Close Without Saving</button>
          </div>
        </div>
      `;
      
      // Add styles
      const style = document.createElement('style');
      style.textContent = `
        .unsaved-changes-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        }
        .unsaved-changes-content {
          background: white;
          padding: 30px;
          border-radius: 8px;
          max-width: 400px;
          text-align: center;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .unsaved-changes-content h3 {
          margin-bottom: 15px;
          color: #333;
        }
        .unsaved-changes-content p {
          margin-bottom: 25px;
          color: #666;
        }
        .unsaved-changes-buttons {
          display: flex;
          gap: 10px;
          justify-content: center;
        }
        .unsaved-changes-buttons .btn {
          padding: 10px 20px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-weight: 500;
        }
        .unsaved-changes-buttons .btn-secondary {
          background: #6c757d;
          color: white;
        }
        .unsaved-changes-buttons .btn-danger {
          background: #dc3545;
          color: white;
        }
        .unsaved-changes-buttons .btn:hover {
          opacity: 0.9;
        }
      `;
      document.head.appendChild(style);
      document.body.appendChild(modal);
      
      // Add event listeners after modal is created
      const cancelBtn = modal.querySelector('#cancelBtn');
      const confirmBtn = modal.querySelector('#confirmBtn');
      
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          modal.remove();
          // Don't close the form - just close the modal and keep the form open
        });
      }
      
      if (confirmBtn) {
        confirmBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          modal.remove();
          
          // Close the appropriate panel
          if (panelType === 'addCouponPanel') {
            const addCouponPanel = document.getElementById('addCouponPanel');
            const couponOverlay = document.getElementById('couponOverlay');
            const couponForm = document.getElementById('couponForm');
            
            if (couponForm) couponForm.reset();
            if (addCouponPanel) addCouponPanel.classList.remove('active');
            if (couponOverlay) couponOverlay.classList.remove('active');
            document.body.classList.remove('admin-popup-open');
          } else if (panelType === 'editCouponPanel') {
            const editCouponPanel = document.getElementById('editCouponPanel');
            const editCouponForm = document.getElementById('editCouponForm');
            const couponOverlay = document.getElementById('couponOverlay');
            
            if (editCouponForm) {
              editCouponForm.reset();
              delete editCouponForm.dataset.couponId;
            }
            
            if (editCouponPanel) editCouponPanel.classList.remove('active');
            if (couponOverlay) couponOverlay.classList.remove('active');
            document.body.classList.remove('admin-popup-open');
          }
        });
      }
    }

    function initializeCouponForms() {
      
      // Add Coupon Button
      const showAddCouponBtn = document.getElementById('showAddCouponBtn');
      const addCouponPanel = document.getElementById('addCouponPanel');
      const closeAddCouponPanel = document.getElementById('closeAddCouponPanel');
      const couponOverlay = document.getElementById('couponOverlay');
      
      if (showAddCouponBtn) {
        showAddCouponBtn.addEventListener('click', () => {
          addCouponPanel.classList.add('active');
          couponOverlay.classList.add('active');
          document.body.classList.add('admin-popup-open');
        });
      }
      
      if (closeAddCouponPanel) {
        closeAddCouponPanel.addEventListener('click', () => {
          const hasChanges = hasUnsavedChanges('couponForm');
          
          if (!hasChanges) {
            addCouponPanel.classList.remove('active');
            couponOverlay.classList.remove('active');
            document.body.classList.remove('admin-popup-open');
          } else {
            showUnsavedChangesConfirmation('addCouponPanel');
          }
        });
      }
      
      // Edit Coupon Panel Close Button
      const closeEditCouponPanel = document.getElementById('closeEditCouponPanel');
      if (closeEditCouponPanel) {
        closeEditCouponPanel.addEventListener('click', () => {
          const hasChanges = hasUnsavedChanges('editCouponForm');
          
          if (!hasChanges) {
            const editCouponPanel = document.getElementById('editCouponPanel');
            const editCouponForm = document.getElementById('editCouponForm');
            
            // Reset form
            if (editCouponForm) {
              editCouponForm.reset();
              delete editCouponForm.dataset.couponId;
            }
            
            // Close panel
            if (editCouponPanel) editCouponPanel.classList.remove('active');
            if (couponOverlay) couponOverlay.classList.remove('active');
            document.body.classList.remove('admin-popup-open');
            
          } else {
            showUnsavedChangesConfirmation('editCouponPanel');
          }
        });
      }
      
      // Close modal when clicking overlay
      if (couponOverlay) {
        couponOverlay.addEventListener('click', () => {
          // Check which panel is currently active
          const addCouponPanel = document.getElementById('addCouponPanel');
          const editCouponPanel = document.getElementById('editCouponPanel');
          
          let hasChanges = false;
          let panelType = '';
          
          if (addCouponPanel && addCouponPanel.classList.contains('active')) {
            hasChanges = hasUnsavedChanges('couponForm');
            panelType = 'addCouponPanel';
          } else if (editCouponPanel && editCouponPanel.classList.contains('active')) {
            hasChanges = hasUnsavedChanges('editCouponForm');
            panelType = 'editCouponPanel';
          }
          
          if (!hasChanges) {
            // No changes, close immediately
            if (addCouponPanel) addCouponPanel.classList.remove('active');
            if (editCouponPanel) editCouponPanel.classList.remove('active');
            couponOverlay.classList.remove('active');
            document.body.classList.remove('admin-popup-open');
          } else {
            // Has changes, show confirmation
            showUnsavedChangesConfirmation(panelType);
          }
        });
      }
      
      // Coupon Form Submit
      const couponForm = document.getElementById('couponForm');
      if (couponForm && !couponForm.dataset.initialized) {
        couponForm.dataset.initialized = 'true';
        let isSubmitting = false; // Prevent duplicate submissions
        couponForm.addEventListener('submit', async (e) => {
          
          e.preventDefault();
          
          if (isSubmitting) {
            return;
          }
          
          isSubmitting = true;
          
          const formData = new FormData(couponForm);
          const couponData = Object.fromEntries(formData.entries());
          
          // Client-side validation based on coupon type
          const couponType = couponData.type;
          const discountPercentage = couponData.discount_percentage;
          const freeDays = couponData.free_days;
          
          if (couponType === 'percentage') {
            if (!discountPercentage || discountPercentage <= 0 || discountPercentage > 100) {
              showCustomAlert('Please enter a valid discount percentage between 1 and 100', 'error');
              return;
            }
            // Remove free_days field for percentage type
            delete couponData.free_days;
          } else if (couponType === 'free_days') {
            if (!freeDays || freeDays <= 0) {
              showCustomAlert('Please enter a valid number of free days', 'error');
              return;
            }
            // Remove discount_percentage field for free_days type
            delete couponData.discount_percentage;
          }
          
          try {
            const token = localStorage.getItem('adminToken');
            const response = await fetch(`${window.API_BASE_URL}/api/coupons`, {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(couponData)
            });
            
            if (response.ok) {
              showCustomAlert('Coupon added successfully!', 'success');
              couponForm.reset();
              addCouponPanel.classList.remove('active');
              couponOverlay.classList.remove('active');
              document.body.classList.remove('admin-popup-open');
              loadCoupons();
            } else {
              const error = await response.json();
              showCustomAlert('Error adding coupon: ' + error.error, 'error');
            }
          } catch (error) {
            console.error('Error adding coupon:', error);
            showCustomAlert('Error adding coupon', 'error');
          } finally {
            isSubmitting = false; // Reset submission flag
          }
        });
      }
      
      // Coupon Type Selection Handler
      const couponType = document.getElementById('couponType');
      const editCouponType = document.getElementById('editCouponType');
      
      function handleCouponTypeChange(typeSelect, percentageField, freeDaysField) {
        if (typeSelect) {
          typeSelect.addEventListener('change', function() {
            const selectedType = this.value;
            const percentageInput = percentageField.querySelector('input[name="discount_percentage"]');
            const freeDaysInput = freeDaysField.querySelector('input[name="free_days"]');
            
            if (selectedType === 'percentage') {
              percentageField.style.display = 'block';
              freeDaysField.style.display = 'none';
              percentageInput.required = true;
              freeDaysInput.required = false;
              freeDaysInput.value = '';
            } else if (selectedType === 'free_days') {
              percentageField.style.display = 'none';
              freeDaysField.style.display = 'block';
              percentageInput.required = false;
              freeDaysInput.required = true;
              percentageInput.value = '';
            }
          });
        }
      }
      
      // Initialize coupon type handlers
      if (couponType) {
        handleCouponTypeChange(
          couponType, 
          document.getElementById('percentageField'), 
          document.getElementById('freeDaysField')
        );
        // Set initial state for add form
        const percentageInput = document.getElementById('percentageField').querySelector('input[name="discount_percentage"]');
        const freeDaysInput = document.getElementById('freeDaysField').querySelector('input[name="free_days"]');
        if (percentageInput) percentageInput.required = true;
        if (freeDaysInput) freeDaysInput.required = false;
      }
      

      
      if (editCouponType) {
        handleCouponTypeChange(
          editCouponType, 
          document.getElementById('editPercentageField'), 
          document.getElementById('editFreeDaysField')
        );
      }
      
      // Edit Coupon Form Submit
      const editCouponForm = document.getElementById('editCouponForm');
      const editCouponSubmitBtn = document.getElementById('editCouponFormSubmitBtn');
      
      // Add click event listener to button as backup
      if (editCouponSubmitBtn) {
        editCouponSubmitBtn.addEventListener('click', (e) => {
          console.log('🔧 Update Coupon button clicked');
          // Let the form submit event handle it
        });
      }
      
      if (editCouponForm) {
        editCouponForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          console.log('🔧 Edit coupon form submitted');
          
          const couponId = editCouponForm.dataset.couponId;
          console.log('🔧 Coupon ID:', couponId);
          if (!couponId) {
            showCustomAlert('No coupon ID found', 'error');
            return;
          }
          
          const formData = new FormData(editCouponForm);
          const couponData = Object.fromEntries(formData.entries());
          
          // Client-side validation based on coupon type
          const couponType = couponData.type;
          const discountPercentage = couponData.discount_percentage;
          const freeDays = couponData.free_days;
          
          if (couponType === 'percentage') {
            if (!discountPercentage || discountPercentage <= 0 || discountPercentage > 100) {
              showCustomAlert('Please enter a valid discount percentage between 1 and 100', 'error');
              return;
            }
            // Remove free_days field for percentage type
            delete couponData.free_days;
          } else if (couponType === 'free_days') {
            if (!freeDays || freeDays <= 0) {
              showCustomAlert('Please enter a valid number of free days', 'error');
              return;
            }
            // Remove discount_percentage field for free_days type
            delete couponData.discount_percentage;
          }
          
          try {
            console.log('🔧 Making PUT request to update coupon');
            const token = localStorage.getItem('adminToken');
            console.log('🔧 Token available:', !!token);
            console.log('🔧 Coupon data:', couponData);
            const response = await fetch(`${window.API_BASE_URL}/api/coupons/${couponId}`, {
              method: 'PUT',
              headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(couponData)
            });
            
            console.log('🔧 Response status:', response.status);
            if (response.ok) {
              showCustomAlert('Coupon updated successfully!', 'success');
              editCouponForm.reset();
              const editCouponPanel = document.getElementById('editCouponPanel');
              const couponOverlay = document.getElementById('couponOverlay');
              if (editCouponPanel && couponOverlay) {
                editCouponPanel.classList.remove('active');
                couponOverlay.classList.remove('active');
                document.body.classList.remove('admin-popup-open');
              }
              loadCoupons();
            } else {
              const error = await response.json();
              showCustomAlert('Error updating coupon: ' + error.error, 'error');
            }
          } catch (error) {
            console.error('Error updating coupon:', error);
            showCustomAlert('Error updating coupon: ' + error.message, 'error');
          }
        });
      }
    }

    // Edit and Delete Functions
    async function editCar(carId) {
      try {
        const response = await fetch(`${window.API_BASE_URL}/api/cars/${carId}`);
        const car = await response.json();
        
        if (!response.ok) {
          showCustomAlert('Error loading car data: ' + car.error, 'error');
          return;
        }
        
        // Populate the edit form with car data
        const editForm = document.getElementById('editCarForm');
        if (!editForm) return;
        
        // Fill in all the form fields
        const makeInput = editForm.querySelector('select[name="make_name"]');
        const modelInput = editForm.querySelector('input[name="model_name"]');
        const productionYearSelect = editForm.querySelector('select[name="production_year"]');
        const gearTypeSelect = editForm.querySelector('select[name="gear_type"]');
        const fuelTypeSelect = editForm.querySelector('select[name="fuel_type"]');
        const engineCapacityInput = editForm.querySelector('input[name="engine_capacity"]');
        const carTypeSelect = editForm.querySelector('select[name="car_type"]');
        const numDoorsSelect = editForm.querySelector('select[name="num_doors"]');
        const numPassengersSelect = editForm.querySelector('select[name="num_passengers"]');
        
        if (makeInput) makeInput.value = car.make_name || '';
        if (modelInput) modelInput.value = car.model_name || '';
        if (productionYearSelect) productionYearSelect.value = car.production_year || '';
        if (gearTypeSelect) gearTypeSelect.value = car.gear_type || '';
        if (fuelTypeSelect) fuelTypeSelect.value = car.fuel_type || '';
        if (engineCapacityInput) engineCapacityInput.value = car.engine_capacity || '';
        if (carTypeSelect) carTypeSelect.value = car.car_type || '';
        if (numDoorsSelect) numDoorsSelect.value = car.num_doors || '';
        if (numPassengersSelect) numPassengersSelect.value = car.num_passengers || '';
        
        // Fill in price policy fields
        if (car.price_policy) {
          const price1_2Input = editForm.querySelector('input[name="price_1_2"]');
          const price3_7Input = editForm.querySelector('input[name="price_3_7"]');
          const price8_20Input = editForm.querySelector('input[name="price_8_20"]');
          const price21_45Input = editForm.querySelector('input[name="price_21_45"]');
          const price46Input = editForm.querySelector('input[name="price_46"]');
          
          if (price1_2Input) price1_2Input.value = car.price_policy['1-2'] || '';
          if (price3_7Input) price3_7Input.value = car.price_policy['3-7'] || '';
          if (price8_20Input) price8_20Input.value = car.price_policy['8-20'] || '';
          if (price21_45Input) price21_45Input.value = car.price_policy['21-45'] || '';
          if (price46Input) price46Input.value = car.price_policy['46+'] || '';
        }
        
        // Fill in additional specifications
        const luggageInput = editForm.querySelector('input[name="luggage"]');
        const mileageInput = editForm.querySelector('input[name="mileage"]');
        const driveSelect = editForm.querySelector('select[name="drive"]');
        const fuelEconomyInput = editForm.querySelector('input[name="fuel_economy"]');
        const exteriorColorInput = editForm.querySelector('input[name="exterior_color"]');
        const interiorColorInput = editForm.querySelector('input[name="interior_color"]');
        const rcaInsuranceInput = editForm.querySelector('input[name="rca_insurance_price"]');
        const cascoInsuranceInput = editForm.querySelector('input[name="casco_insurance_price"]');
        const likesInput = editForm.querySelector('input[name="likes"]');
        const descriptionEnInput = editForm.querySelector('textarea[name="description_en"]');
        const descriptionRoInput = editForm.querySelector('textarea[name="description_ro"]');
        const descriptionRuInput = editForm.querySelector('textarea[name="description_ru"]');
        
        if (luggageInput) luggageInput.value = car.luggage || '';
        if (mileageInput) mileageInput.value = car.mileage || '';
        if (driveSelect) driveSelect.value = car.drive || '';
        if (fuelEconomyInput) fuelEconomyInput.value = car.fuel_economy || '';
        if (exteriorColorInput) exteriorColorInput.value = car.exterior_color || '';
        if (interiorColorInput) interiorColorInput.value = car.interior_color || '';
        if (rcaInsuranceInput) rcaInsuranceInput.value = car.rca_insurance_price || '';
        if (cascoInsuranceInput) cascoInsuranceInput.value = car.casco_insurance_price || '';
        if (likesInput) likesInput.value = car.likes || 0;
        
        // Handle multilingual descriptions
        try {
          const descriptionObj = car.description ? JSON.parse(car.description) : {};
          if (descriptionEnInput) descriptionEnInput.value = descriptionObj.en || '';
          if (descriptionRoInput) descriptionRoInput.value = descriptionObj.ro || '';
          if (descriptionRuInput) descriptionRuInput.value = descriptionObj.ru || '';
        } catch (e) {
          // Fallback for old single-language descriptions
          if (descriptionEnInput) descriptionEnInput.value = car.description || '';
          if (descriptionRoInput) descriptionRoInput.value = '';
          if (descriptionRuInput) descriptionRuInput.value = '';
        }
        
        // Handle booked_until date
        const bookedUntilInput = editForm.querySelector('input[name="booked_until"]');
        if (bookedUntilInput) {
          if (car.booked_until) {
            const date = new Date(car.booked_until);
            const dateString = date.toISOString().split('T')[0];
            bookedUntilInput.value = dateString;
          } else {
            bookedUntilInput.value = '';
          }
        }
        
        // Store original image data for restoration if form is closed without saving
        editForm.dataset.originalHeadImageData = car.head_image || '';
        editForm.dataset.originalGalleryImagesData = car.gallery_images ? JSON.stringify(car.gallery_images) : '';
        
        // Show current images if they exist
        const editHeadImagePreview = document.getElementById('editHeadImagePreview');
        if (car.head_image && editHeadImagePreview) {
          editHeadImagePreview.innerHTML = `
            <div style="position: relative; display: inline-block;">
              <img src="${car.head_image.startsWith('http') ? car.head_image : window.API_BASE_URL + car.head_image}" alt="Current head image" style="max-width: 200px; max-height: 150px; border-radius: 4px;">
              <button type="button" class="btn btn-danger btn-sm" style="position: absolute; top: -8px; right: -8px; border-radius: 50%; width: 24px; height: 24px; padding: 0; font-size: 12px;" onclick="removeHeadImage()">×</button>
            </div>
          `;
        } else {
          if (editHeadImagePreview) editHeadImagePreview.innerHTML = '';
        }
        
        const editGalleryImagesPreview = document.getElementById('editGalleryImagesPreview');
        if (car.gallery_images && car.gallery_images.length > 0 && editGalleryImagesPreview) {
          editGalleryImagesPreview.innerHTML = car.gallery_images.map((img, index) => `
            <div style="position: relative; display: inline-block; margin: 5px;">
              <img src="${img.startsWith('http') ? img : window.API_BASE_URL + img}" alt="Gallery image" style="max-width: 100px; max-height: 75px; border-radius: 4px;">
              <button type="button" class="btn btn-danger btn-sm" style="position: absolute; top: -8px; right: -8px; border-radius: 50%; width: 24px; height: 24px; padding: 0; font-size: 12px;" onclick="removeGalleryImageByUrl('${img}')">×</button>
            </div>
          `).join('');
        } else {
          if (editGalleryImagesPreview) editGalleryImagesPreview.innerHTML = '';
        }
        
        // Store car ID for form submission
        editForm.dataset.carId = carId;
        
        // Show the edit panel
        const editCarPanel = document.getElementById('editCarPanel');
        const adminOverlay = document.getElementById('adminOverlay');
        editCarPanel.classList.add('active');
        adminOverlay.classList.add('active');
        document.body.classList.add('admin-popup-open');
        
        // Store original values after a short delay to ensure form is populated
        setTimeout(() => storeOriginalValues('editCarForm'), 100);
        
      } catch (error) {
        console.error('Error loading car for editing:', error);
        showCustomAlert('Error loading car data', 'error');
      }
    }

    async function deleteCar(carId) {
      if (confirm('Are you sure you want to delete this car?')) {
        try {
          const token = localStorage.getItem('adminToken');
          const response = await fetch(`${window.API_BASE_URL}/api/cars/${carId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (response.ok) {
            showCustomAlert('Car deleted successfully!', 'success');
            loadCars();
          } else {
            const error = await response.json();
            showCustomAlert('Error deleting car: ' + error.error, 'error');
          }
        } catch (error) {
          console.error('Error deleting car:', error);
          showCustomAlert('Error deleting car', 'error');
        }
      }
    }

    async function togglePremium(carId, isPremium) {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${window.API_BASE_URL}/api/cars/${carId}/premium`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ is_premium: isPremium })
        });
        
        if (response.ok) {
          showCustomAlert(`Car ${isPremium ? 'marked as premium' : 'removed from premium'} successfully!`, 'success');
          loadCars();
        } else {
          const error = await response.json();
          showCustomAlert('Error updating premium status: ' + error.error, 'error');
        }
      } catch (error) {
        console.error('Error updating premium status:', error);
        showCustomAlert('Error updating premium status', 'error');
      }
    }

    async function editCoupon(couponId) {
      try {
        const response = await fetch(`${window.API_BASE_URL}/api/coupons/${couponId}`);
        const coupon = await response.json();
        
        if (!response.ok) {
          showCustomAlert('Error loading coupon data: ' + coupon.error, 'error');
          return;
        }
        
        // Populate the edit form with coupon data
        const editForm = document.getElementById('editCouponForm');
        if (!editForm) return;
        
        // Fill in the form fields
        const codeInput = editForm.querySelector('input[name="code"]');
        const typeSelect = editForm.querySelector('select[name="type"]');
        const discountPercentageInput = editForm.querySelector('input[name="discount_percentage"]');
        const freeDaysInput = editForm.querySelector('input[name="free_days"]');
        const descriptionInput = editForm.querySelector('textarea[name="description"]');
        const expiresAtInput = editForm.querySelector('input[name="expires_at"]');
        const isActiveSelect = editForm.querySelector('select[name="is_active"]');
        
        if (codeInput) codeInput.value = coupon.code || '';
        if (typeSelect) typeSelect.value = coupon.type || 'percentage';
        if (discountPercentageInput) discountPercentageInput.value = coupon.discount_percentage || '';
        if (freeDaysInput) freeDaysInput.value = coupon.free_days || '';
        if (descriptionInput) descriptionInput.value = coupon.description || '';
        if (isActiveSelect) isActiveSelect.value = coupon.is_active ? '1' : '0';
        
        // Handle expiry date
        if (expiresAtInput && coupon.expires_at) {
          const date = new Date(coupon.expires_at);
          const dateString = date.toISOString().slice(0, 16); // Format for datetime-local
          expiresAtInput.value = dateString;
        } else if (expiresAtInput) {
          expiresAtInput.value = '';
        }
        
        // Trigger the type change event to show/hide appropriate fields
        if (typeSelect) {
          typeSelect.dispatchEvent(new Event('change'));
        }
        
        // Show the edit panel
        const editCouponPanel = document.getElementById('editCouponPanel');
        const couponOverlay = document.getElementById('couponOverlay');
        if (editCouponPanel && couponOverlay) {
          editCouponPanel.classList.add('active');
          couponOverlay.classList.add('active');
          document.body.classList.add('admin-popup-open');
        }
        
        // Store the coupon ID for the form submission
        editForm.dataset.couponId = couponId;
        
        // Store original values for unsaved changes detection
        setTimeout(() => {
          storeOriginalValues('editCouponForm');
        }, 100);
        
        // Load dynamic codes for this coupon
        await loadDynamicCodes(couponId);
        
      } catch (error) {
        console.error('Error loading coupon data:', error);
        showCustomAlert('Error loading coupon data', 'error');
      }
    }

    // Function to load dynamic codes for a coupon
    async function loadDynamicCodes(couponId) {
      try {
        const activeCodesTable = document.getElementById('activeCodesTable');
        const redeemedCodesTable = document.getElementById('redeemedCodesTable');
        
        if (!activeCodesTable || !redeemedCodesTable) return;
        
        // Fetch coupon data to get the arrays
        const response = await fetch(`${window.API_BASE_URL}/api/coupons/${couponId}`);
        if (!response.ok) {
          console.error('Failed to fetch coupon data for dynamic codes');
          return;
        }
        
        const coupon = await response.json();
        
        // Parse the JSON arrays from the database
        let availableCodes = [];
        let showedCodes = [];
        
        try {
          availableCodes = coupon.available_codes ? JSON.parse(coupon.available_codes) : [];
          showedCodes = coupon.showed_codes ? JSON.parse(coupon.showed_codes) : [];
        } catch (parseError) {
          console.error('Error parsing JSON arrays:', parseError);
          availableCodes = [];
          showedCodes = [];
        }
        
        // Populate active codes table (available_codes)
        const activeTbody = activeCodesTable.querySelector('tbody');
        if (availableCodes.length === 0) {
          activeTbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted py-3">No active codes available</td></tr>';
        } else {
          activeTbody.innerHTML = availableCodes.slice(0, 10).map(code => `
            <tr>
              <td><code>${code}</code></td>
              <td>${new Date().toLocaleDateString()}</td>
            </tr>
          `).join('');
        }
        
        // Populate redeemed codes table (showed_codes)
        const redeemedTbody = redeemedCodesTable.querySelector('tbody');
        if (showedCodes.length === 0) {
          redeemedTbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted py-3">No redeemed codes</td></tr>';
        } else {
          redeemedTbody.innerHTML = showedCodes.slice(0, 10).map(code => `
            <tr>
              <td><code>${code}</code></td>
              <td>${new Date().toLocaleDateString()}</td>
            </tr>
          `).join('');
        }
        
        // Set the href for the "See all codes" link
        const seeAllCodesBtn = document.getElementById('seeAllCodesBtn');
        if (seeAllCodesBtn) {
          seeAllCodesBtn.href = `all-codes?id=${couponId}`;
        }

        
      } catch (error) {
        console.error('Error loading dynamic codes:', error);
      }
    }
    


    // Function to show custom delete confirmation overlay
    function showDeleteConfirmation(couponId) {
      const overlay = document.getElementById('deleteConfirmationOverlay');
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      const cancelBtn = document.getElementById('cancelDeleteBtn');
      
      if (!overlay || !confirmBtn || !cancelBtn) {
        console.error('❌ Delete confirmation elements not found');
        return;
      }
      
      // Set global variables for onclick handlers
      currentDeleteCouponId = couponId;
      currentDeleteOverlay = overlay;
      
      // Show overlay
      overlay.style.display = 'block';
      
      // Handle confirm button click
      const handleConfirm = async () => {
        overlay.style.display = 'none';
        await performDeleteCoupon(couponId);
      };
      
      // Handle cancel button click
      const handleCancel = () => {
        overlay.style.display = 'none';
      };
      
      // Remove existing event listeners
      confirmBtn.removeEventListener('click', handleConfirm);
      cancelBtn.removeEventListener('click', handleCancel);
      
      // Add event listeners
      confirmBtn.addEventListener('click', handleConfirm);
      cancelBtn.addEventListener('click', handleCancel);
      
      // Close overlay when clicking outside
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          handleCancel();
        }
      });
    }
    
    // Function to perform the actual delete operation
    async function performDeleteCoupon(couponId) {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${window.API_BASE_URL}/api/coupons/${couponId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          showCustomAlert('Coupon deleted successfully!', 'success');
          loadCoupons();
        } else {
          const error = await response.json();
          console.error('❌ Error response:', error);
          showCustomAlert('Error deleting coupon: ' + error.error, 'error');
        }
      } catch (error) {
        console.error('❌ Error deleting coupon:', error);
        showCustomAlert('Error deleting coupon', 'error');
      }
    }

    // Global variables to store current coupon ID
    let currentDeleteCouponId = null;
    let currentDeleteOverlay = null;

    // Global functions for onclick handlers
    function handleCancelDelete() {
      if (currentDeleteOverlay) {
        currentDeleteOverlay.style.display = 'none';
      }
    }

    function handleConfirmDelete() {
      if (currentDeleteOverlay) {
        currentDeleteOverlay.style.display = 'none';
      }
      if (currentDeleteCouponId) {
        performDeleteCoupon(currentDeleteCouponId);
      }
    }

    async function deleteCoupon(couponId) {
      // Show custom delete confirmation overlay
      showDeleteConfirmation(couponId);
    }


    </script>
    
            <!-- Global formatting function -->
        <script>
            // Global formatting function
            function formatDisplayText(rawKey) {
              if (!rawKey) return '';
              return rawKey
                .split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
            }

            // Function to get mapped display text for car attributes
            function getMappedDisplayText(attributeType, value) {
              if (!value) return '-';
              
              const mappings = {
                luggage: {
                  '1_small': '1 Small Suitcase',
                  '2_small': '2 Small Suitcases',
                  '1_large': '1 Large Suitcase',
                  '2_large': '2 Large Suitcases',
                  '3_large': '3 Large Suitcases',
                  '1_small_1_large': '1 Small + 1 Large Suitcase',
                  '2_small_1_large': '2 Small + 1 Large Suitcase',
                  '1_small_2_large': '1 Small + 2 Large Suitcases',
                  '2_small_2_large': '2 Small + 2 Large Suitcases',
                  '3_small_1_large': '3 Small + 1 Large Suitcase',
                  '4_small': '4 Small Suitcases',
                  '5_small': '5 Small Suitcases',
                  '4_large': '4 Large Suitcases',
                  '5_large': '5 Large Suitcases'
                },
                drive: {
                  'front_wheel': 'Front Wheel Drive',
                  'rear_wheel': 'Rear Wheel Drive',
                  'all_wheel': 'All Wheel Drive',
                  'four_wheel': '4-Wheel Drive'
                }
              };
              
              return mappings[attributeType]?.[value] || value;
            }
        </script>
        
        <!-- Autocomplete functionality -->
        <script>
            // Initialize autocomplete functionality
            function initializeAutocomplete() {
          // Data for autocomplete
          const makes = [
            'bmw', 'mercedes', 'audi', 'volkswagen', 'toyota', 'honda', 'ford', 'chevrolet', 
            'nissan', 'hyundai', 'kia', 'mazda', 'subaru', 'volvo', 'lexus', 'infiniti', 
            'acura', 'buick', 'cadillac', 'chrysler', 'dodge', 'jeep', 'ram', 'gmc', 
            'pontiac', 'saturn', 'oldsmobile', 'plymouth', 'eagle', 'tesla', 'ferrari', 
            'lamborghini', 'porsche', 'maserati', 'aston_martin', 'bentley', 'rolls_royce', 
            'mclaren', 'bugatti', 'koenigsegg', 'pagani', 'rimac', 'lotus', 'alpine', 
            'caterham', 'ariel', 'noble', 'radical', 'ultima', 'zenvo', 'gumpert', 
            'saleen', 'hennessey', 'callaway', 'ruf', 'techart', 'mansory', 'brabus', 
            'alpina', 'hamann', 'hartge', 'ac_schnitzer', 'dinan', 'vorsteiner', 'hre', 
            'adv_1', 'forgiato', 'vossen', 'rohana', 'titan7', 'volk', 'work', 'rays', 
            'enkei', 'bbs', 'oz', 'ssr', 'weds', 'gram_lights', 'volk_racing', 
            'work_emotion', 'volk_te37', 'volk_ce28', 'volk_re30', 'volk_gt_c', 
            'volk_gt_n', 'volk_gt_v', 'volk_gt_u', 'volk_gt_f', 'volk_gt_m', 'volk_gt_s', 
            'volk_gt_t', 'volk_gt_w', 'volk_gt_x', 'volk_gt_y', 'volk_gt_z'
          ];
          
          const models = [
            '3_series', '5_series', 'x3', 'x5', 'x7', 'z4', 'm3', 'm5', 'm8',
            'c_class', 'e_class', 's_class', 'gla', 'glc', 'gle', 'gls', 'amg_gt',
            'a3', 'a4', 'a6', 'a8', 'q3', 'q5', 'q7', 'q8', 'rs6', 'rs7',
            'golf', 'passat', 'tiguan', 'atlas', 'id4',
            'camry', 'corolla', 'rav4', 'highlander', 'prius',
            'civic', 'accord', 'cr_v', 'pilot',
            'focus', 'fusion', 'escape', 'explorer',
            'cruze', 'malibu', 'equinox', 'tahoe',
            'sentra', 'altima', 'rogue', 'murano',
            'elantra', 'sonata', 'tucson', 'santa_fe',
            'forte', 'optima', 'sportage', 'sorento',
            'mazda3', 'mazda6', 'cx5', 'cx9',
            'impreza', 'legacy', 'forester', 'outback',
            's60', 's90', 'xc40', 'xc60', 'xc90',
            'es', 'ls', 'rx', 'nx', 'gx', 'lx',
            'q50', 'q70', 'qx50', 'qx60',
            'tlx', 'rlx', 'rdx', 'mdx',
            'regal', 'lacrosse', 'encore', 'enclave',
            'cts', 'ct6', 'xt4', 'xt5', 'escalade',
            '300', 'pacifica', 'charger', 'challenger', 'durango',
            'cherokee', 'grand_cherokee', 'wrangler',
            '1500', '2500', '3500', 'terrain', 'acadia', 'yukon',
            'model_3', 'model_s', 'model_x', 'model_y',
            'f8', 'sf90', 'roma', 'huracan', 'aventador', 'urus',
            '911', 'cayenne', 'macan', 'ghibli', 'quattroporte', 'levante',
            'db11', 'vantage', 'dbs', 'continental', 'flying_spur', 'bentayga',
            'phantom', 'ghost', 'cullinan', '720s', '765lt', 'artura',
            'chiron', 'veyron', 'jesko', 'regera', 'huayra', 'zonda',
            'nevera', 'emira', 'evija', 'a110', 'seven', 'atom', 'm600',
            'sr3', 'evo', 'ts1', 'apollo', 's7', 'venom', 'corvette',
            'ctr', 'gt_street', 'mercedes', 'bmw', 'wheels'
          ];
          
          const colors = [
            'white', 'black', 'silver', 'gray', 'red', 'blue', 'green', 'yellow', 'orange', 
            'purple', 'brown', 'beige', 'gold', 'bronze', 'copper', 'chrome', 'matte_black', 
            'matte_white', 'matte_gray', 'matte_red', 'matte_blue', 'matte_green', 'matte_yellow', 
            'matte_orange', 'matte_purple', 'matte_brown', 'matte_beige', 'matte_gold', 
            'matte_bronze', 'matte_copper', 'matte_chrome', 'pearl_white', 'pearl_black', 
            'pearl_silver', 'pearl_gray', 'pearl_red', 'pearl_blue', 'pearl_green', 'pearl_yellow', 
            'pearl_orange', 'pearl_purple', 'pearl_brown', 'pearl_beige', 'pearl_gold', 
            'pearl_bronze', 'pearl_copper', 'pearl_chrome', 'metallic_white', 'metallic_black', 
            'metallic_silver', 'metallic_gray', 'metallic_red', 'metallic_blue', 'metallic_green', 
            'metallic_yellow', 'metallic_orange', 'metallic_purple', 'metallic_brown', 'metallic_beige', 
            'metallic_gold', 'metallic_bronze', 'metallic_copper', 'metallic_chrome', 'candy_white', 
            'candy_black', 'candy_silver', 'candy_gray', 'candy_red', 'candy_blue', 'candy_green', 
            'candy_yellow', 'candy_orange', 'candy_purple', 'candy_brown', 'candy_beige', 'candy_gold', 
            'candy_bronze', 'candy_copper', 'candy_chrome', 'chameleon_white', 'chameleon_black', 
            'chameleon_silver', 'chameleon_gray', 'chameleon_red', 'chameleon_blue', 'chameleon_green', 
            'chameleon_yellow', 'chameleon_orange', 'chameleon_purple', 'chameleon_brown', 'chameleon_beige', 
            'chameleon_gold', 'chameleon_bronze', 'chameleon_copper', 'chameleon_chrome'
          ];
          
          // Function to create autocomplete
          function createAutocomplete(inputId, dropdownId, options) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            
            if (!input || !dropdown) return;
            
            let selectedIndex = -1;
            
            function filterOptions(query) {
              return options.filter(option => 
                option.toLowerCase().includes(query.toLowerCase())
              );
            }
            
            function highlightMatch(text, query) {
              const regex = new RegExp(`(${query})`, 'gi');
              return text.replace(regex, '<span class="autocomplete-highlight">$1</span>');
            }
            

            
            function showDropdown(filteredOptions) {
              dropdown.innerHTML = '';
              
              if (filteredOptions.length === 0) {
                dropdown.style.display = 'none';
                return;
              }
              
              filteredOptions.forEach((option, index) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                
                // Format display text using the new function
                const displayText = formatDisplayText(option);
                
                item.innerHTML = highlightMatch(displayText, query);
                item.dataset.value = option;
                
                item.addEventListener('click', () => {
                  // Set the formatted display text for user experience
                  input.value = displayText;
                  // Store the raw key in a data attribute for validation
                  input.dataset.rawValue = option;
                  dropdown.style.display = 'none';
                  selectedIndex = -1;
                  input.classList.remove('is-invalid'); // Clear any error state
                  input.classList.add('is-valid'); // Mark as valid
                });
                
                item.addEventListener('mouseenter', () => {
                  selectedIndex = index;
                  updateSelection();
                });
                
                dropdown.appendChild(item);
              });
              
              dropdown.style.display = 'block';
              selectedIndex = -1;
              updateSelection();
            }
            
            function updateSelection() {
              const items = dropdown.querySelectorAll('.autocomplete-item');
              items.forEach((item, index) => {
                item.classList.toggle('selected', index === selectedIndex);
              });
            }
            
            function hideDropdown() {
              dropdown.style.display = 'none';
              selectedIndex = -1;
            }
            
            // Event listeners
            input.addEventListener('input', (e) => {
              const query = e.target.value.trim();
              
              // Only show dropdown if there are actual characters typed
              if (query.length === 0) {
                hideDropdown();
                return;
              }
              
              const filteredOptions = filterOptions(query);
              
              // Update the showDropdown function to use the trimmed query for highlighting
              function showDropdownWithQuery(filteredOptions, query) {
                dropdown.innerHTML = '';
                
                if (filteredOptions.length === 0) {
                  dropdown.style.display = 'none';
                  return;
                }
                
                filteredOptions.forEach((option, index) => {
                  const item = document.createElement('div');
                  item.className = 'autocomplete-item';
                  
                  // Format display text using the new function
                  const displayText = formatDisplayText(option);
                  
                  item.innerHTML = highlightMatch(displayText, query);
                  item.dataset.value = option;
                  
                  item.addEventListener('click', () => {
                    // Set the formatted display text for user experience
                    input.value = displayText;
                    // Store the raw key in a data attribute for validation
                    input.dataset.rawValue = option;
                    dropdown.style.display = 'none';
                    selectedIndex = -1;
                    input.classList.remove('is-invalid'); // Clear any error state
                    input.classList.add('is-valid'); // Mark as valid
                  });
                  
                  item.addEventListener('mouseenter', () => {
                    selectedIndex = index;
                    updateSelection();
                  });
                  
                  dropdown.appendChild(item);
                });
                
                dropdown.style.display = 'block';
                selectedIndex = -1;
                updateSelection();
              }
              
              showDropdownWithQuery(filteredOptions, query);
              
              // Don't validate during typing - let user type freely
              // Validation will happen on blur or form submission
            });
            
            input.addEventListener('keydown', (e) => {
              const items = dropdown.querySelectorAll('.autocomplete-item');
              
              if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateSelection();
              } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection();
              } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && items[selectedIndex]) {
                  input.value = items[selectedIndex].dataset.value;
                  hideDropdown();
                }
              } else if (e.key === 'Escape') {
                hideDropdown();
              }
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
              if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                hideDropdown();
              }
            });
            
            // Add validation on blur
            input.addEventListener('blur', () => {
              setTimeout(() => {
                const currentValue = input.value;
                const rawValue = input.dataset.rawValue;
                
                // Check if the value is a valid option (either exact match or has stored raw value)
                const isValid = options.includes(currentValue) || (rawValue && options.includes(rawValue));
                
                if (currentValue && !isValid) {
                  // Only clear if it's not a valid option and not empty
                  input.value = '';
                  delete input.dataset.rawValue;
                  input.classList.add('is-invalid');
                  input.classList.remove('is-valid');
                } else if (currentValue && isValid) {
                  input.classList.remove('is-invalid');
                  input.classList.add('is-valid');
                } else {
                  input.classList.remove('is-invalid', 'is-valid');
                }
              }, 200);
            });
          }
          
                      // Initialize autocomplete for each field
            // Make name is now a simple select dropdown - no autocomplete needed
            // Model name is now a simple text input - no autocomplete needed
          createAutocomplete('add_exterior_color', 'add_exterior_color_dropdown', colors);
          createAutocomplete('add_interior_color', 'add_interior_color_dropdown', colors);
        }
        
        // Initialize autocomplete when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
          initializeAutocomplete();
        });

        // Spinning Wheel Management Functions
        function initializeSpinningWheel() {
          const addWheelBtn = document.getElementById('addWheelBtn');
          
          if (addWheelBtn) {
            addWheelBtn.addEventListener('click', () => {
              showNewWheelForm();
            });
          }
          
          // Initialize wheel edit form
          initializeWheelEditForm();
          
          // Load spinning wheel data when tab is shown
          loadSpinningWheelData();
          
          // Initialize phone number modal handlers
          initializePhoneNumberModal();
        }

        // Preview a specific wheel
        function previewWheel(wheelId) {
          // Show phone number modal first
          const phoneModal = new bootstrap.Modal(document.getElementById('phoneNumberModal'));
          
          // Store the wheel ID to use when opening the preview
          phoneModal._wheelId = wheelId;
          
          phoneModal.show();
        }

        function showWheelConfiguration(wheelId) {
          loadWheelForEdit(wheelId);
        }

        function showNewWheelForm() {
          resetWheelEditForm();
          showWheelConfigurationPanel();
        }

        function initializeWheelEditForm() {
          const wheelEditForm = document.getElementById('wheelEditForm');
          const activateWheelBtn = document.getElementById('activateWheelBtn');
          
          if (wheelEditForm) {
            wheelEditForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              await saveWheel();
            });
          }
          
          if (activateWheelBtn) {
            activateWheelBtn.addEventListener('click', async () => {
              await activateCurrentWheel();
            });
          }
          
          // Initialize filter buttons
          const filterButtons = document.querySelectorAll('[data-filter]');
          filterButtons.forEach(button => {
            button.addEventListener('click', () => {
              filterButtons.forEach(btn => btn.classList.remove('active'));
              button.classList.add('active');
              filterCoupons(button.dataset.filter);
            });
          });
        }

        async function loadSpinningWheelData() {
          try {
            // Load all spinning wheels
            const wheelsResponse = await fetch(`${window.API_BASE_URL}/api/spinning-wheels`);
            const wheels = await wheelsResponse.json();
            
            // Load coupons for all wheels
            const couponsResponse = await fetch(`${window.API_BASE_URL}/api/coupons`);
            const coupons = await couponsResponse.json();
            
            // Update available coupons info
            const availableCouponsInfo = document.getElementById('availableCouponsInfo');
            if (availableCouponsInfo) {
              // Handle both SQLite (1/0) and Supabase (true/false) boolean values
            const activeCoupons = coupons.filter(coupon => {
              return coupon.is_active === 1 || coupon.is_active === true;
            });
                              // Handle both SQLite (1/0) and Supabase (true/false) boolean values
                const wheelEnabledCoupons = activeCoupons.filter(coupon => {
                  return coupon.wheel_enabled === 1 || coupon.wheel_enabled === true;
                });
              availableCouponsInfo.innerHTML = `
                <strong>${wheelEnabledCoupons.length}</strong> of ${activeCoupons.length} active coupons enabled for wheels
              `;
              availableCouponsInfo.className = 'alert alert-info';
            }
            
            // Load wheels list
            const wheelsList = document.getElementById('wheelsList');
            if (wheelsList) {
              if (wheels.length === 0) {
                wheelsList.innerHTML = '<div class="alert alert-warning">No spinning wheels configured.</div>';
              } else {
                                wheelsList.innerHTML = wheels.map(wheel => `
                  <div class="list-group-item d-flex justify-content-between align-items-center wheel-item" 
                       onclick="showWheelConfiguration(${wheel.id})" 
                       style="cursor: pointer; border-left: 4px solid ${wheel.is_active ? '#28a745' : '#6c757d'}; transition: all 0.2s ease;">
                    <div class="flex-grow-1">
                      <div class="d-flex align-items-center mb-1">
                        <strong class="me-2">${wheel.name}</strong>
                      </div>
                      <small class="text-muted d-block">${wheel.description || 'No description'}</small>
                    </div>
                    <div class="d-flex align-items-center gap-1" onclick="event.stopPropagation();">
                      <button class="btn btn-sm btn-outline-info" onclick="previewWheel(${wheel.id})" title="Preview this wheel">
                        <i class="fa fa-eye"></i>
                      </button>
                      <button class="btn btn-sm ${wheel.is_active ? 'btn-success' : 'btn-outline-secondary'}" 
                              style="${!wheel.is_active ? 'color: #6c757d; border-color: #6c757d;' : ''}"
                              onclick="activateWheel(${wheel.id})" title="${wheel.is_active ? 'Currently Active - Click to Deactivate' : 'Activate this wheel'}">
                        <i class="fa ${wheel.is_active ? 'fa-check' : 'fa-play'}"></i>
                        ${wheel.is_active ? 'Active' : 'Activate'}
                      </button>
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteWheel(${wheel.id})" title="Delete this wheel">
                        <i class="fa fa-trash"></i>
                      </button>
                    </div>
                  </div>
                `).join('');
              }
            }
            
          } catch (error) {
            console.error('Error loading spinning wheel data:', error);
          }
        }

        function initializePhoneNumberModal() {
          const submitPhoneNumberBtn = document.getElementById('submitPhoneNumberBtn');
          const phoneNumberInput = document.getElementById('phoneNumberInput');
          const phoneNumberForm = document.getElementById('phoneNumberForm');
          
          if (submitPhoneNumberBtn) {
            submitPhoneNumberBtn.addEventListener('click', async () => {
              const phoneNumber = phoneNumberInput.value.trim();
              
              if (!phoneNumber) {
                phoneNumberInput.setCustomValidity('Please enter a phone number');
                phoneNumberInput.reportValidity();
                return;
              }
              
              // Phone number validation - same as booking form
              const phoneRegex = /^[\+]?[0-9\s\-\(\)]{8,}$/;
              if (!phoneRegex.test(phoneNumber)) {
                phoneNumberInput.setCustomValidity('Please enter a valid phone number (only numbers, spaces, hyphens, parentheses, and optional + at start)');
                phoneNumberInput.reportValidity();
                return;
              }
              
              // Clear any previous validation message
              phoneNumberInput.setCustomValidity('');
              
                              // Track phone number for spinning wheel
                try {
  const response = await fetch(`${window.API_BASE_URL}/api/spinning-wheels/track-phone`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ phoneNumber: phoneNumber })
                });
                
                if (response.ok) {
                  const result = await response.json();
                } else {
                  console.error('❌ Failed to track phone number');
                }
              } catch (error) {
                console.error('❌ Error tracking phone number:', error);
              }
              
              // Close phone number modal
              const phoneModal = bootstrap.Modal.getInstance(document.getElementById('phoneNumberModal'));
              phoneModal.hide();
              
              // Clear the input
              phoneNumberInput.value = '';
              
              // Open spinning wheel modal with phone number and wheel ID
              const wheelModal = new bootstrap.Modal(document.getElementById('spinningWheelModal'));
              const iframe = document.getElementById('spinningWheelIframe');
              
              // Get the wheel ID from the modal instance
              const phoneModalInstance = bootstrap.Modal.getInstance(document.getElementById('phoneNumberModal'));
              const wheelId = phoneModalInstance._wheelId || 'active';
              
              // Pass phone number and wheel ID to iframe via URL parameter
              if (iframe) {
                const currentSrc = iframe.src.split('?')[0];
                iframe.src = `${currentSrc}?phone=${encodeURIComponent(phoneNumber)}&wheel=${wheelId}`;
              }
              
              wheelModal.show();
            });
          }
          
          // Handle form submission on Enter key
          if (phoneNumberForm) {
            phoneNumberForm.addEventListener('submit', (e) => {
              e.preventDefault();
              
              const phoneNumber = phoneNumberInput.value.trim();
              
              if (!phoneNumber) {
                phoneNumberInput.setCustomValidity('Please enter a phone number');
                phoneNumberInput.reportValidity();
                return;
              }
              
              // Phone number validation - same as booking form
              const phoneRegex = /^[\+]?[0-9\s\-\(\)]{8,}$/;
              if (!phoneRegex.test(phoneNumber)) {
                phoneNumberInput.setCustomValidity('Please enter a valid phone number (only numbers, spaces, hyphens, parentheses, and optional + at start)');
                phoneNumberInput.reportValidity();
                return;
              }
              
              // Clear any previous validation message
              phoneNumberInput.setCustomValidity('');
              
              // Proceed with submission
              submitPhoneNumberBtn.click();
            });
          }
        }

        async function activateWheel(wheelId) {
          try {
            // First, get the current wheel to check if it's already active
            const wheelResponse = await fetch(`${window.API_BASE_URL}/api/spinning-wheels/${wheelId}`);
            if (!wheelResponse.ok) {
              showCustomAlert('Error getting wheel information', 'error');
              return;
            }
            
            const wheel = await wheelResponse.json();
            // Handle both SQLite (1/0) and Supabase (true/false) boolean values
            const isCurrentlyActive = wheel.is_active === 1 || wheel.is_active === true;
            
            // If trying to activate a wheel, check the count of active wheels first
            if (!isCurrentlyActive) {
              // Get all wheels to count active ones
              const allWheelsResponse = await fetch(`${window.API_BASE_URL}/api/spinning-wheels`);
              if (!allWheelsResponse.ok) {
                showCustomAlert('Error getting wheels information', 'error');
                return;
              }
              
              const allWheels = await allWheelsResponse.json();
              const activeWheelsCount = allWheels.filter(w => w.is_active === 1 || w.is_active === true).length;
              
              // Check if we already have 2 active wheels
              if (activeWheelsCount >= 2) {
                showCustomAlert('You already have 2 active wheels. Please disable one if you want to enable another one.', 'warning');
                return;
              }
            }
            
            // Choose endpoint based on current state
            const endpoint = isCurrentlyActive ? 'deactivate' : 'activate';
            const token = localStorage.getItem('adminToken');
            const response = await fetch(`${window.API_BASE_URL}/api/spinning-wheels/${wheelId}/${endpoint}`, {
              method: 'PATCH',
              headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              }
            });
            
            if (response.ok) {
              const action = isCurrentlyActive ? 'deactivated' : 'activated';
              showCustomAlert(`Wheel ${action} successfully`, 'success');
              loadSpinningWheelData();
              
              // Open the wheel configuration after activation/deactivation
              showWheelConfiguration(wheelId);
            } else {
              const error = await response.json();
              // Check if it's the maximum limit error
              if (response.status === 400 && error.error && error.error.includes('Maximum limit reached')) {
                showCustomAlert('You already have 2 active wheels. Please disable one if you want to enable another one.', 'warning');
              } else {
                showCustomAlert(`Error ${isCurrentlyActive ? 'deactivating' : 'activating'} wheel: ` + error.error, 'error');
              }
            }
          } catch (error) {
            console.error('Error toggling wheel state:', error);
            showCustomAlert('Error toggling wheel state', 'error');
          }
        }



        async function deleteWheel(wheelId) {
          if (!confirm('Are you sure you want to delete this wheel?')) return;
          
          try {
            const response = await fetch(`${window.API_BASE_URL}/api/spinning-wheels/${wheelId}`, {
              method: 'DELETE'
            });
            
            if (response.ok) {
              showCustomAlert('Wheel deleted successfully', 'success');
              loadSpinningWheelData();
            } else {
              const error = await response.json();
              showCustomAlert('Error deleting wheel: ' + error.error, 'error');
            }
          } catch (error) {
            console.error('Error deleting wheel:', error);
            showCustomAlert('Error deleting wheel', 'error');
          }
        }

        // Wheel Edit Functions
        let currentEditingWheelId = null;
        let currentEditingWheel = null;

        function showWheelConfigurationPanel() {
          const wheelConfigurationPanel = document.getElementById('wheelConfigurationPanel');
          if (wheelConfigurationPanel) {
            wheelConfigurationPanel.innerHTML = `
              <div class="card shadow-sm">
                <div class="card-header bg-light">
                  <h5 class="mb-0" id="wheelEditTitle"><i class="fa fa-cog"></i> ${currentEditingWheelId ? 'Edit Wheel' : 'New Wheel'}</h5>
                </div>
                <div class="card-body">
                  
                  <!-- Wheel Details Form -->
                  <form id="wheelEditForm" class="mb-4">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label fw-bold"><i class="fa fa-tag"></i> Wheel Name</label>
                          <input type="text" id="wheelNameInput" class="form-control" required>
                        </div>
                      </div>

                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-bold"><i class="fa fa-align-left"></i> Description</label>
                      <textarea id="wheelDescriptionInput" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="d-flex gap-2">
                      ${!currentEditingWheelId ? `<button type="submit" class="btn btn-primary">
                        <i class="fa fa-save"></i> Save Wheel
                      </button>` : ''}
                      ${currentEditingWheelId && currentEditingWheel && !currentEditingWheel.is_active ? `<button type="button" class="btn btn-success" id="activateWheelBtn">
                        <i class="fa fa-star"></i> Activate This Wheel
                      </button>` : ''}
                    </div>
                  </form>

                  <!-- Coupons Management Section - Only show when editing existing wheel -->
                  ${currentEditingWheelId ? `
                  <div class="mt-4">
                    <div class="card">
                      <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fa fa-gift"></i> Manage Coupons for this Wheel</h5>
                      </div>
                      <div class="card-body">
                        <p class="text-muted mb-3">Select which coupons should appear on this spinning wheel</p>
                        


                        <div id="wheelCouponsList" class="list-group">
                          <!-- Coupons will be loaded here -->
                        </div>
                      </div>
                    </div>
                  </div>
                  ` : ''}
                </div>
              </div>
            `;
            
            // Re-initialize the form
            initializeWheelEditForm();
          }
        }

        async function loadWheelForEdit(wheelId) {
          try {
            const response = await fetch(`${window.API_BASE_URL}/api/spinning-wheels/${wheelId}`);
            if (response.ok) {
              const wheel = await response.json();
              currentEditingWheelId = wheelId;
              currentEditingWheel = wheel;
              
              // Show configuration panel
              showWheelConfigurationPanel();
              
              // Populate form
              const wheelNameInput = document.getElementById('wheelNameInput');
              const wheelDescriptionInput = document.getElementById('wheelDescriptionInput');
              
              if (wheelNameInput) wheelNameInput.value = wheel.name;
              if (wheelDescriptionInput) wheelDescriptionInput.value = wheel.description || '';
              
              // Update the title
              const wheelEditTitle = document.getElementById('wheelEditTitle');
              if (wheelEditTitle) {
                wheelEditTitle.textContent = `Edit ${wheel.name}`;
              }
              
              // Load coupons for this wheel
              await loadWheelCoupons();
            } else {
              showCustomAlert('Error loading wheel data', 'error');
            }
          } catch (error) {
            console.error('Error loading wheel for edit:', error);
            showCustomAlert('Error loading wheel data', 'error');
          }
        }

        function resetWheelEditForm() {
          currentEditingWheelId = null;
          currentEditingWheel = null;
          showWheelConfigurationPanel();
          
          // Safely reset form elements
          const wheelNameInput = document.getElementById('wheelNameInput');
          const wheelDescriptionInput = document.getElementById('wheelDescriptionInput');
          const wheelCouponsList = document.getElementById('wheelCouponsList');
          
          if (wheelNameInput) wheelNameInput.value = '';
          if (wheelDescriptionInput) wheelDescriptionInput.value = '';
          if (wheelCouponsList) wheelCouponsList.innerHTML = '';
          
          // Don't load coupons for new wheel since the section is hidden
        }

        // Store pending changes for wheel configuration
        let pendingWheelChanges = {
          enabledCoupons: new Set(),
          disabledCoupons: new Set(),
          percentageChanges: new Map()
        };

        function updateSaveChangesButton() {
          const totalChanges = pendingWheelChanges.enabledCoupons.size + 
                             pendingWheelChanges.disabledCoupons.size + 
                             pendingWheelChanges.percentageChanges.size;
          
          const saveButton = document.querySelector('button[onclick="saveWheelChanges()"]');
          if (saveButton) {
            saveButton.disabled = totalChanges === 0;
            saveButton.innerHTML = `<i class="fa fa-save"></i> Save Changes ${totalChanges > 0 ? `(${totalChanges})` : ''}`;
          }
        }

            async function loadWheelCoupons() {
      try {
            const response = await fetch(`${window.API_BASE_URL}/api/coupons`);
            const coupons = await response.json();
            
            let enabledCouponIds = new Set();
            let wheelCoupons = [];
            
            // If editing an existing wheel, get wheel-specific coupon status
            if (currentEditingWheelId) {
              const wheelCouponsResponse = await fetch(`${window.API_BASE_URL}/api/spinning-wheels/${currentEditingWheelId}/coupons?t=${Date.now()}`);
              if (wheelCouponsResponse.ok) {
                wheelCoupons = await wheelCouponsResponse.json();
              }
              
              // Create a set of enabled coupon IDs for this wheel
              enabledCouponIds = new Set(wheelCoupons.map(wc => wc.coupon_id));
            }
            
            // Reset pending changes when loading
            pendingWheelChanges = {
              enabledCoupons: new Set(),
              disabledCoupons: new Set(),
              percentageChanges: new Map()
            };
            
            // Show only active coupons with wheel-specific status
            // Handle both SQLite (1/0) and Supabase (true/false) boolean values
            const activeCoupons = coupons.filter(coupon => {
              // Check for both formats: SQLite uses 1/0, Supabase uses true/false
              return coupon.is_active === 1 || coupon.is_active === true;
            });
            
            const wheelCouponsList = document.getElementById('wheelCouponsList');
            if (wheelCouponsList) {
              if (activeCoupons.length === 0) {
                wheelCouponsList.innerHTML = '<div class="alert alert-warning">No active coupons found.</div>';
              } else {
                wheelCouponsList.innerHTML = activeCoupons.map(coupon => {
                  const isEnabledForWheel = enabledCouponIds.has(coupon.id);
                  // Get the wheel coupon data to find the percentage if it exists
                  const wheelCoupon = wheelCoupons.find(wc => wc.coupon_id === coupon.id);
                  const currentPercentage = wheelCoupon ? wheelCoupon.percentage || 0 : 0;
                  
                                    // Check if coupon has active codes
                  const availableCodes = JSON.parse(coupon.available_codes || '[]');
                  const hasActiveCodes = availableCodes.length > 0;
                  
                  return `
                  <div class="list-group-item coupon-item ${isEnabledForWheel ? 'enabled' : 'disabled'}" data-coupon-id="${coupon.id}">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="flex-grow-1">
                      <strong>${coupon.code}</strong>
                      <br>
                      <small class="text-muted">
                        ${coupon.type === 'free_days' ? 
                          `${coupon.free_days} ${coupon.free_days === 1 ? 'Day Free' : 'Days Free'}` : 
                          `${coupon.discount_percentage}% OFF`}
                      </small>
                      <br>
                      <small class="text-muted">${coupon.description || 'No description'}</small>
                      
                      ${!hasActiveCodes ? `
                        <div class="mt-2">
                          <span class="badge bg-warning text-dark">
                            <i class="fa fa-exclamation-triangle"></i> No active codes
                          </span>
                        </div>
                      ` : ''}
                        
                        ${isEnabledForWheel ? `
                        <div class="mt-3 percentage-field" style="display: block;">
                          <label class="form-label small mb-1">
                            <i class="fa fa-percentage"></i> Wheel Percentage (%)
                          </label>
                          <input type="number" 
                                 class="form-control form-control-sm" 
                                 id="percentage-${coupon.id}" 
                                 value="${currentPercentage}"
                                 min="0" 
                                 max="100" 
                                 step="0.1"
                                 placeholder="Enter percentage"
                                 onchange="updateCouponPercentage(${coupon.id}, this.value)">
                    </div>
                        ` : ''}
                      </div>
                      
                      <div class="d-flex align-items-center gap-2 ms-3">
                        <button type="button" class="btn btn-sm wheel-coupon-button ${isEnabledForWheel ? 'btn-success' : 'btn-outline-secondary'}" 
                                style="position: relative; z-index: 1000;"
                                onclick="toggleCouponForWheel(${coupon.id}, this.getAttribute('data-enabled') === 'true')"
                                data-coupon-id="${coupon.id}"
                                data-enabled="${isEnabledForWheel}"
                                ${!hasActiveCodes && !isEnabledForWheel ? 'disabled' : ''}
                                title="${!hasActiveCodes && !isEnabledForWheel ? 'Cannot enable: No active codes available' : ''}">
                          ${isEnabledForWheel ? '<i class="fa fa-check"></i> Enabled' : 'Enable'}
                      </button>
                      </div>
                    </div>
                  </div>
                `;
                }).join('');
                
                // Add Save Changes button
                wheelCouponsList.innerHTML += `
                  <div class="mt-4 text-center">
                    <button type="button" class="btn btn-primary" onclick="saveWheelChanges()" disabled>
                      <i class="fa fa-save"></i> Save Changes
                    </button>
                  </div>
                `;
                
                // Update the button state
                updateSaveChangesButton();
                
                // Initialize the total percentage display
                updateTotalPercentageDisplay();
              }
              

            }
          } catch (error) {
            console.error('Error loading wheel coupons:', error);
            const wheelCouponsList = document.getElementById('wheelCouponsList');
            if (wheelCouponsList) {
              wheelCouponsList.innerHTML = '<div class="alert alert-danger">Error loading coupons.</div>';
            }
          }
        }



        function toggleCouponForWheel(couponId, currentStatus) {
          if (!currentEditingWheelId) {
            showCustomAlert('Please save the wheel first before managing coupons', 'error');
            return;
          }
          
          // Check if the button is disabled (no active codes)
          const button = document.querySelector(`button[data-coupon-id="${couponId}"]`);
          if (button && button.disabled) {
            showCustomAlert('Cannot enable this coupon: No active codes available', 'warning');
            return;
          }
          
          // Get the original state from the database (before any pending changes)
          const originalEnabledState = Array.from(document.querySelectorAll('.coupon-item')).find(item => 
            item.getAttribute('data-coupon-id') == couponId
          )?.classList.contains('enabled') || false;
          
          // Calculate the final desired state
          const finalDesiredState = !currentStatus;
          
          // Clear any existing pending changes for this coupon
          pendingWheelChanges.enabledCoupons.delete(couponId);
          pendingWheelChanges.disabledCoupons.delete(couponId);
          pendingWheelChanges.percentageChanges.delete(couponId);
          
          // Store the change in pending changes based on the final desired state
          if (finalDesiredState) {
            // Want to enable it
            pendingWheelChanges.enabledCoupons.add(couponId);
          } else {
            // Want to disable it
            pendingWheelChanges.disabledCoupons.add(couponId);
          }
          
          // Update the UI immediately to show the change
          const couponItem = document.querySelector(`[data-coupon-id="${couponId}"]`);
          if (couponItem) {
            const button = couponItem.querySelector('button');
            const newStatus = !currentStatus;
            
            if (newStatus) {
              couponItem.classList.remove('disabled');
              couponItem.classList.add('enabled');
              button.className = 'btn btn-sm wheel-coupon-button btn-success';
              button.innerHTML = '<i class="fa fa-check"></i> Enabled';
              button.style.color = '';
              button.style.borderColor = '';
              button.setAttribute('data-enabled', 'true');
              
              // Add percentage field if it doesn't exist
              const percentageField = couponItem.querySelector('.percentage-field');
              if (!percentageField) {
                const flexGrowDiv = couponItem.querySelector('.flex-grow-1');
                const percentageHtml = `
                  <div class="mt-3 percentage-field" style="display: block;">
                    <label class="form-label small mb-1">
                      <i class="fa fa-percentage"></i> Wheel Percentage (%)
                    </label>
                    <input type="number" 
                           class="form-control form-control-sm" 
                           id="percentage-${couponId}" 
                           value="0"
                           min="0" 
                           max="100" 
                           step="0.1"
                           placeholder="Enter percentage"
                           onchange="updateCouponPercentage(${couponId}, this.value)">
                  </div>
                `;
                flexGrowDiv.insertAdjacentHTML('beforeend', percentageHtml);
              }
            } else {
              couponItem.classList.remove('enabled');
              couponItem.classList.add('disabled');
              button.className = 'btn btn-sm wheel-coupon-button btn-outline-secondary';
              button.innerHTML = 'Enable';
              button.style.color = '';
              button.style.borderColor = '';
              button.setAttribute('data-enabled', 'false');
              
              // Remove percentage field
              const percentageField = couponItem.querySelector('.percentage-field');
              if (percentageField) {
                percentageField.remove();
              }
            }
          }
          
          // Update the Save Changes button
          updateSaveChangesButton();
          
          // Update the total percentage display
          updateTotalPercentageDisplay();
          
          showCustomAlert(`Coupon will be ${!currentStatus ? 'enabled' : 'disabled'} when you save changes`, 'info');
        }

        function updateCouponPercentage(couponId, percentage) {
          if (!currentEditingWheelId) {
            showCustomAlert('Please save the wheel first before managing coupons', 'error');
            return;
          }
          
          // Validate percentage
          const numPercentage = parseFloat(percentage);
          if (isNaN(numPercentage) || numPercentage < 0 || numPercentage > 100) {
            showCustomAlert('Percentage must be between 0 and 100', 'error');
            return;
          }
          
          // Store the percentage change in pending changes
          pendingWheelChanges.percentageChanges.set(couponId, numPercentage);
          
          // Update the Save Changes button
          updateSaveChangesButton();
          
          // Update the total percentage display
          updateTotalPercentageDisplay();
          
          showCustomAlert(`Percentage will be updated to ${numPercentage}% when you save changes`, 'info');
        }

        function updateTotalPercentageDisplay() {
          // Calculate current total percentage
          const enabledCoupons = Array.from(document.querySelectorAll('.coupon-item.enabled'));
          let totalPercentage = 0;
          const percentageDetails = [];

          for (const couponItem of enabledCoupons) {
            const couponId = couponItem.getAttribute('data-coupon-id');
            const percentageInput = document.getElementById(`percentage-${couponId}`);
            
            if (percentageInput) {
              // Check if this coupon has a pending percentage change
              let percentage = pendingWheelChanges.percentageChanges.has(parseInt(couponId)) 
                ? pendingWheelChanges.percentageChanges.get(parseInt(couponId))
                : parseFloat(percentageInput.value) || 0;
              
              totalPercentage += percentage;
              percentageDetails.push(`${couponItem.querySelector('strong').textContent}: ${percentage}%`);
            }
          }

          // Round to 2 decimal places
          totalPercentage = Math.round(totalPercentage * 100) / 100;

          // Update or create the total percentage display
          let totalDisplay = document.getElementById('total-percentage-display');
          if (!totalDisplay) {
            totalDisplay = document.createElement('div');
            totalDisplay.id = 'total-percentage-display';
            totalDisplay.className = 'alert mt-3';
            
            // Insert before the Save Changes button
            const saveButtonContainer = document.querySelector('.mt-4.text-center');
            if (saveButtonContainer) {
              saveButtonContainer.parentNode.insertBefore(totalDisplay, saveButtonContainer);
            }
          }

          // Set the display style based on the total
          if (totalPercentage === 100) {
            totalDisplay.className = 'alert alert-success mt-3';
            totalDisplay.innerHTML = `
              <i class="fa fa-check-circle"></i> 
              <strong>Total Percentage: ${totalPercentage}%</strong> - Ready to save!
            `;
          } else if (totalPercentage > 100) {
            totalDisplay.className = 'alert alert-danger mt-3';
            totalDisplay.innerHTML = `
              <i class="fa fa-exclamation-triangle"></i> 
              <strong>Total Percentage: ${totalPercentage}%</strong> - Exceeds 100%!
            `;
          } else {
            totalDisplay.className = 'alert alert-warning mt-3';
            totalDisplay.innerHTML = `
              <i class="fa fa-info-circle"></i> 
              <strong>Total Percentage: ${totalPercentage}%</strong> - Need ${100 - totalPercentage}% more
            `;
          }
        }

        async function saveWheelChanges() {
          if (!currentEditingWheelId) {
            showCustomAlert('Please save the wheel first before managing coupons', 'error');
            return;
          }
          
          // Check if there are any pending changes
          const hasChanges = pendingWheelChanges.enabledCoupons.size > 0 || 
                           pendingWheelChanges.disabledCoupons.size > 0 || 
                           pendingWheelChanges.percentageChanges.size > 0;
          
          if (!hasChanges) {
            showCustomAlert('No changes to save', 'info');
            return;
          }

          // Validate that total percentage equals exactly 100%
          try {
            // Get all enabled coupons and their percentages
            const enabledCoupons = Array.from(document.querySelectorAll('.coupon-item.enabled'));
            let totalPercentage = 0;
            const percentageDetails = [];

            for (const couponItem of enabledCoupons) {
              const couponId = couponItem.getAttribute('data-coupon-id');
              const percentageInput = document.getElementById(`percentage-${couponId}`);
              
              if (percentageInput) {
                // Check if this coupon has a pending percentage change
                let percentage = pendingWheelChanges.percentageChanges.has(parseInt(couponId)) 
                  ? pendingWheelChanges.percentageChanges.get(parseInt(couponId))
                  : parseFloat(percentageInput.value) || 0;
                
                totalPercentage += percentage;
                percentageDetails.push(`${couponItem.querySelector('strong').textContent}: ${percentage}%`);
              }
            }

            // Round to 2 decimal places to handle floating point precision issues
            totalPercentage = Math.round(totalPercentage * 100) / 100;

            if (totalPercentage !== 100) {
              const errorMessage = `Total percentage must equal exactly 100%. Current total: ${totalPercentage}%\n\nBreakdown:\n${percentageDetails.join('\n')}`;
              showCustomAlert(errorMessage, 'error');
              return;
            }

          } catch (error) {
            console.error('Error during percentage validation:', error);
            showCustomAlert('Error validating percentages', 'error');
            return;
          }
          
          try {
            // Apply all pending changes in the correct order
            const promises = [];
            
            // First, enable coupons (but exclude any that are also in disabledCoupons)
            for (const couponId of pendingWheelChanges.enabledCoupons) {
              if (!pendingWheelChanges.disabledCoupons.has(couponId)) {
                promises.push(
                  fetch(`${window.API_BASE_URL}/api/coupons/${couponId}/toggle-wheel?wheelId=${currentEditingWheelId}`, {
              method: 'PATCH',
              headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
              }
                  }).then(response => {
                    if (!response.ok) {
                      console.error(`Failed to enable coupon ${couponId}:`, response.status, response.statusText);
                      throw new Error(`Failed to enable coupon ${couponId}`);
                    }
                    return response.json();
                  }).then(data => {
                    return data;
                  })
                );
              }
            }
            
            // Wait for enable operations to complete
            if (promises.length > 0) {
              await Promise.all(promises);
              // Add a small delay to ensure database operations complete
              await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Reset promises array for next batch
            const percentagePromises = [];
            
            // Then, update percentages for coupons that have percentage changes
            for (const [couponId, percentage] of pendingWheelChanges.percentageChanges) {
              // Update percentage if the coupon is being enabled (it will exist in the wheel after enable)
              // OR if it's already enabled in the database (we need to check this)
              if (pendingWheelChanges.enabledCoupons.has(couponId)) {
                percentagePromises.push(
                  fetch(`${window.API_BASE_URL}/api/coupons/${couponId}/wheel-percentage`, {
                    method: 'PATCH',
                    headers: { 
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify({ wheelId: currentEditingWheelId, percentage: percentage })
                  }).then(response => {
                    if (!response.ok) {
                      console.error(`Failed to update percentage for coupon ${couponId}:`, response.status, response.statusText);
                      throw new Error(`Failed to update percentage for coupon ${couponId}`);
                    }
                    return response;
                  })
                );
              } else if (!pendingWheelChanges.disabledCoupons.has(couponId)) {
                // If the coupon is not being enabled or disabled, it means it was already enabled
                // and we're just updating its percentage
                percentagePromises.push(
                  fetch(`${window.API_BASE_URL}/api/coupons/${couponId}/wheel-percentage`, {
                    method: 'PATCH',
                    headers: { 
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify({ wheelId: currentEditingWheelId, percentage: percentage })
                  }).then(response => {
                    if (!response.ok) {
                      console.error(`Failed to update percentage for coupon ${couponId}:`, response.status, response.statusText);
                      throw new Error(`Failed to update percentage for coupon ${couponId}`);
                    }
                    return response;
                  })
                );
              }
            }
            
            // Wait for percentage updates to complete
            if (percentagePromises.length > 0) {
              await Promise.all(percentagePromises);
            }
            
            // Finally, disable coupons (do this last to avoid conflicts)
            const disablePromises = [];
            for (const couponId of pendingWheelChanges.disabledCoupons) {
              disablePromises.push(
                fetch(`${window.API_BASE_URL}/api/coupons/${couponId}/toggle-wheel?wheelId=${currentEditingWheelId}`, {
                  method: 'PATCH',
                  headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                  }
                }).then(response => {
                  if (!response.ok) {
                    console.error(`Failed to disable coupon ${couponId}:`, response.status, response.statusText);
                    throw new Error(`Failed to disable coupon ${couponId}`);
                  }
                  return response.json();
                }).then(data => {
                  return data;
                })
              );
            }
            
            // Wait for disable operations to complete
            if (disablePromises.length > 0) {
              await Promise.all(disablePromises);
            }
            
            showCustomAlert('All changes saved successfully!', 'success');
            
            // Reset pending changes
            pendingWheelChanges = {
              enabledCoupons: new Set(),
              disabledCoupons: new Set(),
              percentageChanges: new Map()
            };
            
            // Clear the total percentage display
            const totalDisplay = document.getElementById('total-percentage-display');
            if (totalDisplay) {
              totalDisplay.remove();
            }
            
            // Reload the coupons list to update the display
            await loadWheelCoupons();
            
          } catch (error) {
            console.error('Error saving wheel changes:', error);
            showCustomAlert('Error saving changes', 'error');
          }
        }

        async function saveWheel() {
          const name = document.getElementById('wheelNameInput').value;
          const description = document.getElementById('wheelDescriptionInput').value;
          
          if (!name) {
            showCustomAlert('Name is required', 'error');
            return;
          }
          
          try {
            const url = currentEditingWheelId ? 
              `${window.API_BASE_URL}/api/spinning-wheels/${currentEditingWheelId}` : 
              `${window.API_BASE_URL}/api/spinning-wheels`;
            
            const method = currentEditingWheelId ? 'PUT' : 'POST';
            
            const token = localStorage.getItem('adminToken');
            const response = await fetch(url, {
              method: method,
              headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({ name, description })
            });
            
            if (response.ok) {
              showCustomAlert(`Wheel ${currentEditingWheelId ? 'updated' : 'added'} successfully`, 'success');
              loadSpinningWheelData();
              
              // Reset to default state after successful save
              currentEditingWheelId = null;
              const wheelConfigurationPanel = document.getElementById('wheelConfigurationPanel');
              if (wheelConfigurationPanel) {
                wheelConfigurationPanel.innerHTML = `
                  <div class="card shadow-sm">
                    <div class="card-header bg-light">
                      <h5 class="mb-0"><i class="fa fa-cog"></i> Wheel Configuration</h5>
                    </div>
                    <div class="card-body text-center py-5">
                      <div class="mb-4">
                        <i class="fa fa-arrow-left fa-3x text-muted"></i>
                      </div>
                      <h5 class="card-title">Select a Wheel</h5>
                      <p class="text-muted">Choose a wheel from the list on the left to configure it</p>
                    </div>
                  </div>
                `;
              }
            } else {
              const error = await response.json();
              showCustomAlert('Error saving wheel: ' + error.error, 'error');
            }
          } catch (error) {
            console.error('Error saving wheel:', error);
            showCustomAlert('Error saving wheel', 'error');
          }
        }

        async function activateCurrentWheel() {
          if (!currentEditingWheelId) {
            showCustomAlert('Please save the wheel first', 'error');
            return;
          }
          
          try {
            const token = localStorage.getItem('adminToken');
            const response = await fetch(`${window.API_BASE_URL}/api/spinning-wheels/${currentEditingWheelId}/activate`, {
              method: 'PATCH',
              headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              }
            });
            
            if (response.ok) {
              showCustomAlert('Wheel activated successfully', 'success');
              loadSpinningWheelData();
            } else {
              const error = await response.json();
              showCustomAlert('Error activating wheel: ' + error.error, 'error');
            }
          } catch (error) {
            console.error('Error activating wheel:', error);
            showCustomAlert('Error activating wheel', 'error');
          }
        }

        function filterCoupons(filter) {
          const couponItems = document.querySelectorAll('.coupon-item');
          couponItems.forEach(item => {
            const isEnabled = item.classList.contains('enabled');
            const isDisabled = item.classList.contains('disabled');
            
            switch(filter) {
              case 'enabled':
                item.style.display = isEnabled ? 'flex' : 'none';
                break;
              case 'disabled':
                item.style.display = isDisabled ? 'flex' : 'none';
                break;
              default: // 'all'
                item.style.display = 'flex';
                break;
            }
          });
        }

        // Main initialization - consolidated
        document.addEventListener('DOMContentLoaded', function() {
          // Wait a bit to ensure all functions are loaded
          setTimeout(() => {
            try {
              // Initialize tab navigation
              if (typeof initializeTabs === 'function') {
                initializeTabs();
              }
              
              // Initialize form dropdowns
              if (typeof initializeFormDropdowns === 'function') {
                initializeFormDropdowns();
              }
              
              // Load initial data
              if (typeof loadCars === 'function') {
                loadCars();
              }
              if (typeof loadCoupons === 'function') {
                loadCoupons();
              }
              if (typeof loadAllBookings === 'function') {
                loadAllBookings(); // Load all bookings by default
              }
              
              // Initialize form handlers
              if (typeof initializeCarForms === 'function') {
                initializeCarForms();
              }
              if (typeof initializeCouponForms === 'function') {
                initializeCouponForms();
              }
              if (typeof initializeSpinningWheel === 'function') {
                initializeSpinningWheel();
              }
            } catch (error) {
              console.error('Error during initialization:', error);
            }
          }, 100);
        });
    </script>
</body>

</html>