<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spinning Wheel</title>
    <script src="js/config.js"></script>
    <script>
        // Fallback if config.js doesn't load
        if (!window.API_BASE_URL) {
            window.API_BASE_URL = 'http://localhost:3001';
            console.log('Using fallback API_BASE_URL:', window.API_BASE_URL);
        }
        // Force the correct port
        window.API_BASE_URL = 'http://localhost:3001';
        console.log('Final API_BASE_URL:', window.API_BASE_URL);
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .spinning-wheel-container {
            width: 100%;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .wheel-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            max-width: 1200px;
            width: 100%;
        }

        @media (min-width: 1024px) {
            .wheel-content {
                flex-direction: row;
                justify-content: center;
                align-items: flex-start;
            }
        }

        .wheel-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
        }

        .wheel-container {
            position: relative;
            width: 400px;
            height: 400px;
            will-change: transform;
            transform: translateZ(0);
        }

        .wheel-glow {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            padding: 8px;
            background: linear-gradient(45deg, #20b2aa, #1e90ff, #20b2aa);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
        }

        .wheel-border {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: white;
            padding: 4px;
            box-shadow: 0 0 30px rgba(32, 178, 170, 0.5), inset 0 0 20px rgba(255, 255, 255, 0.8);
        }

        .wheel {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            transition: transform 4s cubic-bezier(0.23, 1, 0.32, 1);
            will-change: transform;
            transform: translateZ(0);
        }

        .wheel-segment {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-origin: center;
            transition: all 0.3s ease;
            will-change: transform;
            transform: translateZ(0);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .segment-content {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120px;
            height: 120px;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .segment-icon {
            font-size: 36px;
            margin-bottom: 8px;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3));
            display: block;
        }

        .segment-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .segment-icon {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .segment-text {
            font-size: 18px;
            line-height: 1;
            font-weight: 700;
            text-align: center;
            padding: 4px 8px;
            white-space: nowrap;
            min-width: 35px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .center-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #20b2aa, #1e90ff);
            border: none;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(32, 178, 170, 0.4), inset 0 2px 4px rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            z-index: 20;
        }

        .center-button:hover {
            box-shadow: 0 12px 35px rgba(32, 178, 170, 0.6), inset 0 2px 4px rgba(255, 255, 255, 0.3);
        }

        .center-button:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .center-icon {
            font-size: 2rem;
            color: white;
            display: block;
        }

        .arrow-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 30;
            animation: arrowPulse 2s ease-in-out infinite;
        }

        .arrow {
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 30px solid white;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
            position: relative;
        }



        @keyframes arrowPulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.1); }
        }

        .reset-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #20b2aa, #1e90ff);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(32, 178, 170, 0.3);
            transition: all 0.3s ease;
        }

        .reset-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(32, 178, 170, 0.4);
        }

        .reset-icon {
            font-size: 1.2rem;
        }

        .info-section {
            flex: 1;
            max-width: 500px;
            min-height: 400px;
        }

        .instructions-card {
            background: linear-gradient(135deg, #20b2aa 0%, #1e90ff 50%, #0066cc 100%);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(32, 178, 170, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .instructions-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            text-align: center;
            margin-bottom: 1.5rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .instructions-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .instruction-step {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .instruction-step:hover {
            background: rgba(32, 178, 170, 0.1);
            transform: translateX(5px);
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #20b2aa, #1e90ff);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(32, 178, 170, 0.3);
        }

        .step-text {
            color: white;
            font-size: 0.95rem;
            line-height: 1.4;
            padding-top: 0.25rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .result-card {
            background: linear-gradient(135deg, #20b2aa 0%, #1e90ff 50%, #0066cc 100%);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            color: white;
            box-shadow: 0 20px 40px rgba(32, 178, 170, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
        }

        .result-card.show {
            display: block;
        }

        .trophy-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
        }

        .congratulations {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .you-won {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .prize-display {
            background: rgba(255, 255, 255, 0.9);
            color: #ff6b6b;
            font-size: 1.5rem;
            font-weight: 800;
            padding: 1rem 2rem;
            border-radius: 50px;
            margin-bottom: 1rem;
            display: inline-block;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .code-text {
            font-size: 1rem;
            margin-bottom: 1.5rem;
            opacity: 0.9;
        }

        .discount-code {
            font-family: 'Courier New', monospace;
            font-weight: 800;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .book-now-button {
            background: white;
            color: #ff6b6b;
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .book-now-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @media (max-width: 768px) {
            .wheel-container {
                width: 300px;
                height: 300px;
            }

            .center-button {
                width: 60px;
                height: 60px;
            }

            .center-icon {
                font-size: 1.5rem;
            }

            .arrow {
                border-left: 15px solid transparent;
                border-right: 15px solid transparent;
                border-bottom: 25px solid #ff4757;
            }

            .instructions-card,
            .result-card {
                padding: 1.5rem;
            }

            .congratulations {
                font-size: 1.5rem;
            }

            .prize-display {
                font-size: 1.2rem;
                padding: 0.75rem 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .wheel-container {
                width: 250px;
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="spinning-wheel-container">
        <div class="wheel-content">
            <!-- Left Side - Wheel -->
            <div class="wheel-section">
                <div class="wheel-container">
                    <!-- Outer glow ring -->
                    <div class="wheel-glow">
                        <div class="wheel-border">
                            <!-- Main wheel -->
                            <div class="wheel" id="wheel">
                                <!-- Wheel segments will be generated by JavaScript -->
                            </div>

                            <!-- Center button -->
                            <button class="center-button" id="centerButton">
                                <span class="center-icon">🎁</span>
                            </button>
                        </div>
                    </div>

                    <!-- Arrow pointer -->
                    <div class="arrow-pointer">
                        <div class="arrow"></div>
                    </div>
                </div>

                <!-- Spin again button -->
                <button class="reset-button" id="resetButton" style="display: none;">
                    <span class="reset-icon">🔄</span>
                    <span id="spinAgainText">Spin Again (New Visit)</span>
                </button>
            </div>

            <!-- Right Side - Instructions/Result -->
            <div class="info-section">
                <div class="instructions-card" id="instructionsCard">
                    <h3 class="instructions-title" id="howToPlayTitle">How to Play</h3>
                    <ul class="instructions-list">
                        <li class="instruction-step">
                            <span class="step-number">1</span>
                            <span class="step-text" id="step1Text">Press the button in the center of the wheel</span>
                        </li>
                        <li class="instruction-step">
                            <span class="step-number">2</span>
                            <span class="step-text" id="step2Text">Watch the wheel spin and stop on your prize</span>
                        </li>
                        <li class="instruction-step">
                            <span class="step-number">3</span>
                            <span class="step-text" id="step3Text">Copy your discount code</span>
                        </li>
                        <li class="instruction-step">
                            <span class="step-number">4</span>
                            <span class="step-text" id="step4Text">Use it when you make your next reservation</span>
                        </li>
                    </ul>
                </div>

                <div class="result-card" id="resultCard">
                    <div class="trophy-icon">🏆</div>
                    <h3 class="congratulations" id="congratulationsText">CONGRATULATIONS! 🎉</h3>
                    <p class="you-won" id="youWonText">You won</p>
                    <div class="prize-display" id="prizeDisplay">0% OFF</div>
                    <p class="code-text"><span id="useCodeText">Use code:</span> <span class="discount-code" id="discountCode">SPIN0FREE</span></p>
                    <button class="book-now-button" id="bookNowButton">Book Now & Apply Bonus</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Language configuration
        let currentLanguage = 'en';
        let translations = {};

        // Language detection and loading
        async function loadLanguage() {
            // Try to get language from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const langParam = urlParams.get('lang');
            
            // Try to get language from localStorage
            const storedLang = localStorage.getItem('lang');
            
            // Try to get language from parent window if embedded
            let parentLang = null;
            try {
                if (window.parent && window.parent !== window) {
                    // Try to access parent's i18next language
                    if (window.parent.i18next && window.parent.i18next.language) {
                        parentLang = window.parent.i18next.language;
                    }
                    // Try to access parent's localStorage
                    if (!parentLang) {
                        parentLang = window.parent.localStorage.getItem('lang');
                    }
                }
            } catch (e) {
                // Cross-origin restriction, ignore
            }

            // Determine language priority
            const lang = langParam || parentLang || storedLang || 'en';
            currentLanguage = lang;

            // Load translation file
            try {
                const response = await fetch(`js/locales/${lang}.json`);
                if (response.ok) {
                    translations = await response.json();
                    updateTexts();
                } else {
                    // Fallback to English
                    const enResponse = await fetch('js/locales/en.json');
                    translations = await enResponse.json();
                    updateTexts();
                }
            } catch (error) {
                console.error('Error loading translations:', error);
                // Use default English texts
                translations = {
                    wheel: {
                        how_to_play: "How to Play",
                        step1: "Press the button in the center of the wheel",
                        step2: "Watch the wheel spin and stop on your prize",
                        step3: "Copy your discount code",
                        step4: "Use it when you make your next reservation",
                        congratulations: "CONGRATULATIONS! 🎉",
                        you_won: "You won",
                        free_days: "FREE DAYS",
                        use_code: "Use code:",
                        book_now: "Book Now & Apply Bonus",
                        spin_again: "Spin Again (New Visit)"
                    }
                };
                updateTexts();
            }
        }

        // Update all text elements with translations
        function updateTexts() {
            const wheel = translations.wheel || {};
            
            // Update instruction texts
            document.getElementById('howToPlayTitle').textContent = wheel.how_to_play || "How to Play";
            document.getElementById('step1Text').textContent = wheel.step1 || "Press the button in the center of the wheel";
            document.getElementById('step2Text').textContent = wheel.step2 || "Watch the wheel spin and stop on your prize";
            document.getElementById('step3Text').textContent = wheel.step3 || "Copy your discount code";
            document.getElementById('step4Text').textContent = wheel.step4 || "Use it when you make your next reservation";
            
            // Update result texts
            document.getElementById('congratulationsText').textContent = wheel.congratulations || "CONGRATULATIONS! 🎉";
            document.getElementById('youWonText').textContent = wheel.you_won || "You won";
            document.getElementById('useCodeText').textContent = wheel.use_code || "Use code:";
            document.getElementById('bookNowButton').textContent = wheel.book_now || "Book Now & Apply Bonus";
            document.getElementById('spinAgainText').textContent = wheel.spin_again || "Spin Again (New Visit)";
            
            // Update wheel segments if coupons are loaded
            if (availableCoupons.length > 0) {
                createWheelSegments();
            }
        }

        // Global variable to store coupons
        let availableCoupons = [];
        let currentWinningCoupon = null;
        let cachedWheelSegments = null;

        // Fetch coupons from the API
        async function fetchCoupons() {
            try {
                // Ensure API_BASE_URL is set
                if (!window.API_BASE_URL) {
                    console.warn('API_BASE_URL not found, using default');
                    window.API_BASE_URL = 'http://localhost:3001';
                }
                
                const apiUrl = window.API_BASE_URL;
                console.log('Fetching coupons from:', apiUrl);
                const response = await fetch(`${apiUrl}/api/coupons`);
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const coupons = await response.json();
                    console.log('Raw coupons:', coupons);
                    // Filter only active coupons
                    availableCoupons = coupons.filter(coupon => coupon.is_active === 1);
                    console.log('Active coupons:', availableCoupons);
                    // Clear cache when new coupons are loaded
                    cachedWheelSegments = null;
                } else {
                    console.error('Failed to fetch coupons, status:', response.status);
                    availableCoupons = [];
                    cachedWheelSegments = null;
                }
            } catch (error) {
                console.error('Error fetching coupons:', error);
                availableCoupons = [];
                cachedWheelSegments = null;
            }
        }

        // Dynamic wheel segments configuration based on active coupons
        function getWheelSegments() {
            // Return cached segments if available
            if (cachedWheelSegments) {
                return cachedWheelSegments;
            }

            if (availableCoupons.length === 0) {
                // Fallback to 4 default segments if no coupons available
                cachedWheelSegments = [
                    { id: 1, text: '10%', gradient: 'linear-gradient(135deg, #a9d5ff 0%, #8bc4ff 100%)', coupon: null },
                    { id: 2, text: '15%', gradient: 'linear-gradient(135deg, #8bc4ff 0%, #6db3ff 100%)', coupon: null },
                    { id: 3, text: '20%', gradient: 'linear-gradient(135deg, #6db3ff 0%, #4fa2ff 100%)', coupon: null },
                    { id: 4, text: '25%', gradient: 'linear-gradient(135deg, #4fa2ff 0%, #1e90ff 100%)', coupon: null }
                ];
                return cachedWheelSegments;
            }

            // Create segments based on available active coupons only
            const segments = [];
            const gradients = [
                'linear-gradient(135deg, #a9d5ff 0%, #8bc4ff 100%)',
                'linear-gradient(135deg, #8bc4ff 0%, #6db3ff 100%)',
                'linear-gradient(135deg, #6db3ff 0%, #4fa2ff 100%)',
                'linear-gradient(135deg, #4fa2ff 0%, #1e90ff 100%)',
                'linear-gradient(135deg, #1e90ff 0%, #0066cc 100%)'
            ];

            // Use only the available active coupons
            availableCoupons.forEach((coupon, index) => {
                segments.push({
                    id: index + 1,
                    text: `${coupon.discount_percentage}%`,
                    gradient: gradients[index % gradients.length],
                    coupon: coupon
                });
                console.log(`Created segment ${index + 1}: ${coupon.discount_percentage}% - ${coupon.code}`);
            });

            // Cache the segments
            cachedWheelSegments = segments;
            return cachedWheelSegments;
        }

        let isSpinning = false;
        let hasSpun = false;
        let currentRotation = 0;

        const wheel = document.getElementById('wheel');
        const centerButton = document.getElementById('centerButton');
        const resetButton = document.getElementById('resetButton');
        const instructionsCard = document.getElementById('instructionsCard');
        const resultCard = document.getElementById('resultCard');
        const prizeDisplay = document.getElementById('prizeDisplay');
        const discountCode = document.getElementById('discountCode');

        // Create wheel segments with optimized performance
        function createWheelSegments() {
            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            const wheelSegments = getWheelSegments();
            console.log('Creating wheel segments:', wheelSegments);
            const segmentAngle = 360 / wheelSegments.length; // Dynamic angle calculation
            console.log('Segment angle:', segmentAngle);
            
            wheelSegments.forEach((segment, index) => {
                const segmentElement = document.createElement('div');
                segmentElement.className = 'wheel-segment';
                segmentElement.style.transform = `rotate(${index * segmentAngle}deg)`;
                segmentElement.style.background = segment.gradient;
                
                // Generate clip-path for this segment
                const startAngle = index * segmentAngle;
                const endAngle = (index + 1) * segmentAngle;
                const clipPath = generateClipPath(startAngle, endAngle);
                segmentElement.style.clipPath = clipPath;

                // Calculate the middle angle of this segment for text positioning
                const middleAngle = (startAngle + endAngle) / 2;
                const middleRad = (middleAngle - 90) * Math.PI / 180;
                const textRadius = 35; // Distance from center for text
                const textX = 50 + textRadius * Math.cos(middleRad);
                const textY = 50 + textRadius * Math.sin(middleRad);
                
                // Rotate text to stay upright relative to the wheel center
                const textRotation = middleAngle;
                
                // Create a container for the content with rotation applied to the parent
                segmentElement.innerHTML = `
                    <div class="segment-content" style="position: absolute; left: ${textX}%; top: ${textY}%; transform: translate(-50%, -50%) rotate(${textRotation}deg);">
                        <div class="segment-icon" style="margin-bottom: 8px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 500 500" fill="none">
                                <path d="M437.5 208.334L437.5 223.959C446.129 223.959 453.125 216.963 453.125 208.334H437.5ZM395.833 250L380.208 249.999V250H395.833ZM437.5 291.667H453.125C453.125 283.037 446.129 276.042 437.5 276.042L437.5 291.667ZM62.5 291.667V276.042C53.8706 276.042 46.875 283.037 46.875 291.667H62.5ZM104.167 250L119.792 250L119.792 249.999L104.167 250ZM63.5752 208.347L63.9708 192.727C63.9052 192.726 63.8395 192.724 63.7739 192.724L63.5752 208.347ZM62.5 208.334H46.875C46.875 216.886 53.7501 223.849 62.3013 223.957L62.5 208.334ZM395.833 104.167V119.792C410.215 119.792 421.875 131.451 421.875 145.834H437.5H453.125C453.125 114.192 427.474 88.5416 395.833 88.5416V104.167ZM437.5 145.834H421.875V208.334H437.5H453.125V145.834H437.5ZM437.5 208.334L437.5 192.709C405.859 192.709 380.208 218.358 380.208 249.999L395.833 250L411.458 250C411.458 235.618 423.117 223.959 437.5 223.959L437.5 208.334ZM395.833 250H380.208C380.208 281.641 405.859 307.292 437.5 307.292L437.5 291.667L437.5 276.042C423.118 276.042 411.458 264.382 411.458 250H395.833ZM437.5 291.667H421.875V354.167H437.5H453.125V291.667H437.5ZM437.5 354.167H421.875C421.875 368.549 410.215 380.209 395.833 380.209V395.834V411.459C427.474 411.459 453.125 385.808 453.125 354.167H437.5ZM395.833 395.834V380.209H104.167V395.834V411.459H395.833V395.834ZM104.167 395.834V380.209C89.7846 380.209 78.125 368.549 78.125 354.167H62.5H46.875C46.875 385.808 72.5257 411.459 104.167 411.459V395.834ZM62.5 354.167H78.125V291.667H62.5H46.875V354.167H62.5ZM62.5 291.667V307.292C94.1413 307.292 119.792 281.641 119.792 250H104.167H88.542C88.542 264.382 76.8824 276.042 62.5 276.042V291.667ZM104.167 250L119.792 249.999C119.792 218.85 94.9363 193.512 63.9708 192.727L63.5752 208.347L63.1795 223.967C77.2438 224.324 88.5419 235.845 88.542 250L104.167 250ZM63.5752 208.347L63.7739 192.724L62.6987 192.71L62.5 208.334L62.3013 223.957L63.3765 223.971L63.5752 208.347ZM62.5 208.334H78.125V145.834H62.5H46.875V208.334H62.5ZM62.5 145.834H78.125C78.125 131.451 89.7846 119.792 104.167 119.792V104.167V88.5416C72.5257 88.5416 46.875 114.192 46.875 145.834H62.5ZM104.167 104.167V119.792H395.833V104.167V88.5416H104.167V104.167Z" fill="white"/>
                                <path d="M312.5 104.167V145.833" stroke="white" stroke-width="41.6667" stroke-linecap="round"/>
                                <path d="M312.5 229.167V270.833" stroke="white" stroke-width="31.25" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M312.5 354.167V395.833" stroke="white" stroke-width="31.25" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="segment-text">${segment.text}</div>
                    </div>
                `;

                fragment.appendChild(segmentElement);
            });
            
            // Clear and append all at once
            wheel.innerHTML = '';
            wheel.appendChild(fragment);
        }

        // Generate clip-path for a segment
        function generateClipPath(startAngle, endAngle) {
            const centerX = 50;
            const centerY = 50;
            const radius = 50;
            
            // Convert angles to radians
            const startRad = (startAngle - 90) * Math.PI / 180;
            const endRad = (endAngle - 90) * Math.PI / 180;
            
            // Calculate points on the circle
            const startX = centerX + radius * Math.cos(startRad);
            const startY = centerY + radius * Math.sin(startRad);
            const endX = centerX + radius * Math.cos(endRad);
            const endY = centerY + radius * Math.sin(endRad);
            
            // Create a proper circular segment using multiple points
            const points = [];
            points.push(`${centerX}% ${centerY}%`); // Center point
            
            // Add start point
            points.push(`${startX}% ${startY}%`);
            
            // Add intermediate points for smooth curve
            const numPoints = 10;
            for (let i = 1; i <= numPoints; i++) {
                const angle = startAngle + (endAngle - startAngle) * (i / numPoints);
                const rad = (angle - 90) * Math.PI / 180;
                const x = centerX + radius * Math.cos(rad);
                const y = centerY + radius * Math.sin(rad);
                points.push(`${x}% ${y}%`);
            }
            
            // Add end point
            points.push(`${endX}% ${endY}%`);
            
            return `polygon(${points.join(', ')})`;
        }



        // Create optimized particles effect
        function createParticles() {
            // Reduce particle count and use more efficient animation
            for (let i = 0; i < 8; i++) {
                const particle = document.createElement('div');
                particle.style.cssText = `
                    position: fixed;
                    width: 6px;
                    height: 6px;
                    background: #ffd700;
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 1000;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    will-change: transform, opacity;
                `;
                document.body.appendChild(particle);

                const randomX = (Math.random() - 0.5) * 200;
                const randomY = (Math.random() - 0.5) * 200;

                particle.animate([
                    { transform: 'translate(-50%, -50%) scale(1)', opacity: 1 },
                    { transform: `translate(calc(-50% + ${randomX}px), calc(-50% + ${randomY}px)) scale(0)`, opacity: 0 }
                ], {
                    duration: 1500,
                    easing: 'ease-out'
                }).onfinish = () => {
                    particle.remove();
                };
            }
        }

        // Spin the wheel with optimized performance
        function spinWheel() {
            if (isSpinning || hasSpun) return;

            isSpinning = true;
            centerButton.disabled = true;
            centerButton.querySelector('.center-icon').textContent = '🔄';

            // Create particle effects with reduced intensity
            createParticles();

            // Ensure transition is applied before spinning
            wheel.style.transition = 'transform 4s cubic-bezier(0.23, 1, 0.32, 1)';

            // Calculate random spin with consistent minimum rotations
            const randomRotation = Math.random() * 360;
            const minRotations = 5; // Minimum 5 full rotations
            const extraRotations = Math.floor(Math.random() * 4); // 0-3 extra rotations
            const fullRotations = (minRotations + extraRotations) * 360;
            const totalRotation = currentRotation + fullRotations + randomRotation;

            // Animate wheel spinning with CSS transition
            wheel.style.transform = `rotate(${totalRotation}deg)`;

            // Calculate winning segment
            setTimeout(() => {
                const normalizedRotation = (totalRotation % 360 + 360) % 360;
                const wheelSegments = getWheelSegments();
                const segmentAngle = 360 / wheelSegments.length;
                
                // The pointer is at the top (12 o'clock position), so we need to calculate
                // which segment the pointer is pointing to
                const pointerAngle = 0; // Pointer is at top (0 degrees)
                const adjustedRotation = (normalizedRotation - pointerAngle + 360) % 360;
                const segmentIndex = Math.floor(adjustedRotation / segmentAngle);
                const winningSegment = wheelSegments[segmentIndex];

                // Debug logging
                console.log('Wheel stopped at rotation:', normalizedRotation);
                console.log('Segment angle:', segmentAngle);
                console.log('Adjusted rotation:', adjustedRotation);
                console.log('Segment index:', segmentIndex);
                console.log('Winning segment:', winningSegment);
                console.log('Winning segment text:', winningSegment.text);
                console.log('Winning coupon:', winningSegment.coupon);

                // Show results
                currentRotation = totalRotation;
                isSpinning = false;
                hasSpun = true;
                centerButton.disabled = false;
                centerButton.querySelector('.center-icon').textContent = '🎁';

                // Store the winning coupon
                currentWinningCoupon = winningSegment.coupon;

                // Update result card with real coupon data
                if (currentWinningCoupon) {
                    // Show actual coupon code and discount
                    prizeDisplay.textContent = `${currentWinningCoupon.discount_percentage}% OFF`;
                    discountCode.textContent = currentWinningCoupon.code;
                    console.log('Displaying coupon:', currentWinningCoupon.discount_percentage + '%', currentWinningCoupon.code);
                } else {
                    // Fallback for segments without real coupons
                    const freeDaysText = translations.wheel?.free_days || "FREE DAYS";
                    prizeDisplay.textContent = `${winningSegment.text} OFF`;
                    discountCode.textContent = `SPIN${winningSegment.id}FREE`;
                    console.log('Displaying fallback:', winningSegment.text);
                }

                // Show result card
                instructionsCard.style.display = 'none';
                resultCard.classList.add('show');

                // Show reset button
                resetButton.style.display = 'flex';
            }, 4000);
        }

        // Reset wheel
        function resetWheel() {
            hasSpun = false;
            currentRotation = 0;
            // Ensure wheel starts at 0 degrees
            wheel.style.transform = 'rotate(0deg)';
            instructionsCard.style.display = 'block';
            resultCard.classList.remove('show');
            resetButton.style.display = 'none';
        }

        // Event listeners
        centerButton.addEventListener('click', spinWheel);
        resetButton.addEventListener('click', resetWheel);

        // Initialize wheel and load language
        loadLanguage().then(async () => {
            console.log('API_BASE_URL:', window.API_BASE_URL);
            // Fetch coupons first, then create wheel segments
            await fetchCoupons();
            console.log('After fetchCoupons, availableCoupons length:', availableCoupons.length);
            createWheelSegments();
            // Ensure wheel starts at 0 degrees and has proper transition
            wheel.style.transition = 'transform 4s cubic-bezier(0.23, 1, 0.32, 1)';
            wheel.style.transform = 'rotate(0deg)';
            // Force a reflow to ensure the initial state is applied
            wheel.offsetHeight;
            // Small delay to ensure the initial state is properly set
            setTimeout(() => {
                wheel.style.transition = 'none';
                wheel.style.transform = 'rotate(0deg)';
                setTimeout(() => {
                    wheel.style.transition = 'transform 4s cubic-bezier(0.23, 1, 0.32, 1)';
                }, 10);
            }, 100);
        });

        // Listen for language changes from parent window
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'languageChange') {
                currentLanguage = event.data.language;
                loadLanguage();
            }
        });

        // Also listen for storage changes (when parent changes localStorage)
        window.addEventListener('storage', function(event) {
            if (event.key === 'lang') {
                currentLanguage = event.newValue;
                loadLanguage();
            }
        });

        // Try to get language from parent on load
        window.addEventListener('load', function() {
            setTimeout(() => {
                try {
                    if (window.parent && window.parent !== window) {
                        // Try to get language from parent's i18next
                        if (window.parent.i18next && window.parent.i18next.language) {
                            currentLanguage = window.parent.i18next.language;
                            loadLanguage();
                        }
                        // Try to get from parent's localStorage
                        else if (window.parent.localStorage.getItem('lang')) {
                            currentLanguage = window.parent.localStorage.getItem('lang');
                            loadLanguage();
                        }
                    }
                } catch (e) {
                    // Cross-origin restriction, ignore
                }
            }, 500);
        });
    </script>
</body>
</html> 