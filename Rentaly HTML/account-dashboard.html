<!DOCTYPE html>
<html lang="zxx">

<head>
    <title>Admin Panel - Car Management</title>
    <link rel="icon" href="images/icon.png" type="image/gif" sizes="16x16">
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="PlusRent - Multipurpose Vehicle Car Rental Website Template" name="description">
    <meta content="" name="keywords">
    <meta content="" name="author">
    <!-- CSS Files
    ================================================== -->
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css" id="bootstrap">
    <link href="css/mdb.min.css" rel="stylesheet" type="text/css" id="mdb">
    <link href="css/plugins.css" rel="stylesheet" type="text/css">
    <link href="css/style.css" rel="stylesheet" type="text/css">
    <link href="css/coloring.css" rel="stylesheet" type="text/css">
    <!-- color scheme -->
    <link id="colors" href="css/colors/scheme-01.css" rel="stylesheet" type="text/css">
    <style>
  .admin-main-container {
    max-width: 1400px;
    margin: 0 auto;
    padding-left: 32px;
    padding-right: 32px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .admin-header {
    text-align: center;
    margin-top: 2rem;
    margin-bottom: 1.2rem;
  }
  .admin-flex-row {
    display: flex;
    align-items: flex-start;
    gap: 32px;
    justify-content: flex-start;
    width: 100%;
  }
  .admin-btn-col {
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    min-width: 180px;
    margin-top: 0.5rem;
    margin-right: 0;
  }
  .admin-form-col {
    flex: 1 1 0;
    position: relative;
    min-width: 340px;
    max-width: 1100px;
  }
  .admin-form-panel {
    display: none;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%) scale(0.98);
    width: 90%;
    max-width: 1200px;
    min-width: 320px;
    max-height: 90vh;
    overflow-y: auto;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.18);
    padding: 1.4rem 1.8rem 1.4rem 1.8rem;
    transition: transform 0.4s cubic-bezier(.4,0,.2,1), opacity 0.4s cubic-bezier(.4,0,.2,1);
    opacity: 0;
    z-index: 10000;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch;
  }
  .admin-form-panel.active {
    display: block;
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
  /* Prevent body scroll when popup is open */
  html.admin-popup-open, body.admin-popup-open {
    overflow: hidden !important;
    height: 100%;
    touch-action: none;
    overscroll-behavior: contain;
  }
  .admin-form-panel .btn-fullwidth {
    width: auto;
    min-width: 160px;
    display: block;
    margin: 0 auto;
  }
  .admin-form-panel .btn {
    display: block;
    margin: 0 auto;
    min-width: 160px;
    width: auto;
  }
  .admin-form-panel .btn-fullwidth {
    width: auto;
    min-width: 160px;
    display: block;
    margin: 0 auto;
  }
  .admin-form-panel .btn-main {
    font-size: 1.1rem;
    padding: 0.7rem 2.2rem;
    height: 44px;
    border-radius: 6px;
  }
  .admin-form-panel .close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #888;
    cursor: pointer;
  }
  .admin-form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
  }
  .admin-form-grid .five-column-grid {
    grid-column: 1 / -1;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
  }
  .admin-form-grid > div {
    min-width: 0;
  }
  .admin-form-panel input,
  .admin-form-panel select {
    background: #fff !important;
    height: 36px !important;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    font-size: 0.75rem;
    width: 100%;
    padding: 0 8px;
    box-sizing: border-box;
  }
  .admin-form-panel input[type="number"] {
    height: 36px !important;
  }
  .admin-form-panel .form-label {
    font-size: 0.75rem;
    font-weight: 500;
    margin-bottom: 0 !important;
    color: #333;
  }
  .admin-form-panel .form-text,
  .admin-form-panel small.form-text {
    font-size: 0.75rem !important;
    color: #666 !important;
    line-height: 1.2 !important;
    margin-top: 2px !important;
    margin-bottom: 0 !important;
    display: block !important;
  }
  .admin-form-panel .form-control {
    height: 36px !important;
    font-size: 0.75rem;
    padding: 0 8px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
  }
  .admin-form-panel input[type="date"] {
    height: 36px !important;
    font-size: 0.75rem;
    padding: 0 8px;
  }
  .admin-form-panel input:focus,
  .admin-form-panel select:focus {
    outline: 2px solid #b3c6ff;
    border-color: #b3c6ff;
  }
  .admin-form-panel fieldset {
    grid-column: 1 / -1;
  }
  .admin-form-panel .row.g-2 > div {
    min-width: 0;
  }
  .admin-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(30, 30, 30, 0.65);
    z-index: 9999;
    transition: opacity 0.3s;
  }
  .admin-overlay.active {
    display: block;
  }
  .admin-confirm-modal {
    display: none;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.18);
    padding: 1.2rem 1.5rem;
    z-index: 10001;
    min-width: 320px;
    max-width: 400px;
    text-align: center;
  }
  .admin-confirm-modal.active {
    display: block;
  }
  .admin-confirm-modal button {
    margin: 0 10px;
    min-width: 110px;
    height: 44px;
    font-size: 1rem;
    border-radius: 6px;
    font-family: inherit;
    font-weight: 500;
  }
  .admin-confirm-modal .btn-main, .admin-confirm-modal .btn-danger {
    background: #031B4E;
    color: #fff;
    border: none;
    transition: background 0.2s;
  }
  .admin-confirm-modal .btn-danger {
    background: #e74c3c;
  }
  .admin-btn-col {
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    min-width: 180px;
    margin-top: 0.5rem;
    margin-right: 0;
  }
  .admin-flex-row {
    display: flex;
    align-items: flex-start;
    gap: 32px;
    justify-content: flex-start;
    width: 100%;
  }
  .admin-flex-row + #carCards, .admin-flex-row + .row#carCards, .admin-flex-row + .row.g-4 {
    margin-top: 1.2rem !important;
  }
  #carCards {
    margin-top: 1.2rem !important;
  }
  /* Fix for car cards being too small after form grid change */
  #carCards.row.g-4 {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-start !important;
    align-items: stretch;
    width: 100%;
  }
  #carCards.row.g-4 > .col-md-6.col-lg-4 {
    min-width: 320px;
    flex: 1 1 320px;
    max-width: 320px;
    display: flex;
    margin: 0 16px 24px 0;
  }
  #carCards .card {
    min-width: 300px;
    width: 100%;
    margin: 0;
  }
  @media (max-width: 900px) {
    .admin-form-panel {
      width: 95vw;
      padding: 1.2rem 1rem;
      max-height: 95vh;
    }
    .admin-form-grid {
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }
    .admin-form-grid .five-column-grid {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }
  }
  @media (max-width: 600px) {
    .admin-form-panel {
      width: 98vw;
      padding: 1rem 0.8rem;
      max-height: 98vh;
    }
    .admin-form-grid {
      grid-template-columns: 1fr;
    }
    .admin-form-grid .five-column-grid {
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    }
  }
  @media (max-width: 480px) {
    .admin-form-panel {
      width: 100vw;
      padding: 0.8rem 0.6rem;
      max-height: 100vh;
      border-radius: 0;
    }
    .admin-form-grid {
      grid-template-columns: 1fr;
    }
    .admin-form-grid .five-column-grid {
      grid-template-columns: 1fr;
    }
    /* Stack image upload sections vertically on mobile */
    .admin-form-grid > div[style*="display: flex"] {
      flex-direction: column !important;
    }
    .admin-form-grid > div[style*="display: flex"] > div {
      width: 100% !important;
      margin-bottom: 16px;
    }
  }
  
  /* Override MDB button text-transform to use normal case */
  .btn {
    text-transform: none !important;
  }
  
  /* Prevent body scroll when modal is open */
  body.modal-open {
    overflow: hidden !important;
    position: fixed !important;
    width: 100% !important;
    left: 0 !important;
    right: 0 !important;
  }
  
  html.modal-open {
    overflow: hidden !important;
  }
  
  /* Prevent scrolling on modal overlay */
  .admin-overlay {
    overflow: hidden !important;
  }
  
  /* Gallery Carousel Styles */
  .admin-gallery-carousel {
    position: relative;
    max-width: 100%;
    margin-top: 8px;
  }
  
  .admin-carousel-container {
    position: relative;
    overflow: visible; /* Allow buttons to overflow outside */
    border-radius: 8px;
    background: #f8f9fa;
  }
  
  .admin-carousel-track-wrapper {
    overflow: hidden;
    border-radius: 8px;
  }
  
  .admin-carousel-track {
    display: flex;
    transition: transform 0.3s ease;
    gap: 10px;
    padding: 10px 3px 10px 10px; /* Balanced right padding - middle ground */
  }
  
  .admin-carousel-image-item {
    position: relative;
    flex: 0 0 auto;
    padding: 0;
  }
  
  .admin-carousel-image-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: block;
  }
  
  .admin-carousel-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
    z-index: 10;
  }
  
  .admin-carousel-nav:hover {
    background: rgba(0,0,0,1);
  }
  
  .admin-carousel-nav:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }
  
  .admin-carousel-prev {
    left: -16px; /* Half of button width (32px / 2 = 16px) outside */
  }
  
  .admin-carousel-next {
    right: -16px; /* Half of button width (32px / 2 = 16px) outside */
  }
  
  .admin-carousel-counter {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
  }
  
  .admin-carousel-remove {
    position: absolute;
    top: -6px;
    right: -6px;
    background: rgb(248 67 61 / 90%);
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    font-size: 15px;
    padding-bottom: 3px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    transition: all 0.2s;
    backdrop-filter: blur(2px);
  }
  
  .admin-carousel-remove:hover {
    transform: scale(1.1);
  }
</style>

<!-- Custom green for success alert and Booked checkbox styles -->
<style>
:root {
  --admin-success-green: #28a745;
}
#adminCustomAlert.success {
  background: var(--admin-success-green) !important;
  color: #fff !important;
}
#adminCustomAlert.error {
  background: #e74c3c !important;
  color: #fff !important;
}
/* Remove all custom Booked checkbox and label styles */
.admin-booked-checkbox, .admin-booked-label { }
</style>
<!-- Add styles for image previews and remove buttons -->
<style>
.admin-image-preview {
  display: inline-block;
  margin: 0 10px 10px 0;
  position: relative;
}
.admin-image-preview img {
  width: 160px;
  height: 150px;
  object-fit: cover;
  border-radius: 6px;
  border: 1.5px solid #e0e0e0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

@media (max-width: 600px) {
  .admin-image-preview img {
    width: 120px;
    height: 110px;
  }
}

@media (max-width: 480px) {
  .admin-image-preview img {
    width: 100px;
    height: 90px;
  }
}
.admin-image-remove {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #e74c3c;
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  font-size: 1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2;
  padding-bottom: 4px;
  padding-left: 6px;
}
/* Add spinner style */
.admin-spinner {
  display: inline-block;
  width: 24px;
  height: 24px;
  border: 3px solid #eee;
  border-top: 3px solid #031B4E;
  border-radius: 50%;
  animation: admin-spin 1s linear infinite;
  margin-left: 10px;
  vertical-align: middle;
}
@keyframes admin-spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Custom upload button styles */
.admin-upload-area {
  position: relative;
  display: flex;
  justify-content: flex-start;
  width: 100%;
  margin-bottom: 10px;
}

  .admin-upload-button {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    width: 100%;
    max-width: 180px;
    height: 48px;
    border: 2px dashed #ccc;
    border-radius: 6px;
    background: #f9f9f9;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #666;
    font-size: 12px;
    pointer-events: auto;
    padding: 8px;
    position: relative;
    z-index: 1;
    gap: 6px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

.admin-upload-button:hover {
  border-color: #031B4E;
  background: #f0f4ff;
  color: #031B4E;
}

.admin-upload-area.has-file .admin-upload-button {
  border-color: #28a745;
  background: #f0fff0;
  color: #28a745;
}

.admin-upload-area.disabled .admin-upload-button {
  border-color: #ccc;
  background: #f5f5f5;
  color: #999;
  cursor: not-allowed;
  opacity: 0.6;
}

.admin-upload-area.disabled .admin-upload-button:hover {
  border-color: #ccc;
  background: #f5f5f5;
  color: #999;
}

.admin-upload-icon {
  width: 16px;
  height: 16px;
  stroke: currentColor;
  fill: none;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
  display: block;
  flex-shrink: 0;
  align-self: flex-start;
  margin-top: 3px;
}

.admin-upload-text {
  font-weight: 500;
  margin-bottom: 4px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 100%;
}

.admin-upload-subtext {
  font-size: 12px;
  color: #999;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 100%;
}

.admin-upload-input {
  position: absolute;
  top: -9999px;
  left: -9999px;
  width: 1px;
  height: 1px;
  opacity: 0;
  z-index: -1;
  pointer-events: none;
}
</style>
</head>

<body>
    <div id="wrapper">
        
        <!-- page preloader begin -->
        <div id="de-preloader"></div>
        <!-- page preloader close -->

        <!-- header begin -->
        <header class="transparent scroll-light has-topbar">
            <div id="topbar" class="topbar-dark text-light">
                <div class="container">
                    <div class="topbar-left xs-hide">
                        <div class="topbar-widget">
                            <div class="topbar-widget"><a href="#"><i class="fa fa-phone"></i>+208 333 9296</a></div>
                            <div class="topbar-widget"><a href="#"><i class="fa fa-envelope"></i>contact@plusrent.com</a></div>
                            <div class="topbar-widget"><a href="#"><i class="fa fa-clock-o"></i>Mon - Fri 08.00 - 18.00</a></div>
                        </div>
                    </div>
                
                    <div class="topbar-right">
                        <div class="social-icons">
                            <a href="#"><i class="fa fa-facebook fa-lg"></i></a>
                            <a href="#"><i class="fa fa-twitter fa-lg"></i></a>
                            <a href="#"><i class="fa fa-youtube fa-lg"></i></a>
                            <a href="#"><i class="fa fa-pinterest fa-lg"></i></a>
                            <a href="#"><i class="fa fa-instagram fa-lg"></i></a>
                        </div>
                    </div>  
                    <div class="clearfix"></div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-md-12">
                        <div class="de-flex sm-pt10">
                            <div class="de-flex-col">
                                <div class="de-flex-col">
                                    <!-- logo begin -->
                                    <div id="logo">
                                        <a href="index.html">
                                            <img class="logo-1" src="images/logo-light.png" alt="">
                                            <img class="logo-2" src="images/logo.png" alt="">
                                        </a>
                                    </div>
                                    <!-- logo close -->
                                </div>
                            </div>
                            <div class="de-flex-col header-col-mid">
                                <ul id="mainmenu">
                                    <li><a class="menu-item" href="index.html">Home</a></li>
                                    <li><a class="menu-item" href="cars.html">Cars</a></li>
                                    <li><a class="menu-item" href="quick-booking.html">Booking</a></li>
                                    <li><a class="menu-item" href="account-dashboard.html">Admin Panel</a></li>
                                </ul>
                            </div>
                            <div class="de-flex-col">
                                <div class="menu_side_area">
                                    <div class="de-login-menu">

                                        <span id="de-click-menu-profile" class="de-menu-profile">                           
                                            <img src="images/profile/1.jpg" class="img-fluid" alt="">
                                        </span>

                                        

                                        <div id="de-submenu-profile" class="de-submenu">
                                            <div class="d-name">
                                                <h4>Monica Lucas</h4>
                                                <span class="text-gray">monica@plusrent.com</span>
                                            </div>

                                            <div class="d-line"></div>

                                            <ul class="menu-col">
                                                <li><a href="account-dashboard.html"><i class="fa fa-home"></i>Dashboard</a></li>
                                                <li><a href="account-profile.html"><i class="fa fa-user"></i>My Profile</a></li>
                                                <li><a href="account-booking.html"><i class="fa fa-calendar"></i>My Orders</a></li>
                                                <li><a href="account-favorite.html"><i class="fa fa-car"></i>My Favorite Cars</a></li>
                                                <li><a href="login.html"><i class="fa fa-sign-out"></i>Sign Out</a></li>
                                            </ul>
                                        </div>
                                        <span id="menu-btn"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
            <!-- header close -->
        <!-- content begin -->
        <div class="no-bottom no-top zebra" id="content">
            <div id="top"></div>
            
            <!-- section begin -->
            <section id="subheader" class="jarallax text-light">
                <img src="images/background/14.jpg" class="jarallax-img" alt="">
                    <div class="center-y relative text-center">
                        <div class="container">
                            <div class="row">
                                <div class="col-md-12 text-center">
									<h1>Admin Panel</h1>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                        </div>
                    </div>
            </section>
            <!-- section close -->

            <section id="admin-add-car" class="bg-gray-100">
              <div class="admin-main-container">
                <h3 class="admin-header mb-4" style="font-family: var(--title-font); font-weight: 600; color: #031B4E;">Manage Cars</h3>
                <div class="admin-flex-row">
                  <div class="admin-btn-col">
                    <button id="showAddCarBtn" type="button" class="btn btn-main btn-lg">Add a Car</button>
                  </div>
                  <div class="admin-form-col">
                    <!-- Overlay -->
                    <div id="adminOverlay" class="admin-overlay"></div>
                    <!-- Add Car Form Panel (popup) -->
                    <div id="addCarPanel" class="admin-form-panel">
                      <button class="close-btn" id="closeAddCarPanel">&times;</button>
                      <form id="carForm" class="form-border" autocomplete="off">
                                                <h3 id="formTitle" class="mb-3" style="font-family: var(--title-font); font-weight: 600; color: #031B4E; font-size: 1.4rem;">Add Car</h3>
                          <div class="admin-form-grid">
                            <div style="grid-column: 1 / -1; display: flex; align-items: flex-start; margin-bottom: 6px; gap: 16px;">
                            <div style="flex: 1;">
                              <label class="form-label">Head Image</label>
                              <div class="admin-upload-area">
                                <div class="admin-upload-button" id="addHeadImageButton">
                                  <svg class="admin-upload-icon" viewBox="0 0 24 24" style="display: block;">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17,8 12,3 7,8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                  </svg>
                                  <div class="admin-upload-text">Upload Head Image</div>
                                </div>
                                <input type="file" id="addHeadImageInput" name="head_image" accept="image/*" class="admin-upload-input">
                              </div>
                              <div id="addHeadImagePreview" class="admin-image-preview"></div>
                            </div>
                            <div style="flex: 1;">
                              <label class="form-label">Gallery Images (max 10)</label>
                              <div class="admin-upload-area">
                                <div class="admin-upload-button" id="addGalleryImagesButton">
                                  <svg class="admin-upload-icon" viewBox="0 0 24 24" style="display: block;">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17,8 12,3 7,8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                  </svg>
                                  <div class="admin-upload-text">Upload Gallery Images</div>
                                </div>
                                <input type="file" id="addGalleryImagesInput" name="gallery_images" accept="image/*" multiple class="admin-upload-input">
                              </div>
                              <div id="addGalleryImagesPreview"></div>
                            </div>
                          </div>
                          <div>
                            <label class="form-label">Make Name</label>
                            <input type="text" name="make_name" class="form-control" required>
                          </div>
                          <div>
                            <label class="form-label">Model Name</label>
                            <input type="text" name="model_name" class="form-control" required>
                          </div>
                          <div>
                            <label class="form-label">Production Year</label>
                            <select name="production_year" class="form-control" required></select>
                          </div>
                          <div>
                            <label class="form-label">Gear Type</label>
                            <select name="gear_type" class="form-control" required>
                              <option value="Automatic">Automatic</option>
                              <option value="Manual">Manual</option>
                            </select>
                          </div>
                          <div class="five-column-grid">
                            <div>
                              <label class="form-label">Fuel Type</label>
                              <select name="fuel_type" class="form-control" required>
                                <option value="Gasoline">Gasoline</option>
                                <option value="Diesel">Diesel</option>
                                <option value="Hybrid">Hybrid</option>
                                <option value="Electric">Electric</option>
                              </select>
                            </div>
                            <div>
                              <label class="form-label">Engine Capacity</label>
                              <input type="number" name="engine_capacity" class="form-control" step="0.1" min="0">
                            </div>
                            <div>
                              <label class="form-label">Car Type</label>
                              <select name="car_type" class="form-control" required>
                                <option value="Crossover">Crossover</option>
                                <option value="Sedan">Sedan</option>
                                <option value="Coupe">Coupe</option>
                              </select>
                            </div>
                            <div>
                              <label class="form-label">Number of Doors</label>
                              <select name="num_doors" class="form-control" required></select>
                            </div>
                            <div>
                              <label class="form-label">Number of Passengers</label>
                              <select name="num_passengers" class="form-control" required></select>
                            </div>
                          </div>
                        </div>
                        <fieldset class="mb-3 p-2 rounded-3" style="border: 1px solid #eee;">
                          <legend class="form-label mb-2" style="font-size: 1rem; color: #031B4E;">Price Policy</legend>
                          <div class="row g-2">
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">1-2 days</label>
                              <input type="text" name="price_1_2" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">3-7 days</label>
                              <input type="text" name="price_3_7" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">8-20 days</label>
                              <input type="text" name="price_8_20" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">21-45 days</label>
                              <input type="text" name="price_21_45" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">46+ days</label>
                              <input type="text" name="price_46" class="form-control" required>
                            </div>
                          </div>
                        </fieldset>
                        <div class="mb-3" style="max-width: 300px;">
                          <label class="form-label">Booked Until (optional)</label>
                          <input type="date" name="booked_until" class="form-control" placeholder="Select date until when car is booked">
                          <small class="form-text text-muted">Leave empty if car is available. Car will be automatically available after this date.</small>
                        </div>
                        <button type="submit" id="formSubmitBtn" class="btn btn-main">Add Car</button>
                      </form>
                    </div>
                    <!-- Edit Car Form Panel (popup) -->
                    <div id="editCarPanel" class="admin-form-panel">
                      <button class="close-btn" id="closeEditCarPanel">&times;</button>
                      <button id="deleteCarBtn" type="button" style="position:absolute;top:16px;right:48px;background:none;border:1.5px solid #e74c3c;color:#e74c3c;padding:6px 14px;border-radius:6px;font-size:1rem;display:flex;align-items:center;gap:6px;cursor:pointer;z-index:2;">
                        <i class="fa fa-trash"></i> Delete Car
                      </button>
                      <form id="editCarForm" class="form-border" autocomplete="off">
                                                <h3 class="mb-3" style="font-family: var(--title-font); font-weight: 600; color: #031B4E; font-size: 1.4rem;">Edit Car</h3>
                          <div class="admin-form-grid">
                            <div style="grid-column: 1 / -1; display: flex; align-items: flex-start; margin-bottom: 6px; gap: 16px;">
                            <div style="flex: 1;">
                              <label class="form-label">Head Image</label>
                              <div class="admin-upload-area">
                                <div class="admin-upload-button" id="editHeadImageButton">
                                  <svg class="admin-upload-icon" viewBox="0 0 24 24" style="display: block;">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17,8 12,3 7,8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                  </svg>
                                  <div class="admin-upload-text">Upload Head Image</div>
                                </div>
                                <input type="file" id="editHeadImageInput" name="head_image" accept="image/*" class="admin-upload-input">
                              </div>
                              <div id="editHeadImagePreview" class="admin-image-preview"></div>
                            </div>
                            <div style="flex: 1;">
                              <label class="form-label">Gallery Images (max 10)</label>
                              <div class="admin-upload-area">
                                <div class="admin-upload-button" id="editGalleryImagesButton">
                                  <svg class="admin-upload-icon" viewBox="0 0 24 24" style="display: block;">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17,8 12,3 7,8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                  </svg>
                                  <div class="admin-upload-text">Upload Gallery Images</div>
                                </div>
                                <input type="file" id="editGalleryImagesInput" name="gallery_images" accept="image/*" multiple class="admin-upload-input">
                              </div>
                              <div id="editGalleryImagesPreview"></div>
                            </div>
                          </div>
                          <div style="grid-column: 1 / -1; margin-bottom: 8px; max-width: 300px;">
                            <label class="form-label">Booked Until (optional)</label>
                            <input type="date" name="booked_until" class="form-control" placeholder="Select date until when car is booked">
                            <small class="form-text text-muted">Leave empty if car is available. Car will be automatically available after this date.</small>
                          </div>
                          <div>
                            <label class="form-label">Make Name</label>
                            <input type="text" name="make_name" class="form-control" required>
                          </div>
                          <div>
                            <label class="form-label">Model Name</label>
                            <input type="text" name="model_name" class="form-control" required>
                          </div>
                          <div>
                            <label class="form-label">Production Year</label>
                            <select name="production_year" class="form-control" required></select>
                          </div>
                          <div>
                            <label class="form-label">Gear Type</label>
                            <select name="gear_type" class="form-control" required>
                              <option value="Automatic">Automatic</option>
                              <option value="Manual">Manual</option>
                            </select>
                          </div>
                          <div class="five-column-grid">
                            <div>
                              <label class="form-label">Fuel Type</label>
                              <select name="fuel_type" class="form-control" required>
                                <option value="Gasoline">Gasoline</option>
                                <option value="Diesel">Diesel</option>
                                <option value="Hybrid">Hybrid</option>
                                <option value="Electric">Electric</option>
                              </select>
                            </div>
                            <div>
                              <label class="form-label">Engine Capacity</label>
                              <input type="number" name="engine_capacity" class="form-control" step="0.1" min="0">
                            </div>
                            <div>
                              <label class="form-label">Car Type</label>
                              <select name="car_type" class="form-control" required>
                                <option value="Crossover">Crossover</option>
                                <option value="Sedan">Sedan</option>
                                <option value="Coupe">Coupe</option>
                              </select>
                            </div>
                            <div>
                              <label class="form-label">Number of Doors</label>
                              <select name="num_doors" class="form-control" required></select>
                            </div>
                            <div>
                              <label class="form-label">Number of Passengers</label>
                              <select name="num_passengers" class="form-control" required></select>
                            </div>
                          </div>
                        </div>
                        <fieldset class="mb-3 p-2 rounded-3" style="border: 1px solid #eee;">
                          <legend class="form-label mb-2" style="font-size: 1rem; color: #031B4E;">Price Policy</legend>
                          <div class="row g-2">
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">1-2 days</label>
                              <input type="text" name="price_1_2" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">3-7 days</label>
                              <input type="text" name="price_3_7" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">8-20 days</label>
                              <input type="text" name="price_8_20" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">21-45 days</label>
                              <input type="text" name="price_21_45" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">46+ days</label>
                              <input type="text" name="price_46" class="form-control" required>
                            </div>
                          </div>
                        </fieldset>
                        <button type="submit" id="editFormSubmitBtn" class="btn btn-main">Confirm changes</button>
                      </form>
                    </div>
                    <!-- Confirm Modal -->
                    <div id="adminConfirmModal" class="admin-confirm-modal">
                      <h4>Are you sure you want to close this form? All unsaved data will be lost.</h4>
                      <div class="mt-4 d-flex justify-content-center gap-3">
                        <button id="confirmCloseBtn" class="btn btn-danger">Close</button>
                        <button id="cancelCloseBtn" class="btn btn-main">Cancel</button>
                      </div>
                    </div>
                    <!-- Add a confirmation modal for delete -->
                    <div id="deleteConfirmModal" class="admin-confirm-modal">
                      <h4>Are you sure you want to delete this car?</h4>
                      <div class="mt-4 d-flex justify-content-center gap-3">
                        <button id="confirmDeleteBtn" class="btn btn-danger">Yes Delete</button>
                        <button id="cancelDeleteBtn" class="btn btn-main">Cancel</button>
                      </div>
                    </div>
                  </div>
                </div>
                <div id="carCards" class="row g-4 mt-4"></div>
              </div>
            </section>
			
			
        </div>
        <!-- content close -->

        <a href="#" id="back-to-top"></a>
        
        <!-- footer begin -->
        <footer class="text-light">
            <div class="container">
                <div class="row g-custom-x">
                    <div class="col-lg-3">
                        <div class="widget">
                            <h5>About PlusRent</h5>
                            <p>Where quality meets affordability. We understand the importance of a smooth and enjoyable journey without the burden of excessive costs. That's why we have meticulously crafted our offerings to provide you with top-notch vehicles at minimum expense.</p>
                        </div>
                    </div>
                    
                    <div class="col-lg-3">
                        <div class="widget">
                            <h5>Contact Info</h5>
                            <address class="s1">
                                <span><i class="id-color fa fa-map-marker fa-lg"></i>08 W 36th St, New York, NY 10001</span>
                                <span><i class="id-color fa fa-phone fa-lg"></i>+1 333 9296</span>
                                <span><i class="id-color fa fa-envelope-o fa-lg"></i><a href="mailto:contact@example.com">contact@example.com</a></span>
                                <span><i class="id-color fa fa-file-pdf-o fa-lg"></i><a href="#">Download Brochure</a></span>
                            </address>
                        </div>
                    </div>

                    <div class="col-lg-3">
                        <h5>Quick Links</h5>
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="widget">
                                    <ul>
                                        <li><a href="#">About</a></li>
                                        <li><a href="#">Blog</a></li>
                                        <li><a href="#">Careers</a></li>
                                        <li><a href="#">News</a></li>
                                        <li><a href="#">Partners</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3">
                        <div class="widget">
                            <h5>Social Network</h5>
                            <div class="social-icons">
                                <a href="#"><i class="fa fa-facebook fa-lg"></i></a>
                                <a href="#"><i class="fa fa-twitter fa-lg"></i></a>
                                <a href="#"><i class="fa fa-linkedin fa-lg"></i></a>
                                <a href="#"><i class="fa fa-pinterest fa-lg"></i></a>
                                <a href="#"><i class="fa fa-rss fa-lg"></i></a>
                            </div>
                        </div>    
                    </div>
                </div>
            </div>
            <div class="subfooter">
                <div class="container">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="de-flex">
                                <div class="de-flex-col">
                                    <a href="index.html">
                                        Copyright 2025 - PlusRent by Designesia
                                    </a>
                                </div>
                                <ul class="menu-simple">
                                    <li><a href="#">Terms &amp; Conditions</a></li>
                                    <li><a href="#">Privacy Policy</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
        <!-- footer close -->
        
    </div>

    <!-- Custom Alert -->
    <div id="adminCustomAlert" style="display:none;position:fixed;top:32px;left:50%;transform:translateX(-50%);z-index:10002;min-width:320px;max-width:90vw;padding:16px 32px;border-radius:8px;font-size:1.1rem;font-weight:500;box-shadow:0 4px 24px rgba(0,0,0,0.12);background:#031B4E;color:#fff;text-align:center;transition:opacity 0.3s;opacity:0;"></div>


    <!-- Javascript Files
    ================================================== -->
    <script src="js/plugins.js"></script>
    <script src="js/designesia.js"></script>

</body>

</html>

<script>
// Global variables
let currentGalleryImages = []; // Track current gallery images for edit mode
let editGalleryImageFiles = []; // Track new gallery image files for edit mode
let addGalleryImageFiles = []; // Track gallery image files for add mode
let isProcessingFiles = false; // Prevent duplicate file processing

// Populate selects for years, doors, passengers
function populateSelect(select, from, to, desc = false) {
  select.innerHTML = '';
  if (desc) {
    for (let i = from; i >= to; i--) {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = i;
      select.appendChild(opt);
    }
  } else {
    for (let i = from; i <= to; i++) {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = i;
      select.appendChild(opt);
    }
  }
}

// Body scroll lock functions
let scrollPosition = 0;

// function preventScroll(e) {
//   e.preventDefault();
//   e.stopPropagation();
//   return false;
// }

function preventKeyScroll(e) {
  // Prevent arrow keys, page up/down, home/end from scrolling
  // But allow navigation keys when typing in input fields
  if ([32, 33, 34, 35, 36, 37, 38, 39, 40].includes(e.keyCode)) {
    // Allow spacebar and arrow keys in input fields, textareas, and other form elements
    if ((e.keyCode === 32 || e.keyCode === 37 || e.keyCode === 39) && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.contentEditable === 'true')) {
      return; // Don't prevent default for spacebar and left/right arrows in input fields
    }
    e.preventDefault();
  }
}

function lockBodyScroll() {
  // Store current scroll position
  scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
  
  // Set the body top position to maintain scroll position BEFORE adding the class
  document.body.style.top = `-${scrollPosition}px`;
  
  // Apply scroll lock
  document.body.classList.add('modal-open');
  document.documentElement.classList.add('modal-open');
  
  // Add event listeners to prevent scrolling
  document.addEventListener('wheel', preventScroll, { passive: false });
  document.addEventListener('touchmove', preventScroll, { passive: false });
  document.addEventListener('keydown', preventKeyScroll);
}

function unlockBodyScroll() {
  // Remove scroll lock
  document.body.classList.remove('modal-open');
  document.documentElement.classList.remove('modal-open');
  
  // Reset body top position
  document.body.style.top = '';
  
  // Remove event listeners
  document.removeEventListener('wheel', preventScroll);
  document.removeEventListener('touchmove', preventScroll);
  document.removeEventListener('keydown', preventKeyScroll);
  
  // Restore scroll position
  window.scrollTo(0, scrollPosition);
}

function showAlert(message, type = 'success') {
  const alertDiv = document.getElementById('adminCustomAlert');
  alertDiv.textContent = message;
  alertDiv.className = type === 'success' ? 'success' : 'error';
  alertDiv.style.display = 'block';
  alertDiv.style.opacity = '1';
  setTimeout(() => {
    alertDiv.style.opacity = '0';
    setTimeout(() => {
      alertDiv.style.display = 'none';
      alertDiv.className = '';
    }, 400);
  }, 2200);
}

// Gallery upload button state management
function updateGalleryUploadButton(containerId, isEdit = false) {
  const maxImages = 10;
  let currentCount = 0;
  let buttonId, inputId;
  
  if (isEdit) {
    buttonId = 'editGalleryImagesButton';
    inputId = 'editGalleryImagesInput';
    currentCount = currentGalleryImages.length + editGalleryImageFiles.length;
  } else {
    buttonId = 'addGalleryImagesButton';
    inputId = 'addGalleryImagesInput';
    currentCount = addGalleryImageFiles.length;
  }
  
  console.log('updateGalleryUploadButton called:', containerId, 'isEdit:', isEdit, 'currentCount:', currentCount);
  
  const button = document.getElementById(buttonId);
  const input = document.getElementById(inputId);
  const buttonArea = button.parentElement;
  
  if (currentCount >= maxImages) {
    button.disabled = true;
    input.disabled = true;
    buttonArea.classList.add('disabled');
    button.querySelector('.admin-upload-text').textContent = `Max ${maxImages} Images`;
    const subtext = button.querySelector('.admin-upload-subtext');
    if (subtext) {
      subtext.textContent = 'Remove to add more';
    }
  } else {
    button.disabled = false;
    input.disabled = false;
    buttonArea.classList.remove('disabled');
    if (currentCount > 0) {
      button.querySelector('.admin-upload-text').textContent = isEdit ? 
        `${editGalleryImageFiles.length} New Images Selected` : 
        `${currentCount} Images Selected`;
      const subtext = button.querySelector('.admin-upload-subtext');
      if (subtext) {
        subtext.textContent = `${currentCount} of ${maxImages} max`;
      }
    } else {
      button.querySelector('.admin-upload-text').textContent = 'Upload Gallery Images';
      const subtext = button.querySelector('.admin-upload-subtext');
      if (subtext) {
        subtext.textContent = 'Click to select images';
      }
    }
  }
}

// Gallery Carousel Functions
function createCarousel(containerId, images, isEdit = false, preservePosition = false) {
  const container = document.getElementById(containerId);
  if (!images || images.length === 0) {
    container.innerHTML = '';
    return;
  }

  // Show 2.5 images per view (continuous scroll)
  const imagesPerView = 2.5;
  const imageWidth = 100 / imagesPerView; // Each image takes up 40% width (100/2.5)

  // Preserve current position if requested and state exists
  const existingState = window.carouselStates && window.carouselStates[containerId];
  const currentPosition = preservePosition && existingState ? existingState.currentIndex : 0;

  // Check if carousel already exists
  const existingCarousel = container.querySelector('.admin-gallery-carousel');
  const existingTrack = document.getElementById(containerId + 'Track');
  
  if (existingCarousel && existingTrack && preservePosition) {
    // Update existing carousel without destroying the container
    const newImagesHTML = images.map((img, index) => `
      <div class="admin-carousel-image-item" style="flex: 0 0 ${imageWidth}%;">
        <img src="${img.src}" alt="Gallery Image ${index + 1}">
        <button type="button" class="admin-carousel-remove" data-container="${containerId}" data-index="${index}" data-is-edit="${isEdit}">×</button>
      </div>
    `).join('');
    
    // Update only the track content
    existingTrack.innerHTML = newImagesHTML;
    
    // Update carousel state
    if (!window.carouselStates) window.carouselStates = {};
    const newMaxIndex = Math.max(0, images.length - Math.floor(imagesPerView));
    const finalPosition = Math.min(currentPosition, newMaxIndex);
    
    window.carouselStates[containerId] = {
      currentIndex: finalPosition,
      totalImages: images.length,
      images: images,
      imagesPerView: imagesPerView,
      maxIndex: newMaxIndex
    };
    
    // Apply position if needed
    if (finalPosition > 0) {
      let translateX;
      if (finalPosition === newMaxIndex && images.length > imagesPerView) {
        const halfImageWidth = imageWidth * 0.5;
        const reducedSpace = halfImageWidth;
        translateX = -(images.length - imagesPerView) * imageWidth - reducedSpace;
      } else {
        translateX = -finalPosition * imageWidth;
      }
      existingTrack.style.transform = `translateX(${translateX}%)`;
    }
  } else {
    // Create new carousel (first time or when not preserving position)
    const carouselHTML = `
      <div class="admin-gallery-carousel">
        <div class="admin-carousel-container">
          <div class="admin-carousel-track-wrapper">
            <div class="admin-carousel-track" id="${containerId}Track">
              ${images.map((img, index) => `
                <div class="admin-carousel-image-item" style="flex: 0 0 ${imageWidth}%;">
                  <img src="${img.src}" alt="Gallery Image ${index + 1}">
                  <button type="button" class="admin-carousel-remove" data-container="${containerId}" data-index="${index}" data-is-edit="${isEdit}">×</button>
                </div>
              `).join('')}
            </div>
          </div>
          <button type="button" class="admin-carousel-nav admin-carousel-prev" id="${containerId}Prev" onclick="moveCarousel('${containerId}', -1)">‹</button>
          <button type="button" class="admin-carousel-nav admin-carousel-next" id="${containerId}Next" onclick="moveCarousel('${containerId}', 1)">›</button>
        </div>
      </div>
    `;

    container.innerHTML = carouselHTML;
    
    // Initialize carousel state
    if (!window.carouselStates) window.carouselStates = {};
    const newMaxIndex = Math.max(0, images.length - Math.floor(imagesPerView));
    const finalPosition = Math.min(currentPosition, newMaxIndex);
    
    window.carouselStates[containerId] = {
      currentIndex: finalPosition,
      totalImages: images.length,
      images: images,
      imagesPerView: imagesPerView,
      maxIndex: newMaxIndex
    };
    
    // Apply initial position if not at the beginning
    if (finalPosition > 0) {
      const track = document.getElementById(containerId + 'Track');
      let translateX;
      if (finalPosition === newMaxIndex && images.length > imagesPerView) {
        const halfImageWidth = imageWidth * 0.5;
        const reducedSpace = halfImageWidth * 0.55;
        translateX = -(images.length - imagesPerView) * imageWidth - reducedSpace;
      } else {
        translateX = -finalPosition * imageWidth;
      }
      track.style.transform = `translateX(${translateX}%)`;
    }
  }
  

  
  updateCarouselButtons(containerId);
}

function moveCarousel(containerId, direction) {
  const state = window.carouselStates[containerId];
  if (!state) {
    console.log('No carousel state found for:', containerId);
    return;
  }
  
  console.log('Manual scroll - currentIndex:', state.currentIndex, 'direction:', direction, 'maxIndex:', state.maxIndex, 'totalImages:', state.totalImages);
  
  const newIndex = state.currentIndex + direction;
  if (newIndex < 0 || newIndex > state.maxIndex) {
    console.log('Manual scroll blocked - newIndex would be:', newIndex, 'maxIndex:', state.maxIndex, 'reason:', newIndex < 0 ? 'below minimum' : 'above maximum');
    return;
  }
  
  state.currentIndex = newIndex;
  console.log('Manual scroll applied - newCurrentIndex:', state.currentIndex);
  
  const track = document.getElementById(containerId + 'Track');
  const imageWidth = 100 / state.imagesPerView;
  
  // Special handling for the last image - don't leave space for non-existent next image
  let translateX;
  if (newIndex === state.maxIndex && state.totalImages > state.imagesPerView) {
    // For the last position, move a bit less than half an image space
    const halfImageWidth = imageWidth * 0.5;
    const reducedSpace = halfImageWidth * 0.35;
    translateX = -(state.totalImages - state.imagesPerView) * imageWidth - reducedSpace;
  } else {
    translateX = -newIndex * imageWidth;
  }
  
  track.style.transform = `translateX(${translateX}%)`;
  
  updateCarouselButtons(containerId);
}

function updateCarouselButtons(containerId) {
  const state = window.carouselStates[containerId];
  if (!state) return;
  
  const prevBtn = document.getElementById(containerId + 'Prev');
  const nextBtn = document.getElementById(containerId + 'Next');
  
  // Debug logging
  console.log('updateCarouselButtons - containerId:', containerId, 'currentIndex:', state.currentIndex, 'maxIndex:', state.maxIndex, 'totalImages:', state.totalImages);
  
  // More robust button state logic
  const canGoPrevious = state.currentIndex > 0 && state.totalImages > state.imagesPerView;
  const canGoNext = state.currentIndex < state.maxIndex && state.totalImages > state.imagesPerView;
  
  if (prevBtn) {
    prevBtn.disabled = !canGoPrevious;
    console.log('Previous button disabled:', !canGoPrevious);
  }
  if (nextBtn) {
    nextBtn.disabled = !canGoNext;
    console.log('Next button disabled:', !canGoNext);
  }
}

function scrollCarouselToEnd(containerId) {
  const state = window.carouselStates[containerId];
  if (!state) return;
  
  // Move to the last position
  state.currentIndex = state.maxIndex;
  
  const track = document.getElementById(containerId + 'Track');
  const imageWidth = 100 / state.imagesPerView;
  
  // Apply the same logic as in moveCarousel for the last image
  let translateX;
  if (state.currentIndex === state.maxIndex && state.totalImages > state.imagesPerView) {
    // For the last position, move a bit less than half an image space
    const halfImageWidth = imageWidth * 0.5;
    const reducedSpace = halfImageWidth * 0.7;
    translateX = -(state.totalImages - state.imagesPerView) * imageWidth - reducedSpace;
  } else {
    translateX = -state.currentIndex * imageWidth;
  }
  
  track.style.transform = `translateX(${translateX}%)`;
  updateCarouselButtons(containerId);
}



async function removeCarouselImage(containerId, imageIndex, isEdit = false) {
  const state = window.carouselStates[containerId];
  if (!state) return;
  
  const imageToRemove = state.images[imageIndex];
  if (!imageToRemove) {
    console.error('Image to remove not found at index:', imageIndex);
    return;
  }
  

  
  // Handle edit mode - remove from server if it's an existing image
  if (isEdit && containerId === 'editGalleryImagesPreview') {
    if (imageToRemove.isExisting) {
      // Remove from server with proper type parameter
      const editForm = document.getElementById('editCarForm');
      const carId = editForm.getAttribute('data-id');
      try {
        const response = await fetch(`http://localhost:3001/api/cars/${carId}/images?path=${encodeURIComponent(imageToRemove.originalPath)}&type=gallery`, { method: 'DELETE' });
        if (response.ok) {
          // Remove from currentGalleryImages array
          const imageIndex = currentGalleryImages.findIndex(img => img === imageToRemove.originalPath);
          if (imageIndex !== -1) {
            currentGalleryImages.splice(imageIndex, 1);
          }
          showAlert('Image deleted successfully!', 'success');
        } else {
          showAlert('Failed to delete image from server.', 'error');
          return;
        }
      } catch (error) {
        console.error('Error removing image from server:', error);
        showAlert('Error deleting image.', 'error');
        return;
      }
    } else {
      // Remove from new uploads array
      editGalleryImageFiles.splice(imageToRemove.fileIndex, 1);
      // Update file indices for remaining new uploads
      state.images.forEach((img, idx) => {
        if (!img.isExisting && img.fileIndex > imageToRemove.fileIndex) {
          img.fileIndex--;
        }
      });
    }
  } else if (isEdit && containerId === 'editHeadImagePreview') {
    if (imageToRemove.isExisting) {
      // Remove head image from server
      const editForm = document.getElementById('editCarForm');
      const carId = editForm.getAttribute('data-id');
      try {
        const response = await fetch(`http://localhost:3001/api/cars/${carId}/images?path=${encodeURIComponent(imageToRemove.originalPath)}&type=head`, { method: 'DELETE' });
        if (response.ok) {
          showAlert('Head image deleted successfully!', 'success');
        } else {
          showAlert('Failed to delete head image from server.', 'error');
          return;
        }
      } catch (error) {
        console.error('Error removing head image from server:', error);
        showAlert('Error deleting head image.', 'error');
        return;
      }
    } else {
      // Remove from new uploads
      editHeadImageFile = null;
    }
  } else if (!isEdit && containerId === 'addGalleryImagesPreview') {
    // Remove from add files array
    if (imageToRemove && imageToRemove.fileIndex !== undefined) {
      console.log('Removing image at fileIndex:', imageToRemove.fileIndex, 'Current array length:', addGalleryImageFiles.length);
      addGalleryImageFiles.splice(imageToRemove.fileIndex, 1);
      console.log('New array length:', addGalleryImageFiles.length);
    } else {
      // Fallback: remove by image index if fileIndex is not available
      console.log('Fallback removal at imageIndex:', imageIndex, 'Current array length:', addGalleryImageFiles.length);
      addGalleryImageFiles.splice(imageIndex, 1);
      console.log('New array length:', addGalleryImageFiles.length);
    }
  } else if (!isEdit && containerId === 'addHeadImagePreview') {
    // Remove from add head image
    addHeadImageFile = null;
  }
  
  // Remove from state
  state.images.splice(imageIndex, 1);
  state.totalImages = state.images.length;
  
  // Recalculate max index
  state.maxIndex = Math.max(0, state.totalImages - Math.floor(state.imagesPerView));
  
  // Calculate new position based on deletion logic
  console.log('Before deletion - currentIndex:', state.currentIndex, 'imageIndex:', imageIndex, 'totalImages:', state.totalImages, 'maxIndex:', state.maxIndex);
  
  let newPosition;
  
  // Special case: if we have 2 or fewer images left, always go to position 0
  if (state.totalImages <= 2) {
    newPosition = 0;
    console.log('Only 2 or fewer images left, resetting to position 0');
    // Force the carousel to actually move to position 0 by triggering the visual reset
    setTimeout(() => {
      const track = document.getElementById(containerId + 'Track');
      if (track) {
        track.style.transform = 'translateX(0%)';
        console.log('Forced carousel reset to position 0');
      }
    }, 50);
  } else {
    // Simple logic: if we delete an image at or before our current position, move back one
    if (imageIndex <= state.currentIndex) {
      newPosition = Math.max(0, state.currentIndex - 1);
    } else {
      // If we delete an image after our current position, stay where we are
      newPosition = state.currentIndex;
    }
    
    // Make sure the new position doesn't exceed the maximum
    newPosition = Math.min(newPosition, state.maxIndex);
  }
  
  console.log('After deletion - newPosition:', newPosition, 'newMaxIndex:', state.maxIndex, 'newTotalImages:', state.totalImages);
  
  // Update the state with the new position
  state.currentIndex = newPosition;
  
  // Additional validation to ensure state consistency
  if (state.currentIndex < 0) state.currentIndex = 0;
  if (state.currentIndex > state.maxIndex) state.currentIndex = state.maxIndex;
  
      // Recreate carousel with updated data
    if (state.totalImages > 0) {
      // For edit mode, rebuild the images array from current data
      if (isEdit && containerId === 'editGalleryImagesPreview') {
        const BASE_URL = 'http://localhost:3001';
        const allImages = [];
        
        // Add new uploads first (so they appear at the beginning)
        editGalleryImageFiles.forEach((file, idx) => {
          const url = URL.createObjectURL(file);
          allImages.push({ src: url, isExisting: false, fileIndex: idx });
        });
        
        // Add existing images after new uploads
        currentGalleryImages.forEach((img, idx) => {
          let imgSrc = img.startsWith('http') ? img : `${BASE_URL}${img}`;
          allImages.push({ src: imgSrc, isExisting: true, originalPath: img });
        });
        
        createCarousel(containerId, allImages, isEdit, true);
      } else if (isEdit && containerId === 'editHeadImagePreview') {
        // For head image, clear the preview and reset button state
        document.getElementById(containerId).innerHTML = '';
        const headButtonArea = document.getElementById('editHeadImageButton').parentElement;
        const headButton = document.getElementById('editHeadImageButton');
        headButtonArea.classList.remove('has-file');
        headButton.querySelector('.admin-upload-text').textContent = 'Upload Head Image';
        const subtext = headButton.querySelector('.admin-upload-subtext');
        if (subtext) {
          subtext.textContent = 'Click to select image';
        }
        editHeadImageFile = null;
        delete window.carouselStates[containerId];
        return;
      } else if (!isEdit && containerId === 'addGalleryImagesPreview') {
        // For add mode, use the global addGalleryImageFiles
        console.log('Recreating carousel with', addGalleryImageFiles.length, 'files');
        const images = addGalleryImageFiles.map((file, idx) => ({
          src: URL.createObjectURL(file),
          fileIndex: idx
        }));
        createCarousel(containerId, images, isEdit, true);
      } else if (!isEdit && containerId === 'addHeadImagePreview') {
        // For add head image, clear the preview and reset button state
        document.getElementById(containerId).innerHTML = '';
        const headButtonArea = document.getElementById('addHeadImageButton').parentElement;
        const headButton = document.getElementById('addHeadImageButton');
        headButtonArea.classList.remove('has-file');
        headButton.querySelector('.admin-upload-text').textContent = 'Upload Head Image';
        const subtext = headButton.querySelector('.admin-upload-subtext');
        if (subtext) {
          subtext.textContent = 'Click to select image';
        }
        addHeadImageFile = null;
        delete window.carouselStates[containerId];
        return;
      } else {
        createCarousel(containerId, state.images, isEdit, true);
      }
    
    // Position is now preserved directly in createCarousel function
    // Small delay to ensure DOM is fully updated before updating button states
    setTimeout(() => {
      updateCarouselButtons(containerId);
    }, 10);
  } else {
    document.getElementById(containerId).innerHTML = '';
    delete window.carouselStates[containerId];
  }
  
  // Update button state after removal (with small delay to ensure DOM is updated)
  setTimeout(() => {
    updateGalleryUploadButton(containerId, isEdit);
  }, 0);
}

document.addEventListener('DOMContentLoaded', function () {
  // Add Car Panel
  const showBtn = document.getElementById('showAddCarBtn');
  const addPanel = document.getElementById('addCarPanel');
  const closeAddBtn = document.getElementById('closeAddCarPanel');
  const addForm = document.getElementById('carForm');
  const addFormSubmitBtn = document.getElementById('formSubmitBtn');

  // Edit Car Panel
  const editPanel = document.getElementById('editCarPanel');
  const closeEditBtn = document.getElementById('closeEditCarPanel');
  const editForm = document.getElementById('editCarForm');
  const editFormSubmitBtn = document.getElementById('editFormSubmitBtn');
  

  // Fix: Declare edit image file variables in the correct scope
  let editHeadImageFile = null;
  
  // Get DOM elements for edit form
  const editHeadImageInput = document.getElementById('editHeadImageInput');
  const editGalleryImagesInput = document.getElementById('editGalleryImagesInput');
  const editHeadImagePreview = document.getElementById('editHeadImagePreview');
  const editGalleryImagesPreview = document.getElementById('editGalleryImagesPreview');

  // Global event listener for carousel remove buttons
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('admin-carousel-remove')) {
      const containerId = e.target.getAttribute('data-container');
      const imageIndex = parseInt(e.target.getAttribute('data-index'));
      const isEdit = e.target.getAttribute('data-is-edit') === 'true';
      removeCarouselImage(containerId, imageIndex, isEdit);
    }
  });

  // Function to delete head image
  async function deleteHeadImage(imagePath) {
    const editForm = document.getElementById('editCarForm');
    const carId = editForm.getAttribute('data-id');
    
    try {
      const response = await fetch(`http://localhost:3001/api/cars/${carId}/images?path=${encodeURIComponent(imagePath)}&type=head`, { method: 'DELETE' });
      
      if (response.ok) {
        // Clear the head image preview
        editHeadImagePreview.innerHTML = '';
        
        // Reset the head image button state
        const headButtonArea = document.getElementById('editHeadImageButton').parentElement;
        const headButton = document.getElementById('editHeadImageButton');
        headButtonArea.classList.remove('has-file');
        headButton.querySelector('.admin-upload-text').textContent = 'Upload Head Image';
        const subtext = headButton.querySelector('.admin-upload-subtext');
        if (subtext) {
          subtext.textContent = 'Click to select image';
        }
        
        showAlert('Head image deleted successfully!', 'success');
      } else {
        showAlert('Failed to delete head image.', 'error');
      }
    } catch (error) {
      console.error('Error deleting head image:', error);
      showAlert('Error deleting head image.', 'error');
    }
  }

  // Make deleteHeadImage function globally accessible
  window.deleteHeadImage = deleteHeadImage;

  // Overlay and Confirm Modal
  const overlay = document.getElementById('adminOverlay');
  const confirmModal = document.getElementById('adminConfirmModal');
  const confirmCloseBtn = document.getElementById('confirmCloseBtn');
  const cancelCloseBtn = document.getElementById('cancelCloseBtn');
  let pendingClosePanel = null;

  // Show Add Panel
  showBtn.addEventListener('click', function (e) {
    e.preventDefault();
    addPanel.classList.add('active');
    editPanel.classList.remove('active');
    overlay.classList.add('active');
    addForm.reset();
    document.body.classList.add('admin-popup-open');
    document.documentElement.classList.add('admin-popup-open');
    lockBodyScroll();
  });

  // Upload button click handlers
  document.getElementById('addHeadImageButton').addEventListener('click', function() {
    document.getElementById('addHeadImageInput').click();
  });
  
  document.getElementById('addGalleryImagesButton').addEventListener('click', function() {
    document.getElementById('addGalleryImagesInput').click();
  });
  
  document.getElementById('editHeadImageButton').addEventListener('click', function() {
    document.getElementById('editHeadImageInput').click();
  });
  
  document.getElementById('editGalleryImagesButton').addEventListener('click', function() {
    document.getElementById('editGalleryImagesInput').click();
  });
  function closePanel(panel, form) {
    // Always hide the confirmation modal when closing the panel
    confirmModal.classList.remove('active');
    pendingClosePanel = null;
    panel.classList.remove('active');
    overlay.classList.remove('active');
    form.reset();
    // Reset image inputs when actually closing the panel
    if (form === editForm) {
      resetEditImageInputs();
    } else if (form === addForm) {
      resetAddImageInputs();
    }
    document.body.classList.remove('admin-popup-open');
    document.documentElement.classList.remove('admin-popup-open');
    unlockBodyScroll();
  }
  function askClosePanel(panel, form) {
    confirmModal.classList.add('active');
    overlay.classList.add('active');
    pendingClosePanel = {panel, form};
  }
  function handleOverlayClick(e) {
    if (addPanel.classList.contains('active')) {
      askClosePanel(addPanel, addForm);
    } else if (editPanel.classList.contains('active')) {
      askClosePanel(editPanel, editForm);
    } else {
      // If neither panel is open, hide the confirmation modal just in case
      confirmModal.classList.remove('active');
      pendingClosePanel = null;
    }
  }
  overlay.addEventListener('click', handleOverlayClick);
  closeAddBtn.addEventListener('click', function () {
    askClosePanel(addPanel, addForm);
  });
  closeEditBtn.addEventListener('click', function () {
    askClosePanel(editPanel, editForm);
  });
  confirmCloseBtn.addEventListener('click', function () {
    if (pendingClosePanel) {
      closePanel(pendingClosePanel.panel, pendingClosePanel.form);
      confirmModal.classList.remove('active'); // Defensive: always remove
      pendingClosePanel = null;
    }
  });
  cancelCloseBtn.addEventListener('click', function () {
    confirmModal.classList.remove('active');
    // Keep overlay active since the main modal is still open
    pendingClosePanel = null;
  });

  // Populate selects for both forms
  populateSelect(addForm.elements['production_year'], new Date().getFullYear(), 2000, true);
  populateSelect(addForm.elements['num_doors'], 2, 7);
  populateSelect(addForm.elements['num_passengers'], 2, 9);
  populateSelect(editForm.elements['production_year'], new Date().getFullYear(), 2000, true);
  populateSelect(editForm.elements['num_doors'], 2, 7);
  populateSelect(editForm.elements['num_passengers'], 2, 9);

  // Handle fuel type changes for engine capacity
  function handleFuelTypeChange(form, isEdit = false) {
    const fuelTypeSelect = form.elements['fuel_type'];
    const engineCapacityInput = form.elements['engine_capacity'];
    
    if (fuelTypeSelect.value === 'Electric') {
      engineCapacityInput.disabled = true;
      engineCapacityInput.value = '';
      engineCapacityInput.placeholder = 'Electric';
      engineCapacityInput.style.opacity = '0.5';
      engineCapacityInput.style.cursor = 'not-allowed';
    } else {
      engineCapacityInput.disabled = false;
      engineCapacityInput.placeholder = '';
      engineCapacityInput.style.opacity = '1';
      engineCapacityInput.style.cursor = 'text';
    }
  }

  // Add event listeners for fuel type changes
  addForm.elements['fuel_type'].addEventListener('change', function() {
    handleFuelTypeChange(addForm, false);
  });

  editForm.elements['fuel_type'].addEventListener('change', function() {
    handleFuelTypeChange(editForm, true);
  });

  // Initial check for both forms
  handleFuelTypeChange(addForm, false);
  handleFuelTypeChange(editForm, true);

  // Add Car form logic
  let addUploading = false;
  let addHeadImageFile = null;
  
  // Get DOM elements for add form
  const addHeadImageInput = document.getElementById('addHeadImageInput');
  const addGalleryImagesInput = document.getElementById('addGalleryImagesInput');
  const addHeadImagePreview = document.getElementById('addHeadImagePreview');
  const addGalleryImagesPreview = document.getElementById('addGalleryImagesPreview');
  
  function resetAddImageInputs() {
    addHeadImageInput.value = '';
    addGalleryImagesInput.value = '';
    addHeadImagePreview.innerHTML = '';
    addGalleryImagesPreview.innerHTML = '';
    addHeadImageFile = null;
    addGalleryImageFiles = [];
    
    // Reset button states
    updateGalleryUploadButton('addGalleryImagesPreview', false);
    const headButtonArea = document.getElementById('addHeadImageButton').parentElement;
    const galleryButtonArea = document.getElementById('addGalleryImagesButton').parentElement;
    const headButton = document.getElementById('addHeadImageButton');
    const galleryButton = document.getElementById('addGalleryImagesButton');
    
    headButtonArea.classList.remove('has-file');
    headButton.querySelector('.admin-upload-text').textContent = 'Upload Head Image';
    
    galleryButtonArea.classList.remove('has-file');
    galleryButton.querySelector('.admin-upload-text').textContent = 'Upload Gallery Images';
    
    // Reset engine capacity field state
    handleFuelTypeChange(addForm, false);
  }
  addHeadImageInput.addEventListener('change', function() {
    addHeadImagePreview.innerHTML = '';
    addHeadImageFile = this.files[0] || null;
    const buttonArea = document.getElementById('addHeadImageButton').parentElement;
    const button = document.getElementById('addHeadImageButton');
    if (addHeadImageFile) {
      const url = URL.createObjectURL(addHeadImageFile);
      addHeadImagePreview.innerHTML = `
        <div style="position: relative; display: inline-block;">
          <img src="${url}" style="width: 180px; height: 170px; object-fit: cover; border-radius: 6px; border: 1.5px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <button type="button" class="admin-carousel-remove" onclick="addHeadImageFile = null; addHeadImagePreview.innerHTML = ''; this.parentElement.remove();" style="position: absolute; top: -6px; right: -6px; background: rgb(248 67 61 / 90%); color: #fff; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 15px; padding-bottom: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; transition: all 0.2s; backdrop-filter: blur(2px);">×</button>
        </div>
      `;
      buttonArea.classList.add('has-file');
      button.querySelector('.admin-upload-text').textContent = 'Image Selected';
      // Fix: Check if subtext element exists before setting it
      const subtext = button.querySelector('.admin-upload-subtext');
      if (subtext) {
        subtext.textContent = addHeadImageFile.name;
      }
    } else {
      buttonArea.classList.remove('has-file');
      button.querySelector('.admin-upload-text').textContent = 'Upload Head Image';
      // Fix: Check if subtext element exists before setting it
      const subtext = button.querySelector('.admin-upload-subtext');
      if (subtext) {
        subtext.textContent = 'Click to select image';
      }
    }
  });
  addGalleryImagesInput.addEventListener('change', function() {
    if (this.files.length === 0 || isProcessingFiles) return; // No files selected or already processing
    
    const currentCount = addGalleryImageFiles.length;
    
    // Check if we're already at the limit
    if (currentCount >= 10) {
      showAlert('You already have the maximum of 10 gallery images.', 'error');
      this.value = ''; // Clear the input
      return;
    }
    
    isProcessingFiles = true;
    
    let files = Array.from(this.files);
    const availableSlots = 10 - currentCount;
    
    console.log('Processing files:', files.length, 'Current count:', currentCount, 'Available slots:', availableSlots);
    
    if (files.length > availableSlots) {
      showAlert(`You can only upload ${availableSlots} more image(s). Maximum is 10.`, 'error');
      files = files.slice(0, availableSlots);
    }
    
    // Only add files if there are any to add and we have available slots
    if (files.length > 0 && currentCount < 10) {
      // Add new files to the beginning of the array
      addGalleryImageFiles = files.concat(addGalleryImageFiles);
      console.log('New total count:', addGalleryImageFiles.length);
      
      const buttonArea = document.getElementById('addGalleryImagesButton').parentElement;
      buttonArea.classList.add('has-file');
      updateGalleryUploadButton('addGalleryImagesPreview', false);
      renderAddGalleryPreviews();
    }
    
    // Clear the input to allow re-selecting the same files
    this.value = '';
    
    // Reset processing flag after a short delay
    setTimeout(() => {
      isProcessingFiles = false;
    }, 100);
  });
  function renderAddGalleryPreviews() {
    if (addGalleryImageFiles.length === 0) {
      addGalleryImagesPreview.innerHTML = '';
      updateGalleryUploadButton('addGalleryImagesPreview', false);
      return;
    }
    
    const images = addGalleryImageFiles.map((file, idx) => ({
      src: URL.createObjectURL(file),
      fileIndex: idx
    }));
    
    // Check if carousel already exists to preserve position during recreation
    const existingCarousel = window.carouselStates && window.carouselStates['addGalleryImagesPreview'];
    
    if (existingCarousel) {
      // New images are at the beginning, so reset to start to show them
      createCarousel('addGalleryImagesPreview', images, false, false);
    } else {
      // First time creating carousel - start at beginning (new images are there)
      createCarousel('addGalleryImagesPreview', images, false);
    }
    
    updateGalleryUploadButton('addGalleryImagesPreview', false);
  }
  // Gallery image removal is now handled by the carousel
  // On Add Car submit, after car is created, upload images
  addForm.onsubmit = async function(e) {
    e.preventDefault();
    if (addUploading) return;
    
    // Validate engine capacity for non-electric cars
    const validationFormData = new FormData(addForm);
    const fuelType = validationFormData.get('fuel_type');
    const engineCapacity = validationFormData.get('engine_capacity');
    
    if (fuelType !== 'Electric' && (!engineCapacity || engineCapacity.trim() === '')) {
      showAlert('Engine capacity is required for non-electric cars.', 'error');
      return;
    }
    
    addUploading = true;
    addFormSubmitBtn.disabled = true;
    addFormSubmitBtn.innerHTML = 'Saving <span class="admin-spinner"></span>';
    // Submit car details first
    const formData = new FormData(addForm);
    const price_policy = {
      '1-2': String(formData.get('price_1_2')),
      '3-7': String(formData.get('price_3_7')),
      '8-20': String(formData.get('price_8_20')),
      '21-45': String(formData.get('price_21_45')),
      '46+': String(formData.get('price_46')),
    };
    const data = {
      make_name: formData.get('make_name'),
      model_name: formData.get('model_name'),
      production_year: formData.get('production_year'),
      gear_type: formData.get('gear_type'),
      fuel_type: formData.get('fuel_type'),
      engine_capacity: formData.get('fuel_type') === 'Electric' ? null : formData.get('engine_capacity'),
      car_type: formData.get('car_type'),
      num_doors: formData.get('num_doors'),
      num_passengers: formData.get('num_passengers'),
      price_policy: price_policy,
      booked_until: formData.get('booked_until') || null
    };
    try {
      const response = await fetch('http://localhost:3001/api/cars', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });
      if (response.ok) {
        const result = await response.json();
        // Now upload images if any
        if (addHeadImageFile || addGalleryImageFiles.length > 0) {
          const imgForm = new FormData();
          if (addHeadImageFile) imgForm.append('head_image', addHeadImageFile);
          addGalleryImageFiles.forEach(f => imgForm.append('gallery_images', f));
          await fetch(`http://localhost:3001/api/cars/${result.id}/images`, {
            method: 'POST',
            body: imgForm
          });
        }
        showAlert('Car added successfully!', 'success');
        addForm.reset();
        resetAddImageInputs();
        closePanel(addPanel, addForm);
        loadCars();
      } else {
        showAlert('Failed to add car.', 'error');
      }
    } catch (err) {
      showAlert('Error saving car.', 'error');
    }
    addUploading = false;
    addFormSubmitBtn.disabled = false;
                            addFormSubmitBtn.innerHTML = 'Add Car';
  };
  // Reset image inputs on close - removed immediate reset, will be handled by closePanel function

  // --- Edit Car image logic ---
  let editUploading = false;
  function resetEditImageInputs() {
    editHeadImageInput.value = '';
    editGalleryImagesInput.value = '';
    editHeadImagePreview.innerHTML = '';
    editGalleryImagesPreview.innerHTML = '';
    editHeadImageFile = null;
    editGalleryImageFiles = [];
    currentGalleryImages = [];
    
    // Reset button states
    updateGalleryUploadButton('editGalleryImagesPreview', true);
    const headButtonArea = document.getElementById('editHeadImageButton').parentElement;
    const galleryButtonArea = document.getElementById('editGalleryImagesButton').parentElement;
    const headButton = document.getElementById('editHeadImageButton');
    const galleryButton = document.getElementById('editGalleryImagesButton');
    
    headButtonArea.classList.remove('has-file');
    headButton.querySelector('.admin-upload-text').textContent = 'Upload Head Image';
    
    galleryButtonArea.classList.remove('has-file');
    galleryButton.querySelector('.admin-upload-text').textContent = 'Upload Gallery Images';
    
    // Reset engine capacity field state
    handleFuelTypeChange(editForm, true);
  }
  function renderEditImagePreviews(car) {
    // Head image
    editHeadImagePreview.innerHTML = '';
    const BASE_URL = 'http://localhost:3001';
    if (car.head_image) {
      let headImgSrc = car.head_image.startsWith('http') ? car.head_image : `${BASE_URL}${car.head_image}`;
      editHeadImagePreview.innerHTML = `
        <div style="position: relative; display: inline-block;">
          <img src='${headImgSrc}' style="width: 180px; height: 170px; object-fit: cover; border-radius: 6px; border: 1.5px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <button type="button" class="admin-carousel-remove" onclick="deleteHeadImage('${car.head_image}')" style="position: absolute; top: -6px; right: -6px; background: rgb(248 67 61 / 90%); color: #fff; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 15px; padding-bottom: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; transition: all 0.2s; backdrop-filter: blur(2px);">×</button>
        </div>
      `;
    }
    // Gallery images
    editGalleryImagesPreview.innerHTML = '';
    // Fix: Ensure gallery_images is always an array and update global variable
    currentGalleryImages = [];
    if (Array.isArray(car.gallery_images)) {
      currentGalleryImages = car.gallery_images;
    } else if (typeof car.gallery_images === 'string' && car.gallery_images) {
      try {
        // Try to parse as JSON array
        currentGalleryImages = JSON.parse(car.gallery_images);
        if (!Array.isArray(currentGalleryImages)) {
          currentGalleryImages = [car.gallery_images];
        }
      } catch {
        // Fallback: treat as single image string
        currentGalleryImages = [car.gallery_images];
      }
    }
    // Combine existing images and new uploads for carousel
    const allImages = [];
    
    // Add new uploads first (so they appear at the beginning)
    editGalleryImageFiles.forEach((file, idx) => {
      const url = URL.createObjectURL(file);
      allImages.push({ src: url, isExisting: false, fileIndex: idx });
    });
    
    // Add existing images after new uploads
    currentGalleryImages.forEach((img, idx) => {
      let imgSrc = img.startsWith('http') ? img : `${BASE_URL}${img}`;
      allImages.push({ src: imgSrc, isExisting: true, originalPath: img });
    });
    
    // Create carousel if there are images
    if (allImages.length > 0) {
      const hasNewImages = editGalleryImageFiles.length > 0;
      
      if (hasNewImages) {
        // New images added at the beginning - reset to start to show them
        createCarousel('editGalleryImagesPreview', allImages, true, false);
      } else {
        // No new images - preserve current position
        createCarousel('editGalleryImagesPreview', allImages, true, true);
      }
    } else {
      editGalleryImagesPreview.innerHTML = '';
    }
    
    // Update button state
    updateGalleryUploadButton('editGalleryImagesPreview', true);
  }
  editHeadImageInput.addEventListener('change', function() {
    editHeadImagePreview.innerHTML = '';
    editHeadImageFile = this.files[0] || null;
    const buttonArea = document.getElementById('editHeadImageButton').parentElement;
    const button = document.getElementById('editHeadImageButton');
    if (editHeadImageFile) {
      const url = URL.createObjectURL(editHeadImageFile);
      editHeadImagePreview.innerHTML = `
        <div style="position: relative; display: inline-block;">
          <img src="${url}" style="width: 180px; height: 170px; object-fit: cover; border-radius: 6px; border: 1.5px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <button type="button" class="admin-carousel-remove" onclick="editHeadImageFile = null; editHeadImagePreview.innerHTML = ''; this.parentElement.remove();" style="position: absolute; top: -6px; right: -6px; background: rgb(248 67 61 / 90%); color: #fff; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 15px; padding-bottom: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; transition: all 0.2s; backdrop-filter: blur(2px);">×</button>
        </div>
      `;
      buttonArea.classList.add('has-file');
      button.querySelector('.admin-upload-text').textContent = 'New Image Selected';
      // Fix: Check if subtext element exists before setting it
      const subtext = button.querySelector('.admin-upload-subtext');
      if (subtext) {
        subtext.textContent = editHeadImageFile.name;
      }
    } else {
      buttonArea.classList.remove('has-file');
      button.querySelector('.admin-upload-text').textContent = 'Upload Head Image';
      // Fix: Check if subtext element exists before setting it
      const subtext = button.querySelector('.admin-upload-subtext');
      if (subtext) {
        subtext.textContent = 'Click to select image';
      }
    }
  });
  editGalleryImagesInput.addEventListener('change', function() {
    if (this.files.length === 0 || isProcessingFiles) return; // No files selected or already processing
    
    const currentCount = currentGalleryImages.length + editGalleryImageFiles.length;
    
    // Check if we're already at the limit
    if (currentCount >= 10) {
      showAlert('You already have the maximum of 10 gallery images.', 'error');
      this.value = ''; // Clear the input
      return;
    }
    
    isProcessingFiles = true;
    
    let files = Array.from(this.files);
    const availableSlots = 10 - currentCount;
    
    if (files.length > availableSlots) {
      showAlert(`You can only upload ${availableSlots} more image(s). Maximum is 10.`, 'error');
      files = files.slice(0, availableSlots);
    }
    
    // Only add files if there are any to add and we have available slots
    if (files.length > 0 && currentCount < 10) {
      // Add new files to the beginning of the array
      editGalleryImageFiles = files.concat(editGalleryImageFiles);
      const buttonArea = document.getElementById('editGalleryImagesButton').parentElement;
      buttonArea.classList.add('has-file');
      updateGalleryUploadButton('editGalleryImagesPreview', true);
      renderEditImagePreviews({ head_image: editHeadImagePreview.querySelector('img') ? editHeadImagePreview.querySelector('img').src : null, gallery_images: Array.from(editGalleryImagesPreview.querySelectorAll('img')).map(img => img.src).filter(src => !src.startsWith('blob:')) });
    }
    
    // Clear the input to allow re-selecting the same files
    this.value = '';
    
    // Reset processing flag after a short delay
    setTimeout(() => {
      isProcessingFiles = false;
    }, 100);
  });
  // Gallery image removal is now handled by the carousel
  // On Edit Car submit, upload new images if any
  editForm.onsubmit = async function(e) {
    e.preventDefault();
    if (editUploading) return;
    
    // Validate engine capacity for non-electric cars
    const validationFormData = new FormData(editForm);
    const fuelType = validationFormData.get('fuel_type');
    const engineCapacity = validationFormData.get('engine_capacity');
    
    if (fuelType !== 'Electric' && (!engineCapacity || engineCapacity.trim() === '')) {
      showAlert('Engine capacity is required for non-electric cars.', 'error');
      return;
    }
    
    editUploading = true;
    editFormSubmitBtn.disabled = true;
    editFormSubmitBtn.innerHTML = 'Saving <span class="admin-spinner"></span>';
    // Submit car details first (as before)
    const formData = new FormData(editForm);
    const price_policy = {
      '1-2': String(formData.get('price_1_2')),
      '3-7': String(formData.get('price_3_7')),
      '8-20': String(formData.get('price_8_20')),
      '21-45': String(formData.get('price_21_45')),
      '46+': String(formData.get('price_46')),
    };
    // Clean gallery image URLs - remove base URL to get relative paths
    console.log('Original currentGalleryImages:', currentGalleryImages);
    const cleanGalleryImages = currentGalleryImages.map(img => {
      // Handle various URL formats
      if (img.startsWith('http://localhost:3001')) {
        return img.replace('http://localhost:3001', '');
      }
      if (img.startsWith('http:/localhost:3001')) {
        return img.replace('http:/localhost:3001', '');
      }
      if (img.startsWith('localhost:3001')) {
        return img.replace('localhost:3001', '');
      }
      // If it's already a relative path, return as is
      return img;
    });
    console.log('Cleaned gallery images:', cleanGalleryImages);
    
    const data = {
      make_name: formData.get('make_name'),
      model_name: formData.get('model_name'),
      production_year: formData.get('production_year'),
      gear_type: formData.get('gear_type'),
      fuel_type: formData.get('fuel_type'),
      engine_capacity: formData.get('fuel_type') === 'Electric' ? null : formData.get('engine_capacity'),
      car_type: formData.get('car_type'),
      num_doors: formData.get('num_doors'),
      num_passengers: formData.get('num_passengers'),
      price_policy: price_policy,
      booked_until: formData.get('booked_until') || null,
      gallery_images: cleanGalleryImages // Send the cleaned gallery images list
    };
    try {
      const id = editForm.getAttribute('data-id');
      const response = await fetch(`http://localhost:3001/api/cars/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });
      if (response.ok) {
        // Now upload images if any
        if (editHeadImageInput.files[0] || editGalleryImageFiles.length > 0) {
          const imgForm = new FormData();
          if (editHeadImageInput.files[0]) imgForm.append('head_image', editHeadImageInput.files[0]);
          editGalleryImageFiles.forEach(f => imgForm.append('gallery_images', f));
          await fetch(`http://localhost:3001/api/cars/${id}/images`, {
            method: 'POST',
            body: imgForm
          });
        }
        showAlert('Car updated successfully!', 'success');
        editForm.reset();
        resetEditImageInputs();
        closePanel(editPanel, editForm);
        loadCars();
      } else {
        showAlert('Failed to update car.', 'error');
      }
    } catch (err) {
      showAlert('Error saving car.', 'error');
    }
    editUploading = false;
    editFormSubmitBtn.disabled = false;
    editFormSubmitBtn.innerHTML = 'Confirm changes';
  };
  // Reset image inputs on close - removed immediate reset, will be handled by closePanel function
  // When opening edit form, render image previews
  function openEditFormWithImages(car) {
    renderEditImagePreviews(car);
  }

  // Duplicate form submission handler removed - using onsubmit handler above



  // Load and display cars as cards
  async function loadCars() {
    const carCards = document.getElementById('carCards');
    carCards.innerHTML = '<div class="text-center w-100">Loading...</div>';
    try {
      const res = await fetch('http://localhost:3001/api/cars');
      const cars = await res.json();
      if (!cars.length) {
        carCards.innerHTML = '<div class="alert alert-info w-100">No cars found.</div>';
        return;
      }
      carCards.innerHTML = '';
      cars.forEach(car => {
        const card = document.createElement('div');
        card.className = 'col-md-6 col-lg-4';
        card.style.padding = '0';
        
        // Prepare head image HTML
        const headImageHtml = car.head_image 
          ? `<div class="mb-3">
               <img src="http://localhost:3001${car.head_image}" 
                    alt="${car.make_name} ${car.model_name}" 
                    style="width: 100%; height: 180px; object-fit: cover; border-radius: 8px;"
                    onerror="this.style.display='none';">
             </div>`
          : '';
        
        // Prepare status badge text and color
        let badgeText = 'Available';
        let badgeClass = 'bg-success';
        
        if (car.booked && car.booked_until) {
          const bookedUntilDate = new Date(car.booked_until);
          const formattedDate = bookedUntilDate.toLocaleDateString('en-GB', { 
            day: 'numeric', 
            month: 'short' 
          });
          badgeText = `Booked until ${formattedDate}`;
          badgeClass = 'bg-danger';
        } else if (car.booked) {
          badgeText = 'Booked';
          badgeClass = 'bg-danger';
        }
        
                 card.innerHTML = `
           <div class="card p-3 h-100 shadow-sm rounded-4" style="position: relative;">
             <span class="badge ${badgeClass}" style="position: absolute; top: 10px; right: 10px; z-index: 10;">${badgeText}</span>
             
             <!-- Edit button at top left -->
             <div class="d-flex justify-content-start mb-2">
               <button class="btn btn-sm editCarBtn" data-id="${car.id}" title="Edit Car" style="background: none; border: 1px solid gray; padding: 3px 6px; color: gray; box-shadow: none;">
                 <i class="fa fa-pencil" style="font-size: 14px;"></i>
               </button>
             </div>
             
             <!-- Car image -->
             ${headImageHtml}
             
             <!-- Header with car name below image -->
             <div class="mb-3">
               <h4 class="mb-0 text-primary text-center">${car.make_name} ${car.model_name}</h4>
             </div>
             
             <!-- Car details -->
             <div class="mb-3">
               <div class="row g-2 mb-2">
                 <div class="col-6" style="font-size: 0.875rem;"><strong>Year:</strong> ${car.production_year}</div>
                 <div class="col-6" style="font-size: 0.875rem;"><strong>Type:</strong> ${car.car_type}</div>
               </div>
               <div class="row g-2 mb-2">
                 <div class="col-6" style="font-size: 0.875rem;"><strong>Gear:</strong> ${car.gear_type}</div>
                 <div class="col-6" style="font-size: 0.875rem;"><strong>Fuel:</strong> ${car.fuel_type}</div>
               </div>
               <div class="row g-2 mb-2">
                 <div class="col-6" style="font-size: 0.875rem;"><strong>Doors:</strong> ${car.num_doors}</div>
                 <div class="col-6" style="font-size: 0.875rem;"><strong>Passengers:</strong> ${car.num_passengers}</div>
               </div>
               ${car.fuel_type !== 'Electric' ? `
               <div class="row g-2 mb-2">
                 <div class="col-6" style="font-size: 0.875rem;"><strong>Engine capacity:</strong> ${car.engine_capacity}</div>
                 <div class="col-6"></div>
               </div>
               ` : ''}
             </div>
             
             <!-- Price policy -->
             <div class="mt-auto">
               <h6 class="mb-2 text-primary">Pricing (€/day)</h6>
               <div class="row g-1 mb-2">
                 <div class="col-6">
                   <div class="text-center p-2 rounded" style="background-color: #e8e8e8; border-radius: 5px !important;">
                     <div style="font-size: 0.7rem; color: #666;">1-2 days</div>
                     <div style="font-size: 0.9rem; font-weight: bold; color: #031B4E;">${car.price_policy['1-2']}€</div>
                   </div>
                 </div>
                 <div class="col-6">
                   <div class="text-center p-2 rounded" style="background-color: #e8e8e8; border-radius: 5px !important;">
                     <div style="font-size: 0.7rem; color: #666;">3-7 days</div>
                     <div style="font-size: 0.9rem; font-weight: bold; color: #031B4E;">${car.price_policy['3-7']}€</div>
                   </div>
                 </div>
               </div>
               <div class="row g-1 mb-2">
                 <div class="col-4">
                   <div class="text-center p-2 rounded" style="background-color: #e8e8e8; border-radius: 5px !important;">
                     <div style="font-size: 0.7rem; color: #666;">8-20 days</div>
                     <div style="font-size: 0.9rem; font-weight: bold; color: #031B4E;">${car.price_policy['8-20']}€</div>
                   </div>
                 </div>
                 <div class="col-4">
                   <div class="text-center p-2 rounded" style="background-color: #e8e8e8; border-radius: 5px !important;">
                     <div style="font-size: 0.7rem; color: #666;">21-45 days</div>
                     <div style="font-size: 0.9rem; font-weight: bold; color: #031B4E;">${car.price_policy['21-45']}€</div>
                   </div>
                 </div>
                 <div class="col-4">
                   <div class="text-center p-2 rounded" style="background-color: #e8e8e8; border-radius: 5px !important;">
                     <div style="font-size: 0.7rem; color: #666;">46+ days</div>
                     <div style="font-size: 0.9rem; font-weight: bold; color: #031B4E;">${car.price_policy['46+']}€</div>
                   </div>
                 </div>
               </div>
             </div>
           </div>
         `;
        carCards.appendChild(card);
      });
      // Add edit button listeners
      document.querySelectorAll('.editCarBtn').forEach(btn => {
        btn.addEventListener('click', function () {
          const car = cars.find(c => c.id == btn.getAttribute('data-id'));
          if (!car) return;
          // Fill edit form
          editForm.setAttribute('data-id', car.id);
          editForm.elements['make_name'].value = car.make_name;
          editForm.elements['model_name'].value = car.model_name;
          editForm.elements['production_year'].value = car.production_year;
          editForm.elements['gear_type'].value = car.gear_type;
          editForm.elements['fuel_type'].value = car.fuel_type;
          editForm.elements['engine_capacity'].value = car.engine_capacity || '';
          editForm.elements['car_type'].value = car.car_type;
          editForm.elements['num_doors'].value = car.num_doors;
          editForm.elements['num_passengers'].value = car.num_passengers;
          editForm.elements['price_1_2'].value = car.price_policy['1-2'];
          editForm.elements['price_3_7'].value = car.price_policy['3-7'];
          editForm.elements['price_8_20'].value = car.price_policy['8-20'];
          editForm.elements['price_21_45'].value = car.price_policy['21-45'];
          editForm.elements['price_46'].value = car.price_policy['46+'];
          editForm.elements['booked_until'].value = car.booked_until || '';
          openEditFormWithImages(car); // Call the new function
          // Handle fuel type state for engine capacity
          handleFuelTypeChange(editForm, true);
          addPanel.classList.remove('active');
          editPanel.classList.add('active');
          overlay.classList.add('active');
          lockBodyScroll();
        });
      });
    } catch (err) {
      carCards.innerHTML = '<div class="alert alert-danger w-100">Failed to load cars.</div>';
    }
  }

  loadCars();

  // Add a confirmation modal for delete
  const deleteCarBtn = document.getElementById('deleteCarBtn');
  const deleteConfirmModal = document.getElementById('deleteConfirmModal');
  const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
  const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
  let pendingDeleteCarId = null;
  deleteCarBtn.addEventListener('click', function() {
    deleteConfirmModal.classList.add('active');
    pendingDeleteCarId = editForm.getAttribute('data-id');
  });
  confirmDeleteBtn.addEventListener('click', async function() {
    if (!pendingDeleteCarId) return;
    try {
      const response = await fetch(`http://localhost:3001/api/cars/${pendingDeleteCarId}`, { method: 'DELETE' });
      if (response.ok) {
        showAlert('Car deleted successfully!', 'success');
        editForm.reset();
        closePanel(editPanel, editForm);
        loadCars();
      } else {
        showAlert('Failed to delete car.', 'error');
      }
    } catch (err) {
      showAlert('Error deleting car.', 'error');
    }
    deleteConfirmModal.classList.remove('active');
    pendingDeleteCarId = null;
  });
  cancelDeleteBtn.addEventListener('click', function() {
    deleteConfirmModal.classList.remove('active');
    pendingDeleteCarId = null;
  });
});
</script>