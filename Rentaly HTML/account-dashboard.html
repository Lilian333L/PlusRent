<!DOCTYPE html>
<html lang="zxx">

<head>
    <title>Admin Panel - Car Management</title>
    <link rel="icon" href="images/icon.png" type="image/gif" sizes="16x16">
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="PlusRent - Multipurpose Vehicle Car Rental Website Template" name="description">
    <meta content="" name="keywords">
    <meta content="" name="author">
    <!-- CSS Files
    ================================================== -->
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css" id="bootstrap">
    <link href="css/mdb.min.css" rel="stylesheet" type="text/css" id="mdb">
    <link href="css/plugins.css" rel="stylesheet" type="text/css">
    <link href="css/style.css" rel="stylesheet" type="text/css">
    <link href="css/coloring.css" rel="stylesheet" type="text/css">
    <!-- color scheme -->
    <link id="colors" href="css/colors/scheme-01.css" rel="stylesheet" type="text/css">
    <style>
      /* Autocomplete styles */
      .autocomplete-container {
        position: relative;
        display: inline-block;
        width: 100%;
      }
      
      .autocomplete-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      
      .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
      }
      
      .autocomplete-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
      }
      
      .autocomplete-item:hover {
        background-color: #f5f5f5;
      }
      
      .autocomplete-item.selected {
        background-color: #007bff;
        color: white;
      }
      
      .autocomplete-highlight {
        background-color: #ffeb3b;
        font-weight: bold;
        padding: 1px 2px;
      }
      
      .autocomplete-input.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
      }
      
      .autocomplete-input.is-valid {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
      }
      
      /* Override MDB button styles to use gray instead of purple */
      .btn-outline-secondary {
        color: #6c757d !important;
        border-color: #6c757d !important;
      }
      
      .btn-outline-secondary:hover {
        color: #fff !important;
        background-color: #6c757d !important;
        border-color: #6c757d !important;
      }
      
      .btn-outline-secondary:focus {
        box-shadow: 0 0 0 0.25rem rgba(108, 117, 125, 0.5) !important;
      }
      
      .btn-outline-secondary:active,
      .btn-outline-secondary.active {
        color: #fff !important;
        background-color: #6c757d !important;
        border-color: #6c757d !important;
      }
      
      /* Ensure wheel configuration buttons are clickable */
      .wheel-coupon-button {
        cursor: pointer !important;
        pointer-events: auto !important;
        user-select: none;
      }
      
      .wheel-coupon-button:disabled {
        cursor: not-allowed !important;
        opacity: 0.6;
      }
      
  .admin-main-container {
    max-width: 1400px;
    margin: 0 auto;
    padding-left: 32px;
    padding-right: 32px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .admin-header {
    text-align: center;
    margin-top: 2rem;
    margin-bottom: 1.2rem;
  }
  .admin-flex-row {
    display: flex;
    align-items: flex-start;
    gap: 32px;
    justify-content: flex-start;
    width: 100%;
  }
  .admin-btn-col {
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    min-width: 180px;
    margin-top: 0.5rem;
    margin-right: 0;
  }
  .admin-form-col {
    flex: 1 1 0;
    position: relative;
    min-width: 340px;
    max-width: 1100px;
  }
  .admin-form-panel {
    display: none;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%) scale(0.98);
    width: 90%;
    max-width: 1200px;
    min-width: 320px;
    max-height: 90vh;
    overflow-y: auto;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.18);
    padding: 1.4rem 1.8rem 1.4rem 1.8rem;
    transition: transform 0.4s cubic-bezier(.4,0,.2,1), opacity 0.4s cubic-bezier(.4,0,.2,1);
    opacity: 0;
    z-index: 10000;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch;
  }
  .admin-form-panel.active {
    display: block;
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
  /* Prevent body scroll when popup is open */
  html.admin-popup-open, body.admin-popup-open {
    overflow: hidden !important;
    height: 100%;
    touch-action: none;
    overscroll-behavior: contain;
  }
  .admin-form-panel .btn-fullwidth {
    width: auto;
    /* min-width: 160px; */
    display: block;
    margin: 0 auto;
  }
  /* .admin-form-panel .btn {
    display: block;
    margin: 0 auto;
    min-width: 160px;
    width: auto;
  } */
  .admin-form-panel .btn-fullwidth {
    width: auto;
    min-width: 160px;
    display: block;
    margin: 0 auto;
  }
  .admin-form-panel .btn-main {
    font-size: 1.1rem;
    padding: 0.7rem 2.2rem;
    height: 44px;
    border-radius: 6px;
  }
  .admin-form-panel .close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #888;
    cursor: pointer;
  }
  .admin-form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
  }
  
  /* Enhanced styling for wheel items */
  .wheel-item:hover {
    background-color: #f8f9fa;
    transform: translateX(2px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .wheel-item.active {
    background-color: #e3f2fd;
    border-left-color: #2196f3 !important;
  }
  
  /* Card enhancements */
  .card.shadow-sm {
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
  }
  
  .card-header {
    border-bottom: 1px solid rgba(0,0,0,0.125);
  }
  
  /* Button enhancements */
  .btn {
    border-radius: 6px;
    font-weight: 500;
  }
  
  .btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
  }
  
  /* List group enhancements */
  .list-group-item {
    border: 1px solid rgba(0,0,0,0.125);
    border-left: 4px solid transparent;
    transition: all 0.2s ease;
  }
  
  .list-group-item:first-child {
    border-top-left-radius: 0.375rem;
    border-top-right-radius: 0.375rem;
  }
  
  .list-group-item:last-child {
    border-bottom-left-radius: 0.375rem;
    border-bottom-right-radius: 0.375rem;
  }
  
  /* Form enhancements */
  .form-control {
    border-radius: 6px;
    border: 1px solid #ced4da;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  }
  
  .form-control:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }
  
  /* Badge enhancements */
  .badge {
    font-size: 0.75em;
    font-weight: 500;
  }
  
  /* Icon spacing */
  .fa {
    margin-right: 0.25rem;
  }
  .admin-form-grid .five-column-grid {
    grid-column: 1 / -1;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
  }
  .admin-form-grid > div {
    min-width: 0;
  }
  .admin-form-panel input,
  .admin-form-panel select {
    background: #fff !important;
    height: 36px !important;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    font-size: 0.75rem;
    width: 100%;
    padding: 0 8px;
    box-sizing: border-box;
  }
  .admin-form-panel input[type="number"] {
    height: 36px !important;
  }
  .admin-form-panel .form-label {
    font-size: 0.75rem;
    font-weight: 500;
    margin-bottom: 0 !important;
    color: #333;
  }
  .admin-form-panel .form-text,
  .admin-form-panel small.form-text {
    font-size: 0.75rem !important;
    color: #666 !important;
    line-height: 1.2 !important;
    margin-top: 2px !important;
    margin-bottom: 0 !important;
    display: block !important;
  }
  .admin-form-panel .form-control {
    height: 36px !important;
    font-size: 0.75rem;
    padding: 0 8px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
  }
  .admin-form-panel input[type="date"] {
    height: 36px !important;
    font-size: 0.75rem;
    padding: 0 8px;
  }
  .admin-form-panel input:focus,
  .admin-form-panel select:focus {
    outline: 2px solid #b3c6ff;
    border-color: #b3c6ff;
  }
  .admin-form-panel fieldset {
    grid-column: 1 / -1;
  }
  .admin-form-panel .row.g-2 > div {
    min-width: 0;
  }
  .admin-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(30, 30, 30, 0.65);
    z-index: 9999;
    transition: opacity 0.3s;
  }
  .admin-overlay.active {
    display: block;
  }
  .admin-confirm-modal {
    display: none;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.18);
    padding: 1.2rem 1.5rem;
    z-index: 10001;
    min-width: 320px;
    max-width: 400px;
    text-align: center;
  }
  .admin-confirm-modal.active {
    display: block;
  }
  .admin-confirm-modal button {
    margin: 0 10px;
    min-width: 110px;
    height: 44px;
    font-size: 1rem;
    border-radius: 6px;
    font-family: inherit;
    font-weight: 500;
  }
  .admin-confirm-modal .btn-main, .admin-confirm-modal .btn-danger {
    background: #031B4E;
    color: #fff;
    border: none;
    transition: background 0.2s;
  }
  .admin-confirm-modal .btn-danger {
    background: #e74c3c;
  }
  .admin-btn-col {
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    min-width: 180px;
    margin-top: 0.5rem;
    margin-right: 0;
  }
  .admin-flex-row {
    display: flex;
    align-items: flex-start;
    gap: 32px;
    justify-content: flex-start;
    width: 100%;
  }
  .admin-flex-row + #carCards, .admin-flex-row + .row#carCards, .admin-flex-row + .row.g-4 {
    margin-top: 1.2rem !important;
  }
  #carCards {
    margin-top: 1.2rem !important;
  }
  /* Fix for car cards being too small after form grid change */
  #carCards.row.g-4 {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-start !important;
    align-items: stretch;
    width: 100%;
  }
  #carCards.row.g-4 > .col-md-6.col-lg-4 {
    min-width: 320px;
    flex: 1 1 320px;
    max-width: 320px;
    display: flex;
  }
  #carCards .card {
    min-width: 300px;
    width: 100%;
    margin: 0;
  }
  @media (max-width: 900px) {
    .admin-form-panel {
      width: 95vw;
      padding: 1.2rem 1rem;
      max-height: 95vh;
    }
    .admin-form-grid {
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }
    .admin-form-grid .five-column-grid {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }
  }
  @media (max-width: 600px) {
    .admin-form-panel {
      width: 98vw;
      padding: 1rem 0.8rem;
      max-height: 98vh;
    }
    .admin-form-grid {
      grid-template-columns: 1fr;
    }
    .admin-form-grid .five-column-grid {
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    }
  }
  @media (max-width: 480px) {
    .admin-form-panel {
      width: 100vw;
      padding: 0.8rem 0.6rem;
      max-height: 100vh;
      border-radius: 0;
    }
    .admin-form-grid {
      grid-template-columns: 1fr;
    }
    .admin-form-grid .five-column-grid {
      grid-template-columns: 1fr;
    }
    /* Stack image upload sections vertically on mobile */
    .admin-form-grid > div[style*="display: flex"] {
      flex-direction: column !important;
    }
    .admin-form-grid > div[style*="display: flex"] > div {
      width: 100% !important;
      margin-bottom: 16px;
    }
  }
  
  /* Override MDB button text-transform to use normal case */
  .btn {
    text-transform: none !important;
  }
  
  /* Prevent body scroll when modal is open */
  body.modal-open {
    overflow: hidden !important;
    position: fixed !important;
    width: 100% !important;
    left: 0 !important;
    right: 0 !important;
  }
  
  html.modal-open {
    overflow: hidden !important;
  }
  
  /* Prevent scrolling on modal overlay */
  .admin-overlay {
    overflow: hidden !important;
  }
  
  /* Gallery Carousel Styles */
  .admin-gallery-carousel {
    position: relative;
    max-width: 100%;
    margin-top: 8px;
  }

  .wheel-config-row {
    justify-content: space-between;
  }
  
  .admin-carousel-container {
    position: relative;
    overflow: visible; /* Allow buttons to overflow outside */
    border-radius: 8px;
    background: #f8f9fa;
  }
  
  .admin-carousel-track-wrapper {
    overflow: hidden;
    border-radius: 8px;
  }
  
  .admin-carousel-track {
    display: flex;
    transition: transform 0.3s ease;
    gap: 10px;
    padding: 10px 3px 10px 10px; /* Balanced right padding - middle ground */
  }
  
  .admin-carousel-image-item {
    position: relative;
    flex: 0 0 auto;
    padding: 0;
  }
  
  .admin-carousel-image-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: block;
  }
  
  .admin-carousel-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
    z-index: 10;
  }
  
  .admin-carousel-nav:hover {
    background: rgba(0,0,0,1);
  }
  
  .admin-carousel-nav:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }
  
  .admin-carousel-prev {
    left: -16px; /* Half of button width (32px / 2 = 16px) outside */
  }
  
  .admin-carousel-next {
    right: -16px; /* Half of button width (32px / 2 = 16px) outside */
  }
  
  .admin-carousel-counter {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
  }
  
  .admin-carousel-remove {
    position: absolute;
    top: -6px;
    right: -6px;
    background: rgb(248 67 61 / 90%);
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    font-size: 15px;
    padding-bottom: 3px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    transition: all 0.2s;
    backdrop-filter: blur(2px);
  }
  
  .admin-carousel-remove:hover {
    transform: scale(1.1);
  }
  
  /* Upload Button Styles */
  .admin-upload-area {
  position: relative;
    margin-bottom: 8px;
  }
  
  .admin-upload-button {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 60px;
    border: 2px dashed #ccc;
  border-radius: 6px;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 8px;
  }
  
  .admin-upload-button:hover {
    border-color: #007bff;
    background: #f0f8ff;
  }
  
  .admin-upload-icon {
    width: 20px;
    height: 20px;
    margin-bottom: 4px;
    color: #666;
  }
  
  .admin-upload-text {
    font-size: 0.7rem;
    font-weight: 500;
    color: #333;
    text-align: center;
    margin: 0;
  }
  
  .admin-upload-subtext {
    font-size: 0.65rem;
    color: #666;
    text-align: center;
    margin: 2px 0 0 0;
  }
  
  .admin-upload-input {
    display: none;
  }
  
  .admin-image-preview {
    margin-top: 8px;
  }
  
  /* Tab Styles */
  .admin-tabs {
  display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }
  
  .admin-tab-btn {
    padding: 12px 24px;
    border: 2px solid #e0e0e0;
    background: white;
    color: #666;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  
  .admin-tab-btn.active {
    border-color: #007bff;
    background: #007bff;
    color: white;
  }
  
  .admin-tab-btn:hover:not(.active) {
    border-color: #007bff;
    color: #007bff;
  }
  
  .admin-tab-content {
    display: none;
    width: 80%;
  }

  @media (max-width: 1100px) {
    .admin-tab-content {
      width: 95%;
    }
  }
  
  .admin-tab-content.active {
    display: block;
  }

  .spinning-wheel-tab {
    width: 90%;
  }
  
  /* Coupon Card Styles */
  .coupon-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: 1px solid #e0e0e0;
  }
  
  /* Booking Card Animation Styles */
  .booking-card {
    transition: all 0.3s ease;
    transform: translateX(0);
    opacity: 1;
  }
  
  .booking-card.approving {
    background: #d4edda;
    border-color: #c3e6cb;
    transform: scale(1.02);
  }
  
  .booking-card.rejecting {
    background: #f8d7da;
    border-color: #f5c6cb;
    transform: scale(1.02);
  }
  
  .booking-card.slide-out {
    transform: translateX(100%);
    opacity: 0;
  }
  
  .booking-card.fade-out {
    opacity: 0;
    transform: scale(0.95);
  }
  
  /* Button Animation Styles */
  .btn-approve, .btn-reject {
    transition: all 0.2s ease;
  }
  
  .btn-approve:active {
    transform: scale(0.95);
    background: #28a745 !important;
  }
  
  .btn-reject:active {
    transform: scale(0.95);
    background: #dc3545 !important;
  }
  
  /* Loading Animation */
  .btn-loading {
    position: relative;
    pointer-events: none;
  }
  
  .btn-loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 16px;
    height: 16px;
    margin: -8px 0 0 -8px;
    border: 2px solid transparent;
    border-top: 2px solid #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .coupon-status {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
  font-weight: 500;
  }
  
  .coupon-status.active {
    background: #d4edda;
    color: #155724;
  }
  
  .coupon-status.inactive {
    background: #f8d7da;
    color: #721c24;
  }
  
  .coupon-status.expired {
    background: #fff3cd;
    color: #856404;
  }
  
  /* Percentage Field Styles */
  .percentage-field {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
    margin-top: 12px;
  }
  
  .percentage-field .form-control-sm {
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
  }
  
  .percentage-field label {
    font-weight: 500;
    color: #495057;
  }
  
  .coupon-item.enabled {
    border-left: 4px solid #28a745;
    background: #f8fff9;
  }
  
  .coupon-item.disabled {
    border-left: 4px solid #6c757d;
    opacity: 0.8;
  }
  
  /* Language switcher styles */
  .btn[data-lang].active {
    background-color: #007bff !important;
    color: white !important;
    border-color: #007bff !important;
    font-weight: 600;
  }
  
  .btn[data-lang]:not(.active) {
    background-color: white !important;
    color: #007bff !important;
    border-color: #007bff !important;
  }
  
  .btn[data-lang]:not(.active):hover {
    background-color: #f8f9fa !important;
  }
</style>

<!-- Custom green for success alert and Booked checkbox styles -->
<style>
:root {
  --admin-success-green: #28a745;
}
#adminCustomAlert.success {
  background: var(--admin-success-green) !important;
  color: #fff !important;
}
#adminCustomAlert.error {
  background: #e74c3c !important;
  color: #fff !important;
}
/* Remove all custom Booked checkbox and label styles */
.admin-booked-checkbox, .admin-booked-label { }
</style>
</head>

<body>
    <div id="wrapper">
        
        <!-- page preloader begin -->
        <div id="de-preloader"></div>
        <!-- page preloader close -->

        <!-- header begin -->
        <header class="transparent scroll-light has-topbar">
            <div id="topbar" class="topbar-dark text-light">
                <div class="container">
                    <div class="topbar-left xs-hide">
                        <div class="topbar-widget">
                            <div class="topbar-widget"><a href="#"><i class="fa fa-phone"></i>+208 333 9296</a></div>
                            <div class="topbar-widget"><a href="#"><i class="fa fa-envelope"></i>contact@plusrent.com</a></div>
                            <div class="topbar-widget"><a href="#"><i class="fa fa-clock-o"></i>Mon - Fri 08.00 - 18.00</a></div>
                        </div>
                    </div>
                
                    <div class="topbar-right">
                        <div class="social-icons">
                            <a href="#"><i class="fa fa-facebook fa-lg"></i></a>
                            <a href="#"><i class="fa fa-twitter fa-lg"></i></a>
                            <a href="#"><i class="fa fa-youtube fa-lg"></i></a>
                            <a href="#"><i class="fa fa-pinterest fa-lg"></i></a>
                            <a href="#"><i class="fa fa-instagram fa-lg"></i></a>
                        </div>
                    </div>  
                    <div class="clearfix"></div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-md-12">
                        <div class="de-flex sm-pt10">
                            <div class="de-flex-col">
                                <div class="de-flex-col">
                                    <!-- logo begin -->
                                    <div id="logo">
                                        <a href="index.html">
                                                            <img class="logo-1" src="images/LOGO-4-demo.png" alt="">
                <img class="logo-2" src="images/LOGO-5-demo.png" alt="">
                                        </a>
                                    </div>
                                    <!-- logo close -->
                                </div>
                            </div>
                            <div class="de-flex-col header-col-mid">
                                <ul id="mainmenu">
                                    <li><a class="menu-item" href="index.html">Home</a></li>
                                    <li><a class="menu-item" href="cars.html">Cars</a></li>
                                    <li><a class="menu-item" href="quick-booking.html">Booking</a></li>
                                    <li><a class="menu-item" href="account-dashboard.html">Admin Panel</a></li>
                                </ul>
                            </div>
                            <div class="de-flex-col">
                                <div class="menu_side_area">
                                        <span id="menu-btn"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
            <!-- header close -->
        <!-- content begin -->
        <div class="no-bottom no-top zebra" id="content">
            <div id="top"></div>
            
            <!-- section begin -->
            <section id="subheader" class="jarallax text-light">
                <img src="images/background/14.jpg" class="jarallax-img" alt="">
                    <div class="center-y relative text-center">
                        <div class="container">
                            <div class="row">
                                <div class="col-md-12 text-center">
									<h1>Admin Panel</h1>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                        </div>
                    </div>
            </section>
            <!-- section close -->

            <section id="admin-add-car" class="bg-gray-100">
              <div class="admin-main-container">
                <h3 class="admin-header mb-4" style="font-family: var(--title-font); font-weight: 600; color: #031B4E;">Admin Panel</h3>
                
                <!-- Tab Navigation -->
                <div class="admin-tabs mb-4">
                  <button class="admin-tab-btn active" data-tab="cars">Manage Cars</button>
                  <button class="admin-tab-btn" data-tab="coupons">Manage Coupon Codes</button>
                  <button class="admin-tab-btn" data-tab="bookings">Manage Bookings</button>
                  <button class="admin-tab-btn" data-tab="spinning-wheel">Manage Spinning Wheel</button>
                </div>
                
                <!-- Language Switcher for Cars -->

                
                <!-- Cars Tab Content -->
                <div id="cars-tab" class="admin-tab-content active">
                <div class="admin-flex-row">
                  <div class="admin-btn-col">
                    <button id="showAddCarBtn" type="button" class="btn btn-main btn-lg">Add a Car</button>
                  </div>
                  <div class="admin-form-col">
                    <!-- Overlay -->
                    <div id="adminOverlay" class="admin-overlay"></div>
                    <!-- Add Car Form Panel (popup) -->
                    <div id="addCarPanel" class="admin-form-panel">
                      <button class="close-btn" id="closeAddCarPanel">&times;</button>
                      <form id="carForm" class="form-border" autocomplete="off">
                                                <h3 id="formTitle" class="mb-3" style="font-family: var(--title-font); font-weight: 600; color: #031B4E; font-size: 1.4rem;">Add Car</h3>
                          <div class="admin-form-grid">
                            <div style="grid-column: 1 / -1; display: flex; align-items: flex-start; margin-bottom: 6px; gap: 16px;">
                            <div style="flex: 1;">
                              <label class="form-label">Head Image</label>
                              <div class="admin-upload-area">
                                <div class="admin-upload-button" id="addHeadImageButton">
                                  <svg class="admin-upload-icon" viewBox="0 0 24 24" style="display: block;">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17,8 12,3 7,8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                  </svg>
                                  <div class="admin-upload-text">Upload Head Image</div>
                                </div>
                                <input type="file" id="addHeadImageInput" name="head_image" accept="image/*" class="admin-upload-input">
                              </div>
                              <div id="addHeadImagePreview" class="admin-image-preview"></div>
                            </div>
                            <div style="flex: 1;">
                              <label class="form-label">Gallery Images</label>
                              <div class="admin-upload-area">
                                <div class="admin-upload-button" id="addGalleryImagesButton">
                                  <svg class="admin-upload-icon" viewBox="0 0 24 24" style="display: block;">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17,8 12,3 7,8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                  </svg>
                                  <div class="admin-upload-text">Upload Gallery Images</div>
                                </div>
                                <input type="file" id="addGalleryImagesInput" name="gallery_images" accept="image/*" multiple class="admin-upload-input">
                              </div>
                              <div id="addGalleryImagesPreview"></div>
                            </div>
                          </div>
                          <div>
                            <label class="form-label">Make Name</label>
                                <select name="make_name" class="form-control" required>
                                <option value="">Select Make</option>
                                <option value="Abarth">Abarth</option>
                                <option value="Acura">Acura</option>
                                <option value="Alfa-Romeo">Alfa Romeo</option>
                                <option value="ARO">ARO</option>
                                <option value="Aito">Aito</option>
                                <option value="Aiways">Aiways</option>
                                <option value="ArcFox">ArcFox</option>
                                <option value="Aston Martin">Aston Martin</option>
                                <option value="Audi">Audi</option>
                                <option value="Avatr">Avatr</option>
                                <option value="BAIC">BAIC</option>
                                <option value="BAW">BAW</option>
                                <option value="Bentley">Bentley</option>
                                <option value="BMW">BMW</option>
                                <option value="Brilliance">Brilliance</option>
                                <option value="Buick">Buick</option>
                                <option value="Byd">Byd</option>
                                <option value="Cadillac">Cadillac</option>
                                <option value="Changan">Changan</option>
                                <option value="Chery">Chery</option>
                                <option value="Chevrolet">Chevrolet</option>
                                <option value="Chrysler">Chrysler</option>
                                <option value="Citroen">Citroen</option>
                                <option value="Cupra">Cupra</option>
                                <option value="Dacia">Dacia</option>
                                <option value="Daewoo">Daewoo</option>
                                <option value="Daihatsu">Daihatsu</option>
                                <option value="Datsun">Datsun</option>
                                <option value="Denza">Denza</option>
                                <option value="Dodge">Dodge</option>
                                <option value="Dongfeng">Dongfeng</option>
                                <option value="DS Automobiles">DS Automobiles</option>
                                <option value="Exeed">Exeed</option>
                                <option value="FAW">FAW</option>
                                <option value="Ferrari">Ferrari</option>
                                <option value="Fiat">Fiat</option>
                                <option value="Ford">Ford</option>
                                <option value="GAC">GAC</option>
                                <option value="Genesis">Genesis</option>
                                <option value="Geely">Geely</option>
                                <option value="GMC">GMC</option>
                                <option value="Great Wall">Great Wall</option>
                                <option value="Hafei">Hafei</option>
                                <option value="Haima">Haima</option>
                                <option value="Haval">Haval</option>
                                <option value="HiPhi">HiPhi</option>
                                <option value="Honda">Honda</option>
                                <option value="Hongqi">Hongqi</option>
                                <option value="Hozon">Hozon</option>
                                <option value="Hummer">Hummer</option>
                                <option value="Hyundai">Hyundai</option>
                                <option value="IM Motors">IM Motors</option>
                                <option value="Infiniti">Infiniti</option>
                                <option value="Iran Khodro">Iran Khodro</option>
                                <option value="Isuzu">Isuzu</option>
                                <option value="Iveco">Iveco</option>
                                <option value="Jac">Jac</option>
                                <option value="Jaguar">Jaguar</option>
                                <option value="Jeep">Jeep</option>
                                <option value="Jetour">Jetour</option>
                                <option value="Jetta">Jetta</option>
                                <option value="JMC">JMC</option>
                                <option value="KIA">KIA</option>
                                <option value="Lada">Lada</option>
                                <option value="Lada / ВАЗ">Lada / ВАЗ</option>
                                <option value="Lamborghini">Lamborghini</option>
                                <option value="Lancia">Lancia</option>
                                <option value="Land Rover">Land Rover</option>
                                <option value="Leapmotor">Leapmotor</option>
                                <option value="Lexus">Lexus</option>
                                <option value="LEVC">LEVC</option>
                                <option value="LiXiang">LiXiang</option>
                                <option value="Lifan">Lifan</option>
                                <option value="Lincoln">Lincoln</option>
                                <option value="Linktour">Linktour</option>
                                <option value="Lotus">Lotus</option>
                                <option value="Lucid">Lucid</option>
                                <option value="Luxeed">Luxeed</option>
                                <option value="Lynk & Co">Lynk & Co</option>
                                <option value="Maserati">Maserati</option>
                                <option value="Mazda">Mazda</option>
                                <option value="McLaren">McLaren</option>
                                <option value="Mercedes">Mercedes</option>
                                <option value="Mercedes-Maybach">Mercedes-Maybach</option>
                                <option value="Mercury">Mercury</option>
                                <option value="MG">MG</option>
                                <option value="Mini">Mini</option>
                                <option value="Mitsubishi">Mitsubishi</option>
                                <option value="NIO">NIO</option>
                                <option value="Nissan">Nissan</option>
                                <option value="Opel">Opel</option>
                                <option value="Oshan">Oshan</option>
                                <option value="Peugeot">Peugeot</option>
                                <option value="Piaggio">Piaggio</option>
                                <option value="Polestar">Polestar</option>
                                <option value="Pontiac">Pontiac</option>
                                <option value="Porsche">Porsche</option>
                                <option value="Ravon">Ravon</option>
                                <option value="Renault">Renault</option>
                                <option value="Renault Samsung">Renault Samsung</option>
                                <option value="Riddara">Riddara</option>
                                <option value="Rivian">Rivian</option>
                                <option value="Roewe">Roewe</option>
                                <option value="Rolls-Royce">Rolls-Royce</option>
                                <option value="Rover">Rover</option>
                                <option value="Saab">Saab</option>
                                <option value="Saturn">Saturn</option>
                                <option value="Scion">Scion</option>
                                <option value="Seat">Seat</option>
                                <option value="Skoda">Skoda</option>
                                <option value="Skywell">Skywell</option>
                                <option value="Smart">Smart</option>
                                <option value="Ssangyong">Ssangyong</option>
                                <option value="Subaru">Subaru</option>
                                <option value="Suzuki">Suzuki</option>
                                <option value="Tank">Tank</option>
                                <option value="Tata">Tata</option>
                                <option value="Tesla">Tesla</option>
                                <option value="Toyota">Toyota</option>
                                <option value="Venucia">Venucia</option>
                                <option value="Volkswagen">Volkswagen</option>
                                <option value="Volvo">Volvo</option>
                                <option value="Voyah">Voyah</option>
                                <option value="Weltmeister">Weltmeister</option>
                                <option value="Wuling">Wuling</option>
                                <option value="Xiaomi">Xiaomi</option>
                                <option value="Xpeng">Xpeng</option>
                                <option value="Zeekr">Zeekr</option>
                                <option value="Zotye">Zotye</option>
                              </select>
                          </div>
                          <div>
                            <label class="form-label">Model Name</label>
                            <input type="text" name="model_name" class="form-control" placeholder="Enter model name" required>
                          </div>
                          <div>
                            <label class="form-label">Production Year</label>
                            <select name="production_year" class="form-control" required></select>
                          </div>
                          <div>
                            <label class="form-label">Gear Type</label>
                            <select name="gear_type" class="form-control" required>
                              <option value="Automatic">Automatic</option>
                              <option value="Manual">Manual</option>
                            </select>
                          </div>
                          <div class="five-column-grid">
                            <div>
                              <label class="form-label">Fuel Type</label>
                              <select name="fuel_type" class="form-control" required>
                                <option value="Gasoline">Gasoline</option>
                                <option value="Diesel">Diesel</option>
                                <option value="Hybrid">Hybrid</option>
                                <option value="Electric">Electric</option>
                              </select>
                            </div>
                            <div>
                              <label class="form-label">Engine Capacity</label>
                              <input type="number" name="engine_capacity" class="form-control" step="0.1" min="0">
                            </div>
                            <div>
                              <label class="form-label">Car Type</label>
                              <select name="car_type" class="form-control" required>
                                <option value="Crossover">Crossover</option>
                                <option value="Sedan">Sedan</option>
                                <option value="Coupe">Coupe</option>
                                  <option value="Minivan">Minivan</option>
                                  <option value="Hatchback">Hatchback</option>
                              </select>
                            </div>
                            <div>
                              <label class="form-label">Number of Doors</label>
                              <select name="num_doors" class="form-control" required></select>
                            </div>
                            <div>
                              <label class="form-label">Number of Passengers</label>
                              <select name="num_passengers" class="form-control" required></select>
                            </div>
                          </div>
                        </div>
                        <fieldset class="mb-3 p-2 rounded-3" style="border: 1px solid #eee;">
                          <legend class="form-label mb-2" style="font-size: 1rem; color: #031B4E;">Price Policy</legend>
                          <div class="row g-2">
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">1-2 days</label>
                              <input type="text" name="price_1_2" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">3-7 days</label>
                              <input type="text" name="price_3_7" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">8-20 days</label>
                              <input type="text" name="price_8_20" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">21-45 days</label>
                              <input type="text" name="price_21_45" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">46+ days</label>
                              <input type="text" name="price_46" class="form-control" required>
                            </div>
                          </div>
                        </fieldset>
                        <div class="mb-3" style="max-width: 300px;">
                          <label class="form-label">Booked Until (optional)</label>
                          <input type="date" name="booked_until" class="form-control" placeholder="Select date until when car is booked">
                          <small class="form-text text-muted">Leave empty if car is available. Car will be automatically available after this date.</small>
                        </div>
                          <fieldset class="mb-3 p-2 rounded-3" style="border: 1px solid #eee;">
                            <legend class="form-label mb-2" style="font-size: 1rem; color: #031B4E;">Additional Specifications (Optional)</legend>
                            <div class="admin-form-grid">
                              <div>
                                <label class="form-label">Luggage Capacity</label>
                                <input type="text" name="luggage" class="form-control" placeholder="e.g., 2 large suitcases">
                              </div>
                              <div>
                                <label class="form-label">Mileage (km)</label>
                                <input type="number" name="mileage" class="form-control" placeholder="e.g., 50000" min="0">
                              </div>
                              <div>
                                <label class="form-label">Drive Type</label>
                                <select name="drive" class="form-control">
                                  <option value="">Select drive type</option>
                                  <option value="Front Wheel Drive">Front Wheel Drive</option>
                                  <option value="Rear Wheel Drive">Rear Wheel Drive</option>
                                  <option value="All Wheel Drive">All Wheel Drive</option>
                                  <option value="4 Wheel Drive">4 Wheel Drive</option>
                                </select>
                              </div>
                              <div>
                                <label class="form-label" id="fuel-economy-label">Fuel Economy (L/100km)</label>
                                <input type="number" name="fuel_economy" class="form-control" placeholder="e.g., 7.5" step="0.1" min="0">
                              </div>
                              <div>
                                <label class="form-label">Exterior Color</label>
                                <input type="text" name="exterior_color" class="form-control" placeholder="e.g., Pearl White">
                              </div>
                              <div>
                                <label class="form-label">Interior Color</label>
                                <input type="text" name="interior_color" class="form-control" placeholder="e.g., Black Leather">
                              </div>
                            </div>
                          </fieldset>
                          <fieldset class="mb-3 p-2 rounded-3" style="border: 1px solid #eee;">
                            <legend class="form-label mb-2" style="font-size: 1rem; color: #031B4E;">Insurance Pricing (Required)</legend>
                            <div class="admin-form-grid">
                              <div>
                                <label class="form-label">RCA Insurance Price (€/day)</label>
                                <input type="number" name="rca_insurance_price" class="form-control" placeholder="e.g., 15" step="0.01" min="0" required>
                              </div>
                              <div>
                                <label class="form-label">Casco Insurance Price (€/day)</label>
                                <input type="number" name="casco_insurance_price" class="form-control" placeholder="e.g., 25" step="0.01" min="0" required>
                              </div>
                            </div>
                          </fieldset>
                        <button type="submit" id="formSubmitBtn" class="btn btn-main">Add Car</button>
                      </form>
                    </div>
                    <!-- Edit Car Form Panel (popup) -->
                    <div id="editCarPanel" class="admin-form-panel">
                      <button class="close-btn" id="closeEditCarPanel">&times;</button>
                      <button id="deleteCarBtn" type="button" style="position:absolute;top:16px;right:48px;background:none;border:1.5px solid #e74c3c;color:#e74c3c;padding:6px 14px;border-radius:6px;font-size:1rem;display:flex;align-items:center;gap:6px;cursor:pointer;z-index:2;">
                        <i class="fa fa-trash"></i> Delete Car
                      </button>
                      <form id="editCarForm" class="form-border" autocomplete="off">
                                                <h3 id="editFormTitle" class="mb-3" style="font-family: var(--title-font); font-weight: 600; color: #031B4E; font-size: 1.4rem;">Edit Car</h3>
                          <div class="admin-form-grid">
                            <div style="grid-column: 1 / -1; display: flex; align-items: flex-start; margin-bottom: 6px; gap: 16px;">
                            <div style="flex: 1;">
                              <label class="form-label">Head Image</label>
                              <div class="admin-upload-area">
                                <div class="admin-upload-button" id="editHeadImageButton">
                                  <svg class="admin-upload-icon" viewBox="0 0 24 24" style="display: block;">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17,8 12,3 7,8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                  </svg>
                                  <div class="admin-upload-text">Upload Head Image</div>
                                </div>
                                <input type="file" id="editHeadImageInput" name="head_image" accept="image/*" class="admin-upload-input">
                              </div>
                              <div id="editHeadImagePreview" class="admin-image-preview"></div>
                            </div>
                            <div style="flex: 1;">
                              <label class="form-label">Gallery Images</label>
                              <div class="admin-upload-area">
                                <div class="admin-upload-button" id="editGalleryImagesButton">
                                  <svg class="admin-upload-icon" viewBox="0 0 24 24" style="display: block;">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17,8 12,3 7,8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                  </svg>
                                  <div class="admin-upload-text">Upload Gallery Images</div>
                                </div>
                                <input type="file" id="editGalleryImagesInput" name="gallery_images" accept="image/*" multiple class="admin-upload-input">
                              </div>
                              <div id="editGalleryImagesPreview"></div>
                            </div>
                          </div>
                          <div>
                            <label class="form-label">Make Name</label>
                                <select name="make_name" class="form-control" required>
                                <option value="">Select Make</option>
                                <option value="Abarth">Abarth</option>
                                <option value="Acura">Acura</option>
                                <option value="Alfa-Romeo">Alfa Romeo</option>
                                <option value="ARO">ARO</option>
                                <option value="Aito">Aito</option>
                                <option value="Aiways">Aiways</option>
                                <option value="ArcFox">ArcFox</option>
                                <option value="Aston Martin">Aston Martin</option>
                                <option value="Audi">Audi</option>
                                <option value="Avatr">Avatr</option>
                                <option value="BAIC">BAIC</option>
                                <option value="BAW">BAW</option>
                                <option value="Bentley">Bentley</option>
                                <option value="BMW">BMW</option>
                                <option value="Brilliance">Brilliance</option>
                                <option value="Buick">Buick</option>
                                <option value="Byd">Byd</option>
                                <option value="Cadillac">Cadillac</option>
                                <option value="Changan">Changan</option>
                                <option value="Chery">Chery</option>
                                <option value="Chevrolet">Chevrolet</option>
                                <option value="Chrysler">Chrysler</option>
                                <option value="Citroen">Citroen</option>
                                <option value="Cupra">Cupra</option>
                                <option value="Dacia">Dacia</option>
                                <option value="Daewoo">Daewoo</option>
                                <option value="Daihatsu">Daihatsu</option>
                                <option value="Datsun">Datsun</option>
                                <option value="Denza">Denza</option>
                                <option value="Dodge">Dodge</option>
                                <option value="Dongfeng">Dongfeng</option>
                                <option value="DS Automobiles">DS Automobiles</option>
                                <option value="Exeed">Exeed</option>
                                <option value="FAW">FAW</option>
                                <option value="Ferrari">Ferrari</option>
                                <option value="Fiat">Fiat</option>
                                <option value="Ford">Ford</option>
                                <option value="GAC">GAC</option>
                                <option value="Genesis">Genesis</option>
                                <option value="Geely">Geely</option>
                                <option value="GMC">GMC</option>
                                <option value="Great Wall">Great Wall</option>
                                <option value="Hafei">Hafei</option>
                                <option value="Haima">Haima</option>
                                <option value="Haval">Haval</option>
                                <option value="HiPhi">HiPhi</option>
                                <option value="Honda">Honda</option>
                                <option value="Hongqi">Hongqi</option>
                                <option value="Hozon">Hozon</option>
                                <option value="Hummer">Hummer</option>
                                <option value="Hyundai">Hyundai</option>
                                <option value="IM Motors">IM Motors</option>
                                <option value="Infiniti">Infiniti</option>
                                <option value="Iran Khodro">Iran Khodro</option>
                                <option value="Isuzu">Isuzu</option>
                                <option value="Iveco">Iveco</option>
                                <option value="Jac">Jac</option>
                                <option value="Jaguar">Jaguar</option>
                                <option value="Jeep">Jeep</option>
                                <option value="Jetour">Jetour</option>
                                <option value="Jetta">Jetta</option>
                                <option value="JMC">JMC</option>
                                <option value="KIA">KIA</option>
                                <option value="Lada">Lada</option>
                                <option value="Lada / ВАЗ">Lada / ВАЗ</option>
                                <option value="Lamborghini">Lamborghini</option>
                                <option value="Lancia">Lancia</option>
                                <option value="Land Rover">Land Rover</option>
                                <option value="Leapmotor">Leapmotor</option>
                                <option value="Lexus">Lexus</option>
                                <option value="LEVC">LEVC</option>
                                <option value="LiXiang">LiXiang</option>
                                <option value="Lifan">Lifan</option>
                                <option value="Lincoln">Lincoln</option>
                                <option value="Linktour">Linktour</option>
                                <option value="Lotus">Lotus</option>
                                <option value="Lucid">Lucid</option>
                                <option value="Luxeed">Luxeed</option>
                                <option value="Lynk & Co">Lynk & Co</option>
                                <option value="Maserati">Maserati</option>
                                <option value="Mazda">Mazda</option>
                                <option value="McLaren">McLaren</option>
                                <option value="Mercedes">Mercedes</option>
                                <option value="Mercedes-Maybach">Mercedes-Maybach</option>
                                <option value="Mercury">Mercury</option>
                                <option value="MG">MG</option>
                                <option value="Mini">Mini</option>
                                <option value="Mitsubishi">Mitsubishi</option>
                                <option value="NIO">NIO</option>
                                <option value="Nissan">Nissan</option>
                                <option value="Opel">Opel</option>
                                <option value="Oshan">Oshan</option>
                                <option value="Peugeot">Peugeot</option>
                                <option value="Piaggio">Piaggio</option>
                                <option value="Polestar">Polestar</option>
                                <option value="Pontiac">Pontiac</option>
                                <option value="Porsche">Porsche</option>
                                <option value="Ravon">Ravon</option>
                                <option value="Renault">Renault</option>
                                <option value="Renault Samsung">Renault Samsung</option>
                                <option value="Riddara">Riddara</option>
                                <option value="Rivian">Rivian</option>
                                <option value="Roewe">Roewe</option>
                                <option value="Rolls-Royce">Rolls-Royce</option>
                                <option value="Rover">Rover</option>
                                <option value="Saab">Saab</option>
                                <option value="Saturn">Saturn</option>
                                <option value="Scion">Scion</option>
                                <option value="Seat">Seat</option>
                                <option value="Skoda">Skoda</option>
                                <option value="Skywell">Skywell</option>
                                <option value="Smart">Smart</option>
                                <option value="Ssangyong">Ssangyong</option>
                                <option value="Subaru">Subaru</option>
                                <option value="Suzuki">Suzuki</option>
                                <option value="Tank">Tank</option>
                                <option value="Tata">Tata</option>
                                <option value="Tesla">Tesla</option>
                                <option value="Toyota">Toyota</option>
                                <option value="Venucia">Venucia</option>
                                <option value="Volkswagen">Volkswagen</option>
                                <option value="Volvo">Volvo</option>
                                <option value="Voyah">Voyah</option>
                                <option value="Weltmeister">Weltmeister</option>
                                <option value="Wuling">Wuling</option>
                                <option value="Xiaomi">Xiaomi</option>
                                <option value="Xpeng">Xpeng</option>
                                <option value="Zeekr">Zeekr</option>
                                <option value="Zotye">Zotye</option>
                              </select>
                          </div>
                          <div>
                            <label class="form-label">Model Name</label>
                            <input type="text" name="model_name" class="form-control" placeholder="Enter model name" required>
                          </div>
                          <div>
                            <label class="form-label">Production Year</label>
                            <select name="production_year" class="form-control" required></select>
                          </div>
                          <div>
                            <label class="form-label">Gear Type</label>
                            <select name="gear_type" class="form-control" required>
                              <option value="Automatic">Automatic</option>
                              <option value="Manual">Manual</option>
                            </select>
                          </div>
                          <div class="five-column-grid">
                            <div>
                              <label class="form-label">Fuel Type</label>
                              <select name="fuel_type" class="form-control" required>
                                <option value="Gasoline">Gasoline</option>
                                <option value="Diesel">Diesel</option>
                                <option value="Hybrid">Hybrid</option>
                                <option value="Electric">Electric</option>
                              </select>
                            </div>
                            <div>
                              <label class="form-label">Engine Capacity</label>
                              <input type="number" name="engine_capacity" class="form-control" step="0.1" min="0">
                            </div>
                            <div>
                              <label class="form-label">Car Type</label>
                              <select name="car_type" class="form-control" required>
                                <option value="Crossover">Crossover</option>
                                <option value="Sedan">Sedan</option>
                                <option value="Coupe">Coupe</option>
                                  <option value="Minivan">Minivan</option>
                                  <option value="Hatchback">Hatchback</option>
                              </select>
                            </div>
                            <div>
                              <label class="form-label">Number of Doors</label>
                              <select name="num_doors" class="form-control" required></select>
                            </div>
                            <div>
                              <label class="form-label">Number of Passengers</label>
                              <select name="num_passengers" class="form-control" required></select>
                            </div>
                          </div>
                        </div>
                        <fieldset class="mb-3 p-2 rounded-3" style="border: 1px solid #eee;">
                          <legend class="form-label mb-2" style="font-size: 1rem; color: #031B4E;">Price Policy</legend>
                          <div class="row g-2">
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">1-2 days</label>
                              <input type="text" name="price_1_2" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">3-7 days</label>
                              <input type="text" name="price_3_7" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">8-20 days</label>
                              <input type="text" name="price_8_20" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">21-45 days</label>
                              <input type="text" name="price_21_45" class="form-control" required>
                            </div>
                            <div class="col-12 col-md-6 col-xl-2 mb-2">
                              <label class="form-label">46+ days</label>
                              <input type="text" name="price_46" class="form-control" required>
                            </div>
                          </div>
                        </fieldset>
                        <div class="mb-3" style="max-width: 300px;">
                          <label class="form-label">Booked Until (optional)</label>
                          <input type="date" name="booked_until" class="form-control" placeholder="Select date until when car is booked">
                          <small class="form-text text-muted">Leave empty if car is available. Car will be automatically available after this date.</small>
                        </div>
                          <fieldset class="mb-3 p-2 rounded-3" style="border: 1px solid #eee;">
                            <legend class="form-label mb-2" style="font-size: 1rem; color: #031B4E;">Additional Specifications (Optional)</legend>
                            <div class="admin-form-grid">
                              <div>
                                <label class="form-label">Luggage Capacity</label>
                                <input type="text" name="luggage" class="form-control" placeholder="e.g., 2 large suitcases">
                              </div>
                              <div>
                                <label class="form-label">Mileage (km)</label>
                                <input type="number" name="mileage" class="form-control" placeholder="e.g., 50000" min="0">
                              </div>
                              <div>
                                <label class="form-label">Drive Type</label>
                                <select name="drive" class="form-control">
                                  <option value="">Select drive type</option>
                                  <option value="Front Wheel Drive">Front Wheel Drive</option>
                                  <option value="Rear Wheel Drive">Rear Wheel Drive</option>
                                  <option value="All Wheel Drive">All Wheel Drive</option>
                                  <option value="4 Wheel Drive">4 Wheel Drive</option>
                                </select>
                              </div>
                              <div>
                                <label class="form-label" id="edit-fuel-economy-label">Fuel Economy (L/100km)</label>
                                <input type="number" name="fuel_economy" class="form-control" placeholder="e.g., 7.5" step="0.1" min="0">
                              </div>
                              <div>
                                <label class="form-label">Exterior Color</label>
                                <input type="text" name="exterior_color" class="form-control" placeholder="e.g., Pearl White">
                              </div>
                              <div>
                                <label class="form-label">Interior Color</label>
                                <input type="text" name="interior_color" class="form-control" placeholder="e.g., Black Leather">
                              </div>
                            </div>
                          </fieldset>
                          <fieldset class="mb-3 p-2 rounded-3" style="border: 1px solid #eee;">
                            <legend class="form-label mb-2" style="font-size: 1rem; color: #031B4E;">Insurance Pricing (Required)</legend>
                            <div class="admin-form-grid">
                              <div>
                                <label class="form-label">RCA Insurance Price (€/day)</label>
                                <input type="number" name="rca_insurance_price" class="form-control" placeholder="e.g., 15" step="0.01" min="0" required>
                              </div>
                              <div>
                                <label class="form-label">Casco Insurance Price (€/day)</label>
                                <input type="number" name="casco_insurance_price" class="form-control" placeholder="e.g., 25" step="0.01" min="0" required>
                              </div>
                            </div>
                          </fieldset>
                          <button type="submit" id="editFormSubmitBtn" class="btn btn-main">Update Car</button>
                      </form>
                    </div>
                    <!-- Confirm Modal -->
                    <div id="adminConfirmModal" class="admin-confirm-modal">
                      <h4>Are you sure you want to close this form? All unsaved data will be lost.</h4>
                      <div class="mt-4 d-flex justify-content-center gap-3">
                        <button id="confirmCloseBtn" class="btn btn-danger">Close</button>
                        <button id="cancelCloseBtn" class="btn btn-main">Cancel</button>
                      </div>
                    </div>
                    <!-- Add a confirmation modal for delete -->
                    <div id="deleteConfirmModal" class="admin-confirm-modal">
                      <h4>Are you sure you want to delete this car?</h4>
                      <div class="mt-4 d-flex justify-content-center gap-3">
                        <button id="confirmDeleteBtn" class="btn btn-danger">Yes Delete</button>
                        <button id="cancelDeleteBtn" class="btn btn-main">Cancel</button>
                      </div>
                    </div>
                      

                  </div>
                </div>
                <div id="carCards" class="row g-4 mt-4"></div>
                </div>
                
                <!-- Coupon Codes Tab Content -->
                <div id="coupons-tab" class="admin-tab-content">
                  <div class="admin-flex-row">
                    <div class="admin-btn-col">
                      <button id="showAddCouponBtn" type="button" class="btn btn-main btn-lg">Add Coupon Code</button>
                    </div>
                    <div class="admin-form-col">
                      <!-- Overlay -->
                      <div id="couponOverlay" class="admin-overlay"></div>
                      <!-- Add Coupon Form Panel (popup) -->
                      <div id="addCouponPanel" class="admin-form-panel">
                        <button class="close-btn" id="closeAddCouponPanel">&times;</button>
                        <form id="couponForm" class="form-border" autocomplete="off">
                          <h3 id="couponFormTitle" class="mb-3" style="font-family: var(--title-font); font-weight: 600; color: #031B4E; font-size: 1.4rem;">Add Coupon Code</h3>
                          <div class="admin-form-grid">
                            <div>
                              <label class="form-label">Coupon Code</label>
                              <input type="text" name="code" class="form-control" placeholder="e.g., WELCOME10" required>
                            </div>
                            <div>
                              <label class="form-label">Coupon Type</label>
                              <select name="type" id="couponType" class="form-control" required>
                                <option value="percentage">Percentage Discount</option>
                                <option value="free_days">Free Days</option>
                              </select>
                            </div>
                            <div id="percentageField" class="coupon-field">
                              <label class="form-label">Discount Percentage</label>
                              <input type="number" name="discount_percentage" class="form-control" placeholder="e.g., 15" min="1" max="100" step="0.01">
                            </div>
                            <div id="freeDaysField" class="coupon-field" style="display: none;">
                              <label class="form-label">Free Days</label>
                              <input type="number" name="free_days" class="form-control" placeholder="e.g., 3" min="1" step="1">
                            </div>
                            <div>
                              <label class="form-label">Description</label>
                              <textarea name="description" class="form-control" placeholder="e.g., Welcome discount for new customers" rows="3"></textarea>
                            </div>
                            <div>
                              <label class="form-label">Expiry Date (Optional)</label>
                              <input type="datetime-local" name="expires_at" class="form-control">
                            </div>
                            <div>
                              <label class="form-label">Status</label>
                              <select name="is_active" class="form-control" required>
                                <option value="1">Active</option>
                                <option value="0">Inactive</option>
                              </select>
                            </div>
                          </div>
                          <button type="submit" id="couponFormSubmitBtn" class="btn btn-main">Add Coupon</button>
                        </form>
                      </div>
                      <!-- Edit Coupon Form Panel (popup) -->
                      <div id="editCouponPanel" class="admin-form-panel">
                        <button class="close-btn" id="closeEditCouponPanel">&times;</button>
                        <button id="deleteCouponBtn" type="button" style="position:absolute;top:16px;right:48px;background:none;border:1.5px solid #e74c3c;color:#e74c3c;padding:6px 14px;border-radius:6px;font-size:1rem;display:flex;align-items:center;gap:6px;cursor:pointer;z-index:2;">
                          <i class="fa fa-trash"></i> Delete Coupon
                        </button>
                        <form id="editCouponForm" class="form-border" autocomplete="off">
                          <h3 class="mb-3" style="font-family: var(--title-font); font-weight: 600; color: #031B4E; font-size: 1.4rem;">Edit Coupon Code</h3>
                          <div class="admin-form-grid">
                            <div>
                              <label class="form-label">Coupon Code</label>
                              <input type="text" name="code" class="form-control" placeholder="e.g., WELCOME10" required>
                            </div>
                            <div>
                              <label class="form-label">Coupon Type</label>
                              <select name="type" id="editCouponType" class="form-control" required>
                                <option value="percentage">Percentage Discount</option>
                                <option value="free_days">Free Days</option>
                              </select>
                            </div>
                            <div id="editPercentageField" class="coupon-field">
                              <label class="form-label">Discount Percentage</label>
                              <input type="number" name="discount_percentage" class="form-control" placeholder="e.g., 15" min="1" max="100" step="0.01">
                            </div>
                            <div id="editFreeDaysField" class="coupon-field" style="display: none;">
                              <label class="form-label">Free Days</label>
                              <input type="number" name="free_days" class="form-control" placeholder="e.g., 3" min="1" step="1">
                            </div>
                            <div>
                              <label class="form-label">Description</label>
                              <textarea name="description" class="form-control" placeholder="e.g., Welcome discount for new customers" rows="3"></textarea>
                            </div>
                            <div>
                              <label class="form-label">Expiry Date (Optional)</label>
                              <input type="datetime-local" name="expires_at" class="form-control">
                            </div>
                            <div>
                              <label class="form-label">Status</label>
                              <select name="is_active" class="form-control" required>
                                <option value="1">Active</option>
                                <option value="0">Inactive</option>
                              </select>
                            </div>
                          </div>
                          <button type="submit" id="editCouponFormSubmitBtn" class="btn btn-main">Update Coupon</button>
                        </form>
                      </div>
                    </div>
                  </div>
                  <div id="couponCards" class="row g-4 mt-4"></div>
                </div>

                <!-- Bookings Tab Content -->
                <div id="bookings-tab" class="admin-tab-content">
                  <div class="admin-flex-row">
                    <div class="admin-btn-col">
                      <h4>Pending Bookings</h4>
                      <p class="text-muted">Review and approve/reject booking requests</p>
                    </div>
                    <div class="admin-form-col">
                      <div id="bookingsList" class="row g-4">
                        <!-- Bookings will be loaded here -->
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Spinning Wheel Tab Content -->
                <div id="spinning-wheel-tab" class="admin-tab-content">
                  <div class="admin-flex-row wheel-config-row">
                    <!-- Left Side - Wheels List -->
                    <div style="width: 50%;">
                      <div class="card shadow-sm">
                        <div class="card-body">
                          <p class="text-muted mb-3">Select a wheel to configure</p>
                          <div class="mb-4">
                            <button id="openSpinningWheelBtn" type="button" class="btn btn-success btn-lg w-100 mb-2">
                              <i class="fa fa-play"></i> Open Active Wheel
                            </button>
                            <button id="addWheelBtn" type="button" class="btn btn-outline-primary btn-lg w-100">
                              <i class="fa fa-plus"></i> Add New Wheel
                            </button>
                          </div>
                          

                          
                          <!-- Wheels List -->
                          <div class="card">
                            <div class="card-header bg-light">
                              <h6 class="mb-0"><i class="fa fa-list"></i> All Wheels</h6>
                            </div>
                            <div class="card-body p-0">
                              <div id="wheelsList" class="list-group list-group-flush">
                                <!-- Wheels will be loaded here -->
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                                         <!-- Right Side - Wheel Configuration -->
                     <div style="width: 50%;">
                       <div id="wheelConfigurationPanel">
                         <!-- Default state when no wheel is selected -->
                         <div class="card shadow-sm">
                           <div class="card-header bg-light">
                             <h5 class="mb-0"><i class="fa fa-cog"></i> Wheel Configuration</h5>
                           </div>
                           <div class="card-body text-center py-5">
                             <div class="mb-4">
                               <i class="fa fa-arrow-left fa-3x text-muted"></i>
                             </div>
                             <h5 class="card-title">Select a Wheel</h5>
                             <p class="text-muted">Choose a wheel from the list on the left to configure it</p>
                           </div>
                         </div>
                       </div>
                     </div>
                  </div>
                </div>
              </div>
            </section>
			
			
        </div>
        <!-- content close -->

        <!-- Spinning Wheel Preview Modal -->
        <div class="modal fade" id="spinningWheelModal" tabindex="-1" aria-labelledby="spinningWheelModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-xl">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="spinningWheelModalLabel">
                  <i class="fa fa-eye"></i> Spinning Wheel Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body p-0">
                <iframe id="spinningWheelIframe" src="spinning-wheel-standalone.html" 
                        style="width: 100%; height: 600px; border: none;"></iframe>
              </div>
              <div class="modal-footer">
                <a href="spinning-wheel-standalone.html" target="_blank" class="btn btn-primary">
                  <i class="fa fa-external-link"></i> Open in New Tab
                </a>
              </div>
            </div>
          </div>
        </div>

        <a href="#" id="back-to-top"></a>
        
        <!-- footer begin -->
        <footer class="text-light">
            <div class="container">
                <div class="row g-custom-x">
                    <div class="col-lg-3">
                        <div class="widget">
                            <h5>About PlusRent</h5>
                            <p>Where quality meets affordability. We understand the importance of a smooth and enjoyable journey without the burden of excessive costs. That's why we have meticulously crafted our offerings to provide you with top-notch vehicles at minimum expense.</p>
                        </div>
                    </div>
                    
                    <div class="col-lg-3">
                        <div class="widget">
                            <h5>Contact Info</h5>
                            <address class="s1">
                                <span><i class="id-color fa fa-map-marker fa-lg"></i>08 W 36th St, New York, NY 10001</span>
                                <span><i class="id-color fa fa-phone fa-lg"></i>+1 333 9296</span>
                                <span><i class="id-color fa fa-envelope-o fa-lg"></i><a href="mailto:contact@example.com">contact@example.com</a></span>
                                <span><i class="id-color fa fa-file-pdf-o fa-lg"></i><a href="#">Download Brochure</a></span>
                            </address>
                        </div>
                    </div>

                    <div class="col-lg-3">
                        <h5>Quick Links</h5>
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="widget">
                                    <ul>
                                        <li><a href="#">About</a></li>
                                        <li><a href="#">Blog</a></li>
                                        <li><a href="#">Careers</a></li>
                                        <li><a href="#">News</a></li>
                                        <li><a href="#">Partners</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3">
                        <div class="widget">
                            <h5>Social Network</h5>
                            <div class="social-icons">
                                <a href="#"><i class="fa fa-facebook fa-lg"></i></a>
                                <a href="#"><i class="fa fa-twitter fa-lg"></i></a>
                                <a href="#"><i class="fa fa-linkedin fa-lg"></i></a>
                                <a href="#"><i class="fa fa-pinterest fa-lg"></i></a>
                                <a href="#"><i class="fa fa-rss fa-lg"></i></a>
                            </div>
                        </div>    
                    </div>
                </div>
            </div>
            <div class="subfooter">
                <div class="container">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="de-flex">
                                <div class="de-flex-col">
                                    <a href="index.html">
                                        Copyright 2025 - PlusRent by Designesia
                                    </a>
                                </div>
                                <ul class="menu-simple">
                                    <li><a href="#">Terms &amp; Conditions</a></li>
                                    <li><a href="#">Privacy Policy</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
        <!-- footer close -->
        
    </div>

    <!-- Custom Alert -->
    <div id="adminCustomAlert" style="display:none;position:fixed;top:32px;left:50%;transform:translateX(-50%);z-index:10002;min-width:320px;max-width:90vw;padding:16px 32px;border-radius:8px;font-size:1.1rem;font-weight:500;box-shadow:0 4px 24px rgba(0,0,0,0.12);background:#031B4E;color:#fff;text-align:center;transition:opacity 0.3s;opacity:0;"></div>


    <!-- Javascript Files
    ================================================== -->
    <script src="js/plugins.js"></script>
    <script src="js/designesia.js"></script>
    <script src="js/config.js"></script>
    <script>
        // Authentication check
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('adminToken');
            const user = localStorage.getItem('adminUser');
            
            if (!token || !user) {
                // Redirect to login if not authenticated
                window.location.href = 'login.html';
                return;
            }
            
            // Verify token is still valid
            fetch(`${window.API_BASE_URL}/api/auth/verify`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    // Token is invalid, redirect to login
                    localStorage.removeItem('adminToken');
                    localStorage.removeItem('adminUser');
                    window.location.href = 'login.html';
                }
            })
            .catch(error => {
                console.error('Token verification error:', error);
                // Network error, but we'll allow access for now
            });
            
            // Add logout functionality
            const logoutBtn = document.createElement('button');
            logoutBtn.textContent = 'Logout';
            logoutBtn.className = 'btn-main';
            logoutBtn.style.marginLeft = '10px';
            
            logoutBtn.addEventListener('click', function() {
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminUser');
                window.location.href = 'login.html';
            });
            
            // Add logout button to the menu_side_area
            const menuSideArea = document.querySelector('.menu_side_area');
            if (menuSideArea) {
                menuSideArea.appendChild(logoutBtn);
            }
        });
    </script>

    <!-- Global Booking Management Functions -->
    <script>
    // Global booking management functions
    async function approveBooking(bookingId, button) {
      if (!window.API_BASE_URL) {
        console.error('API_BASE_URL not defined');
        return;
      }
      
      // Find the booking card
      const bookingCard = button.closest('.booking-card');
      if (!bookingCard) return;
      
      // Add loading state to button
      button.classList.add('btn-loading');
      button.disabled = true;
      
      // Add approving animation to card
      bookingCard.classList.add('approving');
      
      try {
        const response = await fetch(`${window.API_BASE_URL}/api/bookings/${bookingId}/confirm`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          // Success animation - slide out
          bookingCard.classList.remove('approving');
          bookingCard.classList.add('slide-out');
          
          // Remove card after animation
          setTimeout(() => {
            bookingCard.remove();
            // Refresh list if no more bookings
            const remainingCards = document.querySelectorAll('.booking-card');
            if (remainingCards.length === 0) {
              loadPendingBookings();
            }
          }, 300);
        } else {
          const error = await response.json();
          console.error('Error approving booking:', error.error);
          
          // Remove loading state
          bookingCard.classList.remove('approving');
          button.classList.remove('btn-loading');
          button.disabled = false;
        }
      } catch (error) {
        console.error('Error approving booking:', error);
        
        // Remove loading state
        bookingCard.classList.remove('approving');
        button.classList.remove('btn-loading');
        button.disabled = false;
      }
    }

    async function rejectBooking(bookingId, button) {
      if (!window.API_BASE_URL) {
        console.error('API_BASE_URL not defined');
        return;
      }
      
      // Find the booking card
      const bookingCard = button.closest('.booking-card');
      if (!bookingCard) return;
      
      // Add loading state to button
      button.classList.add('btn-loading');
      button.disabled = true;
      
      // Add rejecting animation to card
      bookingCard.classList.add('rejecting');
      
      const reason = ''; // No prompt needed
      
      try {
        const response = await fetch(`${window.API_BASE_URL}/api/bookings/${bookingId}/reject`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason: reason || 'No reason provided' })
        });
        
        if (response.ok) {
          // Success animation - slide out
          bookingCard.classList.remove('rejecting');
          bookingCard.classList.add('slide-out');
          
          // Remove card after animation
          setTimeout(() => {
            bookingCard.remove();
            // Refresh list if no more bookings
            const remainingCards = document.querySelectorAll('.booking-card');
            if (remainingCards.length === 0) {
              loadPendingBookings();
            }
          }, 300);
        } else {
          const error = await response.json();
          console.error('Error rejecting booking:', error.error);
          
          // Remove loading state
          bookingCard.classList.remove('rejecting');
          button.classList.remove('btn-loading');
          button.disabled = false;
        }
      } catch (error) {
        console.error('Error rejecting booking:', error);
        
        // Remove loading state
        bookingCard.classList.remove('rejecting');
        button.classList.remove('btn-loading');
        button.disabled = false;
      }
    }

    // Global alert function
    function showCustomAlert(message, type = 'info') {
      const alert = document.getElementById('adminCustomAlert');
      if (!alert) return;
      
      alert.textContent = message;
      alert.style.background = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#031B4E';
      alert.style.display = 'block';
      alert.style.opacity = '1';
      
      setTimeout(() => {
        alert.style.opacity = '0';
        setTimeout(() => {
          alert.style.display = 'none';
        }, 300);
      }, 3000);
    }

    // Global function to load pending bookings
    async function loadPendingBookings() {
      if (!window.API_BASE_URL) {
        console.error('API_BASE_URL not defined');
        return;
      }
      
      try {
        const response = await fetch(`${window.API_BASE_URL}/api/bookings`);
        const bookings = await response.json();
        
        const bookingsList = document.getElementById('bookingsList');
        if (!bookingsList) return;
        
        const pendingBookings = bookings.filter(booking => booking.status === 'pending');
        
        if (pendingBookings.length === 0) {
          bookingsList.innerHTML = '<div class="col-12"><div class="alert alert-info">No pending bookings found.</div></div>';
          return;
        }
        
        bookingsList.innerHTML = pendingBookings.map(booking => `
          <div class="col-12">
            <div class="card booking-card" data-booking-id="${booking.id}">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-8">
                    <h5 class="card-title">${booking.make_name} ${booking.model_name} (${booking.production_year})</h5>
                    <p class="card-text">
                      <strong>Dates:</strong> ${booking.pickup_date} ${booking.pickup_time} - ${booking.return_date} ${booking.return_time}<br>
                      <strong>Insurance:</strong> ${booking.insurance_type}<br>
                      <strong>Pickup:</strong> ${booking.pickup_location} | <strong>Dropoff:</strong> ${booking.dropoff_location}<br>
                      <strong>Total Price:</strong> €${booking.total_price}<br>
                      <strong>Contact:</strong> ${booking.contact_person || 'Not provided'} | ${booking.contact_phone || 'Not provided'}<br>
                      <strong>Special Instructions:</strong> ${booking.special_instructions || 'None'}
                    </p>
                  </div>
                  <div class="col-md-4 text-end">
                    <div class="btn-group-vertical w-100">
                      <button class="btn btn-success mb-2 btn-approve" onclick="approveBooking(${booking.id}, this)">
                        <i class="fa fa-check"></i> Approve
                      </button>
                      <button class="btn btn-danger btn-reject" onclick="rejectBooking(${booking.id}, this)">
                        <i class="fa fa-times"></i> Reject
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error loading bookings:', error);
        document.getElementById('bookingsList').innerHTML = '<div class="col-12"><div class="alert alert-danger">Error loading bookings.</div></div>';
      }
    }

    // Admin Dashboard Main Functionality
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize tab navigation
      initializeTabs();
      
      // Initialize form dropdowns
      initializeFormDropdowns();
      
      // Load initial data
      loadCars();
      loadCoupons();
      loadPendingBookings();
      
      // Initialize form handlers
      initializeCarForms();
      initializeCouponForms();
    });

    // Tab Navigation
    function initializeTabs() {
      const tabButtons = document.querySelectorAll('.admin-tab-btn');
      const tabContents = document.querySelectorAll('.admin-tab-content');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', function() {
          const targetTab = this.getAttribute('data-tab');
          
          // Remove active class from all buttons and contents
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          
          // Add active class to clicked button and corresponding content
          this.classList.add('active');
          document.getElementById(targetTab + '-tab').classList.add('active');
        });
      });
    }

    // Initialize Form Dropdowns
    function initializeFormDropdowns() {
      // Production Year dropdown (current year to 1990)
      const productionYearSelects = document.querySelectorAll('select[name="production_year"]');
      const currentYear = new Date().getFullYear();
      productionYearSelects.forEach(select => {
        for (let year = currentYear; year >= 1990; year--) {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          select.appendChild(option);
        }
      });
      
      // Number of Doors dropdown
      const numDoorsSelects = document.querySelectorAll('select[name="num_doors"]');
      numDoorsSelects.forEach(select => {
        for (let doors = 2; doors <= 5; doors++) {
          const option = document.createElement('option');
          option.value = doors;
          option.textContent = doors;
          select.appendChild(option);
        }
      });
      
      // Number of Passengers dropdown
      const numPassengersSelects = document.querySelectorAll('select[name="num_passengers"]');
      numPassengersSelects.forEach(select => {
        for (let passengers = 2; passengers <= 8; passengers++) {
          const option = document.createElement('option');
          option.value = passengers;
          option.textContent = passengers;
          select.appendChild(option);
        }
      });
    }

    // Car Management Functions
    async function loadCars() {
      if (!window.API_BASE_URL) {
        console.error('API_BASE_URL not defined');
        return;
      }
      
      try {
        const response = await fetch(`${window.API_BASE_URL}/api/cars`);
        const cars = await response.json();
        
        const carCards = document.getElementById('carCards');
        if (!carCards) return;
        
        if (cars.length === 0) {
          carCards.innerHTML = '<div class="col-12"><div class="alert alert-info">No cars found. Add your first car!</div></div>';
          return;
        }
        
                    carCards.innerHTML = cars.map(car => `
          <div class="col-md-6 col-lg-4">
            <div class="de-item">
              <div class="d-image">
                <img src="${window.API_BASE_URL + car.head_image || window.API_BASE_URL + 'uploads/placeholder.png'}" class="img-fluid" alt="${car.make_name} ${car.model_name}" style="width: 100%; height: 200px; object-fit: cover;" onerror="this.src=window.API_BASE_URL + '/uploads/placeholder.png'">
              </div>
              <div class="d-info">
                <div class="d-text">
                  <h4>${formatDisplayText(car.make_name)}</h4>
                                      <p>${formatDisplayText(car.model_name)}</p>
                  <div class="d-atr-group">
                    <span class="d-atr"><img src="images/icons/1-green.svg" alt=""> ${car.num_passengers || '-'}</span>
                    <span class="d-atr"><img src="images/icons/2-green.svg" alt=""> ${car.num_doors || '-'}</span>
                    <span class="d-atr"><img src="images/icons/3-green.svg" alt="">${car.luggage || '-'}</span>
                    <span class="d-atr"><img src="images/icons/4-green.svg" alt="" ${car.car_type || '-'}</span>
                  </div>
                  <div class="d-price">Daily rate from <span>€${car.price_policy && car.price_policy['1-2'] ? car.price_policy['1-2'] : 'N/A'}</span></div>
                  <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-primary btn-sm" onclick="editCar(${car.id})">
                      <i class="fa fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteCar(${car.id})">
                      <i class="fa fa-trash"></i> Delete
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error loading cars:', error);
        document.getElementById('carCards').innerHTML = '<div class="col-12"><div class="alert alert-danger">Error loading cars.</div></div>';
      }
    }

    // Coupon Management Functions
    async function loadCoupons() {
      
      if (!window.API_BASE_URL) {
        console.error('API_BASE_URL not defined');
        return;
      }
      
      try {
        const response = await fetch(`${window.API_BASE_URL}/api/coupons`);
        const coupons = await response.json();
        
        
        const couponCards = document.getElementById('couponCards');
        if (!couponCards) return;
        
        if (coupons.length === 0) {
          couponCards.innerHTML = '<div class="col-12"><div class="alert alert-info">No coupon codes found. Add your first coupon!</div></div>';
          return;
        }
        
        couponCards.innerHTML = coupons.map(coupon => `
          <div class="col-md-6 col-lg-4">
            <div class="coupon-card">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <h5 class="card-title mb-0">${coupon.code}</h5>
                <span class="coupon-status ${coupon.is_active ? 'active' : 'inactive'}">
                  ${coupon.is_active ? 'Active' : 'Inactive'}
                </span>
              </div>
              <p class="card-text">
                <strong>${coupon.type === 'free_days' ? 'Free Days:' : 'Discount:'}</strong> 
                ${coupon.type === 'free_days' ? `${coupon.free_days} ${coupon.free_days === 1 ? 'Day Free' : 'Days Free'}` : `${coupon.discount_percentage}%`}<br>
                <strong>Description:</strong> ${coupon.description || 'No description'}<br>
                ${coupon.expires_at ? `<strong>Expires:</strong> ${new Date(coupon.expires_at).toLocaleDateString()}` : ''}
              </p>
              <div class="d-flex gap-2">
                <button class="btn btn-primary btn-sm" onclick="editCoupon(${coupon.id})">
                  <i class="fa fa-edit"></i> Edit
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteCoupon(${coupon.id})">
                  <i class="fa fa-trash"></i> Delete
                </button>
              </div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error loading coupons:', error);
        document.getElementById('couponCards').innerHTML = '<div class="col-12"><div class="alert alert-danger">Error loading coupons.</div></div>';
      }
    }

    // Form Handlers
    function initializeCarForms() {
      // Populate dropdown options
      function populateDropdowns() {
        // Production year dropdown (current year to 1990)
        const productionYearSelects = document.querySelectorAll('select[name="production_year"]');
        productionYearSelects.forEach(select => {
          if (select.children.length === 0) {
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= 1990; year--) {
              const option = document.createElement('option');
              option.value = year;
              option.textContent = year;
              select.appendChild(option);
            }
          }
        });

        // Number of doors dropdown
        const numDoorsSelects = document.querySelectorAll('select[name="num_doors"]');
        numDoorsSelects.forEach(select => {
          if (select.children.length === 0) {
            for (let doors = 2; doors <= 5; doors++) {
              const option = document.createElement('option');
              option.value = doors;
              option.textContent = doors;
              select.appendChild(option);
            }
          }
        });

        // Number of passengers dropdown
        const numPassengersSelects = document.querySelectorAll('select[name="num_passengers"]');
        numPassengersSelects.forEach(select => {
          if (select.children.length === 0) {
            for (let passengers = 2; passengers <= 8; passengers++) {
              const option = document.createElement('option');
              option.value = passengers;
              option.textContent = passengers;
              select.appendChild(option);
            }
          }
        });

        // Populate car makes dropdown
        const makeSelects = document.querySelectorAll('select[name="make_name"]');
        makeSelects.forEach(select => {
          if (select.children.length <= 1) { // Only has "Select Make" option
            const makes = [
              'bmw', 'mercedes', 'audi', 'volkswagen', 'toyota', 'honda', 'ford', 'chevrolet', 
              'nissan', 'hyundai', 'kia', 'mazda', 'subaru', 'volvo', 'lexus', 'infiniti', 
              'acura', 'buick', 'cadillac', 'chrysler', 'dodge', 'jeep', 'ram', 'gmc', 
              'pontiac', 'saturn', 'oldsmobile', 'plymouth', 'eagle', 'tesla', 'ferrari', 
              'lamborghini', 'porsche', 'maserati', 'aston_martin', 'bentley', 'rolls_royce', 
              'mclaren', 'bugatti', 'koenigsegg', 'pagani', 'rimac', 'lotus', 'alpine', 
              'caterham', 'ariel', 'noble', 'radical', 'ultima', 'zenvo', 'gumpert', 
              'saleen', 'hennessey', 'callaway', 'ruf', 'techart', 'mansory', 'brabus', 
              'alpina', 'hamann', 'hartge', 'ac_schnitzer', 'dinan', 'vorsteiner', 'hre', 
              'adv_1', 'forgiato', 'vossen', 'rohana', 'titan7', 'volk', 'work', 'rays', 
              'enkei', 'bbs', 'oz', 'ssr', 'weds', 'gram_lights', 'volk_racing', 
              'work_emotion', 'volk_te37', 'volk_ce28', 'volk_re30', 'volk_gt_c', 
              'volk_gt_n', 'volk_gt_v', 'volk_gt_u', 'volk_gt_f', 'volk_gt_m', 'volk_gt_s', 
              'volk_gt_t', 'volk_gt_w', 'volk_gt_x', 'volk_gt_y', 'volk_gt_z'
            ];
            makes.forEach(makeKey => {
              const option = document.createElement('option');
              option.value = makeKey;
              option.textContent = makeKey.toUpperCase().replace('_', ' ');
              select.appendChild(option);
            });
          }
        });

        // Populate car models dropdown
        const modelSelects = document.querySelectorAll('select[name="model_name"]');
        modelSelects.forEach(select => {
          if (select.children.length <= 1) { // Only has "Select Model" option
            const models = [
              'bmw_3_series', 'bmw_5_series', 'bmw_7_series', 'bmw_x3', 'bmw_x5', 'bmw_x7', 
              'bmw_z4', 'bmw_m3', 'bmw_m5', 'bmw_m8', 'mercedes_c_class', 'mercedes_e_class', 
              'mercedes_s_class', 'mercedes_gla', 'mercedes_glc', 'mercedes_gle', 'mercedes_gls', 
              'mercedes_amg_gt', 'audi_a3', 'audi_a4', 'audi_a6', 'audi_a8', 'audi_q3', 
              'audi_q5', 'audi_q7', 'audi_q8', 'audi_rs6', 'audi_rs7', 'volkswagen_golf', 
              'volkswagen_passat', 'volkswagen_tiguan', 'volkswagen_atlas', 'volkswagen_id4', 
              'toyota_camry', 'toyota_corolla', 'toyota_rav4', 'toyota_highlander', 'toyota_prius', 
              'honda_civic', 'honda_accord', 'honda_crv', 'honda_pilot', 'ford_focus', 'ford_fusion', 
              'ford_escape', 'ford_explorer', 'chevrolet_cruze', 'chevrolet_malibu', 'chevrolet_equinox', 
              'chevrolet_tahoe', 'nissan_sentra', 'nissan_altima', 'nissan_rogue', 'nissan_murano', 
              'hyundai_elantra', 'hyundai_sonata', 'hyundai_tucson', 'hyundai_santa_fe', 'kia_forte', 
              'kia_optima', 'kia_sportage', 'kia_sorento', 'mazda_3', 'mazda_6', 'mazda_cx5', 
              'mazda_cx9', 'subaru_impreza', 'subaru_legacy', 'subaru_forester', 'subaru_outback', 
              'volvo_s60', 'volvo_s90', 'volvo_xc40', 'volvo_xc60', 'volvo_xc90', 'lexus_es', 
              'lexus_ls', 'lexus_rx', 'lexus_nx', 'lexus_gx', 'lexus_lx', 'infiniti_q50', 
              'infiniti_q70', 'infiniti_qx50', 'infiniti_qx60', 'acura_tlx', 'acura_rlx', 
              'acura_rdx', 'acura_mdx', 'buick_regal', 'buick_lacrosse', 'buick_encore', 
              'buick_enclave', 'cadillac_cts', 'cadillac_ct6', 'cadillac_xt4', 'cadillac_xt5', 
              'cadillac_escalade', 'chrysler_300', 'chrysler_pacifica', 'dodge_charger', 
              'dodge_challenger', 'dodge_durango', 'jeep_cherokee', 'jeep_grand_cherokee', 
              'jeep_wrangler', 'ram_1500', 'ram_2500', 'ram_3500', 'gmc_terrain', 'gmc_acadia', 
              'gmc_yukon', 'tesla_model_3', 'tesla_model_s', 'tesla_model_x', 'tesla_model_y', 
              'ferrari_f8', 'ferrari_sf90', 'ferrari_roma', 'lamborghini_huracan', 'lamborghini_aventador', 
              'lamborghini_urus', 'porsche_911', 'porsche_cayenne', 'porsche_macan', 'maserati_ghibli', 
              'maserati_quattroporte', 'maserati_levante', 'aston_martin_db11', 'aston_martin_vantage', 
              'aston_martin_dbs', 'bentley_continental', 'bentley_flying_spur', 'bentley_bentayga', 
              'rolls_royce_phantom', 'rolls_royce_ghost', 'rolls_royce_cullinan', 'mclaren_720s', 
              'mclaren_765lt', 'mclaren_artura', 'bugatti_chiron', 'bugatti_veyron', 'koenigsegg_jesko', 
              'koenigsegg_regera', 'pagani_huayra', 'pagani_zonda', 'rimac_nevera', 'lotus_emira', 
              'lotus_evija', 'alpine_a110', 'caterham_7', 'ariel_atom', 'noble_m600', 'radical_sr3', 
              'ultima_evo', 'zenvo_ts1', 'gumpert_apollo', 'saleen_s7', 'hennessey_venom', 
              'callaway_corvette', 'ruf_ctr', 'techart_gt_street', 'mansory_mercedes', 'brabus_mercedes', 
              'alpina_bmw', 'hamann_bmw', 'hartge_bmw', 'ac_schnitzer_bmw', 'dinan_bmw', 'vorsteiner_bmw', 
              'hre_wheels', 'adv_1_wheels', 'forgiato_wheels', 'vossen_wheels', 'rohana_wheels', 
              'titan7_wheels', 'volk_wheels', 'work_wheels', 'rays_wheels', 'enkei_wheels', 
              'bbs_wheels', 'oz_wheels', 'ssr_wheels', 'weds_wheels', 'gram_lights_wheels', 
              'volk_racing_wheels', 'work_emotion_wheels', 'volk_te37_wheels', 'volk_ce28_wheels', 
              'volk_re30_wheels', 'volk_gt_c_wheels', 'volk_gt_n_wheels', 'volk_gt_v_wheels', 
              'volk_gt_u_wheels', 'volk_gt_f_wheels', 'volk_gt_m_wheels', 'volk_gt_s_wheels', 
              'volk_gt_t_wheels', 'volk_gt_w_wheels', 'volk_gt_x_wheels', 'volk_gt_y_wheels', 
              'volk_gt_z_wheels'
            ];
            models.forEach(modelKey => {
              const option = document.createElement('option');
              option.value = modelKey;
              option.textContent = modelKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
              select.appendChild(option);
            });
          }
        });

        // Populate exterior colors dropdown
        const exteriorColorSelects = document.querySelectorAll('select[name="exterior_color"]');
        exteriorColorSelects.forEach(select => {
          if (select.children.length <= 1) { // Only has "Select Exterior Color" option
            const colors = [
              'white', 'black', 'silver', 'gray', 'red', 'blue', 'green', 'yellow', 'orange', 
              'purple', 'brown', 'beige', 'gold', 'bronze', 'copper', 'chrome', 'matte_black', 
              'matte_white', 'matte_gray', 'matte_red', 'matte_blue', 'matte_green', 'matte_yellow', 
              'matte_orange', 'matte_purple', 'matte_brown', 'matte_beige', 'matte_gold', 
              'matte_bronze', 'matte_copper', 'matte_chrome', 'pearl_white', 'pearl_black', 
              'pearl_silver', 'pearl_gray', 'pearl_red', 'pearl_blue', 'pearl_green', 'pearl_yellow', 
              'pearl_orange', 'pearl_purple', 'pearl_brown', 'pearl_beige', 'pearl_gold', 
              'pearl_bronze', 'pearl_copper', 'pearl_chrome', 'metallic_white', 'metallic_black', 
              'metallic_silver', 'metallic_gray', 'metallic_red', 'metallic_blue', 'metallic_green', 
              'metallic_yellow', 'metallic_orange', 'metallic_purple', 'metallic_brown', 'metallic_beige', 
              'metallic_gold', 'metallic_bronze', 'metallic_copper', 'metallic_chrome', 'candy_white', 
              'candy_black', 'candy_silver', 'candy_gray', 'candy_red', 'candy_blue', 'candy_green', 
              'candy_yellow', 'candy_orange', 'candy_purple', 'candy_brown', 'candy_beige', 'candy_gold', 
              'candy_bronze', 'candy_copper', 'candy_chrome', 'chameleon_white', 'chameleon_black', 
              'chameleon_silver', 'chameleon_gray', 'chameleon_red', 'chameleon_blue', 'chameleon_green', 
              'chameleon_yellow', 'chameleon_orange', 'chameleon_purple', 'chameleon_brown', 'chameleon_beige', 
              'chameleon_gold', 'chameleon_bronze', 'chameleon_copper', 'chameleon_chrome'
            ];
            colors.forEach(colorKey => {
              const option = document.createElement('option');
              option.value = colorKey;
              option.textContent = colorKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
              select.appendChild(option);
            });
          }
        });

        // Populate interior colors dropdown
        const interiorColorSelects = document.querySelectorAll('select[name="interior_color"]');
        interiorColorSelects.forEach(select => {
          if (select.children.length <= 1) { // Only has "Select Interior Color" option
            const colors = [
              'white', 'black', 'silver', 'gray', 'red', 'blue', 'green', 'yellow', 'orange', 
              'purple', 'brown', 'beige', 'gold', 'bronze', 'copper', 'chrome', 'matte_black', 
              'matte_white', 'matte_gray', 'matte_red', 'matte_blue', 'matte_green', 'matte_yellow', 
              'matte_orange', 'matte_purple', 'matte_brown', 'matte_beige', 'matte_gold', 
              'matte_bronze', 'matte_copper', 'matte_chrome', 'pearl_white', 'pearl_black', 
              'pearl_silver', 'pearl_gray', 'pearl_red', 'pearl_blue', 'pearl_green', 'pearl_yellow', 
              'pearl_orange', 'pearl_purple', 'pearl_brown', 'pearl_beige', 'pearl_gold', 
              'pearl_bronze', 'pearl_copper', 'pearl_chrome', 'metallic_white', 'metallic_black', 
              'metallic_silver', 'metallic_gray', 'metallic_red', 'metallic_blue', 'metallic_green', 
              'metallic_yellow', 'metallic_orange', 'metallic_purple', 'metallic_brown', 'metallic_beige', 
              'metallic_gold', 'metallic_bronze', 'metallic_copper', 'metallic_chrome', 'candy_white', 
              'candy_black', 'candy_silver', 'candy_gray', 'candy_red', 'candy_blue', 'candy_green', 
              'candy_yellow', 'candy_orange', 'candy_purple', 'candy_brown', 'candy_beige', 'candy_gold', 
              'candy_bronze', 'candy_copper', 'candy_chrome', 'chameleon_white', 'chameleon_black', 
              'chameleon_silver', 'chameleon_gray', 'chameleon_red', 'chameleon_blue', 'chameleon_green', 
              'chameleon_yellow', 'chameleon_orange', 'chameleon_purple', 'chameleon_brown', 'chameleon_beige', 
              'chameleon_gold', 'chameleon_bronze', 'chameleon_copper', 'chameleon_chrome'
            ];
            colors.forEach(colorKey => {
              const option = document.createElement('option');
              option.value = colorKey;
              option.textContent = colorKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
              select.appendChild(option);
            });
          }
        });
      }

      // Call populateDropdowns on page load
      populateDropdowns();

          // Unsaved changes confirmation modal
    function showUnsavedChangesConfirmation(panelType) {
      // Check if modal already exists and remove it
      const existingModal = document.querySelector('.unsaved-changes-modal');
      if (existingModal) {
        existingModal.remove();
      }
      
      const modal = document.createElement('div');
      modal.className = 'unsaved-changes-modal';
      modal.innerHTML = `
        <div class="unsaved-changes-content">
          <h3>Unsaved Changes</h3>
          <p>You have unsaved changes. Are you sure you want to close without saving?</p>
          <div class="unsaved-changes-buttons">
            <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
            <button class="btn btn-danger" id="confirmBtn">Close Without Saving</button>
          </div>
        </div>
      `;
      
      // Add styles
      const style = document.createElement('style');
      style.textContent = `
        .unsaved-changes-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        }
        .unsaved-changes-content {
          background: white;
          padding: 30px;
          border-radius: 8px;
          max-width: 400px;
          text-align: center;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .unsaved-changes-content h3 {
          margin-bottom: 15px;
          color: #333;
        }
        .unsaved-changes-content p {
          margin-bottom: 25px;
          color: #666;
        }
        .unsaved-changes-buttons {
          display: flex;
          gap: 10px;
          justify-content: center;
        }
        .unsaved-changes-buttons .btn {
          padding: 10px 20px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-weight: 500;
        }
        .unsaved-changes-buttons .btn-secondary {
          background: #6c757d;
          color: white;
        }
        .unsaved-changes-buttons .btn-danger {
          background: #dc3545;
          color: white;
        }
        .unsaved-changes-buttons .btn:hover {
          opacity: 0.9;
        }
      `;
      document.head.appendChild(style);
      document.body.appendChild(modal);
      
      // Add event listeners after modal is created
      const cancelBtn = modal.querySelector('#cancelBtn');
      const confirmBtn = modal.querySelector('#confirmBtn');
      
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          modal.remove();
          // Don't close the edit car form - just close the modal and keep the form open
        });
      }
      
      if (confirmBtn) {
        confirmBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          modal.remove();
          
          if (panelType === 'addCarPanel') {
            closeAddCarPanelFunction();
          } else if (panelType === 'editCarPanel') {
            closeEditCarPanelFunction();
          }
        });
      }
    }



    // Check if form has unsaved changes
    function hasUnsavedChanges(formId) {
      const form = document.getElementById(formId);
      if (!form) return false;
      
      // Check if any input has been modified
      const inputs = form.querySelectorAll('input, select, textarea');
      for (let input of inputs) {
        if (input.type === 'file') continue; // Skip file inputs
        
        // Check if the value has changed from the original
        if (input.dataset.originalValue !== undefined) {
          if (input.value !== input.dataset.originalValue) {
            return true;
          }
        } else if (input.value !== '') {
          // If no original value is set, check if current value is not empty
          return true;
        }
      }
      
      // Check for image previews
      if (formId === 'addCarForm') {
        const headImagePreview = document.getElementById('addHeadImagePreview');
        const galleryImagesPreview = document.getElementById('addGalleryImagesPreview');
        if (headImagePreview && headImagePreview.innerHTML !== '') return true;
        if (galleryImagesPreview && galleryImagesPreview.innerHTML !== '') return true;
      } else if (formId === 'editCarForm') {
        // For edit car form, only check if new images were added (not existing ones)
        const headImageInput = document.getElementById('editHeadImageInput');
        const galleryImagesInput = document.getElementById('editGalleryImagesInput');
        
        // Check if new files were selected
        if (headImageInput && headImageInput.files.length > 0) return true;
        if (galleryImagesInput && galleryImagesInput.files.length > 0) return true;
        
        // Check if images were removed from preview (indicating deletion)
        const headImagePreview = document.getElementById('editHeadImagePreview');
        const galleryImagesPreview = document.getElementById('editGalleryImagesPreview');
        
        // If there were originally images but now there are none, that's a change
        const originalHeadImage = form.dataset.originalHeadImage;
        const originalGalleryImages = form.dataset.originalGalleryImages;
        
        if (originalHeadImage && (!headImagePreview || headImagePreview.innerHTML === '')) return true;
        if (originalGalleryImages && (!galleryImagesPreview || galleryImagesPreview.innerHTML === '')) return true;
      }
      
      return false;
    }

    // Store original form values when form is loaded
    function storeOriginalValues(formId) {
      const form = document.getElementById(formId);
      if (!form) return;
      
      const inputs = form.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        if (input.type !== 'file') {
          input.dataset.originalValue = input.value;
        }
      });
      
      // Store original image state for edit car form
      if (formId === 'editCarForm') {
        const headImagePreview = document.getElementById('editHeadImagePreview');
        const galleryImagesPreview = document.getElementById('editGalleryImagesPreview');
        
        if (headImagePreview && headImagePreview.innerHTML !== '') {
          form.dataset.originalHeadImage = 'true';
        }
        if (galleryImagesPreview && galleryImagesPreview.innerHTML !== '') {
          form.dataset.originalGalleryImages = 'true';
        }
      }
    }
    
    // Make function globally accessible
    window.storeOriginalValues = storeOriginalValues;

    // Close functions
    function closeAddCarPanelFunction() {
      const addCarPanel = document.getElementById('addCarPanel');
      const adminOverlay = document.getElementById('adminOverlay');
      addCarPanel.classList.remove('active');
      adminOverlay.classList.remove('active');
      document.body.classList.remove('admin-popup-open');
    }

    function closeEditCarPanelFunction() {
      const editCarPanel = document.getElementById('editCarPanel');
      const editCarForm = document.getElementById('editCarForm');
      const adminOverlay = document.getElementById('adminOverlay');
      
      // Reset form and clear image previews
      editCarForm.reset();
      document.getElementById('editHeadImagePreview').innerHTML = '';
      document.getElementById('editGalleryImagesPreview').innerHTML = '';
      document.getElementById('editHeadImageInput').value = '';
      document.getElementById('editGalleryImagesInput').value = '';
      
      editCarPanel.classList.remove('active');
      adminOverlay.classList.remove('active');
      document.body.classList.remove('admin-popup-open');
    }

    function closeAllPanels() {
      const addCarPanel = document.getElementById('addCarPanel');
      const editCarPanel = document.getElementById('editCarPanel');
      const adminOverlay = document.getElementById('adminOverlay');
      
      addCarPanel.classList.remove('active');
      editCarPanel.classList.remove('active');
      adminOverlay.classList.remove('active');
      document.body.classList.remove('admin-popup-open');
    }

    // Add Car Button
    const showAddCarBtn = document.getElementById('showAddCarBtn');
    const addCarPanel = document.getElementById('addCarPanel');
    const closeAddCarPanel = document.getElementById('closeAddCarPanel');
    const adminOverlay = document.getElementById('adminOverlay');
      
      if (showAddCarBtn) {
        showAddCarBtn.addEventListener('click', () => {
          addCarPanel.classList.add('active');
          adminOverlay.classList.add('active');
          document.body.classList.add('admin-popup-open');
          // Store original values after a short delay to ensure form is rendered
          setTimeout(() => storeOriginalValues('addCarForm'), 100);
        });
      }
      
      if (closeAddCarPanel) {
        closeAddCarPanel.addEventListener('click', () => {
          if (window.bypassUnsavedChangesCheck || !hasUnsavedChanges('addCarForm')) {
            closeAddCarPanelFunction();
          } else {
            showUnsavedChangesConfirmation('addCarPanel');
          }
        });
      }
      
      // Close modal when clicking overlay
      if (adminOverlay) {
        adminOverlay.addEventListener('click', () => {
          if (addCarPanel.classList.contains('active') && !window.bypassUnsavedChangesCheck && hasUnsavedChanges('addCarForm')) {
            showUnsavedChangesConfirmation('addCarPanel');
          } else if (editCarPanel.classList.contains('active') && !window.bypassUnsavedChangesCheck && hasUnsavedChanges('editCarForm')) {
            showUnsavedChangesConfirmation('editCarPanel');
          } else {
            closeAllPanels();
          }
        });
      }
      
      // Edit Car Panel functionality
      const editCarPanel = document.getElementById('editCarPanel');
      const closeEditCarPanel = document.getElementById('closeEditCarPanel');
      

      
      if (closeEditCarPanel) {
        closeEditCarPanel.addEventListener('click', () => {
          if (window.bypassUnsavedChangesCheck || !hasUnsavedChanges('editCarForm')) {
            closeEditCarPanelFunction();
          } else {
            showUnsavedChangesConfirmation('editCarPanel');
          }
        });
      }
      
      // Edit Car Form Submit
      const editCarForm = document.getElementById('editCarForm');
      if (editCarForm && !editCarForm.dataset.initialized) {
        editCarForm.dataset.initialized = 'true';
        
        let isEditSubmitting = false; // Prevent double submission
        
        // Prevent any automatic form submission
        editCarForm.setAttribute('novalidate', 'true');
        editCarForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          if (isEditSubmitting) {
            return;
          }
          
          isEditSubmitting = true;
          
          const carId = editCarForm.dataset.carId;
          if (!carId) {
            showCustomAlert('Error: Car ID not found', 'error');
            return;
          }
          
          const formData = new FormData(editCarForm);
          const carData = Object.fromEntries(formData.entries());
          
          // Convert price fields to price_policy object
          const pricePolicy = {
            '1-2': carData.price_1_2 || '',
            '3-7': carData.price_3_7 || '',
            '8-20': carData.price_8_20 || '',
            '21-45': carData.price_21_45 || '',
            '46+': carData.price_46 || ''
          };
          
          // Remove individual price fields and add price_policy
          delete carData.price_1_2;
          delete carData.price_3_7;
          delete carData.price_8_20;
          delete carData.price_21_45;
          delete carData.price_46;
          carData.price_policy = pricePolicy;
          
          // Ensure all required fields are present
          carData.make_name = carData.make_name || '';
          carData.model_name = carData.model_name || '';
          carData.production_year = carData.production_year || '';
          carData.gear_type = carData.gear_type || '';
          carData.fuel_type = carData.fuel_type || '';
          carData.car_type = carData.car_type || '';
          carData.num_doors = carData.num_doors || '';
          carData.num_passengers = carData.num_passengers || '';
          carData.rca_insurance_price = carData.rca_insurance_price || '';
          carData.casco_insurance_price = carData.casco_insurance_price || '';
          
          // Handle engine_capacity for electric cars
          if (carData.fuel_type === 'Electric') {
            carData.engine_capacity = null;
          } else {
            carData.engine_capacity = carData.engine_capacity || '';
          }
          
          // Handle image uploads if files are selected
          const headImageFile = document.getElementById('editHeadImageInput').files[0];
          const galleryImageFiles = Array.from(document.getElementById('editGalleryImagesInput').files);
          
          console.log('🔍 EDIT CAR - Image upload detected:');
          console.log('  Head image file:', headImageFile);
          console.log('  Gallery image files:', galleryImageFiles);
          console.log('  Original carData:', carData);
          
          if (headImageFile || galleryImageFiles.length > 0) {
            // Create a new FormData and manually add all form fields to avoid duplicates
            const imageFormData = new FormData();
            
            // Add all form fields except files
            const formData = new FormData(editCarForm);
            for (let [key, value] of formData.entries()) {
              if (!(value instanceof File)) {
                imageFormData.append(key, value);
              }
            }
            
            console.log('🔍 EDIT CAR - Original FormData entries:');
            for (let [key, value] of imageFormData.entries()) {
              console.log(`  ${key}:`, value);
            }
            
            // Add price_policy as JSON string
            imageFormData.delete('price_1_2');
            imageFormData.delete('price_3_7');
            imageFormData.delete('price_8_20');
            imageFormData.delete('price_21_45');
            imageFormData.delete('price_46');
            imageFormData.append('price_policy', JSON.stringify(pricePolicy));
            
            console.log('🔍 EDIT CAR - Price policy being sent:', pricePolicy);
            
            // Add images
            if (headImageFile) {
              imageFormData.append('head_image', headImageFile);
              console.log('🔍 EDIT CAR - Added head image:', headImageFile.name, 'Size:', headImageFile.size);
            }
            // Only add gallery images that have actual content
            galleryImageFiles.forEach(file => {
              if (file && file.size > 0 && file.name) {
                imageFormData.append('gallery_images', file);
                console.log('🔍 EDIT CAR - Added gallery image:', file.name, 'Size:', file.size);
              }
            });
            
            console.log('🔍 EDIT CAR - Final FormData entries:');
            for (let [key, value] of imageFormData.entries()) {
              if (value instanceof File) {
                console.log(`  ${key}: [File] ${value.name} (${value.size} bytes)`);
              } else {
                console.log(`  ${key}:`, value);
              }
            }
            
            try {
              console.log('🔍 EDIT CAR - Sending PUT request with FormData to:', `${window.API_BASE_URL}/api/cars/${carId}`);
              const response = await fetch(`${window.API_BASE_URL}/api/cars/${carId}`, {
                method: 'PUT',
                body: imageFormData
              });
              
              console.log('🔍 EDIT CAR - Response status:', response.status, response.statusText);
              if (response.ok) {
                console.log('🔍 EDIT CAR - Success! Car updated successfully');
                showCustomAlert('Car updated successfully!', 'success');
                
                // Clear only the file inputs, but keep image previews
                document.getElementById('editHeadImageInput').value = '';
                document.getElementById('editGalleryImagesInput').value = '';
                
                // Reset original values since form is now clean
                storeOriginalValues('editCarForm');
                
                // Close the panel after successful save
                editCarPanel.classList.remove('active');
                adminOverlay.classList.remove('active');
                document.body.classList.remove('admin-popup-open');
                loadCars();
              } else {
                console.log('🔍 EDIT CAR - Error response received');
                const error = await response.json();
                console.log('🔍 EDIT CAR - Error details:', error);
                let errorMessage = 'Error updating car: ' + error.error;
                if (error.missingFields && error.missingFields.length > 0) {
                  errorMessage += '\n\nMissing fields:\n• ' + error.missingFields.join('\n• ');
                }
                showCustomAlert(errorMessage, 'error');
              }
            } catch (error) {
              console.error('Error updating car:', error);
              showCustomAlert('Error updating car', 'error');
            } finally {
              isEditSubmitting = false; // Reset submission flag
            }
          } else {
            // No images to upload, use JSON
            // Get current gallery images from preview
            const editGalleryImagesPreview = document.getElementById('editGalleryImagesPreview');
            const currentGalleryImages = [];
            if (editGalleryImagesPreview) {
              const galleryImageElements = editGalleryImagesPreview.querySelectorAll('img');
              galleryImageElements.forEach(img => {
                const src = img.getAttribute('src');
                if (src && src.includes('/uploads/')) {
                  // Extract the path from the full URL
                  const pathMatch = src.match(/\/uploads\/.*$/);
                  if (pathMatch) {
                    currentGalleryImages.push(pathMatch[0]);
                  }
                }
              });
            }
            
            // Add current gallery images to carData
            if (currentGalleryImages.length > 0) {
              carData.gallery_images = JSON.stringify(currentGalleryImages);
            }
            
            try {
              const response = await fetch(`${window.API_BASE_URL}/api/cars/${carId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(carData)
              });
              
              if (response.ok) {
                showCustomAlert('Car updated successfully!', 'success');
                
                // Clear only the file inputs, but keep image previews
                document.getElementById('editHeadImageInput').value = '';
                document.getElementById('editGalleryImagesInput').value = '';
                
                // Reset original values since form is now clean
                storeOriginalValues('editCarForm');
                
                // Close the panel after successful save
                editCarPanel.classList.remove('active');
                adminOverlay.classList.remove('active');
                document.body.classList.remove('admin-popup-open');
                loadCars();
              } else {
                const error = await response.json();
                let errorMessage = 'Error updating car: ' + error.error;
                if (error.missingFields && error.missingFields.length > 0) {
                  errorMessage += '\n\nMissing fields:\n• ' + error.missingFields.join('\n• ');
                }
                showCustomAlert(errorMessage, 'error');
              }
            } catch (error) {
              console.error('Error updating car:', error);
              showCustomAlert('Error updating car', 'error');
            } finally {
              isEditSubmitting = false; // Reset submission flag
            }
          }
        });
      }
      
      // Delete Car Button functionality
      const deleteCarBtn = document.getElementById('deleteCarBtn');
      if (deleteCarBtn) {
        deleteCarBtn.addEventListener('click', async () => {
          const carId = editCarForm.dataset.carId;
          if (!carId) {
            showCustomAlert('Error: Car ID not found', 'error');
            return;
          }
          
          if (confirm('Are you sure you want to delete this car? This action cannot be undone.')) {
            try {
              const response = await fetch(`${window.API_BASE_URL}/api/cars/${carId}`, {
                method: 'DELETE'
              });
              
              if (response.ok) {
                showCustomAlert('Car deleted successfully!', 'success');
                
                // Reset form and clear image previews
                editCarForm.reset();
                document.getElementById('editHeadImagePreview').innerHTML = '';
                document.getElementById('editGalleryImagesPreview').innerHTML = '';
                document.getElementById('editHeadImageInput').value = '';
                document.getElementById('editGalleryImagesInput').value = '';
                
                editCarPanel.classList.remove('active');
                adminOverlay.classList.remove('active');
                document.body.classList.remove('admin-popup-open');
                loadCars();
              } else {
                const error = await response.json();
                showCustomAlert('Error deleting car: ' + error.error, 'error');
              }
            } catch (error) {
              console.error('Error deleting car:', error);
              showCustomAlert('Error deleting car', 'error');
            }
          }
        });
      }
      
      // Image Upload Functionality
      initializeImageUploads();
      
      // Fuel Type Change Listener
      initializeFuelTypeListener();
    }
    
    function initializeFuelTypeListener() {
      // Handle both add car and edit car forms
      const addFuelTypeInput = document.querySelector('#addCarPanel select[name="fuel_type"]');
      const addEngineCapacityInput = document.querySelector('#addCarPanel input[name="engine_capacity"]');
      const editFuelTypeInput = document.querySelector('#editCarPanel select[name="fuel_type"]');
      const editEngineCapacityInput = document.querySelector('#editCarPanel input[name="engine_capacity"]');
      
      // Initialize add car form fuel type listener
      if (addFuelTypeInput && addEngineCapacityInput) {
        // Set initial state
        updateEngineCapacityField(addFuelTypeInput, addEngineCapacityInput);
        
        // Add change listener
        addFuelTypeInput.addEventListener('change', () => updateEngineCapacityField(addFuelTypeInput, addEngineCapacityInput));
      }
      
      // Initialize edit car form fuel type listener
      if (editFuelTypeInput && editEngineCapacityInput) {
        // Set initial state
        updateEngineCapacityField(editFuelTypeInput, editEngineCapacityInput);
        
        // Add change listener
        editFuelTypeInput.addEventListener('change', () => updateEngineCapacityField(editFuelTypeInput, editEngineCapacityInput));
      }
      
      function updateEngineCapacityField(fuelTypeInput, engineCapacityInput) {
        const fuelType = fuelTypeInput.value;
        
        if (fuelType === 'Electric') {
          engineCapacityInput.disabled = true;
          engineCapacityInput.value = '';
          engineCapacityInput.placeholder = 'Not applicable';
          engineCapacityInput.style.backgroundColor = '#e0e0e0';
          engineCapacityInput.style.color = '#666';
          engineCapacityInput.style.cursor = 'not-allowed';
        } else {
          engineCapacityInput.disabled = false;
          engineCapacityInput.placeholder = 'Enter engine capacity (e.g., 2.0)';
          engineCapacityInput.style.backgroundColor = '';
          engineCapacityInput.style.color = '';
          engineCapacityInput.style.cursor = '';
        }
      }
    }
    
    function initializeImageUploads() {
      // Add Car Image Uploads
      const addHeadImageButton = document.getElementById('addHeadImageButton');
      const addHeadImageInput = document.getElementById('addHeadImageInput');
      const addHeadImagePreview = document.getElementById('addHeadImagePreview');
      
      if (addHeadImageButton && addHeadImageInput && !addHeadImageButton.dataset.initialized) {

        addHeadImageButton.dataset.initialized = 'true';
        addHeadImageInput.dataset.initialized = 'true';
        
        addHeadImageButton.addEventListener('click', () => {

          addHeadImageInput.click();
        });
        addHeadImageInput.addEventListener('change', (e) => {
          
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              addHeadImagePreview.innerHTML = `
                <div style="position: relative; display: inline-block;">
                  <img src="${e.target.result}" alt="Head image preview" style="max-width: 200px; max-height: 150px; border-radius: 4px;">
                  <button type="button" class="btn btn-danger btn-sm" style="position: absolute; top: -8px; right: -8px; border-radius: 50%; width: 24px; height: 24px; padding: 0; font-size: 12px;" onclick="this.parentElement.remove()">×</button>
                </div>
              `;
            };
            reader.readAsDataURL(file);
          }
        });
      }
      
      const addGalleryImagesButton = document.getElementById('addGalleryImagesButton');
      const addGalleryImagesInput = document.getElementById('addGalleryImagesInput');
      const addGalleryImagesPreview = document.getElementById('addGalleryImagesPreview');
      
      if (addGalleryImagesButton && addGalleryImagesInput && !addGalleryImagesButton.dataset.initialized) {

        addGalleryImagesButton.dataset.initialized = 'true';
        addGalleryImagesInput.dataset.initialized = 'true';
        
        addGalleryImagesButton.addEventListener('click', () => {

          addGalleryImagesInput.click();
        });
        addGalleryImagesInput.addEventListener('change', (e) => {
          
          const files = Array.from(e.target.files);
          
          files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
              addGalleryImagesPreview.innerHTML += `
                <div style="position: relative; display: inline-block; margin: 5px;">
                  <img src="${e.target.result}" alt="Gallery image preview" style="max-width: 100px; max-height: 75px; border-radius: 4px;">
                  <button type="button" class="btn btn-danger btn-sm" style="position: absolute; top: -8px; right: -8px; border-radius: 50%; width: 24px; height: 24px; padding: 0; font-size: 12px;" onclick="this.parentElement.remove()">×</button>
                </div>
              `;
            };
            reader.readAsDataURL(file);
          });
        });
      }
      
      // Edit Car Image Uploads
      const editHeadImageButton = document.getElementById('editHeadImageButton');
      const editHeadImageInput = document.getElementById('editHeadImageInput');
      const editHeadImagePreview = document.getElementById('editHeadImagePreview');
      
      if (editHeadImageButton && editHeadImageInput && !editHeadImageButton.dataset.initialized) {
        editHeadImageButton.dataset.initialized = 'true';
        editHeadImageInput.dataset.initialized = 'true';
        
        editHeadImageButton.addEventListener('click', () => editHeadImageInput.click());
        editHeadImageInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              editHeadImagePreview.innerHTML = `
                <div style="position: relative; display: inline-block;">
                  <img src="${e.target.result}" alt="Head image preview" style="max-width: 200px; max-height: 150px; border-radius: 4px;">
                  <button type="button" class="btn btn-danger btn-sm" style="position: absolute; top: -8px; right: -8px; border-radius: 50%; width: 24px; height: 24px; padding: 0; font-size: 12px;" onclick="this.parentElement.remove()">×</button>
                </div>
              `;
            };
            reader.readAsDataURL(file);
          }
        });
      }
      
      const editGalleryImagesButton = document.getElementById('editGalleryImagesButton');
      const editGalleryImagesInput = document.getElementById('editGalleryImagesInput');
      const editGalleryImagesPreview = document.getElementById('editGalleryImagesPreview');
      
      if (editGalleryImagesButton && editGalleryImagesInput && !editGalleryImagesButton.dataset.initialized) {
        editGalleryImagesButton.dataset.initialized = 'true';
        editGalleryImagesInput.dataset.initialized = 'true';
        
        editGalleryImagesButton.addEventListener('click', () => editGalleryImagesInput.click());
        editGalleryImagesInput.addEventListener('change', (e) => {
          const files = Array.from(e.target.files);
          
          files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
              editGalleryImagesPreview.innerHTML += `
                <div style="position: relative; display: inline-block; margin: 5px;">
                  <img src="${e.target.result}" alt="Gallery image preview" style="max-width: 100px; max-height: 75px; border-radius: 4px;">
                  <button type="button" class="btn btn-danger btn-sm" style="position: absolute; top: -8px; right: -8px; border-radius: 50%; width: 24px; height: 24px; padding: 0; font-size: 12px;" onclick="this.parentElement.remove()">×</button>
                </div>
              `;
            };
            reader.readAsDataURL(file);
          });
        });
      }
      
      // Image removal functions
      window.removeHeadImage = async function() {
        const editHeadImagePreview = document.getElementById('editHeadImagePreview');
        const editForm = document.getElementById('editCarForm');
        const carId = editForm.dataset.carId;
        
        if (!carId) {
          console.error('No car ID found for head image deletion');
          return;
        }
        
        // Get the current head image path from the preview
        const headImage = editHeadImagePreview.querySelector('img');
        if (!headImage) {
          console.log('No head image to delete');
          return;
        }
        
        const imagePath = headImage.src.replace(window.API_BASE_URL, '');
        console.log('🔍 EDIT CAR - Deleting head image:', imagePath);
        
        try {
          const response = await fetch(`${window.API_BASE_URL}/api/cars/${carId}/images?path=${encodeURIComponent(imagePath)}&type=head`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            console.log('🔍 EDIT CAR - Head image deleted successfully');
            editHeadImagePreview.innerHTML = '';
          } else {
            const error = await response.json();
            console.error('🔍 EDIT CAR - Error deleting head image:', error);
            showCustomAlert('Error deleting head image: ' + error.error, 'error');
          }
        } catch (error) {
          console.error('🔍 EDIT CAR - Error deleting head image:', error);
          showCustomAlert('Error deleting head image', 'error');
        }
      };
      
      window.removeGalleryImage = async function(index) {
        const editGalleryImagesPreview = document.getElementById('editGalleryImagesPreview');
        const editForm = document.getElementById('editCarForm');
        const carId = editForm.dataset.carId;
        
        if (!carId) {
          console.error('No car ID found for gallery image deletion');
          return;
        }
        
        const images = editGalleryImagesPreview.querySelectorAll('div');
        if (!images[index]) {
          console.error('Gallery image not found at index:', index);
          return;
        }
        
        // Get the image path from the img element
        const imgElement = images[index].querySelector('img');
        if (!imgElement) {
          console.error('Image element not found at index:', index);
          return;
        }
        
        const imagePath = imgElement.src.replace(window.API_BASE_URL, '');
        console.log('🔍 EDIT CAR - Deleting gallery image:', imagePath, 'at index:', index);
        
        try {
          const response = await fetch(`${window.API_BASE_URL}/api/cars/${carId}/images?path=${encodeURIComponent(imagePath)}&type=gallery`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            console.log('🔍 EDIT CAR - Gallery image deleted successfully');
            images[index].remove();
          } else {
            const error = await response.json();
            console.error('🔍 EDIT CAR - Error deleting gallery image:', error);
            showCustomAlert('Error deleting gallery image: ' + error.error, 'error');
          }
        } catch (error) {
          console.error('🔍 EDIT CAR - Error deleting gallery image:', error);
          showCustomAlert('Error deleting gallery image', 'error');
        }
      };
      
      // Car Form Submit
      const carForm = document.getElementById('carForm');
      if (carForm && !carForm.dataset.initialized) {

        carForm.dataset.initialized = 'true';
        
        let isSubmitting = false; // Prevent double submission
        
        // Prevent any automatic form submission
        carForm.setAttribute('novalidate', 'true');
        
        // Log all form events for debugging
        carForm.addEventListener('click', (e) => {

        });
        
        carForm.addEventListener('input', (e) => {

        });
        

        
        carForm.addEventListener('submit', async (e) => {
          
          
          e.preventDefault();
          e.stopPropagation();
          
          if (isSubmitting) {
            return;
          }
          

          isSubmitting = true;
          
          const formData = new FormData(carForm);
          const carData = Object.fromEntries(formData.entries());
          

          
          // Convert price fields to price_policy object
          const pricePolicy = {
            '1-2': carData.price_1_2 || '',
            '3-7': carData.price_3_7 || '',
            '8-20': carData.price_8_20 || '',
            '21-45': carData.price_21_45 || '',
            '46+': carData.price_46 || ''
          };
          
          // Remove individual price fields and add price_policy
          delete carData.price_1_2;
          delete carData.price_3_7;
          delete carData.price_8_20;
          delete carData.price_21_45;
          delete carData.price_46;
          carData.price_policy = pricePolicy;
          
          // Ensure all required fields are present
          carData.make_name = carData.make_name || '';
          carData.model_name = carData.model_name || '';
          carData.production_year = carData.production_year || '';
          carData.gear_type = carData.gear_type || '';
          carData.fuel_type = carData.fuel_type || '';
          carData.car_type = carData.car_type || '';
          carData.num_doors = carData.num_doors || '';
          carData.num_passengers = carData.num_passengers || '';
          carData.rca_insurance_price = carData.rca_insurance_price || '';
          carData.casco_insurance_price = carData.casco_insurance_price || '';
          
          // Handle engine_capacity for electric cars
          if (carData.fuel_type === 'Electric') {
            carData.engine_capacity = null;
          } else {
            carData.engine_capacity = carData.engine_capacity || '';
          }
          
                  // Convert display text back to raw keys for backend processing
        if (carData.make_name && carData.make_name !== '') {
          // Make name is now a simple select - no conversion needed
          // The value from the select will be used directly
        }
        if (carData.model_name && carData.model_name !== '') {
          // Model name is now a simple select - no conversion needed
          // The value from the select will be used directly
        }
        if (carData.exterior_color && carData.exterior_color !== '') {
          // Check if we have a stored raw value first
          const exteriorColorInput = document.getElementById('add_exterior_color');
          if (exteriorColorInput && exteriorColorInput.dataset.rawValue) {
            carData.exterior_color = exteriorColorInput.dataset.rawValue;
          } else {
          const colorKeys = {
            'White': 'white',
            'Black': 'black',
            'Silver': 'silver',
            'Gray': 'gray',
            'Red': 'red',
            'Blue': 'blue',
            'Green': 'green',
            'Yellow': 'yellow',
            'Orange': 'orange',
            'Purple': 'purple',
            'Pink': 'pink',
            'Brown': 'brown',
            'Beige': 'beige',
            'Gold': 'gold',
            'Bronze': 'bronze',
            'Pearl White': 'pearl_white',
            'Metallic Black': 'metallic_black',
            'Metallic Silver': 'metallic_silver',
            'Metallic Gray': 'metallic_gray',
            'Metallic Red': 'metallic_red',
            'Metallic Blue': 'metallic_blue',
            'Metallic Green': 'metallic_green',
            'Metallic Yellow': 'metallic_yellow',
            'Metallic Orange': 'metallic_orange',
            'Metallic Purple': 'metallic_purple',
            'Metallic Pink': 'metallic_pink',
            'Metallic Brown': 'metallic_brown',
            'Metallic Beige': 'metallic_beige',
            'Metallic Gold': 'metallic_gold',
            'Metallic Bronze': 'metallic_bronze'
          };
          carData.exterior_color = colorKeys[carData.exterior_color] || carData.exterior_color;
          }
        }
        if (carData.interior_color && carData.interior_color !== '') {
          // Check if we have a stored raw value first
          const interiorColorInput = document.getElementById('add_interior_color');
          if (interiorColorInput && interiorColorInput.dataset.rawValue) {
            carData.interior_color = interiorColorInput.dataset.rawValue;
          }
        }
          
          // Handle image uploads if files are selected
          const headImageFile = document.getElementById('addHeadImageInput').files[0];
          const galleryImageFiles = Array.from(document.getElementById('addGalleryImagesInput').files);
          

          
          // Only proceed with one submission path
          if (headImageFile || galleryImageFiles.length > 0) {

            const imageFormData = new FormData();
            
            // Build FormData directly from the form
            const form = document.getElementById('carForm');
            const formData = new FormData(form);
            
            // Add all form fields to imageFormData
            for (let [key, value] of formData.entries()) {
              if (key.startsWith('price_')) {
                // Skip individual price fields as they'll be handled below
                continue;
              } else {
                imageFormData.append(key, value);
              }
            }
            
            // Always create and add price policy object
            const pricePolicy = {
              '1-2': formData.get('price_1_2') || '',
              '3-7': formData.get('price_3_7') || '',
              '8-20': formData.get('price_8_20') || '',
              '21-45': formData.get('price_21_45') || '',
              '46+': formData.get('price_46') || ''
            };
            imageFormData.append('price_policy', JSON.stringify(pricePolicy));
            
            // Add images
            if (headImageFile) {
              imageFormData.append('head_image', headImageFile);
            }
            // Only add gallery images that have actual content
            galleryImageFiles.forEach(file => {
              if (file && file.size > 0 && file.name) {
                imageFormData.append('gallery_images', file);
              }
            });
            
            try {

              const response = await fetch(`${window.API_BASE_URL}/api/cars`, {
                method: 'POST',
                body: imageFormData
              });
              
              if (response.ok) {
                showCustomAlert('Car added successfully!', 'success');
                
                // Reset form and clear image previews
                carForm.reset();
                document.getElementById('addHeadImagePreview').innerHTML = '';
                document.getElementById('addGalleryImagesPreview').innerHTML = '';
                document.getElementById('addHeadImageInput').value = '';
                document.getElementById('addGalleryImagesInput').value = '';
                
                // Reset original values since form is now clean
                storeOriginalValues('addCarForm');
                
                addCarPanel.classList.remove('active');
                adminOverlay.classList.remove('active');
                document.body.classList.remove('admin-popup-open');
                loadCars();
              } else {
                const error = await response.json();
                let errorMessage = 'Error adding car: ' + error.error;
                if (error.missingFields && error.missingFields.length > 0) {
                  errorMessage += '\n\nMissing fields:\n• ' + error.missingFields.join('\n• ');
                }
                showCustomAlert(errorMessage, 'error');
              }
            } catch (error) {
              console.error('💥 Network error adding car:', error);
              showCustomAlert('Error adding car', 'error');
            } finally {
              isSubmitting = false; // Reset submission flag
            }
          } else {
            // No images to upload, use JSON
            try {
              const response = await fetch(`${window.API_BASE_URL}/api/cars`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(carData)
              });
              
              if (response.ok) {
                showCustomAlert('Car added successfully!', 'success');
                
                // Reset form and clear image previews
                carForm.reset();
                document.getElementById('addHeadImagePreview').innerHTML = '';
                document.getElementById('addGalleryImagesPreview').innerHTML = '';
                document.getElementById('addHeadImageInput').value = '';
                document.getElementById('addGalleryImagesInput').value = '';
                
                addCarPanel.classList.remove('admin-popup-open');
                loadCars();
              } else {
                const error = await response.json();
                let errorMessage = 'Error adding car: ' + error.error;
                if (error.missingFields && error.missingFields.length > 0) {
                  errorMessage += '\n\nMissing fields:\n• ' + error.missingFields.join('\n• ');
                }
                showCustomAlert(errorMessage, 'error');
              }
            } catch (error) {
              console.error('Error adding car:', error);
              showCustomAlert('Error adding car', 'error');
            } finally {
              isSubmitting = false; // Reset submission flag
            }
          }
        });
      }
    }

    function initializeCouponForms() {
      
      // Add Coupon Button
      const showAddCouponBtn = document.getElementById('showAddCouponBtn');
      const addCouponPanel = document.getElementById('addCouponPanel');
      const closeAddCouponPanel = document.getElementById('closeAddCouponPanel');
      const couponOverlay = document.getElementById('couponOverlay');
      
      if (showAddCouponBtn) {
        showAddCouponBtn.addEventListener('click', () => {
          addCouponPanel.classList.add('active');
          couponOverlay.classList.add('active');
          document.body.classList.add('admin-popup-open');
        });
      }
      
      if (closeAddCouponPanel) {
        closeAddCouponPanel.addEventListener('click', () => {
          addCouponPanel.classList.remove('active');
          couponOverlay.classList.remove('active');
          document.body.classList.remove('admin-popup-open');
        });
      }
      
      // Close modal when clicking overlay
      if (couponOverlay) {
        couponOverlay.addEventListener('click', () => {
          addCouponPanel.classList.remove('active');
          couponOverlay.classList.remove('active');
          document.body.classList.remove('admin-popup-open');
        });
      }
      
      // Coupon Form Submit
      const couponForm = document.getElementById('couponForm');
      if (couponForm && !couponForm.dataset.initialized) {
        couponForm.dataset.initialized = 'true';
        let isSubmitting = false; // Prevent duplicate submissions
        couponForm.addEventListener('submit', async (e) => {
          console.log('🔍 Form submit event triggered');
          console.log('🔍 Event type:', e.type);
          console.log('🔍 Event target:', e.target);
          console.log('🔍 Event currentTarget:', e.currentTarget);
          console.log('🔍 Is submitting before check:', isSubmitting);
          console.log('🔍 Submitter:', e.submitter);
          
          e.preventDefault();
          
          if (isSubmitting) {
            console.log('🔄 Form submission already in progress, ignoring duplicate submit');
            return;
          }
          
          isSubmitting = true;
          
          const formData = new FormData(couponForm);
          const couponData = Object.fromEntries(formData.entries());
          
          console.log('🔍 Original form data:', couponData);
          
          // Client-side validation based on coupon type
          const couponType = couponData.type;
          const discountPercentage = couponData.discount_percentage;
          const freeDays = couponData.free_days;
          
          console.log('🔍 Coupon type:', couponType);
          console.log('🔍 Discount percentage:', discountPercentage);
          console.log('🔍 Free days:', freeDays);
          
          if (couponType === 'percentage') {
            console.log('🔍 Processing percentage type coupon');
            if (!discountPercentage || discountPercentage <= 0 || discountPercentage > 100) {
              console.log('❌ Invalid discount percentage:', discountPercentage);
              showCustomAlert('Please enter a valid discount percentage between 1 and 100', 'error');
              return;
            }
            // Remove free_days field for percentage type
            delete couponData.free_days;
            console.log('🔍 Removed free_days field for percentage type');
          } else if (couponType === 'free_days') {
            console.log('🔍 Processing free_days type coupon');
            if (!freeDays || freeDays <= 0) {
              console.log('❌ Invalid free days:', freeDays);
              showCustomAlert('Please enter a valid number of free days', 'error');
              return;
            }
            // Remove discount_percentage field for free_days type
            delete couponData.discount_percentage;
            console.log('🔍 Removed discount_percentage field for free_days type');
          }
          
          console.log('🔍 Final coupon data before sending:', couponData);
          
          try {

            console.log('📡 Request body:', JSON.stringify(couponData, null, 2));
            
            const response = await fetch(`${window.API_BASE_URL}/api/coupons`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(couponData)
            });
            
            console.log('📡 Response status:', response.status, response.statusText);
            
            if (response.ok) {
              showCustomAlert('Coupon added successfully!', 'success');
              couponForm.reset();
              addCouponPanel.classList.remove('active');
              couponOverlay.classList.remove('active');
              document.body.classList.remove('admin-popup-open');
              loadCoupons();
            } else {
              console.log('❌ Error response received');
              const error = await response.json();
              console.log('❌ Error details:', error);
              showCustomAlert('Error adding coupon: ' + error.error, 'error');
            }
          } catch (error) {
            console.error('Error adding coupon:', error);
            showCustomAlert('Error adding coupon', 'error');
          } finally {
            isSubmitting = false; // Reset submission flag
          }
        });
      }
      
      // Coupon Type Selection Handler
      const couponType = document.getElementById('couponType');
      const editCouponType = document.getElementById('editCouponType');
      
      function handleCouponTypeChange(typeSelect, percentageField, freeDaysField) {
        if (typeSelect) {
          typeSelect.addEventListener('change', function() {
            const selectedType = this.value;
            const percentageInput = percentageField.querySelector('input[name="discount_percentage"]');
            const freeDaysInput = freeDaysField.querySelector('input[name="free_days"]');
            
            if (selectedType === 'percentage') {
              percentageField.style.display = 'block';
              freeDaysField.style.display = 'none';
              percentageInput.required = true;
              freeDaysInput.required = false;
              freeDaysInput.value = '';
            } else if (selectedType === 'free_days') {
              percentageField.style.display = 'none';
              freeDaysField.style.display = 'block';
              percentageInput.required = false;
              freeDaysInput.required = true;
              percentageInput.value = '';
            }
          });
        }
      }
      
      // Initialize coupon type handlers
      if (couponType) {
        handleCouponTypeChange(
          couponType, 
          document.getElementById('percentageField'), 
          document.getElementById('freeDaysField')
        );
        // Set initial state for add form
        const percentageInput = document.getElementById('percentageField').querySelector('input[name="discount_percentage"]');
        const freeDaysInput = document.getElementById('freeDaysField').querySelector('input[name="free_days"]');
        if (percentageInput) percentageInput.required = true;
        if (freeDaysInput) freeDaysInput.required = false;
      }
      

      
      if (editCouponType) {
        handleCouponTypeChange(
          editCouponType, 
          document.getElementById('editPercentageField'), 
          document.getElementById('editFreeDaysField')
        );
      }
      
      // Edit Coupon Form Submit
      const editCouponForm = document.getElementById('editCouponForm');
      if (editCouponForm) {
        editCouponForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const couponId = editCouponForm.dataset.couponId;
          if (!couponId) {
            showCustomAlert('No coupon ID found', 'error');
            return;
          }
          
          const formData = new FormData(editCouponForm);
          const couponData = Object.fromEntries(formData.entries());
          
          // Client-side validation based on coupon type
          const couponType = couponData.type;
          const discountPercentage = couponData.discount_percentage;
          const freeDays = couponData.free_days;
          
          if (couponType === 'percentage') {
            if (!discountPercentage || discountPercentage <= 0 || discountPercentage > 100) {
              showCustomAlert('Please enter a valid discount percentage between 1 and 100', 'error');
              return;
            }
            // Remove free_days field for percentage type
            delete couponData.free_days;
          } else if (couponType === 'free_days') {
            if (!freeDays || freeDays <= 0) {
              showCustomAlert('Please enter a valid number of free days', 'error');
              return;
            }
            // Remove discount_percentage field for free_days type
            delete couponData.discount_percentage;
          }
          
          try {
            console.log('🔍 Edit coupon - Coupon ID:', couponId);
            console.log('🔍 Edit coupon - Data being sent:', couponData);

            
            // Test if server is reachable
            try {
              const testResponse = await fetch(`${window.API_BASE_URL}/api/coupons`);
              console.log('🔍 Server reachability test - Status:', testResponse.status);
            } catch (testError) {
              console.error('❌ Server not reachable:', testError);
            }
            
            const response = await fetch(`${window.API_BASE_URL}/api/coupons/${couponId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(couponData)
            });
            
            console.log('🔍 Edit coupon - Response status:', response.status);
            if (response.ok) {
              console.log('🔍 Edit coupon - Success response');
              showCustomAlert('Coupon updated successfully!', 'success');
              editCouponForm.reset();
              const editCouponPanel = document.getElementById('editCouponPanel');
              const couponOverlay = document.getElementById('couponOverlay');
              if (editCouponPanel && couponOverlay) {
                editCouponPanel.classList.remove('active');
                couponOverlay.classList.remove('active');
                document.body.classList.remove('admin-popup-open');
              }
              loadCoupons();
            } else {
              console.log('🔍 Edit coupon - Error response');
              const error = await response.json();
              console.log('🔍 Edit coupon - Error details:', error);
              showCustomAlert('Error updating coupon: ' + error.error, 'error');
            }
          } catch (error) {
            console.error('❌ Error updating coupon:', error);
            console.error('❌ Error type:', error.name);
            console.error('❌ Error message:', error.message);
            showCustomAlert('Error updating coupon: ' + error.message, 'error');
          }
        });
      }
    }

    // Edit and Delete Functions
    async function editCar(carId) {
      try {
        const response = await fetch(`${window.API_BASE_URL}/api/cars/${carId}`);
        const car = await response.json();
        
        if (!response.ok) {
          showCustomAlert('Error loading car data: ' + car.error, 'error');
          return;
        }
        
        // Populate the edit form with car data
        const editForm = document.getElementById('editCarForm');
        if (!editForm) return;
        
        // Fill in all the form fields
        const makeInput = editForm.querySelector('select[name="make_name"]');
        const modelInput = editForm.querySelector('input[name="model_name"]');
        const productionYearSelect = editForm.querySelector('select[name="production_year"]');
        const gearTypeSelect = editForm.querySelector('select[name="gear_type"]');
        const fuelTypeSelect = editForm.querySelector('select[name="fuel_type"]');
        const engineCapacityInput = editForm.querySelector('input[name="engine_capacity"]');
        const carTypeSelect = editForm.querySelector('select[name="car_type"]');
        const numDoorsSelect = editForm.querySelector('select[name="num_doors"]');
        const numPassengersSelect = editForm.querySelector('select[name="num_passengers"]');
        
        if (makeInput) makeInput.value = car.make_name || '';
        if (modelInput) modelInput.value = car.model_name || '';
        if (productionYearSelect) productionYearSelect.value = car.production_year || '';
        if (gearTypeSelect) gearTypeSelect.value = car.gear_type || '';
        if (fuelTypeSelect) fuelTypeSelect.value = car.fuel_type || '';
        if (engineCapacityInput) engineCapacityInput.value = car.engine_capacity || '';
        if (carTypeSelect) carTypeSelect.value = car.car_type || '';
        if (numDoorsSelect) numDoorsSelect.value = car.num_doors || '';
        if (numPassengersSelect) numPassengersSelect.value = car.num_passengers || '';
        
        // Fill in price policy fields
        if (car.price_policy) {
          const price1_2Input = editForm.querySelector('input[name="price_1_2"]');
          const price3_7Input = editForm.querySelector('input[name="price_3_7"]');
          const price8_20Input = editForm.querySelector('input[name="price_8_20"]');
          const price21_45Input = editForm.querySelector('input[name="price_21_45"]');
          const price46Input = editForm.querySelector('input[name="price_46"]');
          
          if (price1_2Input) price1_2Input.value = car.price_policy['1-2'] || '';
          if (price3_7Input) price3_7Input.value = car.price_policy['3-7'] || '';
          if (price8_20Input) price8_20Input.value = car.price_policy['8-20'] || '';
          if (price21_45Input) price21_45Input.value = car.price_policy['21-45'] || '';
          if (price46Input) price46Input.value = car.price_policy['46+'] || '';
        }
        
        // Fill in additional specifications
        const luggageInput = editForm.querySelector('input[name="luggage"]');
        const mileageInput = editForm.querySelector('input[name="mileage"]');
        const driveSelect = editForm.querySelector('select[name="drive"]');
        const fuelEconomyInput = editForm.querySelector('input[name="fuel_economy"]');
        const exteriorColorInput = editForm.querySelector('input[name="exterior_color"]');
        const interiorColorInput = editForm.querySelector('input[name="interior_color"]');
        const rcaInsuranceInput = editForm.querySelector('input[name="rca_insurance_price"]');
        const cascoInsuranceInput = editForm.querySelector('input[name="casco_insurance_price"]');
        
        if (luggageInput) luggageInput.value = car.luggage || '';
        if (mileageInput) mileageInput.value = car.mileage || '';
        if (driveSelect) driveSelect.value = car.drive || '';
        if (fuelEconomyInput) fuelEconomyInput.value = car.fuel_economy || '';
        if (exteriorColorInput) exteriorColorInput.value = car.exterior_color || '';
        if (interiorColorInput) interiorColorInput.value = car.interior_color || '';
        if (rcaInsuranceInput) rcaInsuranceInput.value = car.rca_insurance_price || '';
        if (cascoInsuranceInput) cascoInsuranceInput.value = car.casco_insurance_price || '';
        
        // Handle booked_until date
        const bookedUntilInput = editForm.querySelector('input[name="booked_until"]');
        if (bookedUntilInput) {
          if (car.booked_until) {
            const date = new Date(car.booked_until);
            const dateString = date.toISOString().split('T')[0];
            bookedUntilInput.value = dateString;
          } else {
            bookedUntilInput.value = '';
          }
        }
        
        // Show current images if they exist
        const editHeadImagePreview = document.getElementById('editHeadImagePreview');
        if (car.head_image && editHeadImagePreview) {
          editHeadImagePreview.innerHTML = `
            <div style="position: relative; display: inline-block;">
              <img src="${window.API_BASE_URL + car.head_image}" alt="Current head image" style="max-width: 200px; max-height: 150px; border-radius: 4px;">
              <button type="button" class="btn btn-danger btn-sm" style="position: absolute; top: -8px; right: -8px; border-radius: 50%; width: 24px; height: 24px; padding: 0; font-size: 12px;" onclick="removeHeadImage()">×</button>
            </div>
          `;
        } else {
          console.log('🔍 EDIT CAR - No head image to display');
          if (editHeadImagePreview) editHeadImagePreview.innerHTML = '';
        }
        
        const editGalleryImagesPreview = document.getElementById('editGalleryImagesPreview');
        if (car.gallery_images && car.gallery_images.length > 0 && editGalleryImagesPreview) {
          console.log('🔍 EDIT CAR - Displaying gallery images:', car.gallery_images.length, 'images');
          editGalleryImagesPreview.innerHTML = car.gallery_images.map((img, index) => `
            <div style="position: relative; display: inline-block; margin: 5px;">
              <img src="${window.API_BASE_URL + img}" alt="Gallery image" style="max-width: 100px; max-height: 75px; border-radius: 4px;">
              <button type="button" class="btn btn-danger btn-sm" style="position: absolute; top: -8px; right: -8px; border-radius: 50%; width: 24px; height: 24px; padding: 0; font-size: 12px;" onclick="removeGalleryImage(${index})">×</button>
            </div>
          `).join('');
        } else {
          console.log('🔍 EDIT CAR - No gallery images to display');
          if (editGalleryImagesPreview) editGalleryImagesPreview.innerHTML = '';
        }
        
        // Store car ID for form submission
        editForm.dataset.carId = carId;
        
        // Show the edit panel
        const editCarPanel = document.getElementById('editCarPanel');
        const adminOverlay = document.getElementById('adminOverlay');
        editCarPanel.classList.add('active');
        adminOverlay.classList.add('active');
        document.body.classList.add('admin-popup-open');
        
        // Store original values after a short delay to ensure form is populated
        setTimeout(() => storeOriginalValues('editCarForm'), 100);
        
      } catch (error) {
        console.error('Error loading car for editing:', error);
        showCustomAlert('Error loading car data', 'error');
      }
    }

    async function deleteCar(carId) {
      if (confirm('Are you sure you want to delete this car?')) {
        try {
          const response = await fetch(`${window.API_BASE_URL}/api/cars/${carId}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            showCustomAlert('Car deleted successfully!', 'success');
            loadCars();
          } else {
            const error = await response.json();
            showCustomAlert('Error deleting car: ' + error.error, 'error');
          }
        } catch (error) {
          console.error('Error deleting car:', error);
          showCustomAlert('Error deleting car', 'error');
        }
      }
    }

    async function editCoupon(couponId) {
      console.log('🔍 Loading coupon data for ID:', couponId);
      try {
        const response = await fetch(`${window.API_BASE_URL}/api/coupons/${couponId}`);
        const coupon = await response.json();
        console.log('🔍 Loaded coupon data:', coupon);
        
        if (!response.ok) {
          showCustomAlert('Error loading coupon data: ' + coupon.error, 'error');
          return;
        }
        
        // Populate the edit form with coupon data
        const editForm = document.getElementById('editCouponForm');
        if (!editForm) return;
        
        // Fill in the form fields
        const codeInput = editForm.querySelector('input[name="code"]');
        const typeSelect = editForm.querySelector('select[name="type"]');
        const discountPercentageInput = editForm.querySelector('input[name="discount_percentage"]');
        const freeDaysInput = editForm.querySelector('input[name="free_days"]');
        const descriptionInput = editForm.querySelector('textarea[name="description"]');
        const expiresAtInput = editForm.querySelector('input[name="expires_at"]');
        const isActiveSelect = editForm.querySelector('select[name="is_active"]');
        
        console.log('🔍 Populating form fields...');
        if (codeInput) codeInput.value = coupon.code || '';
        if (typeSelect) typeSelect.value = coupon.type || 'percentage';
        if (discountPercentageInput) discountPercentageInput.value = coupon.discount_percentage || '';
        if (freeDaysInput) freeDaysInput.value = coupon.free_days || '';
        if (descriptionInput) descriptionInput.value = coupon.description || '';
        if (isActiveSelect) isActiveSelect.value = coupon.is_active ? '1' : '0';
        console.log('🔍 Form fields populated');
        
        // Handle expiry date
        if (expiresAtInput && coupon.expires_at) {
          const date = new Date(coupon.expires_at);
          const dateString = date.toISOString().slice(0, 16); // Format for datetime-local
          expiresAtInput.value = dateString;
        } else if (expiresAtInput) {
          expiresAtInput.value = '';
        }
        
        // Trigger the type change event to show/hide appropriate fields
        if (typeSelect) {
          typeSelect.dispatchEvent(new Event('change'));
        }
        
        // Show the edit panel
        const editCouponPanel = document.getElementById('editCouponPanel');
        const couponOverlay = document.getElementById('couponOverlay');
        if (editCouponPanel && couponOverlay) {
          editCouponPanel.classList.add('active');
          couponOverlay.classList.add('active');
          document.body.classList.add('admin-popup-open');
        }
        
        // Store the coupon ID for the form submission
        editForm.dataset.couponId = couponId;
        
      } catch (error) {
        console.error('Error loading coupon data:', error);
        showCustomAlert('Error loading coupon data', 'error');
      }
    }

    async function deleteCoupon(couponId) {
      if (confirm('Are you sure you want to delete this coupon?')) {
        try {
          const response = await fetch(`${window.API_BASE_URL}/api/coupons/${couponId}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            showCustomAlert('Coupon deleted successfully!', 'success');
            loadCoupons();
          } else {
            const error = await response.json();
            showCustomAlert('Error deleting coupon: ' + error.error, 'error');
          }
        } catch (error) {
          console.error('Error deleting coupon:', error);
          showCustomAlert('Error deleting coupon', 'error');
        }
      }
    }


    </script>
    
            <!-- Global formatting function -->
        <script>
            // Global formatting function
            function formatDisplayText(rawKey) {
              if (!rawKey) return '';
              return rawKey
                .split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
            }
        </script>
        
        <!-- Autocomplete functionality -->
        <script>
            // Initialize autocomplete functionality
            function initializeAutocomplete() {
          // Data for autocomplete
          const makes = [
            'bmw', 'mercedes', 'audi', 'volkswagen', 'toyota', 'honda', 'ford', 'chevrolet', 
            'nissan', 'hyundai', 'kia', 'mazda', 'subaru', 'volvo', 'lexus', 'infiniti', 
            'acura', 'buick', 'cadillac', 'chrysler', 'dodge', 'jeep', 'ram', 'gmc', 
            'pontiac', 'saturn', 'oldsmobile', 'plymouth', 'eagle', 'tesla', 'ferrari', 
            'lamborghini', 'porsche', 'maserati', 'aston_martin', 'bentley', 'rolls_royce', 
            'mclaren', 'bugatti', 'koenigsegg', 'pagani', 'rimac', 'lotus', 'alpine', 
            'caterham', 'ariel', 'noble', 'radical', 'ultima', 'zenvo', 'gumpert', 
            'saleen', 'hennessey', 'callaway', 'ruf', 'techart', 'mansory', 'brabus', 
            'alpina', 'hamann', 'hartge', 'ac_schnitzer', 'dinan', 'vorsteiner', 'hre', 
            'adv_1', 'forgiato', 'vossen', 'rohana', 'titan7', 'volk', 'work', 'rays', 
            'enkei', 'bbs', 'oz', 'ssr', 'weds', 'gram_lights', 'volk_racing', 
            'work_emotion', 'volk_te37', 'volk_ce28', 'volk_re30', 'volk_gt_c', 
            'volk_gt_n', 'volk_gt_v', 'volk_gt_u', 'volk_gt_f', 'volk_gt_m', 'volk_gt_s', 
            'volk_gt_t', 'volk_gt_w', 'volk_gt_x', 'volk_gt_y', 'volk_gt_z'
          ];
          
          const models = [
            '3_series', '5_series', 'x3', 'x5', 'x7', 'z4', 'm3', 'm5', 'm8',
            'c_class', 'e_class', 's_class', 'gla', 'glc', 'gle', 'gls', 'amg_gt',
            'a3', 'a4', 'a6', 'a8', 'q3', 'q5', 'q7', 'q8', 'rs6', 'rs7',
            'golf', 'passat', 'tiguan', 'atlas', 'id4',
            'camry', 'corolla', 'rav4', 'highlander', 'prius',
            'civic', 'accord', 'cr_v', 'pilot',
            'focus', 'fusion', 'escape', 'explorer',
            'cruze', 'malibu', 'equinox', 'tahoe',
            'sentra', 'altima', 'rogue', 'murano',
            'elantra', 'sonata', 'tucson', 'santa_fe',
            'forte', 'optima', 'sportage', 'sorento',
            'mazda3', 'mazda6', 'cx5', 'cx9',
            'impreza', 'legacy', 'forester', 'outback',
            's60', 's90', 'xc40', 'xc60', 'xc90',
            'es', 'ls', 'rx', 'nx', 'gx', 'lx',
            'q50', 'q70', 'qx50', 'qx60',
            'tlx', 'rlx', 'rdx', 'mdx',
            'regal', 'lacrosse', 'encore', 'enclave',
            'cts', 'ct6', 'xt4', 'xt5', 'escalade',
            '300', 'pacifica', 'charger', 'challenger', 'durango',
            'cherokee', 'grand_cherokee', 'wrangler',
            '1500', '2500', '3500', 'terrain', 'acadia', 'yukon',
            'model_3', 'model_s', 'model_x', 'model_y',
            'f8', 'sf90', 'roma', 'huracan', 'aventador', 'urus',
            '911', 'cayenne', 'macan', 'ghibli', 'quattroporte', 'levante',
            'db11', 'vantage', 'dbs', 'continental', 'flying_spur', 'bentayga',
            'phantom', 'ghost', 'cullinan', '720s', '765lt', 'artura',
            'chiron', 'veyron', 'jesko', 'regera', 'huayra', 'zonda',
            'nevera', 'emira', 'evija', 'a110', 'seven', 'atom', 'm600',
            'sr3', 'evo', 'ts1', 'apollo', 's7', 'venom', 'corvette',
            'ctr', 'gt_street', 'mercedes', 'bmw', 'wheels'
          ];
          
          const colors = [
            'white', 'black', 'silver', 'gray', 'red', 'blue', 'green', 'yellow', 'orange', 
            'purple', 'brown', 'beige', 'gold', 'bronze', 'copper', 'chrome', 'matte_black', 
            'matte_white', 'matte_gray', 'matte_red', 'matte_blue', 'matte_green', 'matte_yellow', 
            'matte_orange', 'matte_purple', 'matte_brown', 'matte_beige', 'matte_gold', 
            'matte_bronze', 'matte_copper', 'matte_chrome', 'pearl_white', 'pearl_black', 
            'pearl_silver', 'pearl_gray', 'pearl_red', 'pearl_blue', 'pearl_green', 'pearl_yellow', 
            'pearl_orange', 'pearl_purple', 'pearl_brown', 'pearl_beige', 'pearl_gold', 
            'pearl_bronze', 'pearl_copper', 'pearl_chrome', 'metallic_white', 'metallic_black', 
            'metallic_silver', 'metallic_gray', 'metallic_red', 'metallic_blue', 'metallic_green', 
            'metallic_yellow', 'metallic_orange', 'metallic_purple', 'metallic_brown', 'metallic_beige', 
            'metallic_gold', 'metallic_bronze', 'metallic_copper', 'metallic_chrome', 'candy_white', 
            'candy_black', 'candy_silver', 'candy_gray', 'candy_red', 'candy_blue', 'candy_green', 
            'candy_yellow', 'candy_orange', 'candy_purple', 'candy_brown', 'candy_beige', 'candy_gold', 
            'candy_bronze', 'candy_copper', 'candy_chrome', 'chameleon_white', 'chameleon_black', 
            'chameleon_silver', 'chameleon_gray', 'chameleon_red', 'chameleon_blue', 'chameleon_green', 
            'chameleon_yellow', 'chameleon_orange', 'chameleon_purple', 'chameleon_brown', 'chameleon_beige', 
            'chameleon_gold', 'chameleon_bronze', 'chameleon_copper', 'chameleon_chrome'
          ];
          
          // Function to create autocomplete
          function createAutocomplete(inputId, dropdownId, options) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            
            if (!input || !dropdown) return;
            
            let selectedIndex = -1;
            
            function filterOptions(query) {
              return options.filter(option => 
                option.toLowerCase().includes(query.toLowerCase())
              );
            }
            
            function highlightMatch(text, query) {
              const regex = new RegExp(`(${query})`, 'gi');
              return text.replace(regex, '<span class="autocomplete-highlight">$1</span>');
            }
            

            
            function showDropdown(filteredOptions) {
              dropdown.innerHTML = '';
              
              if (filteredOptions.length === 0) {
                dropdown.style.display = 'none';
                return;
              }
              
              filteredOptions.forEach((option, index) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                
                // Format display text using the new function
                const displayText = formatDisplayText(option);
                
                item.innerHTML = highlightMatch(displayText, query);
                item.dataset.value = option;
                
                item.addEventListener('click', () => {
                  // Set the formatted display text for user experience
                  input.value = displayText;
                  // Store the raw key in a data attribute for validation
                  input.dataset.rawValue = option;
                  dropdown.style.display = 'none';
                  selectedIndex = -1;
                  input.classList.remove('is-invalid'); // Clear any error state
                  input.classList.add('is-valid'); // Mark as valid
                });
                
                item.addEventListener('mouseenter', () => {
                  selectedIndex = index;
                  updateSelection();
                });
                
                dropdown.appendChild(item);
              });
              
              dropdown.style.display = 'block';
              selectedIndex = -1;
              updateSelection();
            }
            
            function updateSelection() {
              const items = dropdown.querySelectorAll('.autocomplete-item');
              items.forEach((item, index) => {
                item.classList.toggle('selected', index === selectedIndex);
              });
            }
            
            function hideDropdown() {
              dropdown.style.display = 'none';
              selectedIndex = -1;
            }
            
            // Event listeners
            input.addEventListener('input', (e) => {
              const query = e.target.value.trim();
              
              // Only show dropdown if there are actual characters typed
              if (query.length === 0) {
                hideDropdown();
                return;
              }
              
              const filteredOptions = filterOptions(query);
              
              // Update the showDropdown function to use the trimmed query for highlighting
              function showDropdownWithQuery(filteredOptions, query) {
                dropdown.innerHTML = '';
                
                if (filteredOptions.length === 0) {
                  dropdown.style.display = 'none';
                  return;
                }
                
                filteredOptions.forEach((option, index) => {
                  const item = document.createElement('div');
                  item.className = 'autocomplete-item';
                  
                  // Format display text using the new function
                  const displayText = formatDisplayText(option);
                  
                  item.innerHTML = highlightMatch(displayText, query);
                  item.dataset.value = option;
                  
                  item.addEventListener('click', () => {
                    // Set the formatted display text for user experience
                    input.value = displayText;
                    // Store the raw key in a data attribute for validation
                    input.dataset.rawValue = option;
                    dropdown.style.display = 'none';
                    selectedIndex = -1;
                    input.classList.remove('is-invalid'); // Clear any error state
                    input.classList.add('is-valid'); // Mark as valid
                  });
                  
                  item.addEventListener('mouseenter', () => {
                    selectedIndex = index;
                    updateSelection();
                  });
                  
                  dropdown.appendChild(item);
                });
                
                dropdown.style.display = 'block';
                selectedIndex = -1;
                updateSelection();
              }
              
              showDropdownWithQuery(filteredOptions, query);
              
              // Don't validate during typing - let user type freely
              // Validation will happen on blur or form submission
            });
            
            input.addEventListener('keydown', (e) => {
              const items = dropdown.querySelectorAll('.autocomplete-item');
              
              if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateSelection();
              } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection();
              } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && items[selectedIndex]) {
                  input.value = items[selectedIndex].dataset.value;
                  hideDropdown();
                }
              } else if (e.key === 'Escape') {
                hideDropdown();
              }
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
              if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                hideDropdown();
              }
            });
            
            // Add validation on blur
            input.addEventListener('blur', () => {
              setTimeout(() => {
                const currentValue = input.value;
                const rawValue = input.dataset.rawValue;
                
                // Check if the value is a valid option (either exact match or has stored raw value)
                const isValid = options.includes(currentValue) || (rawValue && options.includes(rawValue));
                
                if (currentValue && !isValid) {
                  // Only clear if it's not a valid option and not empty
                  input.value = '';
                  delete input.dataset.rawValue;
                  input.classList.add('is-invalid');
                  input.classList.remove('is-valid');
                } else if (currentValue && isValid) {
                  input.classList.remove('is-invalid');
                  input.classList.add('is-valid');
                } else {
                  input.classList.remove('is-invalid', 'is-valid');
                }
              }, 200);
            });
          }
          
                      // Initialize autocomplete for each field
            // Make name is now a simple select dropdown - no autocomplete needed
            // Model name is now a simple text input - no autocomplete needed
          createAutocomplete('add_exterior_color', 'add_exterior_color_dropdown', colors);
          createAutocomplete('add_interior_color', 'add_interior_color_dropdown', colors);
        }
        
        // Initialize autocomplete when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
          initializeAutocomplete();
        });

        // Spinning Wheel Management Functions
        function initializeSpinningWheel() {
          const openSpinningWheelBtn = document.getElementById('openSpinningWheelBtn');
          const addWheelBtn = document.getElementById('addWheelBtn');
          
          if (openSpinningWheelBtn) {
            openSpinningWheelBtn.addEventListener('click', () => {
              // Open spinning wheel in a modal popup
              const modal = new bootstrap.Modal(document.getElementById('spinningWheelModal'));
              const iframe = document.getElementById('spinningWheelIframe');
              
              // Refresh the iframe content to get latest data
              if (iframe) {
                iframe.src = iframe.src;
              }
              
              modal.show();
            });
          }
          
          if (addWheelBtn) {
            addWheelBtn.addEventListener('click', () => {
              showNewWheelForm();
            });
          }
          
          // Initialize wheel edit form
          initializeWheelEditForm();
          
          // Load spinning wheel data when tab is shown
          loadSpinningWheelData();
        }

        function showWheelConfiguration(wheelId) {
          loadWheelForEdit(wheelId);
        }

        function showNewWheelForm() {
          resetWheelEditForm();
          showWheelConfigurationPanel();
        }

        function initializeWheelEditForm() {
          const wheelEditForm = document.getElementById('wheelEditForm');
          const activateWheelBtn = document.getElementById('activateWheelBtn');
          
          if (wheelEditForm) {
            wheelEditForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              await saveWheel();
            });
          }
          
          if (activateWheelBtn) {
            activateWheelBtn.addEventListener('click', async () => {
              await activateCurrentWheel();
            });
          }
          
          // Initialize filter buttons
          const filterButtons = document.querySelectorAll('[data-filter]');
          filterButtons.forEach(button => {
            button.addEventListener('click', () => {
              filterButtons.forEach(btn => btn.classList.remove('active'));
              button.classList.add('active');
              filterCoupons(button.dataset.filter);
            });
          });
        }

        async function loadSpinningWheelData() {
          try {
            // Load all spinning wheels
            const wheelsResponse = await fetch(`${window.API_BASE_URL}/api/spinning-wheels`);
            const wheels = await wheelsResponse.json();
            
            // Load coupons for all wheels
            const couponsResponse = await fetch(`${window.API_BASE_URL}/api/coupons`);
            const coupons = await couponsResponse.json();
            
            // Update available coupons info
            const availableCouponsInfo = document.getElementById('availableCouponsInfo');
            if (availableCouponsInfo) {
              const activeCoupons = coupons.filter(coupon => coupon.is_active === 1);
              const wheelEnabledCoupons = activeCoupons.filter(coupon => coupon.wheel_enabled === 1);
              availableCouponsInfo.innerHTML = `
                <strong>${wheelEnabledCoupons.length}</strong> of ${activeCoupons.length} active coupons enabled for wheels
              `;
              availableCouponsInfo.className = 'alert alert-info';
            }
            
            // Load wheels list
            const wheelsList = document.getElementById('wheelsList');
            if (wheelsList) {
              if (wheels.length === 0) {
                wheelsList.innerHTML = '<div class="alert alert-warning">No spinning wheels configured.</div>';
              } else {
                                wheelsList.innerHTML = wheels.map(wheel => `
                  <div class="list-group-item d-flex justify-content-between align-items-center wheel-item" 
                       onclick="showWheelConfiguration(${wheel.id})" 
                       style="cursor: pointer; border-left: 4px solid ${wheel.is_active ? '#28a745' : '#6c757d'}; transition: all 0.2s ease;">
                    <div class="flex-grow-1">
                      <div class="d-flex align-items-center mb-1">
                        <strong class="me-2">${wheel.name}</strong>
                      </div>
                      <small class="text-muted d-block">${wheel.description || 'No description'}</small>
                    </div>
                    <div class="d-flex align-items-center gap-1" onclick="event.stopPropagation();">
                      <button class="btn btn-sm ${wheel.is_active ? 'btn-success' : 'btn-outline-secondary'}" 
                              style="${!wheel.is_active ? 'color: #6c757d !important; border-color: #6c757d !important;' : ''}"
                              onclick="activateWheel(${wheel.id})" title="${wheel.is_active ? 'Currently Active' : 'Activate this wheel'}">
                        <i class="fa ${wheel.is_active ? 'fa-check' : 'fa-play'}"></i>
                        ${wheel.is_active ? 'Active' : 'Activate'}
                      </button>
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteWheel(${wheel.id})" title="Delete this wheel">
                        <i class="fa fa-trash"></i>
                      </button>
                    </div>
                  </div>
                `).join('');
              }
            }
            
          } catch (error) {
            console.error('Error loading spinning wheel data:', error);
          }
        }

        async function activateWheel(wheelId) {
          try {
            // First, get the current wheel to check if it's already active
            const wheelResponse = await fetch(`${window.API_BASE_URL}/api/spinning-wheels/${wheelId}`);
            if (!wheelResponse.ok) {
              showCustomAlert('Error getting wheel information', 'error');
              return;
            }
            
            const wheel = await wheelResponse.json();
            const isCurrentlyActive = wheel.is_active === 1;
            
            // Choose endpoint based on current state
            const endpoint = isCurrentlyActive ? 'deactivate' : 'activate';
            const response = await fetch(`${window.API_BASE_URL}/api/spinning-wheels/${wheelId}/${endpoint}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' }
            });
            
            if (response.ok) {
              const action = isCurrentlyActive ? 'deactivated' : 'activated';
              showCustomAlert(`Wheel ${action} successfully`, 'success');
              loadSpinningWheelData();
              
              // Open the wheel configuration after activation/deactivation
              showWheelConfiguration(wheelId);
            } else {
              const error = await response.json();
              showCustomAlert(`Error ${isCurrentlyActive ? 'deactivating' : 'activating'} wheel: ` + error.error, 'error');
            }
          } catch (error) {
            console.error('Error toggling wheel state:', error);
            showCustomAlert('Error toggling wheel state', 'error');
          }
        }



        async function deleteWheel(wheelId) {
          if (!confirm('Are you sure you want to delete this wheel?')) return;
          
          try {
            const response = await fetch(`${window.API_BASE_URL}/api/spinning-wheels/${wheelId}`, {
              method: 'DELETE'
            });
            
            if (response.ok) {
              showCustomAlert('Wheel deleted successfully', 'success');
              loadSpinningWheelData();
            } else {
              const error = await response.json();
              showCustomAlert('Error deleting wheel: ' + error.error, 'error');
            }
          } catch (error) {
            console.error('Error deleting wheel:', error);
            showCustomAlert('Error deleting wheel', 'error');
          }
        }

        // Wheel Edit Functions
        let currentEditingWheelId = null;
        let currentEditingWheel = null;

        function showWheelConfigurationPanel() {
          const wheelConfigurationPanel = document.getElementById('wheelConfigurationPanel');
          if (wheelConfigurationPanel) {
            wheelConfigurationPanel.innerHTML = `
              <div class="card shadow-sm">
                <div class="card-header bg-light">
                  <h5 class="mb-0" id="wheelEditTitle"><i class="fa fa-cog"></i> ${currentEditingWheelId ? 'Edit Wheel' : 'New Wheel'}</h5>
                </div>
                <div class="card-body">
                  
                  <!-- Wheel Details Form -->
                  <form id="wheelEditForm" class="mb-4">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label fw-bold"><i class="fa fa-tag"></i> Wheel Name</label>
                          <input type="text" id="wheelNameInput" class="form-control" required>
                        </div>
                      </div>

                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-bold"><i class="fa fa-align-left"></i> Description</label>
                      <textarea id="wheelDescriptionInput" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="d-flex gap-2">
                      ${!currentEditingWheelId ? `<button type="submit" class="btn btn-primary">
                        <i class="fa fa-save"></i> Save Wheel
                      </button>` : ''}
                      ${currentEditingWheelId && currentEditingWheel && !currentEditingWheel.is_active ? `<button type="button" class="btn btn-success" id="activateWheelBtn">
                        <i class="fa fa-star"></i> Activate This Wheel
                      </button>` : ''}
                    </div>
                  </form>

                  <!-- Coupons Management Section - Only show when editing existing wheel -->
                  ${currentEditingWheelId ? `
                  <div class="mt-4">
                    <div class="card">
                      <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fa fa-gift"></i> Manage Coupons for this Wheel</h5>
                      </div>
                      <div class="card-body">
                        <p class="text-muted mb-3">Select which coupons should appear on this spinning wheel</p>
                        


                        <div id="wheelCouponsList" class="list-group">
                          <!-- Coupons will be loaded here -->
                        </div>
                      </div>
                    </div>
                  </div>
                  ` : ''}
                </div>
              </div>
            `;
            
            // Re-initialize the form
            initializeWheelEditForm();
          }
        }

        async function loadWheelForEdit(wheelId) {
          try {
            const response = await fetch(`${window.API_BASE_URL}/api/spinning-wheels/${wheelId}`);
            if (response.ok) {
              const wheel = await response.json();
              currentEditingWheelId = wheelId;
              currentEditingWheel = wheel;
              
              // Show configuration panel
              showWheelConfigurationPanel();
              
              // Populate form
              const wheelNameInput = document.getElementById('wheelNameInput');
              const wheelDescriptionInput = document.getElementById('wheelDescriptionInput');
              
              if (wheelNameInput) wheelNameInput.value = wheel.name;
              if (wheelDescriptionInput) wheelDescriptionInput.value = wheel.description || '';
              
              // Update the title
              const wheelEditTitle = document.getElementById('wheelEditTitle');
              if (wheelEditTitle) {
                wheelEditTitle.textContent = `Edit ${wheel.name}`;
              }
              
              // Load coupons for this wheel
              await loadWheelCoupons();
            } else {
              showCustomAlert('Error loading wheel data', 'error');
            }
          } catch (error) {
            console.error('Error loading wheel for edit:', error);
            showCustomAlert('Error loading wheel data', 'error');
          }
        }

        function resetWheelEditForm() {
          currentEditingWheelId = null;
          currentEditingWheel = null;
          showWheelConfigurationPanel();
          
          // Safely reset form elements
          const wheelNameInput = document.getElementById('wheelNameInput');
          const wheelDescriptionInput = document.getElementById('wheelDescriptionInput');
          const wheelCouponsList = document.getElementById('wheelCouponsList');
          
          if (wheelNameInput) wheelNameInput.value = '';
          if (wheelDescriptionInput) wheelDescriptionInput.value = '';
          if (wheelCouponsList) wheelCouponsList.innerHTML = '';
          
          // Don't load coupons for new wheel since the section is hidden
        }

        // Store pending changes for wheel configuration
        let pendingWheelChanges = {
          enabledCoupons: new Set(),
          disabledCoupons: new Set(),
          percentageChanges: new Map()
        };

        function updateSaveChangesButton() {
          const totalChanges = pendingWheelChanges.enabledCoupons.size + 
                             pendingWheelChanges.disabledCoupons.size + 
                             pendingWheelChanges.percentageChanges.size;
          
          const saveButton = document.querySelector('button[onclick="saveWheelChanges()"]');
          if (saveButton) {
            saveButton.disabled = totalChanges === 0;
            saveButton.innerHTML = `<i class="fa fa-save"></i> Save Changes ${totalChanges > 0 ? `(${totalChanges})` : ''}`;
          }
        }

        async function loadWheelCoupons() {
          console.log('loadWheelCoupons called');
          try {
            const response = await fetch(`${window.API_BASE_URL}/api/coupons`);
            const coupons = await response.json();
            
            let enabledCouponIds = new Set();
            let wheelCoupons = [];
            
            // If editing an existing wheel, get wheel-specific coupon status
            if (currentEditingWheelId) {
              const wheelCouponsResponse = await fetch(`${window.API_BASE_URL}/api/spinning-wheels/${currentEditingWheelId}/coupons?t=${Date.now()}`);
              if (wheelCouponsResponse.ok) {
                wheelCoupons = await wheelCouponsResponse.json();
                console.log('API returned wheel coupons:', wheelCoupons);
              }
              
              // Create a set of enabled coupon IDs for this wheel
              enabledCouponIds = new Set(wheelCoupons.map(wc => wc.coupon_id));
              console.log('Enabled coupon IDs:', Array.from(enabledCouponIds));
              console.log('Full wheel coupons data:', wheelCoupons);
            }
            
            // Reset pending changes when loading
            pendingWheelChanges = {
              enabledCoupons: new Set(),
              disabledCoupons: new Set(),
              percentageChanges: new Map()
            };
            
            // Show only active coupons with wheel-specific status
            const activeCoupons = coupons.filter(coupon => coupon.is_active === 1);
            
            const wheelCouponsList = document.getElementById('wheelCouponsList');
            if (wheelCouponsList) {
              if (activeCoupons.length === 0) {
                wheelCouponsList.innerHTML = '<div class="alert alert-warning">No active coupons found.</div>';
              } else {
                wheelCouponsList.innerHTML = activeCoupons.map(coupon => {
                  const isEnabledForWheel = enabledCouponIds.has(coupon.id);
                  // Get the wheel coupon data to find the percentage if it exists
                  const wheelCoupon = wheelCoupons.find(wc => wc.coupon_id === coupon.id);
                  const currentPercentage = wheelCoupon ? wheelCoupon.percentage || 0 : 0;
                  
                  console.log(`Rendering coupon ${coupon.id} (${coupon.code}): isEnabledForWheel = ${isEnabledForWheel}`);
                  

                  
                  return `
                  <div class="list-group-item coupon-item ${isEnabledForWheel ? 'enabled' : 'disabled'}" data-coupon-id="${coupon.id}">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="flex-grow-1">
                      <strong>${coupon.code}</strong>
                      <br>
                      <small class="text-muted">
                        ${coupon.type === 'free_days' ? 
                          `${coupon.free_days} ${coupon.free_days === 1 ? 'Day Free' : 'Days Free'}` : 
                          `${coupon.discount_percentage}% OFF`}
                      </small>
                      <br>
                      <small class="text-muted">${coupon.description || 'No description'}</small>
                        
                        ${isEnabledForWheel ? `
                        <div class="mt-3 percentage-field" style="display: block;">
                          <label class="form-label small mb-1">
                            <i class="fa fa-percentage"></i> Wheel Percentage (%)
                          </label>
                          <input type="number" 
                                 class="form-control form-control-sm" 
                                 id="percentage-${coupon.id}" 
                                 value="${currentPercentage}"
                                 min="0" 
                                 max="100" 
                                 step="0.1"
                                 placeholder="Enter percentage"
                                 onchange="updateCouponPercentage(${coupon.id}, this.value)">
                    </div>
                        ` : ''}
                      </div>
                      
                      <div class="d-flex align-items-center gap-2 ms-3">
                        <button type="button" class="btn btn-sm wheel-coupon-button ${isEnabledForWheel ? 'btn-success' : 'btn-outline-secondary'}" 
                                style="position: relative; z-index: 1000;"
                                onclick="console.log('Button clicked, data-enabled:', this.getAttribute('data-enabled'), 'disabled:', this.disabled); toggleCouponForWheel(${coupon.id}, this.getAttribute('data-enabled') === 'true')"
                                data-coupon-id="${coupon.id}"
                                data-enabled="${isEnabledForWheel}">
                          ${isEnabledForWheel ? '<i class="fa fa-check"></i> Enabled' : 'Enable'}
                      </button>
                      </div>
                    </div>
                  </div>
                `;
                }).join('');
                
                // Add Save Changes button
                wheelCouponsList.innerHTML += `
                  <div class="mt-4 text-center">
                    <button type="button" class="btn btn-primary" onclick="saveWheelChanges()" disabled>
                      <i class="fa fa-save"></i> Save Changes
                    </button>
                  </div>
                `;
                
                // Update the button state
                updateSaveChangesButton();
              }
              

            }
          } catch (error) {
            console.error('Error loading wheel coupons:', error);
            const wheelCouponsList = document.getElementById('wheelCouponsList');
            if (wheelCouponsList) {
              wheelCouponsList.innerHTML = '<div class="alert alert-danger">Error loading coupons.</div>';
            }
          }
        }



        function toggleCouponForWheel(couponId, currentStatus) {
          console.log('toggleCouponForWheel called:', { couponId, currentStatus });
          if (!currentEditingWheelId) {
            showCustomAlert('Please save the wheel first before managing coupons', 'error');
            return;
          }
          
          // Get the original state from the database (before any pending changes)
          const originalEnabledState = Array.from(document.querySelectorAll('.coupon-item')).find(item => 
            item.getAttribute('data-coupon-id') == couponId
          )?.classList.contains('enabled') || false;
          
          console.log(`Original enabled state for coupon ${couponId}:`, originalEnabledState);
          console.log(`Current UI state for coupon ${couponId}:`, currentStatus);
          
          // Calculate the final desired state
          const finalDesiredState = !currentStatus;
          console.log(`Final desired state for coupon ${couponId}:`, finalDesiredState);
          
          // Clear any existing pending changes for this coupon
          pendingWheelChanges.enabledCoupons.delete(couponId);
          pendingWheelChanges.disabledCoupons.delete(couponId);
          pendingWheelChanges.percentageChanges.delete(couponId);
          
          // Store the change in pending changes based on the final desired state
          if (finalDesiredState) {
            // Want to enable it
            pendingWheelChanges.enabledCoupons.add(couponId);
            console.log(`Added coupon ${couponId} to enabledCoupons`);
          } else {
            // Want to disable it
            pendingWheelChanges.disabledCoupons.add(couponId);
            console.log(`Added coupon ${couponId} to disabledCoupons`);
          }
          
          // Debug: Log the current state of pending changes
          console.log('Pending changes after toggle:', {
            enabled: Array.from(pendingWheelChanges.enabledCoupons),
            disabled: Array.from(pendingWheelChanges.disabledCoupons),
            percentages: Array.from(pendingWheelChanges.percentageChanges.entries())
          });
          
          // Update the UI immediately to show the change
          const couponItem = document.querySelector(`[data-coupon-id="${couponId}"]`);
          if (couponItem) {
            const button = couponItem.querySelector('button');
            const newStatus = !currentStatus;
            
            console.log(`Updating UI for coupon ${couponId}: currentStatus=${currentStatus}, newStatus=${newStatus}`);
            
            if (newStatus) {
              couponItem.classList.remove('disabled');
              couponItem.classList.add('enabled');
              button.className = 'btn btn-sm wheel-coupon-button btn-success';
              button.innerHTML = '<i class="fa fa-check"></i> Enabled';
              button.style.color = '';
              button.style.borderColor = '';
              button.setAttribute('data-enabled', 'true');
              
              // Add percentage field if it doesn't exist
              const percentageField = couponItem.querySelector('.percentage-field');
              if (!percentageField) {
                const flexGrowDiv = couponItem.querySelector('.flex-grow-1');
                const percentageHtml = `
                  <div class="mt-3 percentage-field" style="display: block;">
                    <label class="form-label small mb-1">
                      <i class="fa fa-percentage"></i> Wheel Percentage (%)
                    </label>
                    <input type="number" 
                           class="form-control form-control-sm" 
                           id="percentage-${couponId}" 
                           value="0"
                           min="0" 
                           max="100" 
                           step="0.1"
                           placeholder="Enter percentage"
                           onchange="updateCouponPercentage(${couponId}, this.value)">
                  </div>
                `;
                flexGrowDiv.insertAdjacentHTML('beforeend', percentageHtml);
              }
            } else {
              couponItem.classList.remove('enabled');
              couponItem.classList.add('disabled');
              button.className = 'btn btn-sm wheel-coupon-button btn-outline-secondary';
              button.innerHTML = 'Enable';
              button.style.color = '';
              button.style.borderColor = '';
              button.setAttribute('data-enabled', 'false');
              console.log('Button after disable - data-enabled:', button.getAttribute('data-enabled'), 'disabled:', button.disabled, 'className:', button.className, 'onclick:', button.onclick);
              
              // Remove percentage field
              const percentageField = couponItem.querySelector('.percentage-field');
              if (percentageField) {
                percentageField.remove();
              }
            }
          }
          
          // Update the Save Changes button
          updateSaveChangesButton();
          
          showCustomAlert(`Coupon will be ${!currentStatus ? 'enabled' : 'disabled'} when you save changes`, 'info');
        }

        function updateCouponPercentage(couponId, percentage) {
          if (!currentEditingWheelId) {
            showCustomAlert('Please save the wheel first before managing coupons', 'error');
            return;
          }
          
          // Validate percentage
          const numPercentage = parseFloat(percentage);
          if (isNaN(numPercentage) || numPercentage < 0 || numPercentage > 100) {
            showCustomAlert('Percentage must be between 0 and 100', 'error');
            return;
          }
          
          // Store the percentage change in pending changes
          pendingWheelChanges.percentageChanges.set(couponId, numPercentage);
          
          // Update the Save Changes button
          updateSaveChangesButton();
          
          showCustomAlert(`Percentage will be updated to ${numPercentage}% when you save changes`, 'info');
        }

        async function saveWheelChanges() {
          if (!currentEditingWheelId) {
            showCustomAlert('Please save the wheel first before managing coupons', 'error');
            return;
          }
          
          // Check if there are any pending changes
          const hasChanges = pendingWheelChanges.enabledCoupons.size > 0 || 
                           pendingWheelChanges.disabledCoupons.size > 0 || 
                           pendingWheelChanges.percentageChanges.size > 0;
          
          if (!hasChanges) {
            showCustomAlert('No changes to save', 'info');
            return;
          }
          
          try {
            console.log('Starting to save wheel changes...');
            console.log('Pending changes:', {
              enabled: Array.from(pendingWheelChanges.enabledCoupons),
              disabled: Array.from(pendingWheelChanges.disabledCoupons),
              percentages: Array.from(pendingWheelChanges.percentageChanges.entries())
            });
            
            // Apply all pending changes in the correct order
            const promises = [];
            
            // First, enable coupons (but exclude any that are also in disabledCoupons)
            for (const couponId of pendingWheelChanges.enabledCoupons) {
              if (!pendingWheelChanges.disabledCoupons.has(couponId)) {
                console.log(`Enabling coupon ${couponId} in save operation`);
                promises.push(
                  fetch(`${window.API_BASE_URL}/api/coupons/${couponId}/toggle-wheel?wheelId=${currentEditingWheelId}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' }
                  }).then(response => {
                    if (!response.ok) {
                      console.error(`Failed to enable coupon ${couponId}:`, response.status, response.statusText);
                      throw new Error(`Failed to enable coupon ${couponId}`);
                    }
                    return response.json();
                  }).then(data => {
                    console.log(`Successfully enabled coupon ${couponId}:`, data);
                    return data;
                  })
                );
              } else {
                console.log(`Skipping coupon ${couponId} - it's in both enabled and disabled sets`);
              }
            }
            
            // Wait for enable operations to complete
            if (promises.length > 0) {
              await Promise.all(promises);
              // Add a small delay to ensure database operations complete
              await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Reset promises array for next batch
            const percentagePromises = [];
            
            // Then, update percentages for coupons that have percentage changes
            for (const [couponId, percentage] of pendingWheelChanges.percentageChanges) {
              // Update percentage if the coupon is being enabled (it will exist in the wheel after enable)
              // OR if it's already enabled in the database (we need to check this)
              if (pendingWheelChanges.enabledCoupons.has(couponId)) {
                console.log(`Updating percentage for coupon ${couponId} to ${percentage}% (after enable)`);
                percentagePromises.push(
                  fetch(`${window.API_BASE_URL}/api/coupons/${couponId}/wheel-percentage`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wheelId: currentEditingWheelId, percentage: percentage })
                  }).then(response => {
                    if (!response.ok) {
                      console.error(`Failed to update percentage for coupon ${couponId}:`, response.status, response.statusText);
                      throw new Error(`Failed to update percentage for coupon ${couponId}`);
                    }
                    return response;
                  })
                );
              } else if (!pendingWheelChanges.disabledCoupons.has(couponId)) {
                // If the coupon is not being enabled or disabled, it means it was already enabled
                // and we're just updating its percentage
                console.log(`Updating percentage for already-enabled coupon ${couponId} to ${percentage}%`);
                percentagePromises.push(
                  fetch(`${window.API_BASE_URL}/api/coupons/${couponId}/wheel-percentage`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wheelId: currentEditingWheelId, percentage: percentage })
                  }).then(response => {
                    if (!response.ok) {
                      console.error(`Failed to update percentage for coupon ${couponId}:`, response.status, response.statusText);
                      throw new Error(`Failed to update percentage for coupon ${couponId}`);
                    }
                    return response;
                  })
                );
              }
            }
            
            // Wait for percentage updates to complete
            if (percentagePromises.length > 0) {
              await Promise.all(percentagePromises);
            }
            
            // Finally, disable coupons (do this last to avoid conflicts)
            const disablePromises = [];
            for (const couponId of pendingWheelChanges.disabledCoupons) {
              console.log(`Disabling coupon ${couponId} in save operation`);
              disablePromises.push(
                fetch(`${window.API_BASE_URL}/api/coupons/${couponId}/toggle-wheel?wheelId=${currentEditingWheelId}`, {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json' }
                }).then(response => {
                  if (!response.ok) {
                    console.error(`Failed to disable coupon ${couponId}:`, response.status, response.statusText);
                    throw new Error(`Failed to disable coupon ${couponId}`);
                  }
                  return response.json();
                }).then(data => {
                  console.log(`Successfully disabled coupon ${couponId}:`, data);
                  return data;
                })
              );
            }
            
            // Wait for disable operations to complete
            if (disablePromises.length > 0) {
              await Promise.all(disablePromises);
            }
            
            // Log the final state that should be in the database
            console.log('=== SAVE OPERATION COMPLETE ===');
            console.log('Final state summary:');
            console.log('- Coupons that were enabled:', Array.from(pendingWheelChanges.enabledCoupons));
            console.log('- Coupons that were disabled:', Array.from(pendingWheelChanges.disabledCoupons));
            console.log('- Coupons with percentage changes:', Array.from(pendingWheelChanges.percentageChanges.entries()));
            console.log('=== END SAVE OPERATION ===');
            
            showCustomAlert('All changes saved successfully!', 'success');
            
            // Reset pending changes
            pendingWheelChanges = {
              enabledCoupons: new Set(),
              disabledCoupons: new Set(),
              percentageChanges: new Map()
            };
            
                          // Reload the coupons list to update the display
            console.log('Reloading wheel coupons to show final state...');
            await loadWheelCoupons();
            
          } catch (error) {
            console.error('Error saving wheel changes:', error);
            showCustomAlert('Error saving changes', 'error');
          }
        }

        async function saveWheel() {
          const name = document.getElementById('wheelNameInput').value;
          const description = document.getElementById('wheelDescriptionInput').value;
          
          if (!name) {
            showCustomAlert('Name is required', 'error');
            return;
          }
          
          try {
            const url = currentEditingWheelId ? 
              `${window.API_BASE_URL}/api/spinning-wheels/${currentEditingWheelId}` : 
              `${window.API_BASE_URL}/api/spinning-wheels`;
            
            const method = currentEditingWheelId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
              method: method,
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name, description })
            });
            
            if (response.ok) {
              showCustomAlert(`Wheel ${currentEditingWheelId ? 'updated' : 'added'} successfully`, 'success');
              loadSpinningWheelData();
              
              // Reset to default state after successful save
              currentEditingWheelId = null;
              const wheelConfigurationPanel = document.getElementById('wheelConfigurationPanel');
              if (wheelConfigurationPanel) {
                wheelConfigurationPanel.innerHTML = `
                  <div class="card shadow-sm">
                    <div class="card-header bg-light">
                      <h5 class="mb-0"><i class="fa fa-cog"></i> Wheel Configuration</h5>
                    </div>
                    <div class="card-body text-center py-5">
                      <div class="mb-4">
                        <i class="fa fa-arrow-left fa-3x text-muted"></i>
                      </div>
                      <h5 class="card-title">Select a Wheel</h5>
                      <p class="text-muted">Choose a wheel from the list on the left to configure it</p>
                    </div>
                  </div>
                `;
              }
            } else {
              const error = await response.json();
              showCustomAlert('Error saving wheel: ' + error.error, 'error');
            }
          } catch (error) {
            console.error('Error saving wheel:', error);
            showCustomAlert('Error saving wheel', 'error');
          }
        }

        async function activateCurrentWheel() {
          if (!currentEditingWheelId) {
            showCustomAlert('Please save the wheel first', 'error');
            return;
          }
          
          try {
            const response = await fetch(`${window.API_BASE_URL}/api/spinning-wheels/${currentEditingWheelId}/activate`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' }
            });
            
            if (response.ok) {
              showCustomAlert('Wheel activated successfully', 'success');
              loadSpinningWheelData();
            } else {
              const error = await response.json();
              showCustomAlert('Error activating wheel: ' + error.error, 'error');
            }
          } catch (error) {
            console.error('Error activating wheel:', error);
            showCustomAlert('Error activating wheel', 'error');
          }
        }

        function filterCoupons(filter) {
          const couponItems = document.querySelectorAll('.coupon-item');
          couponItems.forEach(item => {
            const isEnabled = item.classList.contains('enabled');
            const isDisabled = item.classList.contains('disabled');
            
            switch(filter) {
              case 'enabled':
                item.style.display = isEnabled ? 'flex' : 'none';
                break;
              case 'disabled':
                item.style.display = isDisabled ? 'flex' : 'none';
                break;
              default: // 'all'
                item.style.display = 'flex';
                break;
            }
          });
        }

        // Add spinning wheel initialization to the main initialization
        document.addEventListener('DOMContentLoaded', function() {
          initializeFormDropdowns();
          initializeCarForms();
          initializeSpinningWheel();
        });
    </script>
</body>

</html>